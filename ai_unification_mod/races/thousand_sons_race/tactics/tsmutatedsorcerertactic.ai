----------------------------------------
-- File: 'tsmutatedsorcerertactic.ai'
-- Edited by Thudmeizer @ 12.09.2012

class 'TSMutatedSorcererTactic' (TSInfantryTactic)

TSMutatedSorcererAbility =
{
	LanceID = cpu_manager.stats:GetAbilityID("thousand_sons_psychic_lance")
	,GaspsID = cpu_manager.stats:GetAbilityID("thousand_sons_gasps_of_chaos")
	,VigorID = cpu_manager.stats:GetAbilityID("thousand_sons_vigor_mortis")
}

function TSMutatedSorcererTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("TS Mutated Sorcerer Tactic")
end

function TSMutatedSorcererTactic:DoAbilities()

	-- Check if we can cast Vigor Mortis
	if self.squad_ai:CanDoAbility(TSMutatedSorcererAbility.VigorID) then
		-- Search a squad
		local iRange = self.squad_ai:GetAbilityRange(TSMutatedSorcererAbility.VigorID)
		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil and oUnit:IsInCombat() and cpu_manager:GetUnitStrength(oUnit) > 200) then
			self.squad_ai:DoSpecialAbilitySquad(TSMutatedSorcererAbility.VigorID, oUnit:GetSquad())
		end
	end

	Ability.DoAbilityTarget( self.squad_ai, TSMutatedSorcererAbility.LanceID, Ability.Filters.CloseSquadEnemy, 1 )
	Ability.DoAbilityTarget( self.squad_ai, TSMutatedSorcererAbility.LanceID, Ability.Filters.CloseMonsterEnemy, 1 )

	Ability.DoAbilityTarget( self.squad_ai, TSMutatedSorcererAbility.GaspsID, Ability.Filters.CloseSquadEnemy, 1 )

	InfantryTactic.DoAbilities(self)
end


function TSMutatedSorcererTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if not InfantryTactic.Update(self) then
		return false
	end

	-- Try to attach
	if (self.squad_ai:GetMeleeStance() == SquadAI.MSTANCE_Assault and cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 30)) then
		if (self:TryAttachSquad(true, true, 25, 100, nil) ~= nil) then
			return
		end
		if (self:TryAttachSquad(false, true, 25, 100, nil) == nil) then
			self:TryAttachSquadMelee()
		end
	end
end