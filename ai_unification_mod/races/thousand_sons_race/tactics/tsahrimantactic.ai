------------------------------------------
-- File: 'tsahrimantactic.ai'
-- Edited by Thudmeizer @ 12.07.2011
-- Edited heavily :) by Gambit @20.06.2014

class 'TSAhrimanTactic' (TSInfantryTactic)

TSAhriman = {}

function TSAhrimanTactic:__init( squad_ai ) super( squad_ai )

		self:SetName("TS Ahriman Tactic")

	self.tzeentchCurseLastUse = g_iGMT
	self.numberOfSelectedAddons = 0
end


function TSAhrimanTactic:AutoBuildAddOn( addonSlot )
	for e in self.squad_ai:GetEntities() do
		local buildChannelAhriman = build_manager:GetBuildChannelFromID(e:GetID())
		if (buildChannelAhriman ~= nil) then
			local addOnID = buildChannelAhriman:GetItemIDAt(BuildChannelAI.PQ_AddOn, addonSlot)
			if (buildChannelAhriman:IsBuilding() == 0 and buildChannelAhriman:CanAddToQueue(BuildChannelAI.PQ_AddOn, addOnID) == BuildChannelAI.CANBUILD_Ok) then
				buildChannelAhriman:BuildAddOn(addOnID)
				self.numberOfSelectedAddons = self.numberOfSelectedAddons + 1
				return
			end
		end
	end
	return
end


function TSAhrimanTactic:IsAttacker()
	return self:IsCommanderAttacker()
end


function TSAhrimanTactic:IsDefender()
	return self:IsCommanderDefender()
end


function TSAhrimanTactic:InitAbilities()

	if (TSAhriman.silence_id == nil) then
	   	TSAhriman.silence_id = cpu_manager.stats:GetAbilityID( "thousand_sons_silence" )	
	end

	if (TSAhriman.damned_marines_id == nil) then
	   	TSAhriman.damned_marines_id = cpu_manager.stats:GetAbilityID( "thousand_sons_summon_damned_marines" )	
	end

	if (TSAhriman.discs_id == nil) then
	   	TSAhriman.discs_id = cpu_manager.stats:GetAbilityID( "thousand_sons_discs_of_tzeentch" )	
	end

	if (TSAhriman.winds_id == nil) then
	  	 TSAhriman.winds_id = cpu_manager.stats:GetAbilityID( "thousand_sons_wind_of_chaos" )	
	end

	if (TSAhriman.phantasmal_killer_id == nil) then
	   	TSAhriman.phantasmal_killer_id = cpu_manager.stats:GetAbilityID( "thousand_sons_phantasmal_killer" )	
	end

	if (TSAhriman.tzeentch_curse_id == nil) then
	   	TSAhriman.tzeentch_curse_id = cpu_manager.stats:GetAbilityID( "thousand_sons_tzeentch_curse" )	
	end

	if (TSAhriman.tzeentch_boon_id == nil) then
	   	TSAhriman.tzeentch_boon_id = cpu_manager.stats:GetAbilityID( "thousand_sons_tzeentch_boon" )	
	end

	if (TSAhriman.meteor_swarm_id == nil) then
	   	TSAhriman.meteor_swarm_id = cpu_manager.stats:GetAbilityID( "thousand_sons_meteor_swarm" )	
	end

	if (TSAhriman.nightmare_prophecy_id == nil) then
	   	TSAhriman.nightmare_prophecy_id = cpu_manager.stats:GetAbilityID( "thousand_sons_nightmare_prophecy" )	
	end

	if (TSAhriman.ritual_time_dilation_id == nil) then
	   	TSAhriman.ritual_time_dilation_id = cpu_manager.stats:GetAbilityID( "thousand_sons_ritual_time_dilation" )	
	end

	if (TSAhriman.ritual_blur_reality_id == nil) then
	   	TSAhriman.ritual_blur_reality_id = cpu_manager.stats:GetAbilityID( "thousand_sons_ritual_blur_reality" )	
	end

	if (TSAhriman.ritual_mass_slow_id == nil) then
	   	TSAhriman.ritual_mass_slow_id = cpu_manager.stats:GetAbilityID( "thousand_sons_ritual_mass_slow" )	
	end

end

function TSAhrimanTactic:DoAbilities()

	Ability.DoAbilityTarget( self.squad_ai, TSAhriman.silence_id, Ability.Filters.CloseEnemy, 1 )
	Ability.DoAbilityArea( self.squad_ai, TSAhriman.discs_id, Ability.Filters.CloseInfantryEnemy, 2 )
	Ability.DoAbilityArea( self.squad_ai, TSAhriman.discs_id, Ability.Filters.CloseCommanderEnemy, 1 )
	Ability.DoAbilityArea( self.squad_ai, TSAhriman.damned_marines_id, Ability.Filters.CloseEnemy, 15, 2 )
	Ability.DoAbilityArea( self.squad_ai, TSAhriman.winds_id, Ability.Filters.CloseEnemy, 18 )

	if ( self.squad_ai:CanDoAbility(TSAhriman.tzeentch_boon_id) ) then
		-- Search a non-vehicle squad
		local iRange = self.squad_ai:GetAbilityRange(TSAhriman.tzeentch_boon_id)
		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
		if oUnit ~= nil then
			local oStats = oUnit:GetStats()
			if (oStats ~= nil and oUnit:IsInCombat()) then
				local eClass = oStats:GetClass()
				if (eClass ~= nil and eClass ~= UnitStatsAI.UC_VehicleLow and eClass ~= UnitStatsAI.UC_VehicleMed
				 and eClass ~= UnitStatsAI.UC_VehicleHigh and eClass ~= UnitStatsAI.UC_AirMed and cpu_manager:GetUnitStrength(oUnit) > 150) then
					self.squad_ai:DoSpecialAbilitySquad(TSAhriman.tzeentch_boon_id, oUnit:GetSquad())
				end
			end
		end
	end

	if ( self.squad_ai:CanDoAbility(TSAhriman.meteor_swarm_id) ) then
		local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
		if ( iRequisition > 700 ) then
			Ability.DoAbilityPos( self.squad_ai, TSAhriman.meteor_swarm_id, Ability.Filters.CloseEnemy, 24 )
			Ability.DoAbilityPos( self.squad_ai, TSAhriman.meteor_swarm_id, Ability.EntityFilters.CloseBaseEntityEnemy, 3 )
		end
	end

	if ( self.squad_ai:CanDoAbility(TSAhriman.nightmare_prophecy_id) ) then
		local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
		if ( Ability.Filters.CloseSquadEnemy(self.squad_ai:GetPosition(), 20, 3) ~= nil and
		iRequisition > 700 and self.squad_ai:GetHealthPercentage() > 0.65 ) then
			self.squad_ai:DoSpecialAbility(TSAhriman.nightmare_prophecy_id)
		end
	end

	if ( self.squad_ai:CanDoAbility(TSAhriman.phantasmal_killer_id) ) then
		local iRange = self.squad_ai:GetAbilityRange(TSAhriman.phantasmal_killer_id)
		local oSquad = cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if ( oSquad ~= nil ) then
			if ( oSquad:GetNumTroopers() > 4 ) then
				self.squad_ai:DoSpecialAbilitySquad(TSAhriman.phantasmal_killer_id, oSquad:GetSquad())
			end
		end
	end
	Ability.DoAbilityTarget( self.squad_ai, TSAhriman.phantasmal_killer_id, Ability.Filters.CloseCommanderEnemy, 1 )

	-- Activate/Deactivate Rituals
	if (self.squad_ai:IsUsingAbility(TSAhriman.ritual_time_dilation_id)) then
		if (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 15, 1) ~= nil or self.squad_ai:GetHealthPercentage() > 0.3) then
			self.squad_ai:DoSpecialAbility(TSAhriman.ritual_time_dilation_id)
		end
	elseif (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 30, 1) == nil and self.squad_ai:GetHealthPercentage() < 0.3) then
		self.squad_ai:DoSpecialAbility(TSAhriman.ritual_time_dilation_id)
	end
	if (self.squad_ai:IsUsingAbility(TSAhriman.ritual_blur_reality_id)) then
		if (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 15, 1) ~= nil or self.squad_ai:GetHealthPercentage() > 0.3) then
			self.squad_ai:DoSpecialAbility(TSAhriman.ritual_blur_reality_id)
		end
	elseif (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 30, 1) == nil and self.squad_ai:GetHealthPercentage() < 0.3) then
		self.squad_ai:DoSpecialAbility(TSAhriman.ritual_blur_reality_id)
	end
	if (self.squad_ai:IsUsingAbility(TSAhriman.ritual_mass_slow_id)) then
		if (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 15, 1) ~= nil or self.squad_ai:GetHealthPercentage() > 0.3) then
			self.squad_ai:DoSpecialAbility(TSAhriman.ritual_mass_slow_id)
		end
	elseif (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 30, 1) == nil and self.squad_ai:GetHealthPercentage() < 0.3) then
		self.squad_ai:DoSpecialAbility(TSAhriman.ritual_mass_slow_id)
	end

	self:DoAhrimanTargetWeapon()
		
	InfantryTactic.DoAbilities(self)

end


function TSAhrimanTactic:DoAhrimanTargetWeapon()

	if self.squad_ai:IsInCombat() then
		if ( g_iGMT > self.tzeentchCurseLastUse + 70 ) then
			if Ability.DoAbilityTarget(self.squad_ai, TSAhriman.tzeentch_curse_id, Ability.Filters.CloseEnemy, 1) then
				self.tzeentchCurseLastUse = g_iGMT 
			end
		end
	end

end


function TSAhrimanTactic:Upgrade()

	if not Tactic.Options.can_reinforce then 
		return 
	end

--[[		OLD SYSTEM, addon-based. No longer used.
					AHRIMAN SPELL ADDONS LIST
		SLOT	SPELL ADDON NAME		Entity Addon Line
		  0		Meteor Swarm			[addon_01]
		  1		Nightmare Prophecy		[addon_02]
		  2		Summon Damned Marines	[addon_03]
		  3		Tzeentch's Curse		[addon_04]
		  4		Wind of Chaos			[addon_05]
		  5		Tzeentch's Boon			[addon_06]
		  6		Discs of Tzeentch		[addon_07]
		  7		Phantasmal Killer		[addon_08]
		  8		Blur Reality			[addon_09]
		  9		Mass Slow				[addon_10]
		 10		Time Dilation			[addon_11]
	Note: Each slot (starting from 0) corresponds to an Ahriman's
	entity spell addon (starting from 01 on the entity's addon list)

	-- Spell choices. You normally get 2 spells + 1 epic, or 1 spell + 1 epic + 1 ritual (the least possible).
	-- If resources are not enough, you get 3 spells, or 2 spells + 1 ritual, or 1 spell + 2 rituals (the least possible).
	if self.numberOfSelectedAddons < 3 then
		local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
		if ( iRequisition > 1200 ) then
			local epic_spell_addon_random_selector = math.random( 0, 1 )
			self:AutoBuildAddOn(epic_spell_addon_random_selector)
		end
		local spell_addon_random_selector = math.random( 2, 7 )
		self:AutoBuildAddOn(spell_addon_random_selector)
		local ritual_addon_random_selector = math.random( 8, 10 )
		self:AutoBuildAddOn(ritual_addon_random_selector)
	end]]

end


function TSAhrimanTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
end
