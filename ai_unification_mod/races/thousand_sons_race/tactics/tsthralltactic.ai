----------------------------------------
-- File: 'thralltactic.ai'
-- Edited by Thudmeizer @ 11.08.2011

class 'TSThrallTactic' (EngineerTactic)

TSThrall = {}

function TSThrallTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("TSThrall Tactic")
	-- Transportable by Rhinos
	self.m_iTransportable = 1

	-- Global, used to DISALLOW the 3rd (last produced) Thrall, to be capper (we need one at the base!)
	ThrallBuilderID = self.squad_ai:GetID()
end

--[[function TSThrallTactic:IsDefender()
	return true
end]]

function TSThrallTactic:InitAbilities()

	if (TSThrall.bolt_id == nil) then
	   	TSThrall.bolt_id = cpu_manager.stats:GetAbilityID( "thousand_sons_bolt_of_change_thrall" )	
	end

	if (TSThrall.unlife_id == nil) then
	  	 TSThrall.unlife_id = cpu_manager.stats:GetAbilityID( "thousand_sons_breath_of_unlife" )	
	end

	if (TSThrall.storm_id == nil) then
	   	TSThrall.storm_id = cpu_manager.stats:GetAbilityID( "thousand_sons_warp_storm" )	
	end
end

function TSThrallTactic:DoAbilities()

	-- Cast Bolt of Change on either Vehicles or Monsters
	if (self.squad_ai:CanDoAbility(TSThrall.bolt_id)) then

		-- Get closest squad in range
		local iRange = self.squad_ai:GetAbilityRange(TSThrall.bolt_id)
		local oSquad = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oSquad ~= nil) then
		
			-- Get stats
			local oStats = oSquad:GetStats()
			if (oStats ~= nil) then
			
				-- Check unit type
				local eClass = oStats:GetClass()
				if (eClass == UnitStatsAI.UC_MonsterMed) or (eClass == UnitStatsAI.UC_VehicleLow) or (eClass == UnitStatsAI.UC_VehicleMed) or (eClass == UnitStatsAI.UC_VehicleHigh) then
					
					-- Cast Bolt of Change
					self.squad_ai:DoSpecialAbilitySquad(TSThrall.bolt_id, oSquad:GetSquad())
				end
			end	
		end
	end 

	-- Cast Breath of Unlife on Commanders
	if (self.squad_ai:CanDoAbility(TSThrall.unlife_id)) then

		-- Get closest squad in range
		local iRange = self.squad_ai:GetAbilityRange(TSThrall.unlife_id)
		local oSquad = cpu_manager.cpu_player:FindFirstHurtSquad(self.squad_ai:GetPosition(), iRange)
		if (oSquad ~= nil) then
		
			-- Get stats
			local oStats = oSquad:GetStats()
			if (oStats ~= nil) then
			
				-- Check unit type
				local eClass = oStats:GetClass()
				if (eClass == UnitStatsAI.UC_Commander) then
					
					-- Cast Heal on Commanders
					self.squad_ai:DoSpecialAbilitySquad(TSThrall.unlife_id, oSquad:GetSquad())
				end
			end	
		end
	end 

	-- Cast Warp Storm if enemies nearby, but NOT allies!
	if (self.squad_ai:CanDoAbility(TSThrall.storm_id) and self.squad_ai:IsInCombat()) then
		if (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 15, 2) ~= nil and Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), 20, 4) == nil) then
			self.squad_ai:DoSpecialAbility(TSThrall.storm_id)
		end
	end

end

-- The last Thrall should be a regular builder, and not be able to capture, in order to remain close to base
function TSThrallTactic:IsEngineerWhoCanCapture()
	if BuildBaseStrategy:CountSquads("thousand_sons_squad_thrall") == 3 then
		if ThrallBuilderID == self.squad_ai:GetID() then
			return false
		end
	end
	return true
end
