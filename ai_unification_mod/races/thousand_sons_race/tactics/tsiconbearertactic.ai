----------------------------------------
-- File: 'tsiconbearertactic.ai'
-- Created by Thudmeizer @ 07.08.2011

class 'TSIconBearerTactic' (TSInfantryTactic)

TSIconBearer = {}

function TSIconBearerTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("TS Icon Bearer Tactic")

	self.boltLastUse = g_iGMT
end

function TSIconBearerTactic:InitAbilities()

	if (TSIconBearer.blasted_id == nil) then
		TSIconBearer.blasted_id = cpu_manager.stats:GetAbilityID( "thousand_sons_blasted_standard_start" )	
		TSIconBearer.bolt_id = cpu_manager.stats:GetAbilityID( "thousand_sons_bolt_of_change_icon_bearer" )	
	end
end

function TSIconBearerTactic:DoAbilities()
	if Ability.DoAbilityTarget(self.squad_ai, TSIconBearer.bolt_id, Ability.Filters.CloseVehicleEnemy, 1)
	or Ability.DoAbilityTargetEntity(self.squad_ai, TSIconBearer.bolt_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1) then
		self.boltLastUse = g_iGMT
	end

	if self.squad_ai:CanDoAbility(TSIconBearer.blasted_id) then
		-- Do the ability ONLY IF ATTACHED!
		if self.squad_ai:IsAttached() then
			if self.abilitySumUse == nil then self.abilitySumUse = 0 end
			if self.boltLastUse == nil then self.boltLastUse = 0 end
			local total_time = self.abilitySumUse + self.boltLastUse
			if total_time > 1.8 * g_iGMT then
				if self.squad_ai:WasRecentlyHurt() or total_time > 2.2 then
					local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
					local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
					if iRequisition > 250 and iPower > 250 then
						self.squad_ai:DoSpecialAbility(TSIconBearer.blasted_id)
					end
				end
			end
		end
	end

	InfantryTactic.DoAbilities(self)
end


function TSIconBearerTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if not InfantryTactic.Update(self) then
		return false
	end


	-- Try to attach	
	if (self:TryAttachSquad(true, true, 50, 100, nil) ~= nil) then
		return
	end
	if (self:TryAttachSquad(false, true, 50, 100, nil) == nil) then
		self:TryAttachSquadMelee()
	end

end