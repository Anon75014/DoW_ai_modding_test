----------------------------------------
-- File: 'numerologisttactic.ai'
-- Created by Thudmeizer @ 31.08.2025

class 'TSNumerologistTactic' (EngineerTactic)

TSNumerologist = {}

function TSNumerologistTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("TS Numerologist Tactic")
end

function TSNumerologistTactic:InitAbilities()

	if (TSNumerologist.multiplier_id == nil) then
		TSNumerologist.multiplier_id = cpu_manager.stats:GetAbilityID( "thousand_sons_force_multiplier" )	
		TSNumerologist.heal_id = cpu_manager.stats:GetAbilityID( "thousand_sons_vehicle_heal_numerologist" )	
	end
end

function TSNumerologistTactic:DoAbilities()

	-- Use the vehicle force-multipler ability
	if (self.squad_ai:CanDoAbility(TSNumerologist.multiplier_id)) then
		local range = self.squad_ai:GetAbilityRange( TSNumerologist.multiplier_id )	
		local squad_filter = function( squad_ai )		
			return squad_ai:CanBeRepaired() and squad_ai:IsInCombat() and self.squad_ai:IsAttacking() and squad_ai:GetHealthPercentage() < 0.9
		end	
   		local oSquad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
		if (oSquad ~= nil) then
			oStats = oSquad:GetStats()
			if (oStats ~= nil) then
				local eClass = oStats:GetClass()
				local eName = oSquad:GetSquadName()
				if (eClass == UnitStatsAI.UC_VehicleLow or eClass == UnitStatsAI.UC_VehicleMed or eClass == UnitStatsAI.UC_VehicleHigh
				or eClass == UnitStatsAI.UC_AirMed) then
					self.squad_ai:DoSpecialAbilitySquad( TSNumerologist.multiplier_id, oSquad:GetSquad() )
				end
			end
 		end
	end

	-- Use the vehicle health-restoring ability
	if (self.squad_ai:CanDoAbility(TSNumerologist.heal_id)) then
		local range = self.squad_ai:GetAbilityRange( TSNumerologist.heal_id )	
		local squad_filter = function( squad_ai )		
			return squad_ai:CanBeRepaired() and squad_ai:IsInCombat() and squad_ai:GetHealthPercentage() < 0.4
		end	
   		local oSquad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
		if (oSquad ~= nil) then
			oStats = oSquad:GetStats()
			if (oStats ~= nil) then
				local eClass = oStats:GetClass()
				local eName = oSquad:GetSquadName()
				if (eClass == UnitStatsAI.UC_VehicleLow or eClass == UnitStatsAI.UC_VehicleMed or eClass == UnitStatsAI.UC_VehicleHigh
				or eClass == UnitStatsAI.UC_AirMed) then
					self.squad_ai:DoSpecialAbilitySquad( TSNumerologist.heal_id, oSquad:GetSquad() )
				end
			end
 		end
	end

	InfantryTactic.DoAbilities(self)
end

function TSNumerologistTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if not InfantryTactic.Update(self) then
		return false
	end

	-- Try to attach
	if (self.squad_ai:GetMeleeStance() == SquadAI.MSTANCE_Assault and cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 30)) then
		if (self:TryAttachSquad(true, true, 25, 100, nil) ~= nil) then
			return
		end
		if (self:TryAttachSquad(false, true, 25, 100, nil) == nil) then
			self:TryAttachSquadMelee()
		end
	end
end