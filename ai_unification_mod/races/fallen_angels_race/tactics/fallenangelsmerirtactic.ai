----------------------------------------
-- File: 'fallenangelsmerirtactic.ai'
-- Edited by Thudmeizer @ 31.08.2025

class 'FallenAngelsMerirTactic' (FallenAngelsInfantryTactic)

FallenAngelsMerir = {}

function FallenAngelsMerirTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Fallen Angels Merir Astelan Tactic")
end

function FallenAngelsMerirTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function FallenAngelsMerirTactic:IsDefender()
	return self:IsCommanderDefender()
end

function FallenAngelsMerirTactic:InitAbilities()

	-- Init ability ID's
	if (FallenAngelsMerir.battlecry_id == nil) then
		FallenAngelsMerir.battlecry_id = cpu_manager.stats:GetAbilityID( "fallen_battlecry" )
	end

	if (FallenAngelsMerir.orbital_b == nil) then
		FallenAngelsMerir.orbital_b = cpu_manager.stats:GetAbilityID( "fallen_orbital_bombardment" )
	end

	if (FallenAngelsMerir.warcry_id == nil) then
		FallenAngelsMerir.warcry_id = cpu_manager.stats:GetAbilityID( "fallen_warcry_merir" )
	end
end

function FallenAngelsMerirTactic:DoAbilities()

	if self.squad_ai:IsInCombat() then
		-- Try to use battlecry
		if self.squad_ai:CanDoAbility(FallenAngelsMerir.battlecry_id) then
			if Ability.DoAbilityArea(self.squad_ai, FallenAngelsMerir.battlecry_id, Ability.Filters.CloseInCombat, 10, 1) then
				return
			end
		end

		-- Try to use warcry
		if self.squad_ai:CanDoAbility(FallenAngelsMerir.warcry_id) then
			if Ability.DoAbilityArea(self.squad_ai, FallenAngelsMerir.warcry_id, Ability.Filters.CloseInCombat, 10, 1) then
				return
			end
		end

		if self.squad_ai:CanDoAbility(FallenAngelsMerir.orbital_b) then
			if Ability.DoAbilityPos(self.squad_ai, FallenAngelsMerir.orbital_b, Ability.Filters.CloseEnemy, 24)
				or Ability.DoAbilityPos(self.squad_ai, FallenAngelsMerir.orbital_b, Ability.EntityFilters.CloseBaseEntityEnemy, 3) then
			end
		end
	end
end

function FallenAngelsMerirTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end

       	if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then
            	if (self:TryAttachSquad(false, true, 50, 150, self.m_fCommanderAttachHealth) == nil) then
      			self:TryAttachSquadMelee()
         	end
        end
end
