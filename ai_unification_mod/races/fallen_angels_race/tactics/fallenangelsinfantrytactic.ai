----------------------------------------
-- File: 'fallenangelsinfantrytactic.ai'
-- Edited by Thudmeizer         @ 05.01.2025

class 'FallenAngelsInfantryTactic' (InfantryTactic)

FallenAngelsInfantryAbility =
{
	-- Infantry
    	FragBombID = cpu_manager.stats:GetAbilityID("fallen_frag_grenades")
    	,MeltaBombID = cpu_manager.stats:GetAbilityID("fallen_melta_bombs")
}

function FallenAngelsInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Fallen Angels Infantry Tactic")
	
	-- All squads are transportable
	local sSquadName = squad_ai:GetSquadName()
	if (sSquadName == "fa_squad_zealot" or
		sSquadName == "fa_squad_zealot_advanced" or
		sSquadName == "fa_squad_tactical" or
		sSquadName == "fa_squad_havoc" or
		sSquadName == "fa_squad_noise_marine" or
		sSquadName == "fa_squad_apothecary" or
		sSquadName == "fa_squad_banner_bearer" or
		sSquadName == "fa_squad_chaplain" or
		sSquadName == "fa_squad_cypher" or
		sSquadName == "fa_squad_luther" or
		sSquadName == "fa_squad_hero_merir_astelan" or
		sSquadName == "fa_squad_lord" or
		sSquadName == "fa_squad_sorcerer") then

		-- Squads are transportable 
		self.m_iTransportable = 1	-- Rhino / Razorback
			
		-- Squads are able to deepstrike
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("fa_orbital_relay")

	elseif (sSquadName == "fa_squad_terminator" or
			sSquadName == "fa_squad_terminator_assault" or
			sSquadName == "fa_squad_obliterator" or
			sSquadName == "fa_squad_mutilator") then
		
		-- Squads are transportable and able to deepstrike	
		self.m_iTransportable = 2	-- Land Raider
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("fa_orbital_relay")
	end

    self.fragBombLastUse = g_iGMT
    self.meltaBombLastUse = g_iGMT
end

function FallenAngelsInfantryTactic:AddTargetAbilities()

end

function FallenAngelsInfantryTactic:AddCommanders()
	table.insert(self.commander, { "fa_squad_lord", true })
	table.insert(self.commander, { "fa_squad_cypher", true })
	table.insert(self.commander, { "fa_squad_chaplain", false })
	table.insert(self.commander, { "fa_squad_hero_merir_astelan", false })
	table.insert(self.commander, { "fa_squad_sorcerer", false })
	table.insert(self.commander, { "fa_squad_apothecary", false })
	table.insert(self.commander, { "fa_squad_banner_bearer", false })
	table.insert(self.commander, { "fa_squad_luther", false })
end

function FallenAngelsInfantryTactic:DoAbilities()

	-- I might have these attached
	if (self.squad_ai:IsAttached()) then
		if (self.squad_ai:HasSquadAttached("fa_squad_lord")) then
			FallenAngelsLordTactic.InitAbilities( self )
			FallenAngelsLordTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("fa_squad_sorcerer")) then
			FallenAngelsLibrarianTactic.InitAbilities( self )
			FallenAngelsLibrarianTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("fa_squad_hero_merir_astelan")) then
			FallenAngelsMerirTactic.InitAbilities( self )
			FallenAngelsMerirTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("fa_squad_chaplain")) then
			FallenAngelsChaplainTactic.InitAbilities( self )
			FallenAngelsChaplainTactic.DoAbilities( self )
		end
	end

	self:DoThrowGrenades()

	-- Check if raptor squad can speed up with boost
	if ((not self.squad_ai:IsInCombat() and self.squad_ai:IsInStateMove()) or self.stateID ~= Tactic.StateID.NoState) then

		-- Check if I can use speed fiend
		local faspeed_id = cpu_manager.stats:GetAbilityID( "fallen_speed_fiend" )
		
		if (self.squad_ai:CanDoAbility( faspeed )) then
			self.squad_ai:DoSpecialAbility( faspeed )
		end
	end

	
	-- Call basic DoAbilities methods
	InfantryTactic.DoAbilities(self)
end

function FallenAngelsInfantryTactic:DoThrowGrenades()

    if self.squad_ai:IsInCombat() then
        
        if ( g_iGMT > self.fragBombLastUse + 30 ) then
            if Ability.DoAbilityTarget( self.squad_ai, FallenAngelsInfantryAbility.FragBombID, Ability.Filters.CloseCommanderEnemy, 1 ) 
            or Ability.DoAbilityTarget( self.squad_ai, FallenAngelsInfantryAbility.FragBombID, Ability.Filters.CloseSquadEnemy, 4 )
            then
                self.fragBombLastUse = g_iGMT 
            end
        end
    
   
        if ( g_iGMT > self.meltaBombLastUse + 65 ) then        
            if Ability.DoAbilityTarget( self.squad_ai, FallenAngelsInfantryAbility.MeltaBombID, Ability.Filters.CloseVehicleEnemy, 1 )
            or Ability.DoAbilityTargetEntity( self.squad_ai, FallenAngelsInfantryAbility.MeltaBombID, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
            then
                self.meltaBombLastUse = g_iGMT
            end
        end
    end
end

function FallenAngelsInfantryTactic:CheckForBroken()

	if (self.squad_ai:IsBroken()) then
	
		-- Check if I can repair my morale
		local farally_id = cpu_manager.stats:GetAbilityID( "fallen_rally" )
		if (self.squad_ai:CanDoAbility( farally_id )) then
			self.squad_ai:DoSpecialAbility( farally_id )
		end

		-- Check if I can repair my morale
		local famark_id = cpu_manager.stats:GetAbilityID( "fallen_mark_of_slaanesh" )
		if (self.squad_ai:CanDoAbility( famark_id )) then
			self.squad_ai:DoSpecialAbility( famark_id )
		end
	end
	
	-- Call basic broken check method
	InfantryTactic.CheckForBroken(self)
end

function FallenAngelsInfantryTactic:CheckDance(oSquad)

	-- Check opponent
	if (oSquad == nil) then
		return false
	end
	
	-- Compare opponents
	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "fa_squad_tactical" or sSquadName == "fa_squad_terminator" or sSquadName == "fa_squad_havoc") then
		
		-- Check opponent
		if (oSquad:GetSquadName() == "chaos_squad_cultist") then
			return false
		end
	end
	return true
end

function FallenAngelsInfantryTactic:Upgrade()

	-- Check if we have free ressources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- Don't upgrade squads with less than 6 troopers
	if (self.squad_ai:GetSquadName() == "fa_squad_tactical" and self.squad_ai:GetNumTroopers() < 6) then
		return
	end
	
	if (not self.squad_ai:IsReinforcing() and self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 3) then
		
		-- Figure out my enemy's favourite class
		local enemy = cpu_manager:FindClosestEnemyPlayer()
		if (enemy == nil) then
			return
		end
		local class_type = enemy:GetMajorityClassType()
		
		-- Larkins hard counter upgrade for HeavyInfantryMed 
		if (class_type < UnitStatsAI.UC_HeavyInfantryMed) then	  
		  
			local enemy_race = enemy:GetPlayerRaceName()
			if (enemy_race == "da_race" or enemy_race == "chaos_marine_race" or enemy_race == "necron_race") then
		    	class_type = UnitStatsAI.UC_HeavyInfantryMed
		  	end
		end
		
		-- Do best upgrade
		self.squad_ai:DoBestUpgrade(class_type)
	end
end