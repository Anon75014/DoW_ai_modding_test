----------------------------------------
-- File: 'deathguaredinfantrytactic.ai'
-- Edited by Thudmeizer		@ 23.04.2025

class 'DeathGuardInfantryTactic' (InfantryTactic)

function DeathGuardInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Death Guard Infantry Tactic")

	-- Death Guard infantry is able to enter transport vehicles
	local sSquadName = squad_ai:GetSquadName()
	if (sSquadName == "death_guard_squad_cultist" or
		sSquadName == "death_guard_squad_flies" or
		sSquadName == "death_guard_squad_gut" or
		sSquadName == "death_guard_squad_plague_marine_ranged" or
		sSquadName == "death_guard_squad_plague_marine_melee" or
		sSquadName == "death_guard_squad_plague_havoc" or
		sSquadName == "death_guard_squad_plague_poisoner" or
		sSquadName == "death_guard_squad_possessed" or
		sSquadName == "death_guard_squad_chosen" or
		sSquadName == "death_guard_squad_blightbringer" or
		sSquadName == "death_guard_squad_blightspawn" or
		sSquadName == "death_guard_squad_herald" or
		sSquadName == "death_guard_squad_icon" or
		sSquadName == "death_guard_squad_putrifier" or
		sSquadName == "death_guard_squad_sigil" or
		sSquadName == "death_guard_squad_sorcerer" or
		sSquadName == "death_guard_squad_sorcerer_2" or
		sSquadName == "death_guard_squad_surgeon" or
		sSquadName == "death_guard_squad_tallyman" or
		sSquadName == "death_guard_squad_lord" or
		sSquadName == "death_guard_squad_lord_2") then
		self.m_iTransportable = 1	-- Rhino // Plague Tower

	elseif (sSquadName == "death_guard_squad_terminator_blightlord" or
		sSquadName == "death_guard_squad_terminator_deathshroud" or
		sSquadName == "death_guard_squad_lord_terminator" or
		sSquadName == "death_guard_squad_sorcerer_terminator" or
		sSquadName == "death_guard_squad_typhus") then
		self.m_iTransportable = 2	-- Land Raider

	elseif (sSquadName == "death_guard_squad_zombie") then
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("death_guard_hq")

	elseif (sSquadName == "death_guard_squad_glitchling" or
		sSquadName == "death_guard_squad_nurgling" or
		sSquadName == "death_guard_squad_plaguebearer" or
		sSquadName == "death_guard_squad_guo") then
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("death_guard_sacrificial_circle_daemons")
	end
end

function DeathGuardInfantryTactic:AddCommanders()
	table.insert(self.commander, { "death_guard_squad_lord", true })
	table.insert(self.commander, { "death_guard_squad_lord_2", true })
	table.insert(self.commander, { "death_guard_squad_lord_terminator", true })
	table.insert(self.commander, { "death_guard_squad_sorcerer", false })
	table.insert(self.commander, { "death_guard_squad_sorcerer_2", false })
	table.insert(self.commander, { "death_guard_squad_sorcerer_terminator", false })
	table.insert(self.commander, { "death_guard_squad_typhus", false })
	table.insert(self.commander, { "death_guard_squad_typhus_ktgm", false })
	table.insert(self.commander, { "death_guard_squad_herald", false })
end

function DeathGuardInfantryTactic:AddTargetAbilities()
	table.insert(InfantryTactic.TargetAbilities, { nil, "death_guard_blight_grenades", Ability.Filters.CloseVehicleEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "death_guard_blight_grenades_hyper", Ability.Filters.CloseSquadEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "death_guard_head_grenades", Ability.Filters.CloseSquadEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "death_guard_corrosive_plague_bomb", Ability.Filters.CloseVehicleEnemy, 1, 0 })
end

function DeathGuardInfantryTactic:DoAbilities()

	if (self.squad_ai:IsAttached()) then
		if (self.squad_ai:HasSquadAttached("death_guard_squad_lord") or self.squad_ai:HasSquadAttached("death_guard_squad_lord_2") or self.squad_ai:HasSquadAttached("death_guard_squad_lord_terminator")) then
			DeathGuardLordTactic.InitAbilities( self )
			DeathGuardLordTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("death_guard_squad_herald")) then
			DeathGuardHeraldTactic.InitAbilities( self )
			DeathGuardHeraldTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("death_guard_squad_sorcerer") or self.squad_ai:HasSquadAttached("death_guard_squad_sorcerer_2") or self.squad_ai:HasSquadAttached("death_guard_squad_sorcerer_terminator")) then
			DeathGuardSorcererTactic.InitAbilities( self )
			DeathGuardSorcererTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("death_guard_squad_typhus")) then
			DeathGuardTyphusTactic.InitAbilities( self )
			DeathGuardTyphusTactic.DoAbilities( self )
		end
	end

	-- Use Nurgle's Touch
	if self.squad_ai:IsInCombat() and self.squad_ai:WasRecentlyHurt() then
		local nurgle_touch_id = cpu_manager.stats:GetAbilityID( "death_guard_nurgle_touch" )
		if self.squad_ai:CanDoAbility(nurgle_touch_id) then
			self.squad_ai:DoSpecialAbility(nurgle_touch_id)
		end		
	end

	-- Call basic DoAbilities methods
	InfantryTactic.DoAbilities(self)
end

function DeathGuardInfantryTactic:CheckDance(oSquad)
	if (oSquad == nil) then
		return false
	end
	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "death_guard_squad_marine_ranged" or sSquadName == "death_guard_squad_terminator_blightlord") then
		if (oSquad:GetSquadName() == "chaos_squad_cultist") then
			return false
		end
	end
	return true
end

function DeathGuardInfantryTactic:Upgrade()

	if (not Tactic.Options.can_reinforce) then
		return
	end

	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end

	if (self.squad_ai:GetSquadName() == "death_guard_squad_marine_ranged" and self.squad_ai:GetNumTroopers() < 4) then
		return
	end

	if (not self.squad_ai:IsReinforcing() and self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 3) then
		local enemy = cpu_manager:FindClosestEnemyPlayer()
		if (enemy == nil) then
			return
		end

		local class_type = enemy:GetMajorityClassType()
		if (class_type < UnitStatsAI.UC_HeavyInfantryMed) then	  
			local enemy_race = enemy:GetPlayerRaceName()
			if (enemy_race == "space_marine_race" or enemy_race == "chaos_marine_race" or enemy_race == "necron_race") then
		    		class_type = UnitStatsAI.UC_HeavyInfantryMed
		  	end
		end
		self.squad_ai:DoBestUpgrade(class_type)
	end
end
