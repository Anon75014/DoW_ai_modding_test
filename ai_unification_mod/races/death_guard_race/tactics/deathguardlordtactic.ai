----------------------------------------
-- File: 'deathguardlordtactic.ai'
-- Edited by Thudmeizer @ 16.06.2022

class 'DeathGuardLordTactic' (DeathGuardInfantryTactic)

DeathGuardLord = {}

function DeathGuardLordTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Death Guard Lord Tactic")
end

function DeathGuardLordTactic:IsAttacker()
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

function DeathGuardLordTactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end

function DeathGuardLordTactic:InitAbilities()

	if DeathGuardLord.healing_id == nil then
		DeathGuardLord.airstrike_id = cpu_manager.stats:GetAbilityID( "death_guard_airstrike" )
		DeathGuardLord.healing_id = cpu_manager.stats:GetAbilityID( "death_guard_healing_touch" )	
	end
end

function DeathGuardLordTactic:DoAbilities()

	-- Make a healing attempt
	if self.squad_ai:CanDoAbility(DeathGuardLord.healing_id) then
		-- Find: nearby (25) + wounded + non-vehicle + more that 3 members squad. For Commanders apply even for 1 member.
		local oSquad = cpu_manager.cpu_player:FindFirstHurtSquad(self.squad_ai:GetPosition(), 25)
		if oSquad ~= nil and oSquad:GetHealthPercentage() < 0.75 then
			local oStats = oSquad:GetStats()
			local oClass = nil
			if oStats ~= nil then oClass = oStats:GetClass() end
			if oClass ~= nil then
				if oClass == UnitStatsAI.UC_Commander then
					self.squad_ai:DoSpecialAbilitySquad(DeathGuardLord.healing_id, oSquad:GetSquad())
					return
				elseif oSquad:GetNumTroopers() > 3 then
					if oClass ~= UnitStatsAI.UC_VehicleLow and oClass ~= UnitStatsAI.UC_VehicleMed
					and oClass ~= UnitStatsAI.UC_VehicleHigh and oClass ~= UnitStatsAI.UC_AirMed then
						self.squad_ai:DoSpecialAbilitySquad(DeathGuardLord.healing_id, oSquad:GetSquad())
						return
					end
				end
			end
		end
		-- 
		if not self.squad_ai:IsAttached() and self.squad_ai:GetHealthPercentage() < 0.25 then
			self.squad_ai:DoSpecialAbilitySquad(DeathGuardLord.healing_id, self.squad_ai:GetSquad())
			return
		end
	end

	-- We are dying, lower requisites for attacks
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
		Ability.DoAbilityPos(self.squad_ai, DeathGuardLord.airstrike_id, Ability.Filters.CloseEnemy, 4)
		Ability.DoAbilityPos(self.squad_ai, DeathGuardLord.airstrike_id, Ability.EntityFilters.CloseBaseEntityEnemy, 2)
	else
		Ability.DoAbilityPos(self.squad_ai, DeathGuardLord.airstrike_id, Ability.Filters.CloseEnemy, 8)
		Ability.DoAbilityPos(self.squad_ai, DeathGuardLord.airstrike_id, Ability.EntityFilters.CloseBaseEntityEnemy, 3)
	end

	if (self.squad_ai:CanPossess()) then

		if (self.squad_ai:IsInCombat() or cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 35)) then
			self.squad_ai:DoPossess()
		end
	end
end

function DeathGuardLordTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Assassinate win condition -- never attach to a squad
    	if (not cpu_manager.assassinate and self.squad_ai:GetMeleeStance() == SquadAI.MSTANCE_Assault) then
         
		if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then
        
            	if (self:TryAttachSquad(false, true, 50, 150, self.m_fCommanderAttachHealth) == nil) then
                		self:TryAttachSquadMelee()
            	end
        	end
    	end
end
