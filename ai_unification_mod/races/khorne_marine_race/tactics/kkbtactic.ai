----------------------------------------
-- File: 'kinfantrytactic.ai'
-- Created by I_Chample
-- Edited by Thudmeizer  @ 23.05.2020

class 'kKBTactic' (kInfantryTactic)

KB = {}

function kKBTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("k KB Tactic")

	KB.NextExecuteCheck = 0
end

function kKBTactic:InitAbilities()

	if (KB.sarcrificle_id == nil or KB.NextExecuteCheck == nil) then
		KB.sarcrificle_id = cpu_manager.stats:GetAbilityID( "khm_sarcrificle" )
		KB.NextExecuteCheck = iGMT
	end

	if (KB.rage_id == nil) then
		KB.rage_id = cpu_manager.stats:GetAbilityID( "khm_furious_rage" )	
	end
end

function kKBTactic:DoAbilities()

	if (self.squad_ai:IsAttacking() and	self.squad_ai:CanDoAbility(KB.sarcrificle_id) and
		self.squad_ai:GetNumTroopers() > 6 and g_iGMT > KB.NextExecuteCheck) then
		self.squad_ai:DoSpecialAbility(KB.sarcrificle_id) 
		KB.NextExecuteCheck = g_iGMT + 20
	end

	if (self.squad_ai:IsInCombat() and not self.squad_ai:IsCapturing() and not self.squad_ai:IsBroken()) then
		if (not self:IsMoving()) then
			if (self.squad_ai:CanDoAbility( KB.rage_id )) then
				self.squad_ai:DoSpecialAbility( KB.rage_id )
			end
		end		
	end
	kInfantryTactic.DoAbilities(self)
end

function kKBTactic:Reinforce()

	if (g_iGMT > DefendChokePointPlan.HarassingTime * 60) then
		if (not Tactic.Options.can_reinforce) then
			return
		end
	end

	if (not self.squad_ai:IsReinforcing()) then
		if (self.squad_ai:CanReinforce( false, 0 )) then
			self.squad_ai:DoReinforce( false, 0 )
			return
		end

		local berssergIndex = 0
		local marinesergIndex = 1
		local iconIndex = 2
		local skullchampIndex = 3

		local nummarinesergs = self.squad_ai:GetLeaderCount( marinesergIndex )
		local numberssergs = self.squad_ai:GetLeaderCount( berssergIndex )
		local numicons = self.squad_ai:GetLeaderCount( iconIndex )
		local numskullchamps = self.squad_ai:GetLeaderCount( skullchampIndex )

		local desiredmarinesergs = 1
		local desiredberssergs = 1
		local desiredicons = 1
		local desiredskullchamps = 1

		local squadMax = self.squad_ai:GetMaxLeaderCount()

		if (squadMax >= 2) then
			desiredmarinesergs = 1
			desiredberssergs = 1
			desiredicons = 1
			desiredskullchamps = 1
		end

		if (cpu_manager:EnemyHasUnitInfiltrators() or cpu_manager:EnemyHasBaseInfiltrators()) then
			if (numicons <= 0) then
				desiredberssergs = 0
				desiredmarinesergs = 0
				desiredicons = 1
				desiredskullchamps = 1
			end
			if (nummarinesergs <= 0) then
				desiredberssergs = 0
				desiredmarinesergs = 1
				desiredicons = 0
				desiredskullchamps = 1
			end
			if (numberssergs <= 0) then
				desiredberssergs = 1
				desiredmarinesergs = 1
				desiredicons = 0
				desiredskullchamps = 0
			end
			if (numskullchamps <= 0) then
				desiredberssergs = 0
				desiredmarinesergs = 1
				desiredicons = 1
				desiredskullchamps = 0
			end
		end
		if (numberssergs < desiredberssergs) then
			if self.squad_ai:CanReinforce( true, berssergIndex ) then
				self.squad_ai:DoReinforce( true, berssergIndex )
			end
		elseif (nummarinesergs < desiredmarinesergs) then
			if self.squad_ai:CanReinforce( true, marinesergIndex ) then
				self.squad_ai:DoReinforce( true, marinesergIndex )
			end
		elseif (numicons < desiredicons) then
			if self.squad_ai:CanReinforce( true, iconIndex ) then
				self.squad_ai:DoReinforce( true, iconIndex )
			end
		elseif (numskullchamps < desiredskullchamps) then
			if self.squad_ai:CanReinforce( true, skullchampIndex ) then
				self.squad_ai:DoReinforce( true, skullchampIndex )
			end
		end
	end
end