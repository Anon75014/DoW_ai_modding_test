----------------------------------------
-- File: 'kinfantrytactic.ai'
-- Created by I_Chample
-- Edited by Thudmeizer  @ 09.03.2023

class 'kCultLeaderTactic' (kInfantryTactic)

CultLeader = {}

function kCultLeaderTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("k CultLeader Tactic")

	CultLeader.NextExecuteCheck = 0
end

function kCultLeaderTactic:InitAbilities()

	if (CultLeader.sarcrificle_id == nil or CultLeader.NextExecuteCheck == nil) then
		CultLeader.sarcrificle_id = cpu_manager.stats:GetAbilityID( "khm_cult_sarcrificle" )
		CultLeader.NextExecuteCheck = iGMT
	end

	if (CultLeader.regen_id == nil) then
		CultLeader.regen_id = cpu_manager.stats:GetAbilityID( "khm_hero_regeneration" )
	end
end

function kCultLeaderTactic:DoAbilities()

	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.5) then
		Ability.DoAbility(self.squad_ai, CultLeader.regen_id, Ability.Filters.IsInCombat )
	end

	if (self.squad_ai:IsAttacking() and self.squad_ai:CanDoAbility(CultLeader.sarcrificle_id) and
		self.squad_ai:GetNumTroopers() > 6 and g_iGMT > CultLeader.NextExecuteCheck) then
		self.squad_ai:DoSpecialAbility(CultLeader.sarcrificle_id) 
		CultLeader.NextExecuteCheck = g_iGMT + 20
	end

	kInfantryTactic.DoAbilities(self)
end

function kCultLeaderTactic:Reinforce()

	if (g_iGMT > DefendChokePointPlan.HarassingTime * 60) then
		if (not Tactic.Options.can_reinforce) then
			return
		end
	end

	if (not self.squad_ai:IsReinforcing()) then
		if (self.squad_ai:CanReinforce( false, 0 )) then
			self.squad_ai:DoReinforce( false, 0 )
			return
		end
		local MeleeCultIndex = 0
		local RangeCultIndex = 1
		local AssassinCultIndex = 2
		local BodyguardCultIndex = 3

		local numRangeCult = self.squad_ai:GetLeaderCount( RangeCultIndex )
		local numMeleeCult = self.squad_ai:GetLeaderCount( MeleeCultIndex )
		local numAssassinCult = self.squad_ai:GetLeaderCount( AssassinCultIndex )
		local numBodyguardCult = self.squad_ai:GetLeaderCount( BodyguardCultIndex )

		local desiredRangeCult = 4
		local desiredMeleeCult = 3
		local desiredAssassinCult = 2
		local desiredBodyguardCult = 2

		local squadMax = self.squad_ai:GetMaxLeaderCount()

		if (squadMax >= 19) then
			desiredRangeCult = 4
			desiredMeleeCult = 3
			desiredAssassinCult = 2
			desiredBodyguardCult = 2
		end

		if (cpu_manager:EnemyHasUnitInfiltrators() or cpu_manager:EnemyHasBaseInfiltrators()) then
			if (numAssassinCult <= 0) then
				desiredMeleeCult = 4
				desiredRangeCult = 3
				desiredAssassinCult = 2
				desiredBodyguardCult = 2
			end
			if (numRangeCult <= 0) then
				desiredMeleeCult = 0
				desiredRangeCult = 7
				desiredAssassinCult = 2
				desiredBodyguardCult = 2
			end
			if (numMeleeCult <= 0) then
				desiredMeleeCult = 7
				desiredRangeCult = 0
				desiredAssassinCult = 2
				desiredBodyguardCult = 2
			end
		end
		if (numMeleeCult < desiredMeleeCult) then
			if self.squad_ai:CanReinforce( true, MeleeCultIndex ) then
				self.squad_ai:DoReinforce( true, MeleeCultIndex )
			end
		elseif (numRangeCult < desiredRangeCult) then
			if self.squad_ai:CanReinforce( true, RangeCultIndex ) then
				self.squad_ai:DoReinforce( true, RangeCultIndex )
			end
		elseif (numAssassinCult < desiredAssassinCult) then
			if self.squad_ai:CanReinforce( true, AssassinCultIndex ) then
				self.squad_ai:DoReinforce( true, AssassinCultIndex )
			end
		elseif (numBodyguardCult < desiredBodyguardCult) then
			if self.squad_ai:CanReinforce( true, BodyguardCultIndex ) then
				self.squad_ai:DoReinforce( true, BodyguardCultIndex )
			end
		end
	end
end