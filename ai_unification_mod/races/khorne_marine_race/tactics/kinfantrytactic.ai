----------------------------------------
-- File: 'kinfantrytactic.ai'
-- Created by I_Chample
-- Edited by Gambit, to treat builder attachments 
-- Edited by Thudmeizer  @ 04.02.2024

class 'kInfantryTactic' (InfantryTactic)

function kInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("k Infantry Tactic")

	local sSquadName = squad_ai:GetSquadName()
	if (sSquadName == "khm_squad_cult_infantry_melee" or
			sSquadName == "khm_squad_cult_infantry_range" or
			sSquadName == "khm_squad_cult_leader" or
			sSquadName == "khm_squad_servitor_melee" or
			sSquadName == "khm_squad_servitor_range" or
			sSquadName == "khm_squad_marine_havoc" or
			sSquadName == "khm_squad_marine_teeth" or
			sSquadName == "khm_squad_marine_bolter" or
			sSquadName == "khm_squad_khorne_berserker" or
			sSquadName == "khm_squad_khorne_berserker_prepared" or
			sSquadName == "khm_squad_khorne_berserker_broken" or
			sSquadName == "khm_squad_khorne_berserker_primaris" or
			sSquadName == "khm_squad_bloodletter_hero" or
			sSquadName == "khm_squad_warpsmith" or
			sSquadName == "khm_squad_dark_apostle" or
			sSquadName == "khm_squad_techmarine" or
			sSquadName == "khm_squad_surgeon" or
			sSquadName == "khm_squad_blood_wolf" or
			sSquadName == "khm_squad_hero_crull" or
			sSquadName == "khm_squad_hero_kharn" or
			sSquadName == "khm_squad_hero_kharn_ktgm" or
			sSquadName == "khm_squad_rampager" or
			sSquadName == "khm_squad_lord_khorne" or
			sSquadName == "khm_squad_lord_khorne_sp" or
			sSquadName == "khm_squad_lord_khorne_terminator" or
			sSquadName == "khm_squad_chosen_berzerkers" or
			sSquadName == "khm_squad_chosen_heavy" or
			sSquadName == "khm_squad_chosen_range" or
			sSquadName == "khm_squad_kasrkin") then
				self.m_iTransportable = 1	-- Testudo / Meat Carrier
				self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("khm_greater_sacrificial_circle")

	elseif (sSquadName =="khm_squad_bloodhounds" or
			sSquadName == "khm_squad_bloodletters" or
			sSquadName == "khm_squad_bloodletters_favored" or
			sSquadName == "khm_squad_bloodletters_ktgm" or
			sSquadName == "khm_squad_possessed_marine" or
			sSquadName == "khm_squad_hero_angron") then
				self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("khm_greater_sacrificial_circle")

	elseif (sSquadName == "khm_squad_juggernaut" or
			sSquadName == "khm_squad_slave" or
			sSquadName == "khm_squad_hero_lotara" or
			sSquadName == "khm_squad_hero_svane" or
			sSquadName == "khm_squad_hero_zhufor") then
				self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("khm_sacrificial_circle")

	elseif (sSquadName == "khm_squad_raptor" or
			sSquadName == "khm_squad_warp_talons" or
			sSquadName == "khm_squad_chosen_assault" or
			sSquadName == "khm_squad_khorne_terminator" or
			sSquadName == "khm_squad_khorne_terminator_assault") then
				self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("khm_temple")
	end

	BLDR_CNTR_SWTCH_KHM = 0
end

function kInfantryTactic:AddTargetAbilities()

	table.insert(InfantryTactic.TargetAbilities, { nil, "khm_frag_grenades", Ability.Filters.CloseSquadEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "khm_cult_frag_grenades", Ability.Filters.CloseSquadEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "khm_krak_grenades", Ability.Filters.CloseVehicleEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "khm_melta_bombs", Ability.Filters.CloseVehicleEnemy, 1, 0 })
end

function kInfantryTactic:AddCommanders()

	table.insert(self.commander, { "khm_squad_lord_khorne", true })
	table.insert(self.commander, { "khm_squad_lord_khorne_sp", true })
	table.insert(self.commander, { "khm_squad_lord_khorne_terminator", true })
	table.insert(self.commander, { "khm_squad_bloodletter_hero", true })
	table.insert(self.commander, { "khm_squad_daemon_lord_khorne", false })
	table.insert(self.commander, { "khm_squad_slave", false })
	table.insert(self.commander, { "khm_squad_techmarine", false })
	table.insert(self.commander, { "khm_squad_surgeon", false })
	table.insert(self.commander, { "khm_squad_warpsmith", false })
	table.insert(self.commander, { "khm_squad_dark_apostle", false })
	table.insert(self.commander, { "khm_squad_hero_svane", false })
	table.insert(self.commander, { "khm_squad_hero_crull", false })
	table.insert(self.commander, { "khm_squad_hero_kharn", false })
	table.insert(self.commander, { "khm_squad_hero_kharn_ktgm", false })
	table.insert(self.commander, { "khm_squad_hero_lotara", false })
	table.insert(self.commander, { "khm_squad_hero_zhufor", false })
end

function kInfantryTactic:DoAbilities()

	if (self.squad_ai:IsAttached()) then

		if (self.squad_ai:HasSquadAttached("khm_squad_lord_khorne")) or (self.squad_ai:HasSquadAttached("khm_squad_lord_khorne_terminator")) then
			kLordTactic.InitAbilities( self )
			kLordTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_slave")) or (self.squad_ai:HasSquadAttached("khm_squad_techmarine")) then
			kSlaveTactic.InitAbilities( self )
			kSlaveTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_daemon_lord_khorne")) then
			kDaemonLordTactic.InitAbilities( self )
			kDaemonLordTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_surgeon")) then
			kSurgeonTactic.InitAbilities( self )
			kSurgeonTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_hero_crull")) then
			kCrullTactic.InitAbilities( self )
			kCrullTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_hero_kharn")) then
			kKharnTactic.InitAbilities( self )
			kKharnTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_hero_kharn_ktgm")) then
			kKharnktgmTactic.InitAbilities( self )
			kKharnktgmTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_hero_svane")) then
			kSvaneTactic.InitAbilities( self )
			kSvaneTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_hero_zhufor")) then
			kZhuforTactic.InitAbilities( self )
			kZhuforTactic.DoAbilities( self )
		end

		if (self.squad_ai:HasSquadAttached("khm_squad_hero_lotara")) then
			kLotaraTactic.InitAbilities( self )
			kLotaraTactic.DoAbilities( self )
		end
	end

	InfantryTactic.DoAbilities(self)
end
function kInfantryTactic:CheckDance(oSquad)

	if (oSquad == nil) then
		return false
	end

	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "khm_squad_marine_bolter" or sSquadName == "khm_squad_khorne_terminator") then
		if (oSquad:GetSquadName() == "chaos_squad_cultist") then
			return false
		end
	end
	return true
end

function kInfantryTactic:CheckForDetach()

	local fDetachHealth = self.m_fCommanderAttachHealth + 0.2
    	if (not self.squad_ai:IsInCombat() and not self.squad_ai:WasRecentlyHurt() and
        	self:CommanderAttached() and self.squad_ai:GetAttachedHealthPercentage() > fDetachHealth) then
        	self.squad_ai:DoDetachSquad()
        	self.squad_ai:DoSetDefaultMeleeStance()
		return
    	end

	if ((self.squad_ai:IsBroken() or self.squad_ai:IsCapturing()) and
		(self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt())) then 
		self.squad_ai:DoDetachSquad()
		self.squad_ai:DoSetDefaultMeleeStance()
		return
	end

	if BLDR_CNTR_SWTCH_KHM == nil then BLDR_CNTR_SWTCH_KHM = 0 end
	if KHM_AttachedBuilders == nil then KHM_AttachedBuilders = 0 end
	if KHM_FreeBuilders == nil then KHM_FreeBuilders = 0 end
		if g_iGMT > BLDR_CNTR_SWTCH_KHM + 8 then
			KHM_AttachedBuilders, KHM_FreeBuilders = 0, 0
			for oSquad in cpu_manager.stats:GetPlayerStatsFromID(cpu_manager.player_id):GetSquads() do
				if oSquad:IsValid() then
					local oName = oSquad:GetSquadName()
					if oSquad:HasSquadAttached("khm_squad_slave") or oSquad:HasSquadAttached("khm_squad_techmarine") then
						KHM_AttachedBuilders = KHM_AttachedBuilders + 1
					elseif oName == "khm_squad_slave" or oName == "khm_squad_techmarine" then
						KHM_FreeBuilders = KHM_FreeBuilders + 1
					end
				end
			end

		BLDR_CNTR_SWTCH_KHM = g_iGMT
		if (self.squad_ai:HasSquadAttached("khm_squad_slave") or self.squad_ai:HasSquadAttached("khm_squad_techmarine")) then
			if KHM_FreeBuilders <= KHM_AttachedBuilders then
				self.squad_ai:DoDetachSquad()
				self.squad_ai:DoSetDefaultMeleeStance()
			end
		end
	end
end

function kInfantryTactic:CanOnlyDecap()

	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "khm_squad_khorne_terminator") then
        	return true
    	elseif (sSquadName == "khm_squad_khorne_terminator_assault") then
        	return true
    	end
	return false
end
