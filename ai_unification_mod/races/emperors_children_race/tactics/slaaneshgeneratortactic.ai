----------------------------------------
-- File: 'slaaneshgeneratortactic.ai'
-- Edited by Thudmeizer		@ 25.08.2009

class 'SlaaneshGeneratorTactic' (BaseTactic)
--class 'SlaaneshGeneratorTactic' (GarrisonableBaseTactic)

function SlaaneshGeneratorTactic:__init( base_ai ) super( base_ai )
	
	self.unitTactic = nil
	self.hasUnitGarrisoned = false

	self:SetName("Slaanesh Generator Tactic")
	--self.base_ai:DoUnload()
end

function SlaaneshGeneratorTactic:GetUnitNameToGarrison()
	return "emperors_children_squad_cultist"
end

function SlaaneshGeneratorTactic:DoEnterSquad()

	local enteringAI = nil
	if self.unitTactic ~= nil then
		enteringAI = self.unitTactic.squad_ai
	end

	if enteringAI == nil or not enteringAI:IsValid() then
		enteringAI = self:FindUnitToGarrison()
	end
	
	if enteringAI ~= nil and enteringAI:IsValid() then
	
		self.unitTactic = enteringAI:GetTactic()
	
		local basePosition = self.base_ai:GetPosition()
		local distToSquad = distance_sqr( enteringAI:GetPosition(), basePosition)
		
		Tactic.SetSubState( self.unitTactic, self.unitTactic.HoldState, "Holding" )
		self.unitTactic:SetManagedByGenerator(true)
		
		if distToSquad > 64  then
		
			cpu_manager:DoMove(enteringAI, basePosition, false, "moving to Generator")
		else
	
			enteringAI:DoDefault(self.base_ai:GetEntity())
			self.hasUnitGarrisoned = true
		end
	else
		self.unitTactic = nil
		self.hasUnitGarrisoned = false
	end
end

function SlaaneshGeneratorTactic:FindUnitToGarrison()

	local filter = function(ai)
	
		return ( ai:GetSquadName() == "emperors_children_squad_cultist" and not ai:IsLocked() )
	end
	
	local basePosition = self.base_ai:GetPosition()
	
	local squadAI = cpu_manager:GetClosestSquad(basePosition, 80, filter )
	return squadAI
end


function SlaaneshGeneratorTactic:DoReleaseSquad()

	self.base_ai:DoUnload()
	dbAssert(self.unitTactic ~= nil)
		
	self.unitTactic:SetManagedByGenerator(false)
end


function SlaaneshGeneratorTactic:Update()
--[[	
	-- Don't try to garrison passed T2 due to random CTDs
   	if (cpu_manager:GetTierLevel() > 2) then 
		return
	end
]]
	local continue = true 
	if self:GetState() == Tactic.States.Disabled then
		continue = false
	end
	
	if continue and not self.base_ai:IsValid() then
		continue = false
	end

	if not self.base_ai:IsConstructionDone() then 
		continue = false 
	end
	
	if (not continue) then
		return false
	end	
	
	if continue then
		self.state_function( self )
	end

	-- Do not garrison unit until the first 2 minutes
    	if  g_iGMT < 2 * 60 then 
		return true
	end	

	if not self.hasUnitGarrisoned and self.base_ai:GetHealthPercentage() > 0.75 then
		self:DoEnterSquad()
	end
	
	if self.base_ai:GetHealthPercentage() < 0.50 and self.hasUnitGarrisoned then
		self:DoReleaseSquad()
		
		self.hasUnitGarrisoned = false
		self.unitTactic = nil
	end
--[[
	local iHealth = self.base_ai:GetHealthPercentage()
	local iReq = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
	local iPow = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
	if self.hasUnitGarrisoned then
		if iHealth < 0.4 or (iReq < iPow and iPow > 300) or self.base_ai:IsUnderAttack()  then
			self:DoReleaseSquad()
			self.hasUnitGarrisoned = false
			self.unitTactic = nil
		end
	elseif iHealth >= 0.4 and (iReq > iPow and iReq > 300) then
		self:DoEnterSquad()
	end
]]
	return true
end
