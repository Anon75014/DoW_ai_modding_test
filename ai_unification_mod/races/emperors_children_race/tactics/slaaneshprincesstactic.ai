----------------------------------------
-- File: 'slaaneshprincesstactic.ai'
-- Created by Gambit	@ 06.03.2023

class 'SlaaneshPrincessTactic' (EmperorsChildrenInfantryTactic)

SlaaneshPrincess = {}

function SlaaneshPrincessTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Slaanesh Avatar")
end


-- Try not to attack if of low health
function SlaaneshPrincessTactic:IsAttacker()
	if self.squad_ai:GetHealthPercentage() < 0.25 then
		return false
	else
		return true
	end
end


-- Try not to defend if of low health
function SlaaneshPrincessTactic:IsDefender()
	if self.squad_ai:GetHealthPercentage() < 0.25 then
		return false
	else
		return true
	end
end


function SlaaneshPrincessTactic:InitAbilities()

	-- Init ability ID's
	if SlaaneshPrincess.allure_id == nil then
		SlaaneshPrincess.allure_id = cpu_manager.stats:GetAbilityID( "emperors_children_allure_slaanesh" )
		SlaaneshPrincess.heal_id = cpu_manager.stats:GetAbilityID( "emperors_children_emerald_lifeswarm" )
	end
end


function SlaaneshPrincessTactic:DoAbilities()

	-- Check if I can use in-combat abilities 
	if self.squad_ai:IsInCombat() then
		-- First, try to direct spawn the Kakophoni squad
		if (self.squad_ai:CanDirectSpawn()) then 
			self.squad_ai:DoDirectSpawn()
			return
		end

		-- Check if I can use in-combat abilities 
		if self.squad_ai:IsInCombat() then

			if self.squad_ai:CanDoAbility(SlaaneshPrincess.allure_id) then
				if Ability.Filters.CloseCommanderEnemy(self.squad_ai:GetPosition(), 5, 1) ~= nil
				or Ability.Filters.CloseSquadEnemy(self.squad_ai:GetPosition(), 10, 6) ~= nil
				or Ability.Filters.CloseMonsterEnemy(self.squad_ai:GetPosition(), 8, 1) ~= nil then
					self.squad_ai:DoSpecialAbility( SlaaneshPrincess.allure_id )
					return
				end
			end
			-- NOT TESTED!!!
			if self.squad_ai:CanDoAbility(SlaaneshPrincess.heal_id) then
				-- Find: nearby (25) + wounded + non-vehicle + more that 3 members squad. For Commanders apply even for 1 member.
				local oSquad = cpu_manager.cpu_player:FindFirstHurtSquad(self.squad_ai:GetPosition(), 25)
				if oSquad ~= nil and oSquad:GetHealthPercentage() < 0.75 then
					local oStats = oSquad:GetStats()
					local oClass = nil
					if oStats ~= nil then oClass = oStats:GetClass() end
					if oClass ~= nil then
						if oClass == UnitStatsAI.UC_Commander then
							self.squad_ai:DoSpecialAbilitySquad(SlaaneshPrincess.heal_id, oSquad:GetSquad())
						elseif oSquad:GetNumTroopers() > 3 then
							if oClass ~= UnitStatsAI.UC_VehicleLow and oClass ~= UnitStatsAI.UC_VehicleMed
							and oClass ~= UnitStatsAI.UC_VehicleHigh and oClass ~= UnitStatsAI.UC_AirMed
							and oClass ~= UnitStatsAI.UC_MonsterHigh then
								self.squad_ai:DoSpecialAbilitySquad(SlaaneshPrincess.heal_id, oSquad:GetSquad())
							end
						end
					end
				end
			end
		end
	end
end
