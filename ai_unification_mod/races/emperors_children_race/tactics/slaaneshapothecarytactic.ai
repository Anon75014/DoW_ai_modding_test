----------------------------------------
-- File: 'slaaneshapothecarytactic.ai'
-- Edited by Gambit @ 23.07.2018

class 'SlaaneshApothecaryTactic' (EmperorsChildrenInfantryTactic)

SlaaneshApothecary = {}

function SlaaneshApothecaryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Slaanesh Noise Apothecary Tactic")
	
	PrimarisSpawnGlobalTimer = g_iGMT
end


function SlaaneshApothecaryTactic:InitAbilities()

	-- Init ability ID's
	if (SlaaneshApothecary.siren_id == nil) then
		SlaaneshApothecary.siren_id = cpu_manager.stats:GetAbilityID( "emperors_children_doom_siren" )
		SlaaneshApothecary.drugs_id = cpu_manager.stats:GetAbilityID( "emperors_children_combat_drugs" )
	end
end


function SlaaneshApothecaryTactic:DoAbilities()

	-- Check if I can use in-combat abilities 
	if self.squad_ai:IsInCombat() then
		if self.squad_ai:CanDoAbility(SlaaneshApothecary.siren_id) then
			Ability.DoAbilityArea(self.squad_ai, SlaaneshApothecary.siren_id, Ability.Filters.CloseEnemy, 10, 4 )
		end
		if self.squad_ai:CanDoAbility(SlaaneshApothecary.drugs_id) then
			self.squad_ai:DoSpecialAbility(SlaaneshApothecary.drugs_id)
		end
	end

	-- Check if we can gather genes
	local vSquadPos = self.squad_ai:GetPosition()
	if (not self.squad_ai:IsInCombat() and self.squad_ai:IsIdle() and not cpu_manager.terrain_analyzer:HasThreat(vSquadPos, 50)) then
		if self.squad_ai:GetNumCorpses(12) > 0 then
			self.squad_ai:DoCannibalize()
		end
	end

	-- Spawn a primaris squad
	if ( g_iGMT > PrimarisSpawnGlobalTimer + 4 and self.squad_ai:CanDirectSpawn() ) then 
		self.squad_ai:DoDirectSpawn()
		PrimarisSpawnGlobalTimer = g_iGMT
		return
	end
end


function SlaaneshApothecaryTactic:Update()

	if self:IsComplete() then
      		return
   	end
   
	--state machine
	if not InfantryTactic.Update( self ) then
		return
	end

   	--attach to squad
   	self:TryAttachSquad( false, false, 1000, 200, nil )
end
