----------------------------------------
-- File: 'slaaneshnoisemarinetactic.ai'
-- Edited by Thudmeizer	@ 24.07.2018

class 'SlaaneshNoiseMarineTactic' (EmperorsChildrenInfantryTactic)

SlaaneshNoiseMarine = {}

function SlaaneshNoiseMarineTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Slaanesh Noise Marine Tactic")
	self.harmonicsTMR = g_iGMT
end

function SlaaneshNoiseMarineTactic:InitAbilities()

	-- Init ability ID's
	if SlaaneshNoiseMarine.combatdrugs_id == nil then
		SlaaneshNoiseMarine.combatdrugs_id = cpu_manager.stats:GetAbilityID( "emperors_children_combat_drugs" )	
		SlaaneshNoiseMarine.siren_id = cpu_manager.stats:GetAbilityID( "emperors_children_doom_siren" )	
		SlaaneshNoiseMarine.harmonics_id = cpu_manager.stats:GetAbilityID( "emperors_children_harmonics" )
		SlaaneshNoiseMarine.flamers_id = cpu_manager.stats:GetAbilityID( "emperors_children_harmonics_flamers" )
		SlaaneshNoiseMarine.bombing_id = cpu_manager.stats:GetAbilityID( "emperors_children_strafing_run" )
	end
end

function SlaaneshNoiseMarineTactic:DoAbilities()

	-- Check if I can use in-combat abilities 
	if self.squad_ai:IsInCombat() then

		-- Use siren
		if self.squad_ai:CanDoAbility(SlaaneshNoiseMarine.siren_id) then
			Ability.DoAbilityArea(self.squad_ai, SlaaneshNoiseMarine.siren_id, Ability.Filters.CloseEnemy, 10, 4 )
		end
	
		-- Use combat drugs
		if self.squad_ai:CanDoAbility(SlaaneshNoiseMarine.combatdrugs_id) then
			self.squad_ai:DoSpecialAbility( SlaaneshNoiseMarine.combatdrugs_id )
		end
		
		-- Use the alternate firing mode 1
		if g_iGMT > self.harmonicsTMR + 30 and self.squad_ai:CanDoAbility(SlaaneshNoiseMarine.harmonics_id)
		and not self:IsMoving() then
			local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
			if iPower > 350 then
				local iTarget = Ability.Filters.CloseVehicleEnemy(self.squad_ai:GetPosition(), 30, 1)
				if iTarget ~= nil then
					self.squad_ai:DoSpecialAbility(SlaaneshNoiseMarine.harmonics_id)
					self.harmonicsTMR = g_iGMT
					return
				end
			end
		end
		-- Use the alternate firing mode 2
		if g_iGMT > self.harmonicsTMR + 30 and self.squad_ai:CanDoAbility(SlaaneshNoiseMarine.flamers_id) then
			local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
			if iPower > 350 then
				local iTarget = Ability.Filters.CloseInfantryEnemy(self.squad_ai:GetPosition(), 30, 8)
				if iTarget ~= nil then
					self.squad_ai:DoSpecialAbility(SlaaneshNoiseMarine.flamers_id)
					self.harmonicsTMR = g_iGMT
				end
			end
		end

		-- For Palatines, use bombing run
		if self.squad_ai:CanDoAbility(SlaaneshNoiseMarine.bombing_id) then
			Ability.DoAbilityPos(self.squad_ai, SlaaneshNoiseMarine.bombing_id, Ability.Filters.CloseEnemy, 6 ) 
		end
	end

    self:DoThrowGrenades()
end
