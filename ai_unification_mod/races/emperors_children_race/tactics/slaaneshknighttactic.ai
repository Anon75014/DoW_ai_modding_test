----------------------------------------
-- File: 'slaaneshknighttactic.ai'
-- Edited by Gambit   @ 31.08.2025

class 'SlaaneshKnightTactic' (EmperorsChildrenVehicleTactic)

SlaaneshKnight = {}

function SlaaneshKnightTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Slaanesh Knight Tactic")
	
	self.KnightR_Upgrade = math.random( 1, 6 )	  	-- In case of 1, do not upgrade the R weapon
	self.KnightR_Choice = math.random( 0, 6 )	  	-- 0: Chaingun,  1:Thermal Cannon,  2: Las Impolsor, 3: Lightning Cannon, 4: Plasma Cannon,  5: Volkite Chieorovile,  6: Chainsword
	self.KnightL_Upgrade = math.random( 1, 3 )	  	-- In case of 1, do not upgrade the L weapon
	self.KnightL_Choice = 7				  	-- 7: Chaingun
	if math.random( 1, 2 ) == 1 then self.KnightL_Choice = 12 end -- 13: Lightning Claw (patched later)
	self.KnightAcc_Choice = math.random( 8, 9 )  		-- 8: Melta Gun  9: Grav Gun
	self.KnightTop_Choice = math.random( 10, 11 ) 		-- 10: Quad Autocannon  11: Missile Launcher
	self.KnightOther_Choice = math.random( 12, 13 ) 	-- 12: Flamestorm  13: Blastmaster
	self.lastAddonTry = g_iGMT
end


function SlaaneshKnightTactic:AutoBuildAddOn( addonSlot )
	for e in self.squad_ai:GetEntities() do
		local buildChannel = build_manager:GetBuildChannelFromID(e:GetID())
		if buildChannel ~= nil then
			local addOnID = buildChannel:GetItemIDAt(BuildChannelAI.PQ_AddOn, addonSlot)
			if (buildChannel:IsBuilding() == 0 and buildChannel:CanAddToQueue(BuildChannelAI.PQ_AddOn, addOnID) == BuildChannelAI.CANBUILD_Ok) then
				buildChannel:BuildAddOn(addOnID)
				return
			end
		end
	end
	return
end


function SlaaneshKnightTactic:AlwaysAttack()
	return true
end

function SlaaneshKnightTactic:InitAbilities()

	-- Init ability ID's
	if SlaaneshKnight.shield_id == nil then
		SlaaneshKnight.shield_id = cpu_manager.stats:GetAbilityID( "emperors_children_knight_ion_shield" )	
	end
end

function SlaaneshKnightTactic:DoAbilities()

	if self.squad_ai:IsInCombat() and self.squad_ai:WasRecentlyHurt() then
		if self.squad_ai:CanDoAbility(SlaaneshKnight.shield_id) and self.squad_ai:GetHealthPercentage() < 0.4 then
			self.squad_ai:DoSpecialAbility(SlaaneshKnight.shield_id)
		end
	end

	-- Check to addon every 10+ secs
	if g_iGMT > self.lastAddonTry + 10 then
		self.lastAddonTry = g_iGMT
		-- Check available resources and health, before performing any upgrade
		local iReq = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
		local iPow = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
		if iReq > 300 and iPow > 300 and self.squad_ai:GetHealthPercentage() > 0.35 then
			if self.KnightR_Upgrade ~= 1 then self:AutoBuildAddOn(self.KnightR_Choice) end
			if self.KnightL_Upgrade ~= 1 then self:AutoBuildAddOn(self.KnightL_Choice) end
			self:AutoBuildAddOn(self.KnightAcc_Choice)
			self:AutoBuildAddOn(self.KnightTop_Choice)
			self:AutoBuildAddOn(self.KnightOther_Choice)
		end
	end
end
