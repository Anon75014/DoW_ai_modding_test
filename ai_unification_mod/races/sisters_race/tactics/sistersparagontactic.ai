----------------------------------------
-- File: 'sistersparagontactic.ai'
-- Edited by Thudmeizer @ 22.03.2008

class 'SistersParagonTactic' (SistersInfantryTactic)

SistersParagon = {}

function SistersParagonTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Sisters Paragon Tactic")
	self.i_ReinforceType = math.random( 1,4 )
	-- 1: Melee / 2: Ranged / 3-4: Mixed
end


function SistersParagonTactic:InitAbilities()

end


function SistersParagonTactic:DoAbilities()

	SistersInfantryTactic.DoAbilities(self)
end


function SistersParagonTactic:Reinforce()

	-- Check if we are reinforcing
	if (not self.squad_ai:IsReinforcing()) then

		-- try for different types of squad members
		local melee1Index = 0
		local melee2Index = 1
		local rangd1Index = 2
		local rangd2Index = 3

		-- Desired number of each leader type
		local desiredmelee1 = 0
		local desiredmelee2 = 0
		local desiredrangd1 = 0
		local desiredrangd2 = 0

		if self.i_ReinforceType == 1 then
			desiredmelee1 = 2
			desiredmelee2 = 2
		elseif self.i_ReinforceType == 2 then
			desiredrangd1 = 2
			desiredrangd2 = 2
		else
			desiredmelee1 = 1
			desiredmelee2 = 1
			desiredrangd1 = 1
			desiredrangd2 = 1
		end

		-- Desired order of reinforcing
		if (self.squad_ai:GetLeaderCount( melee1Index ) < desiredmelee1) then
			if (self.squad_ai:CanReinforce( true, melee1Index )) then
				self.squad_ai:DoReinforce( true, melee1Index )
			end
		elseif (self.squad_ai:GetLeaderCount( melee2Index ) < desiredmelee2) then
			if (self.squad_ai:CanReinforce( true, melee2Index )) then
				self.squad_ai:DoReinforce( true, melee2Index )
			end
		elseif (self.squad_ai:GetLeaderCount( rangd1Index ) < desiredrangd1) then
			if (self.squad_ai:CanReinforce( true, rangd1Index )) then
				self.squad_ai:DoReinforce( true, rangd1Index )
			end
		elseif (self.squad_ai:GetLeaderCount( rangd2Index ) < desiredrangd2) then
			if (self.squad_ai:CanReinforce( true, rangd2Index )) then
				self.squad_ai:DoReinforce( true, rangd2Index )
			end
		else
			if (self.squad_ai:CanReinforce( false, 0 )) then
				self.squad_ai:DoReinforce( false, 0 )
			end			
		end
	end
end


function SistersParagonTactic:Update()

	-- State machine
	if not Tactic.Update( self ) then
		return false
	end
	
	if self.squad_ai:CanJump() then
		self.tolerance_default = self.squad_ai:GetJumpDistance()
	else
		self.tolerance_default = 100
	end
	
	-- Update commander attach/detach health
	local iSupportCap = build_manager:GetSupportCapCurrentMax() - build_manager:GetSupportCapLeft()
	if (iSupportCap >= 4) then
		self.m_fCommanderAttachHealth = 0.3
	else
		self.m_fCommanderAttachHealth = 0.1
	end
	
	-- Upgrade weapons (GAMBIT: Not needed)
	-- self:Upgrade()
	
	-- Reinforce squads
	self:Reinforce()
	
	self:SyncSubState()
	
	self:CheckForBroken()
	
	-- If not already in substate
	if (self.stateID == Tactic.StateID.NoState) then
	   
		-- Check dance mode
		if (CpuManager.AISettings.iDancing == 2) then
		 	self:CheckForDeath()
			if (self.stateID == Tactic.StateID.NoState) then
				self:CheckForDance()
				if (self.stateID == Tactic.StateID.NoState) then
					self:CheckForStealthTroops()
				end
			end
		elseif (CpuManager.AISettings.iDancing == 1 and g_iGMT > self.m_iDancing + 10) then
			self:CheckForDeath()
			if (self.stateID == Tactic.StateID.NoState) then
				self:CheckForDance()
				if (self.stateID == Tactic.StateID.NoState) then
					self:CheckForStealthTroops()
				end
			end
		end
	end
	
	if (cpu_manager.assassinate and self.stateID == Tactic.StateID.NoState) then
	
		for i in self.commander do
		
			if self.squad_ai:HasSquadAttached( self.commander[i][1] ) and self.commander[i][2] then
				
				--if I'm nearly dead, run away
				if self.squad_ai:GetAttachedHealthPercentage() < 0.7 then
				   self.squad_ai:DoMoveToClosestSafePoint( self.safe_point, self.tolerance )
				end
				return
			end
		end
	end
	
	if (self.squad_ai:IsAttached()) then
		self:CheckForDetach()
	end
	
	-- Special moves
	self:CloseOnEnemy()
	
	-- Do abilities
	self:InitAbilities()
	self:DoAbilities()
	
	-- Check stance (GAMBIT: Updated)
	-- Check if I have setup time
	if self.i_ReinforceType ~= nil and (self.i_ReinforceType == 1 or self.i_ReinforceType == 2) then
		if self.squad_ai:GetStance() ~= SquadAI.STANCE_Attack then
			self.squad_ai:DoSetStance( SquadAI.STANCE_Attack )
		end
	elseif self.squad_ai:GetStance() ~= SquadAI.STANCE_StandGround then
		self.squad_ai:DoSetStance( SquadAI.STANCE_StandGround )
	end
	
	-- Return success
	return true
end


