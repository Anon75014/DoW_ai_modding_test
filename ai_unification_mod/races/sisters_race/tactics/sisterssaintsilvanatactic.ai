----------------------------------------
-- File: 'sisterssaintsilvanatactic.ai'
-- Edited by Gambit 	@ 27.06.2021
-- Edited by Thudmeizer @ 27.08.2025

class 'SistersSaintSilvanaTactic' (SistersInfantryTactic)

SistersUnitSaint = {}

function SistersSaintSilvanaTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Sisters Saint Silvana/Mina/Sabbat Tactic")
	
	self.m_iTransportable = 1
end

function SistersSaintSilvanaTactic:InitAbilities()
	-- Init ability ID's
	if SistersUnitSaint.sabbat_voice_id == nil then
		SistersUnitSaint.sabbat_voice_id = cpu_manager.stats:GetAbilityID( "sisters_sabbat_voice_of_command" )
	end

	if SistersUnitSaint.silvana_strike_id == nil then
		SistersUnitSaint.silvana_strike_id = cpu_manager.stats:GetAbilityID( "sisters_silvana_lightning_strike_passive" )
	end
end

function SistersSaintSilvanaTactic:DoAbilities()

	-- Try to always have it in use
	if self.squad_ai:CanDoAbility(SistersUnitSaint.sabbat_voice_id) then
		-- Search a squad
		local iRange = self.squad_ai:GetAbilityRange(SistersUnitSaint.sabbat_voice_id)
		
		local oFunctor = function(oSquad, iCount)
			local oStats = oSquad:GetStats()
			if (oStats == nil) then
				return false
			end
			local oClass = oStats:GetClass()
			local is_infantry = (oClass == UnitStatsAI.UC_LightInfantryMed or oClass == UnitStatsAI.UC_LightInfantryHigh
							  or oClass == UnitStatsAI.UC_HeavyInfantryMed or oClass == UnitStatsAI.UC_HeavyInfantryHigh)
			return is_infantry and oSquad:GetNumTroopers() >= iCount
		end
		local oUnit = cpu_manager:GetClosestSquad(self.squad_ai:GetPosition(), iRange, oFunctor, 6)
		if oUnit ~= nil and oUnit:IsValid() then
			self.squad_ai:DoSpecialAbilitySquad(SistersUnitSaint.sabbat_voice_id, oUnit:GetSquad())
			return
		end
	end

	if self.squad_ai:IsInCombat() and self.squad_ai:CanDoAbility(SistersUnitSaint.silvana_strike_id) then
		if  resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Power) > 200
		and resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Requisition) > 200 then
			local iRange = self.squad_ai:GetAbilityRange(SistersUnitSaint.silvana_strike_id)
			local iPos = self.squad_ai:GetPosition()
			local oSquad = Ability.Filters.CloseVehicleHighEnemy( iPos , iRange, 1 )
			if oSquad == nil then
				oSquad = Ability.Filters.CloseVehicleEnemy( iPos , iRange, 1 )
			end
			if oSquad ~= nil and oSquad:IsValid() then
				self.squad_ai:DoSpecialAbilitySquad(SistersUnitSaint.silvana_strike_id, oSquad:GetSquad())
				return
			end
		end
	end

	-- New code to unstuck units with pathing issues, that can jump.
	-- Call it with [true], only for multi-membered squads.
	self:SolveStuckCase(false)
end
