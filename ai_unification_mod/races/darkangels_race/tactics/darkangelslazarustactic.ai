----------------------------------------
-- File: 'darkangelslazarustactic.ai'
-- Edited by Gambit @ 14.07.2020

class 'DarkAngelsLazarusTactic' (DarkAngelsInfantryTactic)

DarkAngelsLazarus = {}

function DarkAngelsLazarusTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Dark Angels Lasarus Tactic")
end

-- Assassinate win condition -- never attack
function DarkAngelsLazarusTactic:IsAttacker()
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

-- Assassinate win condition -- never defend
function DarkAngelsLazarusTactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end


function DarkAngelsLazarusTactic:InitAbilities()
	if DarkAngelsLazarus.daemonic_defender == nil then
		DarkAngelsLazarus.daemonic_defender = cpu_manager.stats:GetAbilityID("darkangels_lazarus_daemonic_defender")
		DarkAngelsLazarus.orbital_bombardment = cpu_manager.stats:GetAbilityID("darkangels_orbital_bombardment")
	end
end


function DarkAngelsLazarusTactic:DoAbilities()
	if self.squad_ai:IsInCombat() or self.squad_ai:IsAttacking()  then
		if self.squad_ai:CanDoAbility(DarkAngelsLazarus.orbital_bombardment) then
			Ability.DoAbilityPos(self.squad_ai, DarkAngelsLazarus.orbital_bombardment, Ability.Filters.CloseEnemy, 24)
			Ability.DoAbilityPos(self.squad_ai, DarkAngelsLazarus.orbital_bombardment, Ability.EntityFilters.CloseBaseEntityEnemy, 3)
		end
		if self.squad_ai:CanDoAbility(DarkAngelsLazarus.daemonic_defender) then
			if Ability.Filters.CloseMonsterEnemy(self.squad_ai:GetPosition(), 18) ~= nil then
				Ability.DoAbility(self.squad_ai, DarkAngelsLazarus.daemonic_defender)
			end
		end
	end
end


function DarkAngelsLazarusTactic:CheckForBroken()

	if (self.squad_ai:IsBroken()) then
	
		-- Check if I can repair my morale
		local grandmasterrally_id = cpu_manager.stats:GetAbilityID( "darkangels_rally" )
		if (self.squad_ai:CanDoAbility( grandmasterrally_id )) then
			self.squad_ai:DoSpecialAbility( grandmasterrally_id )
		end
	end
	
	-- Call basic broken check method
	InfantryTactic.CheckForBroken(self)
end


function DarkAngelsLazarusTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Assassinate win condition -- never attach to a squad
	if (not cpu_manager.assassinate) then
		
		-- Attach to melee in tier3+
		if (cpu_manager:GetTierLevel() > 2) then
		
			if (self:TryAttachSquad(true, true, 50, 100, nil) ~= nil) then
				return
			end
		end
		if (self:TryAttachSquad(false, true, 50, 100, self.m_fCommanderAttachHealth) == nil) then
			self:TryAttachSquadMelee()
		end
	end
end