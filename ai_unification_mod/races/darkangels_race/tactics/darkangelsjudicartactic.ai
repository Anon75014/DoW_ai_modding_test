----------------------------------------
-- File: 'darkangelsjudicartactic.ai'
-- Edited by Thudmeizer @ 06.06.2018

class 'DarkAngelsJudicarTactic' (DarkAngelsInfantryTactic)

DarkAngelsJudicar = {}

function DarkAngelsJudicarTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Dark Angels Judicar Tactic")
end

function DarkAngelsJudicarTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function DarkAngelsJudicarTactic:IsDefender()
	return self:IsCommanderDefender()
end


function DarkAngelsJudicarTactic:InitAbilities()
	if DarkAngelsJudicar.blade_strike == nil then
		DarkAngelsJudicar.blade_strike = cpu_manager.stats:GetAbilityID("darkangels_executioners_blade")
		DarkAngelsJudicar.tempormortis = cpu_manager.stats:GetAbilityID("darkangels_tempormortis")
		DarkAngelsJudicar.frag_id = cpu_manager.stats:GetAbilityID( "darkangels_frag_grenades_judicar" )
		DarkAngelsJudicar.krak_id = cpu_manager.stats:GetAbilityID( "darkangels_krak_grenades_judicar" )
	end
end


function DarkAngelsJudicarTactic:DoAbilities()
	if self.squad_ai:IsInCombat() then
		if self.squad_ai:CanDoAbility(DarkAngelsJudicar.blade_strike) then
			if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsJudicar.blade_strike, Ability.Filters.CloseCommanderEnemy, 1 ) then
				return
			end
		end

		if self.squad_ai:CanDoAbility(DarkAngelsJudicar.tempormortis) then
			local oEnemyCommander = Ability.Filters.CloseCommanderEnemy(self.squad_ai:GetPosition(), 20, 1)
			if oEnemyCommander ~= nil then
				self.squad_ai:DoSpecialAbility(DarkAngelsJudicar.tempormortis)
				return
			end
		end

        if self.squad_ai:CanDoAbility(DarkAngelsJudicar.frag_id) then
            if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsJudicar.frag_id, Ability.Filters.CloseCommanderEnemy, 1 ) 
            or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsJudicar.frag_id, Ability.Filters.CloseSquadEnemy, 4 )
			then
				return
            end
        end
    
        if self.squad_ai:CanDoAbility(DarkAngelsJudicar.krak_id) then
            if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsJudicar.krak_id, Ability.Filters.CloseVehicleEnemy, 1 )
            or Ability.DoAbilityTargetEntity( self.squad_ai, DarkAngelsJudicar.krak_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
            then end
        end
	end
end


function DarkAngelsJudicarTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update(self)) then
		return
	end
	
	-- Attach to melee in tier2+
	if (cpu_manager:GetTierLevel() > 1) then
	
		if (self:TryAttachSquad(true, true, 50, 100, nil) ~= nil) then
			return
		end
	end
	if (self:TryAttachSquad(false, true, 50, 100, self.m_fCommanderAttachHealth) == nil) then
		self:TryAttachSquadMelee()
	end
end

