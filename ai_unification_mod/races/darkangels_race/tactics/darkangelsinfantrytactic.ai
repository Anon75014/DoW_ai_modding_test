----------------------------------------
-- File: 'darkangelsinfantrytactic.ai'
-- Edited by Thudmeizer         @ 11.04.2023

class 'DarkAngelsInfantryTactic' (InfantryTactic)

DarkAngelsInfantryAbility =
{
	-- Infantry
    	FragBombID = cpu_manager.stats:GetAbilityID("darkangels_frag_grenades")
    	,KrakBombID = cpu_manager.stats:GetAbilityID("darkangels_krak_grenades")
    	,MeltaBombID = cpu_manager.stats:GetAbilityID("darkangels_melta_bombs")
	
	-- Grand Master, Deathwing Champion, Azrael
   	 ,OrbitalBombardmentID = cpu_manager.stats:GetAbilityID("darkangels_orbital_bombardment")

	-- Belial, Azrael
    	,BattlecryID = cpu_manager.stats:GetAbilityID("darkangels_battlecry")
    	,BattlecryAID = cpu_manager.stats:GetAbilityID("darkangels_battlecry_belial")
    	,BattlecryBID = cpu_manager.stats:GetAbilityID("darkangels_battlecry_champion")
    	,HuntFallenID = cpu_manager.stats:GetAbilityID("darkangels_hunt_the_fallen_commander")
    	,HuntFallenBID = cpu_manager.stats:GetAbilityID("darkangels_hunt_the_fallen_sammael")

	-- Chaplains
	,DemoralizeID = cpu_manager.stats:GetAbilityID("darkangels_demoralize")
	,HuntFallenAID = cpu_manager.stats:GetAbilityID("darkangels_hunt_the_fallen")

	-- Librarians
	,HellfireID = cpu_manager.stats:GetAbilityID("darkangels_hellfire")
	,ForceBarrierID = cpu_manager.stats:GetAbilityID("darkangels_force_barrier")
	,MindWormID = cpu_manager.stats:GetAbilityID("darkangels_mind_worm")
	,MindWormID2 = cpu_manager.stats:GetAbilityID("darkangels_mind_worm_termi")

	-- Ravenwing Masters
	,StrafingRunID = cpu_manager.stats:GetAbilityID("darkangels_ravenwing_strafing_run")
	,StrafingRunAID = cpu_manager.stats:GetAbilityID("darkangels_ravenwing_strafing_run_2")

}

function DarkAngelsInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Dark Angels Infantry Tactic")
	
	-- All squads are transportable
	local sSquadName = squad_ai:GetSquadName()
	if (sSquadName == "da_squad_scout" or
		sSquadName == "da_squad_tactical" or
		sSquadName == "da_squad_devastator" or
		sSquadName == "da_squad_primaris_hellblaster" or
		sSquadName == "da_squad_veteran_tactical" or
		sSquadName == "da_squad_veteran_assault" or
		sSquadName == "da_squad_command_squad" or
		sSquadName == "da_squad_grand_master" or
		sSquadName == "da_squad_hero_lazarus_master" or
		sSquadName == "da_squad_banner_bearer" or
		sSquadName == "da_squad_apothecary" or
		sSquadName == "da_squad_apothecary_battle_company" or
		sSquadName == "da_squad_techmarine" or
		sSquadName == "da_squad_chaplain" or
		sSquadName == "da_squad_librarian" or
		sSquadName == "da_squad_hero_azrael_master" or
		sSquadName == "da_squad_hero_asmodai_chaplain" or
		sSquadName == "da_squad_hero_ezekiel_librarian") then

			-- Squads are transportable 
			self.m_iTransportable = 1	-- Rhino
			--self.m_iTransportable = 2	-- Razorback
			--self.m_iTransportable = 3	-- Thunderhawk
			--self.m_iTransportable = 4	-- LR Solemnus (DW)
			
			-- Squads are able to Deep Strike
			self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("darkangels_hero_building")

	elseif (sSquadName == "da_squad_hero_belial_deathwing" or
			sSquadName == "da_squad_deathwing_master" or
			sSquadName == "da_squad_apothecary_terminator" or
			sSquadName == "da_squad_banner_bearer_terminator" or
			sSquadName == "da_squad_librarian_terminator" or
			sSquadName == "da_squad_chaplain_terminator" or
			sSquadName == "da_squad_deathwing_terminators_kill_team" or
			sSquadName == "da_squad_deathwing_terminator_knight" or
			sSquadName == "da_squad_deathwing_terminator" or
			sSquadName == "da_squad_deathwing_terminator_assault") then

		-- Squads are transportable 
		self.m_iTransportable = 4	-- LR Solemnus (DW)

		-- Squads are transportable and able to deepstrike	
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("darkangels_orbital_relay")
	end

    self.fragBombLastUse = g_iGMT
    self.krakBombLastUse = g_iGMT
    self.meltaBombLastUse = g_iGMT
    self.orbitalBombardmentLastUse = g_iGMT
    self.battlecryLastUse = g_iGMT
    self.battlecryALastUse = g_iGMT
    self.battlecryBLastUse = g_iGMT
    self.demoralizeLastUse = g_iGMT
    self.huntFallenLastUse = g_iGMT
    self.huntFallenALastUse = g_iGMT
    self.huntFallenBLastUse = g_iGMT
    self.hellfireLastUse = g_iGMT
    self.forceBarrierLastUse = g_iGMT
    self.mindWormLastUse = g_iGMT
    self.strafingRunLastUse = g_iGMT
    self.strafingRunALastUse = g_iGMT
end

function DarkAngelsInfantryTactic:AddTargetAbilities()

end

function DarkAngelsInfantryTactic:AddCommanders()
	table.insert(self.commander, { "da_squad_grand_master", true })
	table.insert(self.commander, { "da_squad_hero_lazarus_master", false })
	table.insert(self.commander, { "da_squad_deathwing_master", false })
	table.insert(self.commander, { "da_squad_hero_azrael_master", false })
	table.insert(self.commander, { "da_squad_hero_asmodai_chaplain", false })
	table.insert(self.commander, { "da_squad_hero_ezekiel_librarian", false })
	table.insert(self.commander, { "da_squad_hero_belial_deathwing", false })
	table.insert(self.commander, { "da_squad_hero_sammael_ravenwing", false })
	table.insert(self.commander, { "da_squad_primaris_judicar", false })
	table.insert(self.commander, { "da_squad_librarian", false })
	table.insert(self.commander, { "da_squad_librarian_terminator", false })
	table.insert(self.commander, { "da_squad_ravenwing_librarian", false })
	table.insert(self.commander, { "da_squad_chaplain", false })
	table.insert(self.commander, { "da_squad_ravenwing_chaplain", false })
	table.insert(self.commander, { "da_squad_chaplain_terminator", false })
	table.insert(self.commander, { "da_squad_apothecary", false })
	table.insert(self.commander, { "da_squad_apothecary_terminator", false })
	table.insert(self.commander, { "da_squad_ravenwing_apothecary", false })
	table.insert(self.commander, { "da_squad_apothecary_battle_company", false })
	table.insert(self.commander, { "da_squad_banner_bearer", false })
	table.insert(self.commander, { "da_squad_banner_bearer_terminator", false })
	table.insert(self.commander, { "da_squad_ravenwing_banner_bearer", false })
end

function DarkAngelsInfantryTactic:DoAbilities()

	-- I might have these attached
	if (self.squad_ai:IsAttached()) then
		if (self.squad_ai:HasSquadAttached("da_squad_grand_master")) then
			DarkAngelsGrandMasterTactic.InitAbilities( self )
			DarkAngelsGrandMasterTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_hero_lazarus_master")) then
			DarkAngelsLazarusTactic.InitAbilities( self )
			DarkAngelsLazarusTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_deathwing_master")) then
			DarkAngelsDeathwingChampionTactic.InitAbilities( self )
			DarkAngelsDeathwingChampionTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_hero_azrael_master")) then
			DarkAngelsSupremeGrandMasterTactic.InitAbilities( self )
			DarkAngelsSupremeGrandMasterTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_hero_ezekiel_librarian")) then
			DarkAngelsEzekielTactic.InitAbilities( self )
			DarkAngelsEzekielTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_hero_belial_deathwing")) then
			DarkAngelsBelialTactic.InitAbilities( self )
			DarkAngelsBelialTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_hero_asmodai_chaplain")) then
			DarkAngelsAsmodaiTactic.InitAbilities( self )
			DarkAngelsAsmodaiTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_librarian")) then
			DarkAngelsLibrarianTactic.InitAbilities( self )
			DarkAngelsLibrarianTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_librarian_terminator")) then
			DarkAngelsLibrarianTerminatorTactic.InitAbilities( self )
			DarkAngelsLibrarianTerminatorTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_ravenwing_librarian")) then
			DarkAngelsLibrarianBikeTactic.InitAbilities( self )
			DarkAngelsLibrarianBikeTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_chaplain")) then
			DarkAngelsChaplainTactic.InitAbilities( self )
			DarkAngelsChaplainTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_ravenwing_chaplain")) then
			DarkAngelsChaplainBikeTactic.InitAbilities( self )
			DarkAngelsChaplainBikeTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_chaplain_terminator")) then
			DarkAngelsChaplainTerminatorTactic.InitAbilities( self )
			DarkAngelsChaplainTerminatorTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("da_squad_primaris_judicar")) then
			DarkAngelsJudicarTactic.InitAbilities( self )
			DarkAngelsJudicarTactic.DoAbilities( self )
		end
	end

    self:DoThrowGrenades()
    self:DoStrafingRun()
    self:DoOrbitalBombardment()
    self:DoBattlecry()
    self:DoHuntTheFallen()
    self:DoDemoralize()
    self:DoLibrarianAttacks()
	
	-- Call basic DoAbilities methods
	InfantryTactic.DoAbilities(self)
end

function DarkAngelsInfantryTactic:DoThrowGrenades()

    if self.squad_ai:IsInCombat() then
        
        if ( g_iGMT > self.fragBombLastUse + 30 ) then
            if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.FragBombID, Ability.Filters.CloseCommanderEnemy, 1 ) 
            or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.FragBombID, Ability.Filters.CloseSquadEnemy, 4 )
            then
                self.fragBombLastUse = g_iGMT 
            end
        end
    
        if ( g_iGMT > self.krakBombLastUse + 30 ) then
            if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.KrakBombID, Ability.Filters.CloseVehicleEnemy, 1 )
            or Ability.DoAbilityTargetEntity( self.squad_ai, DarkAngelsInfantryAbility.KrakBombID, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
            then
                self.krakBombLastUse = g_iGMT             
            end
        end

        if ( g_iGMT > self.meltaBombLastUse + 65 ) then        
            if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.MeltaBombID, Ability.Filters.CloseVehicleEnemy, 1 )
            or Ability.DoAbilityTargetEntity( self.squad_ai, DarkAngelsInfantryAbility.MeltaBombID, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
            then
                self.meltaBombLastUse = g_iGMT
            end
        end
    end
end

function DarkAngelsInfantryTactic:DoOrbitalBombardment()

    if self.squad_ai:IsInCombat() then

        if ( g_iGMT > self.orbitalBombardmentLastUse + 30 ) then
            if Ability.DoAbilityPos( self.squad_ai, DarkAngelsInfantryAbility.OrbitalBombardmentID, Ability.Filters.CloseEnemy, 24 )
            or Ability.DoAbilityPos( self.squad_ai, DarkAngelsInfantryAbility.OrbitalBombardmentID, Ability.EntityFilters.CloseBaseEntityEnemy, 3 )
            then
                self.orbitalBombardmentLastUse = g_iGMT 
            end
        end
    end
end

function DarkAngelsInfantryTactic:DoBattlecry()

    if self.squad_ai:IsInCombat() then

        if ( g_iGMT > self.battlecryLastUse + 30 ) then
            if Ability.DoAbilityArea( self.squad_ai, DarkAngelsInfantryAbility.BattlecryID, Ability.Filters.CloseEnemy, 10, 1 )
            then
                self.battlecryLastUse = g_iGMT 
            end
        end

        if ( g_iGMT > self.battlecryALastUse + 30 ) then
            if Ability.DoAbilityArea( self.squad_ai, DarkAngelsInfantryAbility.BattlecryAID, Ability.Filters.CloseEnemy, 10, 1 )
            then
                self.battlecryALastUse = g_iGMT 
            end
        end

        if ( g_iGMT > self.battlecryBLastUse + 30 ) then
            if Ability.DoAbilityArea( self.squad_ai, DarkAngelsInfantryAbility.BattlecryBID, Ability.Filters.CloseEnemy, 10, 1 )
            then
                self.battlecryBLastUse = g_iGMT 
            end
        end
    end
end

function DarkAngelsInfantryTactic:DoHuntTheFallen()

    if self.squad_ai:IsInCombat() then

        if ( g_iGMT > self.huntFallenLastUse + 30 ) then
            if Ability.DoAbilityArea( self.squad_ai, DarkAngelsInfantryAbility.HuntFallenID, Ability.Filters.CloseEnemy, 10, 5 )
            then
                self.huntFallenLastUse = g_iGMT 
            end
        end

        if ( g_iGMT > self.huntFallenALastUse + 30 ) then
            if Ability.DoAbilityArea( self.squad_ai, DarkAngelsInfantryAbility.HuntFallenAID, Ability.Filters.CloseEnemy, 10, 1 )
            then
                self.huntFallenALastUse = g_iGMT 
            end
        end

        if ( g_iGMT > self.huntFallenBLastUse + 30 ) then
            if Ability.DoAbilityArea( self.squad_ai, DarkAngelsInfantryAbility.HuntFallenBID, Ability.Filters.CloseEnemy, 10, 1 )
            then
                self.huntFallenBLastUse = g_iGMT 
            end
        end
    end
end

function DarkAngelsInfantryTactic:DoDemoralize()

    if self.squad_ai:IsInCombat() then

        if ( g_iGMT > self.demoralizeLastUse + 30 ) then
            if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.DemoralizeID, Ability.Filters.CloseSquadEnemy, 1 )
            or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.DemoralizeID, Ability.Filters.CloseCommanderEnemy, 1 ) 
            or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.DemoralizeID, Ability.Filters.CloseMonsterEnemy, 1 )
            then
                self.demoralizeLastUse = g_iGMT 
            end
        end
    end
end

function DarkAngelsInfantryTactic:DoLibrarianAttacks()

    if self.squad_ai:IsInCombat() then

        if ( g_iGMT > self.hellfireLastUse + 30 ) then
            if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.HellfireID, Ability.Filters.CloseSquadEnemy, 1 )
            or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.HellfireID, Ability.Filters.CloseCommanderEnemy, 1 ) 
            or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.HellfireID, Ability.Filters.CloseMonsterEnemy, 1 )
            then
                self.hellfireLastUse = g_iGMT 
            end
        end

        if ( g_iGMT > self.forceBarrierLastUse + 30 ) then
            if Ability.DoAbilityArea( self.squad_ai, DarkAngelsInfantryAbility.ForceBarrierID, Ability.Filters.CloseEnemy, 15, 1 )
            then
                self.forceBarrierLastUse = g_iGMT 
            end
        end

		if self.squad_ai:CanDoAbility(DarkAngelsInfantryAbility.MindWormID) then
			if ( g_iGMT > self.mindWormLastUse + 30 ) then
				if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.MindWormID, Ability.Filters.CloseSquadEnemy, 1 )
				or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.MindWormID, Ability.Filters.CloseCommanderEnemy, 1 ) 
				or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.MindWormID, Ability.Filters.CloseMonsterEnemy, 1 )
				then
					self.mindWormLastUse = g_iGMT 
				end
			end
		elseif self.squad_ai:CanDoAbility(DarkAngelsInfantryAbility.MindWormID2) then
			if ( g_iGMT > self.mindWormLastUse + 30 ) then
				if Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.MindWormID2, Ability.Filters.CloseSquadEnemy, 1 )
				or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.MindWormID2, Ability.Filters.CloseCommanderEnemy, 1 ) 
				or Ability.DoAbilityTarget( self.squad_ai, DarkAngelsInfantryAbility.MindWormID2, Ability.Filters.CloseMonsterEnemy, 1 )
				then
					self.mindWormLastUse = g_iGMT 
				end
			end
        end
    end
end

function DarkAngelsInfantryTactic:DoStrafingRun()

    if self.squad_ai:IsInCombat() then

        if ( g_iGMT > self.strafingRunLastUse + 30 ) then
            if Ability.DoAbilityPos( self.squad_ai, DarkAngelsInfantryAbility.StrafingRunID, Ability.Filters.CloseEnemy, 9 )
            then
                self.strafingRunLastUse = g_iGMT 
            end
        end

        if ( g_iGMT > self.strafingRunALastUse + 30 ) then
            if Ability.DoAbilityPos( self.squad_ai, DarkAngelsInfantryAbility.StrafingRunAID, Ability.Filters.CloseEnemy, 9 )
            then
                self.strafingRunALastUse = g_iGMT 
            end
        end   
    end
end


function DarkAngelsInfantryTactic:CheckForBroken()

	if (self.squad_ai:IsBroken()) then
	
		-- Check if I can repair my morale
		local darally_id = cpu_manager.stats:GetAbilityID( "darkangels_rally" )
		if (self.squad_ai:CanDoAbility( darally_id )) then
			self.squad_ai:DoSpecialAbility( darally_id )
		end
	end
	
	-- Call basic broken check method
	InfantryTactic.CheckForBroken(self)
end

function DarkAngelsInfantryTactic:CheckDance(oSquad)

	-- Check opponent
	if (oSquad == nil) then
		return false
	end
	
	-- Compare opponents
	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "da_squad_tactical" or sSquadName == "da_squad_deathwing_terminator" or
		sSquadName == "da_squad_devastator") then
		
		-- Check opponent
		if (oSquad:GetSquadName() == "chaos_squad_cultist") then
			return false
		end
	end
	return true
end

function DarkAngelsInfantryTactic:Upgrade()

	-- Check if we have free ressources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- Don't upgrade squads with less than 6 troopers
	if (self.squad_ai:GetSquadName() == "da_squad_tactical" and self.squad_ai:GetNumTroopers() < 6) then
		return
	end
	
	if (not self.squad_ai:IsReinforcing() and self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 3) then
		
		-- Figure out my enemy's favourite class
		local enemy = cpu_manager:FindClosestEnemyPlayer()
		if (enemy == nil) then
			return
		end
		local class_type = enemy:GetMajorityClassType()
		
		-- Larkins hard counter upgrade for HeavyInfantryMed 
		if (class_type < UnitStatsAI.UC_HeavyInfantryMed) then	  
		  
			local enemy_race = enemy:GetPlayerRaceName()
			if (enemy_race == "da_race" or enemy_race == "chaos_marine_race" or enemy_race == "necron_race") then
		    	class_type = UnitStatsAI.UC_HeavyInfantryMed
		  	end
		end
		
		-- Do best upgrade
		self.squad_ai:DoBestUpgrade(class_type)
	end
end