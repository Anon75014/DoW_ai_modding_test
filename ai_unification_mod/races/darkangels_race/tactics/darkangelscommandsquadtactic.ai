----------------------------------------
-- File: 'darkangelscommandsquadtactic.ai'
-- Edited by Thudmeizer @ 06.06.2018

class 'DarkAngelsCommandSquadTactic' (DarkAngelsInfantryTactic)

DarkAngelsCommandSquad = {}

function DarkAngelsCommandSquadTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Dark Angels Command Squad Tactic")
end

function DarkAngelsCommandSquadTactic:InitAbilities()

end

function DarkAngelsCommandSquadTactic:DoAbilities()

    self:DoThrowGrenades()
end

function DarkAngelsCommandSquadTactic:CheckForBroken()

	if (self.squad_ai:IsBroken()) then
	
		-- Check if I can repair my morale
		local commandsquadrally_id = cpu_manager.stats:GetAbilityID( "darkangels_rally" )
		if (self.squad_ai:CanDoAbility( commandsquadrally_id )) then
			self.squad_ai:DoSpecialAbility( commandsquadrally_id )
		end
	end
	
	-- Call basic broken check method
	InfantryTactic.CheckForBroken(self)
end

function DarkAngelsCommandSquadTactic:Reinforce()

  --always try for the actual leader first
	if not self.squad_ai:IsReinforcing() then
		if self.squad_ai:CanReinforce( false, 0 ) then
		   self.squad_ai:DoReinforce( false, 0 )
		end
	end

	if not self.squad_ai:IsReinforcing() then

		-- try for different types of squad members
		local marineIndex = 0
		local apothecaryIndex = 1
		local sergeantIndex = 2
		local bearerIndex = 3
	
		local numMarines = self.squad_ai:GetLeaderCount( marineIndex )
		local numApothecaries = self.squad_ai:GetLeaderCount( apothecaryIndex )
		local numSergeants = self.squad_ai:GetLeaderCount( sergeantIndex )
		local numBearers = self.squad_ai:GetLeaderCount( bearerIndex )

		-- Desired number of each leader type
		local desiredMarines = 4
		local desiredApothecaries = 1 
		local desiredSergeants = 1
		local desiredBearers = 1

		-- Desired order of reinforcing
		if numMarines < desiredMarines then
			if self.squad_ai:CanReinforce( true, marineIndex ) then
				self.squad_ai:DoReinforce( true, marineIndex )
			end

		elseif numApothecaries < desiredApothecaries then
			if self.squad_ai:CanReinforce( true, apothecaryIndex ) then
				self.squad_ai:DoReinforce( true, apothecaryIndex )
			end

		elseif numSergeants < desiredSergeants then
			if self.squad_ai:CanReinforce( true, sergeantIndex ) then
				self.squad_ai:DoReinforce( true, sergeantIndex )
			end

		elseif numBearers < desiredBearers then
			if self.squad_ai:CanReinforce( true, bearerIndex ) then
				self.squad_ai:DoReinforce( true, bearerIndex )
			end
		end
	end
end

function DarkAngelsCommandSquadTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
end