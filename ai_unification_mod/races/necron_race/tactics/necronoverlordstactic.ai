----------------------------------------
-- File: 'necronoverlordstactic.ai'
-- Edited by Gambit	@ 25.01.2021
-- Edited by Thudmeizer @ 09.11.2023

class 'NecronOverlordsTactic' (NecronInfantryTactic)

NecronOverlords = {}

function NecronOverlordsTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Necron Overlords Tactic")

	self.m_oTimedSpecialAbilities = Timer( NecronOverlordsTactic.DoTimedSpecialAbilities, self, 7 )
end

function NecronOverlordsTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function NecronOverlordsTactic:IsDefender()
	return self:IsCommanderDefender()
end

-- Necron Lords are allowed to retreat even directly after a jump
function NecronOverlordsTactic:SetTarget( target, variant_type )

	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

function NecronOverlordsTactic:MoveToDisengage()
	Tactic.MoveToDisengage(self)
end

function NecronOverlordsTactic:CheckForDance()
	InfantryTactic.CheckForDance(self)
end

function NecronOverlordsTactic:CheckForDeath()
	InfantryTactic.CheckForDeath(self)
end

function NecronOverlordsTactic:InitAbilities()

	if NecronOverlords.lightning_storm_id == nil then
		NecronOverlords.lightning_storm_id = cpu_manager.stats:GetAbilityID( "necron_imotekh_lord_of_the_storm" )
		NecronOverlords.tesseract_labyrinth_id = cpu_manager.stats:GetAbilityID( "necron_trazyn_tesseract_labyrinth" )
		NecronOverlords.surrogate_host_id = cpu_manager.stats:GetAbilityID( "necron_trazyn_surrogate_host" )
		NecronOverlords.tachyon_arrow1_id = cpu_manager.stats:GetAbilityID( "necron_xunbakyr_tachyon_arrow" )
		NecronOverlords.tachyon_arrow2_id = cpu_manager.stats:GetAbilityID( "necron_anrakyr_tachyon_arrow" )	
		NecronOverlords.phase_shifter_id = cpu_manager.stats:GetAbilityID( "necron_anrakyr_phase_shifter" )
		NecronOverlords.mind_machine_id = cpu_manager.stats:GetAbilityID( "necron_anrakyr_mind_in_the_machine" )
		NecronOverlords.mass_resurrection_id = cpu_manager.stats:GetAbilityID( "necron_galmakh_mass_resurrection" )
		NecronOverlords.summon_sentry_pylon_id = cpu_manager.stats:GetAbilityID( "necron_galmakh_summon_sentry_pylon" )
		NecronOverlords.pokeball_id = cpu_manager.stats:GetAbilityID( "necron_pokeball" )
	end
end

function NecronOverlordsTactic:DoAbilities()

	-- Summon the appropriate C'Tan Shard, or the Obelisk
	if self.squad_ai:CanDirectSpawn() then 
		if self.squad_ai:WasRecentlyHurt() then
			if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power ) > 1100 then
				self.squad_ai:DoDirectSpawn()
				return
			end
		end
	end

	-- Tachyon Arrow has LONG range so the first requirement is ONLY a distant Vehicle High
	if self.squad_ai:CanDoAbility(NecronOverlords.tachyon_arrow1_id) then
		if Ability.DoAbilityTarget( self.squad_ai, NecronOverlords.tachyon_arrow1_id, Ability.Filters.CloseVehicleHighEnemy, 1 ) then
			return
		end
	elseif self.squad_ai:CanDoAbility(NecronOverlords.tachyon_arrow2_id) then
		if Ability.DoAbilityTarget( self.squad_ai, NecronOverlords.tachyon_arrow2_id, Ability.Filters.CloseVehicleHighEnemy, 1 ) then
			return
		end
	end


	-- Try abilities
	if self.squad_ai:IsInCombat() then

		if self.squad_ai:CanDoAbility(NecronOverlords.phase_shifter_id) then
			if Ability.DoAbility( self.squad_ai, NecronOverlords.phase_shifter_id, Ability.PredicateFilters.IsLowHealthAndUnderAttack , { min_health = 0.25 }) then
				return
			end
		end

		if self.squad_ai:CanDoAbility(NecronOverlords.mind_machine_id) then
			if Ability.DoAbilityTarget( self.squad_ai, NecronOverlords.mind_machine_id, Ability.Filters.CloseVehicleHighEnemy, 1 )
			or Ability.DoAbilityTarget( self.squad_ai, NecronOverlords.mind_machine_id, Ability.Filters.CloseVehicleEnemy, 1 ) then
				return
			end
		end

		if self.squad_ai:CanDoAbility(NecronOverlords.summon_sentry_pylon_id) then
			if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power ) > 200 then
				if Ability.DoAbilityPos( self.squad_ai, NecronOverlords.summon_sentry_pylon_id, Ability.Filters.CloseEnemy, 5 ) then
					return
				end
			end
		end

		if self.squad_ai:CanDoAbility(NecronOverlords.lightning_storm_id) then
			if Ability.DoAbilityPos( self.squad_ai, NecronOverlords.lightning_storm_id, Ability.Filters.CloseEnemy, 8 ) then
				return
			end
		end

		if self.squad_ai:CanDoAbility(NecronOverlords.tesseract_labyrinth_id) then
			if Ability.DoAbilityPos( self.squad_ai, NecronOverlords.tesseract_labyrinth_id, Ability.Filters.CloseInfantryEnemy, 6 )
			or Ability.DoAbilityPos( self.squad_ai, NecronOverlords.tesseract_labyrinth_id, Ability.Filters.CloseMonsterEnemy, 6 ) then
				return
			end
		end

		-- Try to produce a Surrogate Host for Trazyn, to give him more chances in combat
		if self.squad_ai:CanDoAbility(NecronOverlords.surrogate_host_id) then
			if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power ) > 200 then
				self.squad_ai:DoSpecialAbility( NecronOverlords.surrogate_host_id )
				return
			end
		end

		-- Re-try Tachyon Arrow to other targets
		if self.squad_ai:CanDoAbility(NecronOverlords.tachyon_arrow1_id) then
			if Ability.DoAbilityTarget( self.squad_ai, NecronOverlords.tachyon_arrow1_id, Ability.Filters.CloseVehicleEnemy, 1 )
			or Ability.DoAbilityTargetEntity( self.squad_ai, NecronOverlords.tachyon_arrow1_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
			or Ability.DoAbilityTarget( self.squad_ai, NecronOverlords.tachyon_arrow1_id, Ability.Filters.CloseCommanderEnemy, 1 ) then
				return
			end
		elseif self.squad_ai:CanDoAbility(NecronOverlords.tachyon_arrow2_id) then
			if Ability.DoAbilityTarget( self.squad_ai, NecronOverlords.tachyon_arrow2_id, Ability.Filters.CloseVehicleEnemy, 1 )
			or Ability.DoAbilityTargetEntity( self.squad_ai, NecronOverlords.tachyon_arrow2_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
			or Ability.DoAbilityTarget( self.squad_ai, NecronOverlords.tachyon_arrow2_id, Ability.Filters.CloseCommanderEnemy, 1 ) then
				return
			end
		end

		-- Try to use mass resurrection ability
		if self.squad_ai:CanDoAbility(NecronOverlords.mass_resurrection_id) then
			Ability.DoAbility(self.squad_ai, NecronOverlords.mass_resurrection_id, Ability.PredicateFilters.HasUsableBodies, { ability_id = NecronOverlords.mass_resurrection_id, min_bodies = 5 })
		end
	end

	if (self.m_oTimedSpecialAbilities ~= nil) then
		self.m_oTimedSpecialAbilities:Call()
	else
		NecronOverlordsTactic.DoTimedSpecialAbilities(self)
	end
end

function NecronOverlordsTactic:DoTimedSpecialAbilities()

  	if (self.squad_ai:CanDoAbility(NecronOverlords.pokeball_id)) then
    
    		-- Check for infiltrated enemy
        	local oEnemy = Ability.Filters.CloseSquadEnemy(self.squad_ai:GetPosition(), 35, 1)
        	if (oEnemy ~= nil) then

        		-- Get distance to enemy unit
           		local vSquadPos = self.squad_ai:GetPosition()
            		local vEnemyPos = oEnemy:GetPosition()
            		local iDistance = distance(vSquadPos, vEnemyPos)
            
            		-- If target is too far away launch auspex in range
            		local vTargetPos = Vector3f(vSquadPos)
            		local iRange = self.squad_ai:GetAbilityRange(NecronOverlords.pokeball_id)
            		if (iDistance > iRange) then
                		local fThrowFactor = iRange / iDistance
                		vTargetPos.x = vTargetPos.x + (vEnemyPos.x - vSquadPos.x) * fThrowFactor
                		vTargetPos.z = vTargetPos.z + (vEnemyPos.z - vSquadPos.z) * fThrowFactor
            		else
                		vTargetPos = Vector3f(vEnemyPos)
            		end

			self.squad_ai:DoSpecialAbilityPos(NecronOverlords.pokeball_id, vTargetPos)
        	end
	end
end

function NecronOverlordsTactic:Update()

 	-- State machine
	if not Tactic.Update( self ) then
		return false
	end

	if self.squad_ai:CanJump() then
		self.tolerance_default = self.squad_ai:GetJumpDistance()
	else
		self.tolerance_default = 100
	end

	self:SyncSubState()	

	-- If not already in substate
	if (self.stateID == Tactic.StateID.NoState) then
	   
		-- Check dance mode
		if (CpuManager.AISettings.iDancing == 2) then
		 	self:CheckForDeath()
			if (self.stateID == Tactic.StateID.NoState) then
				self:CheckForDance()
				if (self.stateID == Tactic.StateID.NoState) then
					self:CheckForStealthTroops()
				end
			end
		elseif (CpuManager.AISettings.iDancing == 1 and g_iGMT > self.m_iDancing + 10) then
			self:CheckForDeath()
			if (self.stateID == Tactic.StateID.NoState) then
				self:CheckForDance()
				if (self.stateID == Tactic.StateID.NoState) then
					self:CheckForStealthTroops()
				end
			end
		end
	end
	
	-- Check if we are in serious trouble
	self:EmergencyRetreat()
	-- Special moves
	self:CloseOnEnemy()
	-- Do abilities
	self:InitAbilities()
	self:DoAbilities()
	-- Check stance
	self:UpdateStance()

	-- Attach to melee
	if self.squad_ai:GetMeleeStance() == SquadAI.MSTANCE_Assault then
		if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then
			if (self:TryAttachSquad(false, true, 50, 150, self.m_fCommanderAttachHealth) == nil) then
				self:TryAttachSquadMelee()
			end
		end
	end

	-- Return success
	return true
end
