----------------------------------------
-- File: 'LOTDInfantryTactic.ai'
-- Created by Arkhan	@ 12.01.2006
-- Edited by Gambit 	@ 25.05.2016
-- Edited by Thudmeizer	@ 06.02.2025

class 'LOTDInfantryTactic' (InfantryTactic)

LOTDInfantryAbilities = {}

function LOTDInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Legion of the Damned Infantry Tactic")
	
	-- Set infantry options
	local sSquadName = squad_ai:GetSquadName()
	if (sSquadName == "lotd_space_marine_squad_lotd" or
		sSquadName == "lotd_space_marine_squad_muerto" or
		sSquadName == "lotd_space_marine_squad_force_commander" or
		sSquadName == "lotd_space_marine_squad_hero") then
		
		-- Squads are transportable and able to deepstrike	
		self.m_iTransportable = 1	-- Rhino
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID( "lotd_space_marine_hq" )

	elseif (sSquadName == "lotd_space_marine_squad_terminator" or
		sSquadName == "lotd_space_marine_squad_terminator_assault") then

		-- Squads are transportable and able to deepstrike	
		self.m_iTransportable = 2	-- Land Raider
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID( "lotd_space_marine_hq" )
	end
end

function LOTDInfantryTactic:AddTargetAbilities()
	table.insert(InfantryTactic.TargetAbilities, { nil, "lotd_frag_grenades", Ability.Filters.CloseSquadEnemy, 4, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "lotd_melta_bombs", Ability.Filters.CloseVehicleEnemy, 1, 0 })
end

function LOTDInfantryTactic:AddCommanders()
	table.insert(self.commander, { "lotd_space_marine_squad_force_commander", true })
	table.insert(self.commander, { "lotd_space_marine_squad_hero", false })
	table.insert(self.commander, { "lotd_space_marine_squad_muerto", false })
end

function LOTDInfantryTactic:DoAbilities()

	-- Check if we can time travel
	local timetravel_id = cpu_manager.stats:GetAbilityID( "lotd_time_travel" )
	if self.squad_ai:CanDoAbility(timetravel_id) then
		if (self.squad_ai:GetHealthPercentage() < 0.4 and self.squad_ai:IsUnderAttack()) then
			self.squad_ai:DoSpecialAbility(timetravel_id)
		end
	end

	-- Call basic DoAbilities methods
	InfantryTactic.DoAbilities(self)
end

function LOTDInfantryTactic:CheckForBroken()

	-- Call basic broken check method
--	InfantryTactic.CheckForBroken(self)
end

function LOTDInfantryTactic:CheckDance(oSquad)

	-- Check opponent
	if (oSquad == nil) then
		return false
	end
	
	-- Compare opponents
	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "lotd_space_marine_squad_lotd") then
		
		-- Check opponent
		if (oSquad:GetSquadName() == "chaos_squad_cultist") then
			return false
		end
	end
	return true
end

-- added 30/6/16
function LOTDInfantryTactic:IsAffectedByMorale()
    return false
end

function LOTDInfantryTactic:Reinforce()
	
	-- Always try to reinforce
	if (not self.squad_ai:IsReinforcing()) then
			
		if (self.squad_ai:CanReinforce( true, 0 )) then
			self.squad_ai:DoReinforce( true, 0 )
		elseif (self.squad_ai:CanReinforce( false, 0 )) then
			self.squad_ai:DoReinforce( false, 0 )
		end	
	end
end

function LOTDInfantryTactic:Upgrade()

	-- Check if we have free resources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- Don't upgrade space marine squads with less than 2 troopers
	if (self.squad_ai:GetSquadName() == "lotd_space_marine_squad_lotd" and self.squad_ai:GetNumTroopers() < 2) then
		return
	end
	
	if (not self.squad_ai:IsReinforcing() and self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 1) then
		
		-- Figure out my enemy's favourite class
		local enemy = cpu_manager:FindClosestEnemyPlayer()
		if (enemy == nil) then
			return
		end
		local class_type = enemy:GetMajorityClassType()
		
		-- Larkins hard counter upgrade for HeavyInfantryMed 
		if (class_type < UnitStatsAI.UC_HeavyInfantryMed) then	  
		  
			local enemy_race = enemy:GetPlayerRaceName()
			if (enemy_race == "space_marine_race" or enemy_race == "chaos_marine_race" or enemy_race == "necron_race") then
		    	class_type = UnitStatsAI.UC_HeavyInfantryMed
		  	end
		end
		
		-- Do best upgrade
		self.squad_ai:DoBestUpgrade(class_type)
	end
end