----------------------------------------
-- File: 'LOTDMarineBuildBaseStrategy.ai'
-- Edited by Thudmeizer @ 24.04.2025

class 'LOTDMarineBuildBaseStrategy' (BuildBaseStrategy)

function LOTDMarineBuildBaseStrategy:__init( baseinfo ) super( baseinfo )

	-- Add detector units (Best first, worst last)
	self:AddDetectorUnit("lotd_space_marine_squad_force_commander")

	CpuPrerequisites2.AddSpecialItem("lotd_space_marine_squad_muerto", CpuPrerequisites.BT_Squad)
end

function LOTDMarineBuildBaseStrategy:ChooseBuildProgram()

	-- Check build program count
	if (table.getn(self.info.BuildPrograms) ~= 1) then
		return BuildBaseStrategy.ChooseBuildProgram(self)
	end

	-- Get map size and closest enemy distance
	local sMapSize, iClosestEnemyDistance = self:GetMapSize()
		
	-- Modify probabilities according to the closest enemy player
	local oEnemy = cpu_manager:FindClosestEnemyPlayer(false)
	local sEnemy = oEnemy:GetPlayerRaceName()		
	if (sEnemy == "ork_race") then
		
	elseif (sEnemy == "eldar_race" or sEnemy == "guard_race" or sEnemy == "tau_race" or sEnemy == "necron_race") then
		
	end

	local iRandom = math.random(1, 1)
	return iRandom
end

function LOTDMarineBuildBaseStrategy:GetBuildingName( sType )

	-- Return race specific object string
	if (sType == "HQ") then
		return "lotd_space_marine_hq"

	elseif (sType == "ListeningPost") then
		return "lotd_space_marine_listening_post"

	elseif (sType == "Mine") then
		return "lotd_space_marine_mine_field"

	elseif (sType == "BiggerGenerator") then
		return "lotd_space_marine_thermo_generator"
	end
	return nil
end

function LOTDMarineBuildBaseStrategy:GetAddonBuilding( sType )

	if (sType == "lotd_space_marine_turret_addon") then
		return "lotd_space_marine_turret_spec"

	elseif (sType == "lotd_space_marine_turret_addon") then
		return "lotd_space_marine_turret_spec_no_limit"

	elseif (sType == "lotd_space_marine_turret_addon") then
		return "lotd_space_marine_thermo_generator"

	elseif (sType == "lotd_space_marine_turret_addon") then
		return "lotd_space_marine_thermo_generator_no_limit"

	elseif (sType == "lotd_space_marine_list_post_addon_1") then
		return "lotd_space_marine_listening_post"
		
	elseif (sType == "lotd_space_marine_list_post_addon_2") then
		return "lotd_space_marine_listening_post"
		
	elseif (sType == "lotd_space_marine_hq_addon_1") then
		return "lotd_space_marine_hq"
		
	elseif (sType == "lotd_space_marine_hq_addon_2") then
		return "lotd_space_marine_hq"

	elseif (sType == "lotd_space_marine_hq_addon_3") then
		return "lotd_space_marine_hq"

	elseif (sType == "lotd_space_marine_hq_addon_4") then
		return "lotd_space_marine_hq"
	end
	return nil
end

-- Arkhan 01.2006: Inherited method to check if an addon is a tier addon
function LOTDMarineBuildBaseStrategy:IsTierAddon( sName, iTargetTier )

	-- Check addon name and target tier
	if (sName == "lotd_space_marine_hq_addon_1" and iTargetTier == 2) then
		return true
	elseif (sName == "lotd_space_marine_hq_addon_2" and iTargetTier == 3) then
		return true
	elseif (sName == "lotd_space_marine_hq_addon_3" and iTargetTier == 4) then
		return true
	end
	return false
end

-- Arkhan 11.2005: Returns the squad cap and support cap of the given squad
function LOTDMarineBuildBaseStrategy:GetUnitStats(sSquadName)

	if (sSquadName == "lotd_space_marine_squad_bike") then
		return 2, 0
	elseif (sSquadName == "lotd_space_marine_squad_lotd") then
		return 3, 0
	elseif (sSquadName == "lotd_space_marine_squad_terminator") then
		return 4, 0
	elseif (sSquadName == "lotd_space_marine_squad_terminator_assault") then
		return 4, 0
	elseif (sSquadName == "lotd_space_marine_squad_hunter_rhino") then
		return 0, 3
	elseif (sSquadName == "lotd_space_marine_squad_dreadnought") then
		return 0, 3
	elseif (sSquadName == "lotd_space_marine_squad_venerable_dreadnought") then
		return 0, 4
	elseif (sSquadName == "lotd_space_marine_squad_predator") then
		return 0, 5
	elseif (sSquadName == "lotd_space_marine_squad_land_raider") then
		return 0, 3
	elseif (sSquadName == "lotd_space_marine_squad_imperial_knight") then
		return 0, 12
	end
	return 0, 0
end

function LOTDMarineBuildBaseStrategy:UpdateTierLevel()

	-- Reset tier level
	self.tierLevel = 1
	
	-- Prepare
	local iHQAddon1ID = cpu_manager.stats:GetAddOnID("lotd_space_marine_hq_addon_1")
	local iHQAddon2ID = cpu_manager.stats:GetAddOnID("lotd_space_marine_hq_addon_2")
	local iHQAddon3ID = cpu_manager.stats:GetAddOnID("lotd_space_marine_hq_addon_3")
	local oStats = cpu_manager.stats:GetPlayerStatsFromID( cpu_manager.player_id )
	
	-- Check HQ's for addons
	for oBase in oStats:GetBases() do
		-- Check for valid HQ
		if (oBase:IsValid() and oBase:GetBaseName() == "lotd_space_marine_hq") then
			-- Check for HQ addon 3
			if oBase:HasAddOn(iHQAddon3ID) then
				self.tierLevel = 4
				return
			-- Check for HQ addon 2
			elseif oBase:HasAddOn(iHQAddon2ID) then
				self.tierLevel = 3
				return
			-- Check for HQ addon 1
			elseif oBase:HasAddOn(iHQAddon1ID) then
				self.tierLevel = 2
				return
			end
		end
	end
end

function LOTDMarineBuildBaseStrategy:BuildFlexible()

	-- Always test first to see if there is at least one existing HQ
	if self:GetBuildingCountByName(self:GetBuildingName("HQ")) < 1 then
     		self:BuildFirstHQ()
	end

	-- Always test first to see if there is at least one existing builder unit
	self:BuildFirstBuilder("lotd_space_marine_squad_servitor")

	-- Dynamic research item syntax: ResearchName, MinTier, RequisitionCost, PowerCost, MinSquadCap, MinSupportCap, SquadName, SquadMinCount
	local iArmyStrength = cpu_manager:GetArmyStrength()
	local iCommanderSquads	= self:CountSquads("lotd_space_marine_squad_force_commander")
	local iInfantrySquads	= self:CountSquads("lotd_space_marine_squad_lotd")

	-- Compute tier 2 researches (tier 1 has none)
	if (self.tierLevel >= 2) then

		-- Compute infantry researches 
		self:DynamicResearch("lotd_max_weapons_research", 2, 0, 0, 0, 0, nil, 0)
		self:DynamicResearch("lotd_health_upgrade_research", 2, 0, 0, 0, 0, "lotd_space_marine_squad_lotd", 1)
		self:DynamicResearch("lotd_morale_upgrade_research", 2, 0, 0, 0, 0, "lotd_space_marine_squad_lotd", 1)

		-- Try to build no-limit defensive turrets and mines
		self:DynamicBuild("lotd_space_marine_turret_spec", 2, 2, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_turret_spec_no_limit", 2, 2, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_mine_field", 2, 2, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_mine_field_no_limit", 2, 2, 0, 0, 0, 0)
	end
	
	-- Compute tier 3 researches
	if (self.tierLevel >= 3) then

		-- Compute infantry researches 
		self:DynamicResearch("lotd_sight_research", 3, 0, 0, 0, 0, "lotd_space_marine_squad_lotd", 1)
		self:DynamicResearch("lotd_max_weapons_research2", 2, 0, 0, 0, 0, nil, 0)
		self:DynamicResearch("lotd_health_upgrade_research2", 2, 0, 0, 0, 0, "lotd_space_marine_squad_lotd", 1)
		self:DynamicResearch("lotd_morale_upgrade_research2", 2, 0, 0, 0, 0, "lotd_space_marine_squad_lotd", 1)

		-- Try to build no-limit defensive turrets and mines
		self:DynamicBuild("lotd_space_marine_turret_spec", 4, 3, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_turret_spec_no_limit", 4, 3, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_mine_field", 6, 3, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_mine_field_no_limit", 6, 3, 0, 0, 0, 0)
	end
	
	-- Compute tier 4 researches
	if (self.tierLevel >= 4) then

		-- Compute Titan addons
		self:DynamicAddon("lotd_space_marine_hq_addon_4", 100, 4, 0, 0, 0, 0, nil, nil, false)

		-- Compute advanced infantry researches 
		self:DynamicResearch("lotd_infiltrate_research", 4, 0, 0, 0, 0, "lotd_space_marine_squad_lotd", 2)
		self:DynamicResearch("lotd_health_upgrade_research3", 2, 0, 0, 0, 0, "lotd_space_marine_squad_lotd", 1)
		self:DynamicResearch("lotd_morale_upgrade_research3", 2, 0, 0, 0, 0, "lotd_space_marine_squad_lotd", 1)

		-- Compute HQ Tier2 and Tier3 Addons for future HQs
       		if self:GetBuildingCountByName(self:GetBuildingName("HQ")) > 1 then
			self:DynamicAddon("lotd_space_marine_hq_addon_1", 100, 4, 0, 0, 0, 0, nil, nil, false)
			self:DynamicAddon("lotd_space_marine_hq_addon_2", 100, 4, 0, 0, 0, 0, nil, nil, false)
			self:DynamicAddon("lotd_space_marine_hq_addon_3", 100, 4, 0, 0, 0, 0, nil, nil, false)
			self:DynamicAddon("lotd_space_marine_hq_addon_4", 100, 4, 0, 0, 0, 0, nil, nil, false)
		end

		-- Try to build no-limit defensive turrets and mines
		self:DynamicBuild("lotd_space_marine_turret_spec", 10, 4, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_turret_spec_no_limit", 10, 4, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_mine_field", 10, 4, 0, 0, 0, 0)
		self:DynamicBuild("lotd_space_marine_mine_field_no_limit", 12, 4, 0, 0, 0, 0)
	end

	-- Restrict dynamic builds to hard difficulty or higher
	if (CpuManager.AISettings.bMultiBuildings) then
	
		-- Dynamic buildings
		-- Item-Syntax: BuildingName, BuildingCount, MinTier, MinRequisition, MinPower, MinSquadCap, MinSupportCap
		self:DynamicBuild("lotd_space_marine_hq", 2, 3, 0, 0, 0, 0)
	end
end

-- Force AI to give priority to re-build HQ if lost and none are present
function LOTDMarineBuildBaseStrategy:BuildFirstHQ()

	-- Check if a plan exists
	local iBuildingID = cpu_manager.stats:GetBuildingID(self:GetBuildingName("HQ"))
	if (self:PlanExists("Build Building Plan", iBuildingID)) then
		return
	end

	-- Check if any HQ are in production
	for oBuildChannel in build_manager:GetBuildChannelAIs() do

		-- Check building ID
		if (oBuildChannel:GetBlueprintID() == iBuildingID and not oBuildChannel:ConstructionDone()) then
			return
		end
	end
		
	-- Build the HQ
	local sHQName = self:GetBuildingName("HQ")
	local tBuildType = CpuBuildType()
	tBuildType.btype = CpuPrerequisites.BT_Building
	tBuildType.name = sHQName
	if (self:TryBuild( tBuildType )) then
		aitrace("BuildController: Dynamic build of "..tBuildType.name)
	end
	return
end

-- Force AI to give priority to recruit a builder unit if none are present
function LOTDMarineBuildBaseStrategy:BuildFirstBuilder(iBuilderName)

	if self:CountSquads(iBuilderName) < 1 then

		-- Recruit a builder squad
		local tBuildType = CpuBuildType()
		tBuildType.btype = CpuPrerequisites.BT_Squad
		tBuildType.name = iBuilderName
		if (self:TryBuild( tBuildType )) then
			aitrace("BuildController: Dynamic build of "..tBuildType.name)
		end
		return
	end
end

-- Arkhan 01.2006: Method to check if force tech should be computed
function LOTDMarineBuildBaseStrategy:ForceTech()
	return false
end

-- Arkhan 03.2006: Return placement type for buildings
function LOTDMarineBuildBaseStrategy:GetPlacementType(iBuildingID)
	
	-- Check building
	if (iBuildingID == cpu_manager.stats:GetBuildingID(self:GetBuildingName("HQ"))) then
        	local count = self:GetBuildingCountByName(self:GetBuildingName("HQ"), false)
		local friend = cpu_manager:FindClosestFriendPlayer()
		if friend == nil then
			-- Lone Player
			if count == 0 and not cpu_manager:HQThreat() then
				return "HQ"
			else
				return "Safeplace"
			end
		else
			-- Has allies
			if count > 0 or cpu_manager:HQThreat() then
				return "HQ"
			else
				return "Safeplace"
			end
		end
	elseif (iBuildingID == cpu_manager.stats:GetBuildingID("lotd_space_marine_turret_spec") or
		iBuildingID == cpu_manager.stats:GetBuildingID("lotd_space_marine_turret_spec_no_limit")) then
		return "Front2"
	elseif (cpu_manager:IsMine(iBuildingID)  or
			iBuildingID == cpu_manager.stats:GetBuildingID("lotd_space_marine_mine_field_no_limit")) then
		return "Mine"
	end
	return "Basic"
end

-- Arkhan 03.2006: Inherited method to modify squad demand
function LOTDMarineBuildBaseStrategy:ModifySquadDemand(iUnitID)

	-- Only build rhinos if we've full support cap
	if (iUnitID == cpu_manager.stats:GetSquadID("lotd_space_marine_squad_hunter_rhino")) then
		
		-- Check army strength
		if (cpu_manager:GetArmyStrength() < 2000) then
			return 0
		end
	end
	return BuildBaseStrategy.ModifySquadDemand(self, iUnitID)
end

-- Arkhan 11.2006: Check if we have enough resources for a bigger generator
function LOTDMarineBuildBaseStrategy:HasResourcesForBiggerGenerator(iRequisition, iPower)
	return true
end

-- Arkhan 11.2006: Virtual method for checking out relic units
function LOTDMarineBuildBaseStrategy:RelicRequired(sName)

	-- Check name
	if (sName == "lotd_space_marine_squad_land_raider") then
		return true
	end
	return false
end


-- Gambit 08.2016: Modified for the LotD race that:
-- 1] Does NOT have small Gens, but DO have Big Gens and
-- 2] Has NO use of requisition or power resources
function LOTDMarineBuildBaseStrategy:DoBuildGenerators()

	aitrace("BuildController: Check generators...")

	-- Check build plans for Big Generators
	local iBiggerGeneratorID = cpu_manager.stats:GetBuildingID(self:GetBuildingName("BiggerGenerator"))
	if self:PlanExists("Build Building Plan", iBiggerGeneratorID) then
		return
	end

	-- Try to build a bigger generator
	aitrace("BuildController: Trying to build bigger generator")

	-- Update where the free slag heaps are
	resource_manager:UpdateFreeSlagHeaps(iBiggerGeneratorID)
	
	-- Look for the closest generator
	local base_pos = cpu_manager.start_pos 
	local slag_table = {}
	
	for slag_heap in resource_manager:GetSlagHeaps() do
		local slag_pos = slag_heap:GetPosition()					
		if not cpu_manager.terrain_analyzer:HasThreat( slag_pos, 35 ) then
			-- Find available engineer
			local functor = function( squad_ai )
				local squad_pos = squad_ai:GetPosition()
				return (squad_ai:IsEngineer() and squad_ai:CanBuild(iBiggerGeneratorID) == SquadAI.CANBUILD_Ok and
						not cpu_manager:HasThreatOnPath( squad_pos, slag_pos, 40 ))
			end
			local engineer = cpu_manager:GetClosestUnlockedSquad( slag_pos, 500, functor )
			if engineer ~= nil then
				aitrace("BuildController: Build bigger generator pathing check...")
				local dist = cpu_manager:GetShortestPathingDistance( base_pos, slag_pos, true )
				local max_dist = 90 + self.tierLevel * 60
				--only close slag heaps at low tier levels
				if dist > 0 and dist <= max_dist then
					local can_build = engineer:CanBuildAt(iBiggerGeneratorID, slag_pos )
					table.insert( slag_table, {slag_pos, engineer, dist, can_build} ) 
				end
			end
		end
	end

	local num_items = table.getn ( slag_table )

	-- Multiple entries, we have to sort by distance
	if num_items > 1 then
		sortfunc = function( item1, item2 )					
			return item1[3] < item2[3]
		end
		table.sort( slag_table, sortfunc )
	end

	-- If we do have an available free Slag, proceed
	if num_items > 0 then	 
		if slag_table[1][4] then
			-- Add the plan to build, can_build is true
			aitrace("BuildManager: Dynamic build of bigger generator at "..tostring(slag_table[1][1].x)..", "..tostring(slag_table[1][1].z))
			self:AddPlan( BuildBuildingPlan(iBiggerGeneratorID, slag_table[1][1]) )
		else
			-- Send engineer to slag position
			if not cpu_manager:JumpBuilder( slag_table[1][2], slag_table[1][1] ) then
				cpu_manager:DoMove( slag_table[1][2], slag_table[1][1], false, "Go to bigger generator")
			end
		end
	end
end
