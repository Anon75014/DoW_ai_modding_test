----------------------------------------
-- File: 'Lieutenanttactic.ai'
-- Edited by Thudmeizer @ 04.10.2023

class 'LieutenantTactic' (SteelLegionInfantryTactic)

Lieutenant = {}

function LieutenantTactic:__init( squad_ai ) super( squad_ai )

	   self:SetName("Lieutenant Tactic")
end

function LieutenantTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function LieutenantTactic:IsDefender()
	return self:IsCommanderDefender()
end

function LieutenantTactic:InitAbilities()

	if (Lieutenant.melta_id == nil) then
	    Lieutenant.melta_id = cpu_manager.stats:GetAbilityID( "steel_legion_melta_bombs" )	
	end

	if (Lieutenant.rally_id == nil) then
	    Lieutenant.rally_id = cpu_manager.stats:GetAbilityID( "steel_legion_rally" )	
	end
--[[
	if (Lieutenant.sensor_id == nil) then
	    Lieutenant.sensor_id = cpu_manager.stats:GetAbilityID( "steel_legion_sensor_sweep_colonol" )	
	end
]]
	if (Lieutenant.vox_id == nil) then
	    Lieutenant.vox_id = cpu_manager.stats:GetAbilityID( "steel_legion_vox_deploy" )	
	end
end

function LieutenantTactic:DoAbilities()

        --TargetVehicle: Damages enemy tanks and stuns them temporarily
	Ability.DoAbilityTarget( self.squad_ai, Lieutenant.melta_id, Ability.Filters.CloseVehicleEnemy, 1 )
	Ability.DoAbilityTargetEntity( self.squad_ai, Lieutenant.melta_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1) 

	--check if I can repair my morale
        if (self.squad_ai:IsAttached() and self.squad_ai:IsBroken()) then
	  	  
		if self.squad_ai:CanDoAbility( Lieutenant.rally_id ) then
			self.squad_ai:DoSpecialAbility( Lieutenant.rally_id )
          	end
     	end
--[[
	-- Can we activate sensor sweep when enemy infiltrators are nearby
	if (self.squad_ai:IsUsingAbility(Lieutenant.sensor_id)) then
		-- Enable sensor sweep only when enemy infiltrators are nearby
		if (Ability.Filters.CloseInfiltratedEnemy(self.squad_ai:GetPosition(), 45, 1) == nil) then
			self.squad_ai:DoSpecialAbility(Lieutenant.sensor_id)
		end
	elseif (Ability.Filters.CloseInfiltratedEnemy(self.squad_ai:GetPosition(), 45, 1) ~= nil) then
		self.squad_ai:DoSpecialAbility(Lieutenant.sensor_id)
	end
]]
	-- Try to deploy a Vox Officer near to commander if infiltrators are detected
	if (self.squad_ai:CanDoAbility(Lieutenant.vox_id)) then
	
		local iRange = self.squad_ai:GetAbilityRange(Lieutenant.vox_id)
		local oSquad = Ability.Filters.CloseInfiltratedEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oSquad ~= nil) then
			
			-- Only try to detect if the infiltrating unit is attacking
			if (oSquad:IsAttacking()) then
				self.squad_ai:DoSpecialAbilitySquad(Lieutenant.vox_id, self.squad_ai:GetPosition())
			end
		end
	end
end

function LieutenantTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Try to attach to melee in tier 2+
	if (cpu_manager:GetTierLevel() >= 2 or self.squad_ai:WasRecentlyHurt()) then
	
		if (self:TryAttachSquad(true, true, 50, 100, nil) ~= nil) then
			return
		end
		
		if (self:TryAttachSquad(false, true, 50, 100, nil) == nil) then
			self:TryAttachSquadMelee()
		end
	end
end
