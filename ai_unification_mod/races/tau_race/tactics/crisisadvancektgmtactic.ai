----------------------------------------
-- File: 'crisisadvancektgmtactic.ai'
-- Edited by Thudmeizer	@ 28.10.2023

class 'CrisisAdvanceKtgmTactic' (TauInfantryTactic)

CrisisAdvanceKtgm = {}

function CrisisAdvanceKtgmTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Crisis Advanced Kill Team Tactic")
end

function CrisisAdvanceKtgmTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function CrisisAdvanceKtgmTactic:IsDefender()
	return self:IsCommanderDefender()
end

-- Commander is allowed to retreat even directly after a jump
function CrisisAdvanceKtgmTactic:SetTarget( target, variant_type )

	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

function CrisisAdvanceKtgmTactic:JumpAttack()
	Tactic.JumpAttack(self)
end

function CrisisAdvanceKtgmTactic:InitAbilities()

	-- Init ability ID's
	if (CrisisAdvanceKtgm.shield == nil) then
		CrisisAdvanceKtgm.shield = cpu_manager.stats:GetAbilityID( "tau_ls_crisis_suit_advance_personal_shield" )
	end
	if (CrisisAdvanceKtgm.mark == nil) then
		CrisisAdvanceKtgm.mark = cpu_manager.stats:GetAbilityID( "tau_ls_crisis_suit_advance_mark_squad" )
	end
	if (CrisisAdvanceKtgm.detonator == nil) then
		CrisisAdvanceKtgm.detonator = cpu_manager.stats:GetAbilityID( "tau_ls_crisis_suit_advance_fail_safe_detonator" )
	end
	if (CrisisAdvanceKtgm.lasergun == nil) then
		CrisisAdvanceKtgm.lasergun = cpu_manager.stats:GetAbilityID( "tau_ls_crisis_suit_advance_lasergun_sp" )
	end
	if (CrisisAdvanceKtgm.restoration == nil) then
		CrisisAdvanceKtgm.restoration = cpu_manager.stats:GetAbilityID( "tau_ls_crisis_suit_advance_restoration_sequence" )
	end
end

function CrisisAdvanceKtgmTactic:DoAbilities()

	-- Check if we can use Personal shields if health is low
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.8) then
		Ability.DoAbility( self.squad_ai, CrisisAdvanceKtgm.shield, Ability.PredicateFilters.IsInCombat ) 
	end

	-- Check if we can use mark squad ability
	if self.squad_ai:CanDoAbility(CrisisAdvanceKtgm.mark) and self.squad_ai:IsInCombat() then
	
		-- Get closest squad in range
		local iRange = self.squad_ai:GetAbilityRange(CrisisAdvanceKtgm.mark)
		local oSquad = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oSquad ~= nil) then
		
			-- Get stats
			local oStats = oSquad:GetStats()
			if (oStats ~= nil) then
			
				-- Check unit type
				local eClass = oStats:GetClass()
				if (eClass == UnitStatsAI.UC_VehicleLow or eClass == UnitStatsAI.UC_VehicleMed or
					eClass == UnitStatsAI.UC_VehicleHigh or eClass == UnitStatsAI.UC_Commander or
					eClass == UnitStatsAI.UC_MonsterHigh or oSquad:GetNumTroopers() >= 4) then
					
					-- Use mark ability on squad
					self.squad_ai:DoSpecialAbilitySquad(CrisisAdvanceKtgm.mark, oSquad:GetSquad())
				end
			end	
		end
	end

	-- Check if we can use the failsafe detonator if real low on health with enemies nearby
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.2) then
		Ability.DoAbilityArea( self.squad_ai, CrisisAdvanceKtgm.detonator, Ability.Filters.CloseInCombat, 10, 6)
	end
--[[
	-- Launch a lasgun salvo at close enemy
	if self.squad_ai:CanDoAbility(CrisisAdvanceKtgm.lasergun) then
		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) then
			Ability.DoAbilityPos( self.squad_ai, CrisisAdvanceKtgm.lasergun, Ability.Filters.CloseEnemy, 3 )
		else
			Ability.DoAbilityPos( self.squad_ai, CrisisAdvanceKtgm.lasergun, Ability.Filters.CloseEnemy, 5 )
		end
	end
]]
	-- Try to use restoration sequence if low on health or broken
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) or (self.squad_ai:IsBroken()) then
		if (self.squad_ai:CanDoAbility(CrisisAdvanceKtgm.restoration)) then
			self.squad_ai:DoSpecialAbility(CrisisAdvanceKtgm.restoration)
		end
	end

	-- Spawn Drone Squad
	if (self.squad_ai:CanDirectSpawn()) then 
		self.squad_ai:DoDirectSpawn()
	end

	-- Launch a lasgun salvo at close enemy (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(CrisisAdvanceKtgm.lasergun)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(CrisisAdvanceKtgm.lasergun)
		local oUnit = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 6)
		if (oUnit ~= nil) then
			--print("Using Lasgun Salvo Ability for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(CrisisAdvanceKtgm.lasergun, oUnit:GetSquad())
			return
		end
	end

	-- New code to unstuck units with pathing issues, that can jump.
	-- Call it with [true], only for multi-membered squads.
	self:SolveStuckCase(false)
end

function CrisisAdvanceKtgmTactic:Reinforce()

	-- Check if we are reinforcing
	if (not self.squad_ai:IsReinforcing()) then

		-- try for different types of squad members
		local InhibitorIndex = 0
		local AcceleratorIndex = 1

		local numInhibitors = self.squad_ai:GetLeaderCount( InhibitorIndex )
		local numAccelerators = self.squad_ai:GetLeaderCount( AcceleratorIndex )	

		-- Desired number of each leader type
		local desiredInhibitors = math.random(0,1)
		local desiredAccelerators = math.random(0,1) 

		-- Desired order of reinforcing
		if (numInhibitors < desiredInhibitors) then
			if (self.squad_ai:CanReinforce( true, InhibitorIndex )) then
				self.squad_ai:DoReinforce( true, InhibitorIndex )
			end
		elseif (numAccelerators < desiredAccelerators) then
			if (self.squad_ai:CanReinforce( true, AcceleratorIndex )) then
				self.squad_ai:DoReinforce( true, AcceleratorIndex )
			end
		else
			if (self.squad_ai:CanReinforce( false, 0 )) then
				self.squad_ai:DoReinforce( false, 0 )
			end			
		end
	end
end

function CrisisAdvanceKtgmTactic:Update()

	if (self:IsComplete()) then
		return
	end

    	-- State machine
    	if (not InfantryTactic.Update(self)) then
        	return
    	end
    
	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end