----------------------------------------
-- File: 'nightlordscaptaintactic.ai'
-- Edited by Torzel @ 18.05.2013
-- Edited by Thudmeizer	@ 02.02.2017

class 'NightLordsCaptainTactic' (NightLordsInfantryTactic)

NightLordsCaptain = {}

function NightLordsCaptainTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Night Lords Captain Tactic")
end

-- Assassinate win condition -- never attack
function NightLordsCaptainTactic:IsAttacker()
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

-- Assassinate win condition -- never defend
function NightLordsCaptainTactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end

-- Night Lord is allowed to retreat even directly after a jump
function NightLordsCaptainTactic:SetTarget( target, variant_type )

	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

-- Assassinate win condition -- never jump into combat
function NightLordsCaptainTactic:JumpAttack()

	if (not cpu_manager.assassinate) then
		Tactic.JumpAttack(self)
	end
end

function NightLordsCaptainTactic:CanJumpAttached()
	return true
end

function NightLordsCaptainTactic:InitAbilities()

	-- Init ability ID's
	if (NightLordsCaptain.vision_id == nil) then
		NightLordsCaptain.vision_id = cpu_manager.stats:GetAbilityID( "night_lords_night_vision" )	
	end
	if (NightLordsCaptain.nostramo_id == nil) then
		NightLordsCaptain.nostramo_id = cpu_manager.stats:GetAbilityID( "night_lords_shadow_of_nostramo" )	
	end
	if (NightLordsCaptain.demoralize_id == nil) then
		NightLordsCaptain.demoralize_id = cpu_manager.stats:GetAbilityID( "night_lords_demoralize" )	
	end
end

function NightLordsCaptainTactic:DoAbilities()

	-- Check if we can possess to become Daemon Prince
	if (self.squad_ai:CanPossess()) then
	
		-- Check if we are in combat
		if (self.squad_ai:IsInCombat() or cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 35)) then
			self.squad_ai:DoPossess()
		end
	end

	-- If we are dying, lower requisites for attacks
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
		Ability.DoAbilityArea( self.squad_ai, NightLordsCaptain.nostramo_id, Ability.Filters.CloseEnemy, 30, 3)
		Ability.DoAbilityTarget( self.squad_ai, NightLordsCaptain.demoralize_id, Ability.Filters.CloseInfantryEnemy, 4 )
	else
		Ability.DoAbilityArea( self.squad_ai, NightLordsCaptain.nostramo_id, Ability.Filters.CloseEnemy, 30, 5)
		Ability.DoAbilityTarget( self.squad_ai, NightLordsCaptain.demoralize_id, Ability.Filters.CloseInfantryEnemy, 8 )
	end

	-- Search for infiltrating squads first
    	Ability.DoAbilityArea( self.squad_ai, NightLordsCaptain.vision_id, Ability.Filters.CloseInfiltratedEnemy, 30, 1 )

    	-- Then search for infiltrating buildings
    	local pos = self.squad_ai:GetPosition()
    	if cpu_manager:CloseEnemyBuildings(pos, 30) then -- Quick check to speed-up code
       		if NightLordsCaptainTactic:IsEnemyInfiltratingBuildingWithin(pos, 30) then
       			self.squad_ai:DoSpecialAbility(NightLordsCaptain.vision_id)
   	 	end
	end
--[[
	-- Then search for infiltrating buildings
	local pos = self.squad_ai:GetPosition()
	if cpu_manager:CloseEnemyBuildings(pos, 30) then
		-- Quick check to speed-up code
        	local oBase = cpu_manager.cpu_player:FindFirstBaseEnemy(pos, 30, 1)
        	if oBase ~= nil and oBase:IsInfiltrating() then
            		self.squad_ai:DoSpecialAbility(NightLordsCaptain.vision_id)
        	end
	end
]]
--[[
	-- Then search for infiltrating buildings
	if self.squad_ai:CanDoAbility(NightLordsCaptain.vision_id) then
        local pos = self.squad_ai:GetPosition()
        	if cpu_manager:CloseEnemyBuildings(pos, 30) then -- Quick check to speed-up code
            		for oPlayer in cpu_manager.stats:GetPlayerStats() do
                		if not oPlayer:IsPlayerDead() then
                    			if cpu_manager.player_stats:IsEnemy(oPlayer) then
                        			for oBuilding in oPlayer:GetBases() do
                            				if oBuilding:IsValid() and oBuilding:IsInfiltrating() then
                                				if distance_sqr(oBuilding:GetPosition(), pos) < 900 then
                                    					self.squad_ai:DoSpecialAbility(NightLordsCaptain.vision_id)
                                    					return
                                				end
                            				end
                        			end
                    			end
                		end
            		end
        	end
    	end
]]
end

function NightLordsCaptainTactic:IsEnemyInfiltratingBuildingWithin(iPos, iRange)
	local iRangeSqr = iRange * iRange
	for oPlayer in cpu_manager.stats:GetPlayerStats() do
        	if not oPlayer:IsPlayerDead() then
            		if cpu_manager.player_stats:IsEnemy(oPlayer) then
                		for oBuilding in oPlayer:GetBases() do
                    			if oBuilding:IsValid() and oBuilding:IsInfiltrating() then
                        			if distance_sqr(oBuilding:GetPosition(), iPos) < iRangeSqr then
                           				return true
                        			end
                    			end
                		end
            		end
        	end
	end
	return false
end

function NightLordsCaptainTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Assassinate win condition -- never attach to a squad
	if (not cpu_manager.assassinate) then
				
		-- Attach to melee in tier2+
		if (cpu_manager:GetTierLevel() > 1) then
		
			if (self:TryAttachSquad(true, true, 50, 150, nil) ~= nil) then
				return
			end
		end
		if (self:TryAttachSquad(false, true, 50, nil, self.m_fCommanderAttachHealth) == nil) then
			self:TryAttachSquadMelee()
		end
	end

	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end
