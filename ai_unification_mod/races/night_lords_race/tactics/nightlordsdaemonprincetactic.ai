----------------------------------------
-- File: 'nightlordsdaemonprincetactic.ai'
-- Edited by Torzel @ 18.05.2013
-- Edited by Thudmeizer	@ 02.02.2017

class 'NightLordsDaemonPrinceTactic' (NightLordsInfantryTactic)

NightLordsDaemonPrince = {}

function NightLordsDaemonPrinceTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Night Lords Daemon Prince Tactic")
end

-- Daemon Prince is allowed to retreat even directly after a jump
function NightLordsDaemonPrinceTactic:SetTarget( target, variant_type )

	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

function NightLordsDaemonPrinceTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function NightLordsDaemonPrinceTactic:IsDefender()
	return self:IsCommanderDefender()
end

function NightLordsDaemonPrinceTactic:JumpAttack()
	Tactic.JumpAttack(self)
end

function NightLordsDaemonPrinceTactic:InitAbilities()

	-- Init ability ID's
	if (NightLordsDaemonPrince.vision_id == nil) then
		NightLordsDaemonPrince.vision_id = cpu_manager.stats:GetAbilityID( "night_lords_night_vision" )	
	end

	if (NightLordsDaemonPrince.roar_id == nil) then
		NightLordsDaemonPrince.roar_id = cpu_manager.stats:GetAbilityID( "night_lords_fear_roar" )	
	end

	if (NightLordsDaemonPrince.orb_id == nil) then
		NightLordsDaemonPrince.orb_id = cpu_manager.stats:GetAbilityID( "night_lords_curzes_orb" )	
	end	
end

function NightLordsDaemonPrinceTactic:DoAbilities()

	Ability.DoAbilityArea( self.squad_ai, NightLordsDaemonPrince.roar_id, Ability.Filters.CloseSquadEnemy, 10, 4)
	Ability.DoAbilityArea( self.squad_ai, NightLordsDaemonPrince.orb_id, Ability.Filters.CloseEnemy, 10, 4)

	-- Search for infiltrating squads first
    	Ability.DoAbilityArea( self.squad_ai, NightLordsDaemonPrince.vision_id, Ability.Filters.CloseInfiltratedEnemy, 30, 1 )
--[[
	-- Then search for infiltrating buildings
	local pos = self.squad_ai:GetPosition()
	if cpu_manager:CloseEnemyBuildings(pos, 30) then
		-- Quick check to speed-up code
        	local oBase = cpu_manager.cpu_player:FindFirstBaseEnemy(pos, 30, 1)
        	if oBase ~= nil and oBase:IsInfiltrating() then
            		self.squad_ai:DoSpecialAbility(NightLordsDaemonPrince.vision_id)
        	end
	end
]]
    	-- Then search for infiltrating buildings
    	local pos = self.squad_ai:GetPosition()
    	if cpu_manager:CloseEnemyBuildings(pos, 30) then -- Quick check to speed-up code
        	if NightLordsDaemonPrinceTactic:IsEnemyInfiltratingBuildingWithin(pos, 30) then
            		self.squad_ai:DoSpecialAbility(NightLordsDaemonPrince.vision_id)
        	end
	end

end

function NightLordsDaemonPrinceTactic:IsEnemyInfiltratingBuildingWithin(iPos, iRange)
	local iRangeSqr = iRange * iRange
	for oPlayer in cpu_manager.stats:GetPlayerStats() do
        	if not oPlayer:IsPlayerDead() then
            		if cpu_manager.player_stats:IsEnemy(oPlayer) then
                		for oBuilding in oPlayer:GetBases() do
                    			if oBuilding:IsValid() and oBuilding:IsInfiltrating() then
                        			if distance_sqr(oBuilding:GetPosition(), iPos) < iRangeSqr then
                           				return true
                        			end
                    			end
                		end
            		end
        	end
	end
	return false
end

function NightLordsDaemonPrinceTactic:Update()

	if (self:IsComplete()) then
        	return
    	end
    
    	-- State machine
    	if (not InfantryTactic.Update( self )) then
		return
    	end
   
	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end