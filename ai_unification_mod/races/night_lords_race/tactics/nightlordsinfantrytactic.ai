----------------------------------------
-- File: 'nightlordsinfantrytactic.ai'
-- Created by Torzel	@ 18.05.2013
-- Edited by Torzel	@ 06.01.2017
-- Edited by Thudmeizer	@ 28.11.2024

class 'NightLordsInfantryTactic' (InfantryTactic)

NightLordsInfantryAbility =
{
	BlindPanicID = cpu_manager.stats:GetAbilityID("night_lords_blind_panic")
	,BlindPanicEnhancedID = cpu_manager.stats:GetAbilityID("night_lords_enhanced_blind_panic")
	,FragGrenadeID = cpu_manager.stats:GetAbilityID("night_lords_frag_grenades")
	,NightmareGrenadeID = cpu_manager.stats:GetAbilityID("night_lords_nightmare_grenade")
	,MeltaGrenadeID = cpu_manager.stats:GetAbilityID("night_lords_melta_bombs")
}

function NightLordsInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Night Lords Infantry Tactic")
	
	-- Basic night lords infantry is able to enter transport vehicles
	local sSquadName = squad_ai:GetSquadName()

	if (sSquadName == "night_lords_squad_marine" or
			sSquadName == "night_lords_squad_marine_nocap" or
			sSquadName == "night_lords_squad_havoc" or
			sSquadName == "night_lords_squad_night_sister" or
			sSquadName == "night_lords_squad_mawdrym_llansahai" or
			sSquadName == "night_lords_squad_talonmaster" or
			sSquadName == "night_lords_squad_sorcerer" or
			sSquadName == "night_lords_squad_lord") then
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("night_lords_orbital_relay")
		self.m_iTransportable = 1	-- Rhino / Razorback

	-- Units can both deepstrike and enter heavy transports
	elseif (sSquadName == "night_lords_squad_terminator_assault" or
		sSquadName == "night_lords_squad_obliterator") then
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("night_lords_barracks")
		self.m_iTransportable = 2	-- Land Raider
	end

	self.blindPanicLastUse = g_iGMT
	self.blindPanicEnhancedLastUse = g_iGMT
	self.fragGrenadeLastUse = g_iGMT
	self.nightmareGrenadeLastUse = g_iGMT
	self.meltaGrenadeLastUse = g_iGMT
end

function NightLordsInfantryTactic:AddTargetAbilities()
end

function NightLordsInfantryTactic:AddCommanders()
	table.insert(self.commander, { "night_lords_squad_lord", true })
	table.insert(self.commander, { "night_lords_squad_sorcerer", false })
	table.insert(self.commander, { "night_lords_squad_talonmaster", false })
	table.insert(self.commander, { "night_lords_squad_talos", false })
	table.insert(self.commander, { "night_lords_squad_mawdrym_llansahai", false })
end

function NightLordsInfantryTactic:DoAbilities()

	if (self.squad_ai:IsInCombat() and not self.squad_ai:IsCapturing() and not self.squad_ai:IsBroken()) then
	  
		-- Check if I can go berserk while stationary
		if (not self:IsMoving()) then
			local berserk_id = cpu_manager.stats:GetAbilityID( "night_lords_furious_rage" )
			if (self.squad_ai:CanDoAbility( berserk_id )) then
				self.squad_ai:DoSpecialAbility( berserk_id )
			end

			local berserkenhanced_id = cpu_manager.stats:GetAbilityID( "night_lords_enhanced_furious_rage" )
			if (self.squad_ai:CanDoAbility( berserkenhanced_id )) then
				self.squad_ai:DoSpecialAbility( berserkenhanced_id )
			end
		end		
	end

	-- I might have these attached
	if (self.squad_ai:IsAttached()) then
	
		if (self.squad_ai:HasSquadAttached("night_lords_squad_lord")) then
			NightLordsCaptainTactic.InitAbilities( self )
			NightLordsCaptainTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("night_lords_squad_talonmaster")) then
			NightLordsTalonmasterTactic.InitAbilities( self )
			NightLordsTalonmasterTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("night_lords_squad_talos")) then
			NightLordsTalosTactic.InitAbilities( self )
			NightLordsTalosTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("night_lords_squad_mawdrym_llansahai")) then
			NightLordsMawdrymTactic.InitAbilities( self )
			NightLordsMawdrymTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("night_lords_squad_sorcerer")) then
			NightLordsSorcererTactic.InitAbilities( self )
			NightLordsSorcererTactic.DoAbilities( self )
		end
	end

	self:DoThrowGrenades()
	self:DoBlindPanic()

	InfantryTactic.DoAbilities(self)
end

function NightLordsInfantryTactic:DoThrowGrenades()

	if self.squad_ai:IsInCombat() then
		if self.squad_ai:CanDoAbility(NightLordsInfantryAbility.FragGrenadeID) then
			if ( g_iGMT > self.fragGrenadeLastUse + 30 ) then
				if Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.FragGrenadeID, Ability.Filters.CloseSquadEnemy, 1 )
				or Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.FragGrenadeID, Ability.Filters.CloseCommanderEnemy, 1 ) 
				or Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.FragGrenadeID, Ability.Filters.CloseMonsterEnemy, 1 ) then
					self.fragGrenadeLastUse = g_iGMT
				end
			end
		end

		if self.squad_ai:CanDoAbility(NightLordsInfantryAbility.NightmareGrenadeID) then
			if ( g_iGMT > self.nightmareGrenadeLastUse + 30 ) then
				if Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.NightmareGrenadeID, Ability.Filters.CloseSquadEnemy, 1 )
				or Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.NightmareGrenadeID, Ability.Filters.CloseCommanderEnemy, 1 ) 
				or Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.NightmareGrenadeID, Ability.Filters.CloseMonsterEnemy, 1 ) then
					self.nightmareGrenadeLastUse = g_iGMT
				end
			end
		end

		if self.squad_ai:CanDoAbility(NightLordsInfantryAbility.MeltaGrenadeID) then
			if ( g_iGMT > self.meltaGrenadeLastUse + 30 ) then
				if Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.MeltaGrenadeID, Ability.Filters.CloseVehicleEnemy, 1 )
				or Ability.DoAbilityTargetEntity( self.squad_ai, NightLordsInfantryAbility.MeltaGrenadeID, Ability.EntityFilters.CloseBaseEntityEnemy, 1 ) then
					self.meltaGrenadeLastUse = g_iGMT
				end
			end
		end
	end
end

function NightLordsInfantryTactic:DoBlindPanic()

	if self.squad_ai:IsInCombat() then
		if self.squad_ai:CanDoAbility(NightLordsInfantryAbility.BlindPanicID) then
			if ( g_iGMT > self.blindPanicLastUse + 30 ) then
				if Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.BlindPanicID, Ability.Filters.CloseSquadEnemy, 1 )
				or Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.BlindPanicID, Ability.Filters.CloseCommanderEnemy, 1 ) 
				or Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.BlindPanicID, Ability.Filters.CloseMonsterEnemy, 1 ) then
					self.blindPanicLastUse = g_iGMT
				end
			end
		end

		if self.squad_ai:CanDoAbility(NightLordsInfantryAbility.BlindPanicEnhancedID) then
			if ( g_iGMT > self.blindPanicEnhancedLastUse + 30 ) then
				if Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.BlindPanicEnhancedID, Ability.Filters.CloseSquadEnemy, 1 )
				or Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.BlindPanicEnhancedID, Ability.Filters.CloseCommanderEnemy, 1 ) 
				or Ability.DoAbilityTarget( self.squad_ai, NightLordsInfantryAbility.BlindPanicEnhancedID, Ability.Filters.CloseMonsterEnemy, 1 ) then
					self.blindPanicEnhancedLastUse = g_iGMT
				end
			end
		end
	end
end

function NightLordsInfantryTactic:CheckDance(oSquad)

	-- Check opponent
	if (oSquad == nil) then
		return false
	end
	
	-- Compare opponents
	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "night_lords_squad_marine" or sSquadName == "night_lords_squad_terminator_assault") then
		
		-- Check opponent
		if (oSquad:GetSquadName() == "night_lords_squad_raptor_scout") then
			return false
		end
	end
	return true
end