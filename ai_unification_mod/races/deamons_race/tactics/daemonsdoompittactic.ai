----------------------------------------
-- File: 'daemonsdoompittactic.ai'
-- Created by CornCobMan 03/06/2013
-- Heavily edited by Gambit 11/01/2014

class 'DaemonsDoomPitTactic' (BaseTactic)

DaemonsDoomPit = {}

function DaemonsDoomPitTactic:__init( base_ai ) super( base_ai )
	self:SetName("Daemons DoomPit Tactic")
end


-------------------- Functions Needed for the special Daemons Sacrifice abilities----------------------
function CpuManager:FindFirstOwnCommanderWithin( pos, range )
-- Find one own Commander that is not in combat and is not attached.
	local tCommander = nil
	local range_sqr = sqr(range)
	for tCommander in military_manager:GetSquads() do
		if ( tCommander:IsValid() ) then
			local tStats = tCommander:GetStats()
			if ( tStats ~= nil ) then
				local tClass = tStats:GetClass()
				local tName = tStats:GetSquadName()
				-- Juggernaut also excluded, we do not want to be sacrificed by the AI.
				if ( tClass == UnitStatsAI.UC_Commander and ( not (tCommander:IsInCombat() or tName == "daemon_squad_juggernaut" or tCommander:IsAttached()) ) ) then
					local iDistance = distance_sqr(tCommander:GetPosition(), pos)
					if ( iDistance <= range_sqr ) then
						return tCommander
					end
				end
			end
		end
	end
	return tCommander
end



function CpuManager:FindFirstAlliedSacrificeSquadWithin( pos, range )
-- Find an ally infantry (specific types) squad that is of non daemon race, does not have any attachments, is of squad size >5 and not in combat.
	local tSquad = nil
	local range_sqr = sqr(range)
	for tAlly in cpu_manager.stats:GetPlayerStats() do
		if not ( cpu_manager.player_stats:IsEnemy(tAlly) or tAlly:GetPlayerRaceName() == "deamons_race" ) then
			for tSquad in tAlly:GetSquads() do
				if tSquad:IsValid() then
					if ( not tSquad:IsInCombat() ) then
						local tStats = tSquad:GetStats()
						if ( tStats ~= nil ) then
							local tClass = tStats:GetClass()
							if tClass ~= nil then
								if ( tClass == UnitStatsAI.UC_LightInfantryMed or tClass == UnitStatsAI.UC_LightInfantryHigh or tClass == UnitStatsAI.UC_HeavyInfantryMed ) and ( tSquad:GetNumTroopers() > 5 ) then
									local iDistance = distance_sqr(tSquad:GetPosition(), pos)
									if ( iDistance <= range_sqr ) then
										local tSquadName = tSquad:GetSquadName()
										if not ( tSquadName == "blood_angel_squad_death_company" or tSquadName == "blood_angel_squad_assault_death_company" or tSquad:IsAttached() ) then
											return tSquad
										end
									end
								end
							end
						end
					end
				end				
			end		
		end
	end
	return tSquad
end
---------------------------------------------------------------------------------------------------


function DaemonsDoomPitTactic:InitAbilities()

	-- Init abilities
	if (DaemonsDoomPit.pit_khorne_id == nil) then
		DaemonsDoomPit.pit_khorne_id = cpu_manager.stats:GetAbilityID( "daemons_pit_ability_khorne" )
	end

	if (DaemonsDoomPit.pit_nurgle_id == nil) then
		DaemonsDoomPit.pit_nurgle_id = cpu_manager.stats:GetAbilityID( "daemons_pit_ability_nurgle" )
	end

	if (DaemonsDoomPit.pit_slaanesh_id == nil) then
		DaemonsDoomPit.pit_slaanesh_id = cpu_manager.stats:GetAbilityID( "daemons_pit_ability_slaanesh" )
	end

	if (DaemonsDoomPit.pit_tzeentch_id == nil) then
		DaemonsDoomPit.pit_tzeentch_id = cpu_manager.stats:GetAbilityID( "daemons_pit_ability_tzeentch" )
	end

	if (DaemonsDoomPit.pit_undivided_id == nil) then
		DaemonsDoomPit.pit_undivided_id = cpu_manager.stats:GetAbilityID( "daemons_pit_ability_undivided" )
	end

	if (DaemonsDoomPit.pit_sacrifice_minions_id == nil) then
		DaemonsDoomPit.pit_sacrifice_minions_id = cpu_manager.stats:GetAbilityID( "daemons_sacrifice_minions" )
	end

	if (DaemonsDoomPit.pit_sacrifice_gdaemons_id == nil) then
		DaemonsDoomPit.pit_sacrifice_gdaemons_id = cpu_manager.stats:GetAbilityID( "daemons_sacrifice_daemons" )
	end
	
	if (DaemonsDoomPit.pit_sacrifice_minions_old_id == nil) then
		DaemonsDoomPit.pit_sacrifice_minions_old_id = cpu_manager.stats:GetAbilityID( "daemons_sacrifice_minions_old" )
	end

	if (DaemonsDoomPit.pit_sacrifice_gdaemons_old_id == nil) then
		DaemonsDoomPit.pit_sacrifice_gdaemons_old_id = cpu_manager.stats:GetAbilityID( "daemons_sacrifice_daemons_old" )
	end

end


function DaemonsDoomPitTactic:DoAbilities()

	local abilitySelector = math.random(1, 100)
	local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )

	if( abilitySelector <= 25) then
		if ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_khorne_id) and iPower >= 250 ) then
			Ability.DoAbilityTarget( self.base_ai, DaemonsDoomPit.pit_khorne_id, Ability.Filters.CloseInCombat, 4 )
		end
	elseif( abilitySelector <= 50) then
		if ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_nurgle_id) and iPower >= 250 ) then
			Ability.DoAbilityTarget( self.base_ai, DaemonsDoomPit.pit_nurgle_id, Ability.Filters.CloseInCombat, 4 )
		end
	elseif( abilitySelector <= 75) then
		if ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_slaanesh_id) and iPower >= 250 ) then
			-- Try to activate the ability, first against Commanders, then against Infantry	
			local iRange = self.base_ai:GetAbilityRange(DaemonsDoomPit.pit_slaanesh_id)
			local oSquad = Ability.Filters.CloseCommanderEnemy(self.base_ai:GetPosition(), iRange, 1)
			if oSquad ~= nil then
				if oSquad:IsInCombat() then
					self.base_ai:DoSpecialAbilitySquad(DaemonsDoomPit.pit_slaanesh_id, oSquad:GetSquad())
				end
			else
				oSquad = Ability.Filters.CloseInfantryEnemy(self.base_ai:GetPosition(), iRange, 1)
				if oSquad ~= nil then
					if oSquad:IsInCombat() then
						self.base_ai:DoSpecialAbilitySquad(DaemonsDoomPit.pit_slaanesh_id, oSquad:GetSquad())
					end
				end
			end
		end
	else
		if ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_tzeentch_id) and iPower >= 250 ) then
			Ability.DoAbilityTarget( self.base_ai, DaemonsDoomPit.pit_tzeentch_id, Ability.Filters.CloseInCombat, 4 )
		end
	end


	if ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_undivided_id) and iPower >= 300 ) then
		local iRange = self.base_ai:GetAbilityRange(DaemonsDoomPit.pit_undivided_id)
		local oSquad = cpu_manager.cpu_player:FindFirstHurtSquad(self.base_ai:GetPosition(), iRange)
		if ( oSquad ~= nil ) then
			if ( oSquad:IsInCombat() and oSquad:IsBroken() ) then
				local oStats = oSquad:GetStats()
				if (oStats ~= nil) then
					local eClass = oStats:GetClass()
					if eClass == UnitStatsAI.UC_MonsterMed then
						self.base_ai:DoSpecialAbilitySquad(DaemonsDoomPit.pit_undivided_id, oSquad:GetSquad())
					end
				end
			end
		end
	end

	-- Do a sacrifice
	if iPower >= 2500 and (build_manager:GetSquadCapLeft() < 3 or build_manager:GetSupportCapLeft() < 2) then
		-- Sacrifice ALLY Squad!
		if ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_sacrifice_minions_id) ) then
			local iRange = self.base_ai:GetAbilityRange(DaemonsDoomPit.pit_sacrifice_minions_id)
			local oSquad = CpuManager:FindFirstAlliedSacrificeSquadWithin(self.base_ai:GetPosition(), iRange)
			if ( oSquad ~= nil ) then
				self.base_ai:DoSpecialAbilitySquad(DaemonsDoomPit.pit_sacrifice_minions_id, oSquad:GetSquad())
			end
		elseif ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_sacrifice_gdaemons_id) ) then
			local iRange = self.base_ai:GetAbilityRange(DaemonsDoomPit.pit_sacrifice_gdaemons_id)
			local oSquad = CpuManager:FindFirstAlliedSacrificeSquadWithin(self.base_ai:GetPosition(), iRange)
			if ( oSquad ~= nil ) then
				self.base_ai:DoSpecialAbilitySquad(DaemonsDoomPit.pit_sacrifice_gdaemons_id, oSquad:GetSquad())
			end
		-- Sacrifice your own Commander!
		elseif ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_sacrifice_minions_old_id) ) then
			local iRange = self.base_ai:GetAbilityRange(DaemonsDoomPit.pit_sacrifice_minions_old_id)
			local oSquad = cpu_manager:FindFirstOwnCommanderWithin(self.base_ai:GetPosition(), iRange)
			if ( oSquad ~= nil ) then
				-- Check for assassinate, as we do not want to destroy our own commander, to our demise!!!
				local eName = (oSquad:GetStats()):GetSquadName()
				if not ( cpu_manager.assassinate and eName == "daemon_squad_lord" ) then
					self.base_ai:DoSpecialAbilitySquad(DaemonsDoomPit.pit_sacrifice_minions_old_id, oSquad:GetSquad())
				end
			end
		elseif ( self.base_ai:CanDoAbility(DaemonsDoomPit.pit_sacrifice_gdaemons_old_id) ) then
			local iRange = self.base_ai:GetAbilityRange(DaemonsDoomPit.pit_sacrifice_gdaemons_old_id)
			local oSquad = cpu_manager:FindFirstOwnCommanderWithin(self.base_ai:GetPosition(), iRange)
			if ( oSquad ~= nil ) then
				-- Check for assassinate, as we do not want to destroy our own commander, to our demise!!!
				local eName = (oSquad:GetStats()):GetSquadName()
				if not ( cpu_manager.assassinate and eName == "daemon_squad_lord" ) then
					self.base_ai:DoSpecialAbilitySquad(DaemonsDoomPit.pit_sacrifice_gdaemons_old_id, oSquad:GetSquad())
				end
			end
		end
	end
end
