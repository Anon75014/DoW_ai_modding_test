----------------------------------------
-- File: 'RavenGuardSpaceMarineInfantryTactic.ai'
-- Created by Arkhan		@ 12.01.2006
-- Edited by Thudmeizer         @ 31.08.2025

class 'RavenGuardSpaceMarineInfantryTactic' (InfantryTactic)

function RavenGuardSpaceMarineInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Raven Guard Space Marine Infantry Tactic")
	
	-- Set infantry options
	local sSquadName = squad_ai:GetSquadName()
	
	if (sSquadName == "raven_guard_space_marine_squad_tactical" or
			sSquadName == "raven_guard_space_marine_squad_intoner_zero" or
			sSquadName == "raven_guard_space_marine_squad_eliminator" or
			sSquadName == "raven_guard_space_marine_squad_clerg" or
			sSquadName == "raven_guard_space_marine_squad_mor_dethayn" or
			sSquadName == "raven_guard_space_marine_squad_sternguard_veteran") then
		
		-- Squads are transportable and able to deepstrike	
		self.m_iTransportable = 1	-- Rhino / Thunderhawk
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("raven_guard_space_marine_orbital_relay")

	elseif (sSquadName == "raven_guard_space_marine_squad_scout") then
		
		-- Squads are transportable
		self.m_iTransportable = 2	-- Land Speeder Storm

	elseif (sSquadName == "raven_guard_space_marine_squad_assault" or 
			sSquadName == "raven_guard_space_marine_squad_chaplain" or 
			sSquadName == "raven_guard_space_marine_squad_chapter_master" or 
			sSquadName == "raven_guard_space_marine_squad_force_commander" or 
			sSquadName == "raven_guard_space_marine_squad_librarian" or 
			sSquadName == "raven_guard_space_marine_squad_vanguard_veteran") then

		-- Squads are able to deepstrike
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("raven_guard_space_marine_hq")

		
	elseif (sSquadName == "raven_guard_space_marine_squad_terminator" or
			sSquadName == "raven_guard_space_marine_squad_centurion_assault") then
		
		-- Squads are transportable and able to deepstrike	
		self.m_iTransportable = 3	-- Thunderhawk
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("raven_guard_space_marine_orbital_relay")
	end
end

function RavenGuardSpaceMarineInfantryTactic:AddTargetAbilities()
	table.insert(InfantryTactic.TargetAbilities, { nil, "raven_guard_frag_grenades", Ability.Filters.CloseSquadEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "raven_guard_melta_bombs", Ability.Filters.CloseVehicleEnemy, 1, 0 })
end

function RavenGuardSpaceMarineInfantryTactic:AddCommanders()
	table.insert(self.commander, { "raven_guard_space_marine_squad_force_commander", true })
	table.insert(self.commander, { "raven_guard_space_marine_squad_chapter_master", false })
	table.insert(self.commander, { "raven_guard_space_marine_squad_librarian", false })
	table.insert(self.commander, { "raven_guard_space_marine_squad_chaplain", false })
	table.insert(self.commander, { "raven_guard_space_marine_squad_intoner_zero", false })
end

function RavenGuardSpaceMarineInfantryTactic:DoAbilities()

	-- I might have these attached
	if (self.squad_ai:IsAttached()) then
	
		if (self.squad_ai:HasSquadAttached("raven_guard_space_marine_squad_chapter_master")) then
			RavenGuardChapterMasterTactic.InitAbilities( self )
			RavenGuardChapterMasterTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("raven_guard_space_marine_squad_force_commander")) then
			RavenGuardForceCommanderTactic.InitAbilities( self )
			RavenGuardForceCommanderTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("raven_guard_space_marine_squad_librarian")) then
			RavenGuardLibrarianTactic.InitAbilities( self )
			RavenGuardLibrarianTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("raven_guard_space_marine_squad_chaplain")) then
			RavenGuardChaplainTactic.InitAbilities( self )
			RavenGuardChaplainTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("raven_guard_space_marine_squad_skull_probe")) then
			RavenGuardSkullProbeTactic.InitAbilities( self )
			RavenGuardSkullProbeTactic.DoAbilities( self )
		end
	end

	-- Check to make sure if no threats are nearby
	if not (self.squad_ai:IsInCombat()) and not (self.squad_ai:IsUnderAttack()) then

		-- If I am safe I can sprint
		local run_id = cpu_manager.stats:GetAbilityID( "raven_guard_infantry_sprint" )
		if (self.squad_ai:CanDoAbility( run_id )) then
			self.squad_ai:DoSpecialAbility( run_id )
		end
		local runB_id = cpu_manager.stats:GetAbilityID( "raven_guard_infantry_sprint_2" )
		if (self.squad_ai:CanDoAbility( runB_id )) then
			self.squad_ai:DoSpecialAbility( runB_id )
		end
		local runC_id = cpu_manager.stats:GetAbilityID( "raven_guard_infantry_sprint_3" )
		if (self.squad_ai:CanDoAbility( runC_id )) then
			self.squad_ai:DoSpecialAbility( runC_id )
		end
	end

	-- Check to make sure if threats are nearby
	if self.squad_ai:IsInCombat() then

		-- If I can infiltrate when enemies are close
		local iPos = self.squad_ai:GetPosition()
		local oTarget = Ability.Filters.CloseEnemy(iPos, 10, 1)
		local infiltration_id = cpu_manager.stats:GetAbilityID( "raven_guard_infantry_infiltration" )
		if oTarget ~= nil and oTarget:IsValid() then
			if (self.squad_ai:CanDoAbility( infiltration_id )) then
				self.squad_ai:DoSpecialAbility( infiltration_id )
			end
		end

		-- If I can extend infiltration when enemies are close
		local iPos = self.squad_ai:GetPosition()
		local oTarget = Ability.Filters.CloseEnemy(iPos, 10, 1)
		local infiltrationB_id = cpu_manager.stats:GetAbilityID( "raven_guard_infantry_infiltration_extended" )
		if oTarget ~= nil and oTarget:IsValid() then
			if (self.squad_ai:CanDoAbility( infiltrationB_id )) then
				self.squad_ai:DoSpecialAbility( infiltrationB_id )
			end
		end

		-- If I can extend infiltration when enemies are close
		local iPos = self.squad_ai:GetPosition()
		local oTarget = Ability.Filters.CloseEnemy(iPos, 10, 1)
		local infiltrationC_id = cpu_manager.stats:GetAbilityID( "raven_guard_infantry_infiltration_extended_2" )
		if oTarget ~= nil and oTarget:IsValid() then
			if (self.squad_ai:CanDoAbility( infiltrationC_id )) then
				self.squad_ai:DoSpecialAbility( infiltrationC_id )
			end
		end
	end
	
	-- Call basic DoAbilities methods
	InfantryTactic.DoAbilities(self)
end

function RavenGuardSpaceMarineInfantryTactic:CheckForBroken()

	if (self.squad_ai:IsBroken()) then
	
		-- Check if I can repair my morale
		local rally_id = cpu_manager.stats:GetAbilityID( "raven_guard_rally" )
		if (self.squad_ai:CanDoAbility( rally_id )) then
			self.squad_ai:DoSpecialAbility( rally_id )
		end
	end
	
	-- Call basic broken check method
	InfantryTactic.CheckForBroken(self)
end

function RavenGuardSpaceMarineInfantryTactic:CheckDance(oSquad)

	-- Check opponent
	if (oSquad == nil) then
		return false
	end
	
	-- Compare opponents
	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "raven_guard_space_marine_squad_tactical" or sSquadName == "raven_guard_space_marine_squad_terminator") then
		
		-- Check opponent
		if (oSquad:GetSquadName() == "chaos_squad_cultist") then
			return false
		end
	end
	return true
end

function RavenGuardSpaceMarineInfantryTactic:Upgrade()

	-- Check if we have free resources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- Don't upgrade space marine squads with less than 6 troopers
	if (self.squad_ai:GetSquadName() == "raven_guard_space_marine_squad_tactical" and self.squad_ai:GetNumTroopers() < 6) then
		return
	end
	
	if (not self.squad_ai:IsReinforcing() and self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 3) then
		
		-- Figure out my enemy's favourite class
		local enemy = cpu_manager:FindClosestEnemyPlayer()
		if (enemy == nil) then
			return
		end
		local class_type = enemy:GetMajorityClassType()
		
		-- Larkins hard counter upgrade for HeavyInfantryMed 
		if (class_type < UnitStatsAI.UC_HeavyInfantryMed) then	  
		  
			local enemy_race = enemy:GetPlayerRaceName()
			if (enemy_race == "space_marine_race" or enemy_race == "chaos_marine_race" or enemy_race == "necron_race") then
		    	class_type = UnitStatsAI.UC_HeavyInfantryMed
		  	end
		end
		
		-- Do best upgrade
		self.squad_ai:DoBestUpgrade(class_type)
	end
end