----------------------------------------
-- File: 'Praetorian_LieutenantTactic.ai'
-- Edited by Thudmeizer 20.05.2024

class 'Praetorian_LieutenantTactic' (Praetorian_InfantryTactic)

Praetorian_Lieutenant = {}

function Praetorian_LieutenantTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Praetorian Lieutenant Tactic")
end

-- Assassinate win condition -- never attack
function Praetorian_LieutenantTactic:IsAttacker()
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

-- Assassinate win condition -- never defend
function Praetorian_LieutenantTactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end

function Praetorian_LieutenantTactic:InitAbilities()

	-- Init ability ID's
	if Praetorian_Lieutenant.detection_id == nil then
		Praetorian_Lieutenant.detection_id = cpu_manager.stats:GetAbilityID( "praetorian_detection_field" )
	end
	if Praetorian_Lieutenant.fof_id == nil then
		Praetorian_Lieutenant.fof_id = cpu_manager.stats:GetAbilityID( "praetorian_fof" )
	end
	if Praetorian_Lieutenant.ram_id == nil then
		Praetorian_Lieutenant.ram_id = cpu_manager.stats:GetAbilityID( "praetorian_3ram" )
	end
end

function Praetorian_LieutenantTactic:DoAbilities()

	-- Check for infiltrated enemy
	local oEnemy = Ability.Filters.CloseInfiltratedEnemy(self.squad_ai:GetPosition(), 120, 1)
	if oEnemy ~= nil then
		local vEnemyPos = Vector3f(oEnemy:GetPosition())
		self.squad_ai:DoSpecialAbilityPos(Praetorian_Lieutenant.detection_id, vEnemyPos)
	end

	if (self.squad_ai:CanDoAbility(Praetorian_Lieutenant.fof_id)) then
		local range = self.squad_ai:GetAbilityRange( Praetorian_Lieutenant.fof_id )	
		local squad_filter = function( squad_ai )		
			return squad_ai:IsInCombat() and squad_ai:IsInStateAttackMove() and 
					squad_ai:GetNumTroopers() >= 4 and not squad_ai:IsBroken() and
					not squad_ai:IsCapturing()
		end	
   		local target_squad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
		if (target_squad ~= nil) then
			self.squad_ai:DoSpecialAbilitySquad( Praetorian_Lieutenant.fof_id, target_squad:GetSquad() )
 		end
	end

	if (self.squad_ai:CanDoAbility(Praetorian_Lieutenant.ram_id)) then
		local range = self.squad_ai:GetAbilityRange( Praetorian_Lieutenant.ram_id )	
		local squad_filter = function( squad_ai )		
			return squad_ai:IsInCombat() and squad_ai:IsInStateAttackMove() and 
					squad_ai:GetNumTroopers() >= 4 and not squad_ai:IsBroken() and
					not squad_ai:IsCapturing()
		end	
   		local target_squad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
		if (target_squad ~= nil) then
			self.squad_ai:DoSpecialAbilitySquad( Praetorian_Lieutenant.ram_id, target_squad:GetSquad() )
 		end
	end
end

function Praetorian_LieutenantTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Assassinate win condition -- never attach to a squad otherwise always attach immediately when in combat or hurt
    	if (not cpu_manager.assassinate) then
         
        	if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then

			-- Attach to squad
			self:TryAttachSquad(false, false, 1000, 60, nil)
		end
    	end
end