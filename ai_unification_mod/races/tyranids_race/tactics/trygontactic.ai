----------------------------------------
-- File: 'Trygontactic.ai'
-- Created by Thudmeizer @ 27.03.2025

class 'TrygonTactic' (TyranidInfantryTactic)

Trygon = {}

function TrygonTactic:__init( squad_ai ) super( squad_ai )

       self:SetName("Trygon Tactic")

       self.timedDirectSpawnAbility = Timer( TrygonTactic.DoDirectSpawnAbility, self, 5 )
end

-- Trygon is allowed to retreat even directly after a jump
function TrygonTactic:SetTarget( target, variant_type )

	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

function TrygonTactic:JumpAttack()
	Tactic.JumpAttack(self)
end

function TrygonTactic:AlwaysAttack()
	return true
end

function TrygonTactic:InitAbilities()

	 if Trygon.storm_id == nil then
		Trygon.storm_id = cpu_manager.stats:GetAbilityID( "tyranids_trygon_electric_aura" )
	 end
end

function TrygonTactic:DoAbilities()

	-- Do not perform the abilities if we need to reserve Influence
	-- if TyranidsReserveFaithResource then return end

	if self.squad_ai:IsInCombat() and self.squad_ai:CanDoAbility(Trygon.storm_id) then
		if cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), 12, 5) ~= nil then
			self.squad_ai:DoSpecialAbility(Trygon.storm_id)
		end
	end

	-- Try to spawn Ravener guards
	if (self.timedDirectSpawnAbility ~= nil) then
		self.timedDirectSpawnAbility:Call()
	else
		TrygonTactic.DoDirectSpawnAbility(self)
	end

	-- New code to unstuck units with pathing issues, that can jump.
	-- Call it with [true], only for multi-membered squads.
	self:SolveStuckCase(false)
end

function TrygonTactic:DoDirectSpawnAbility()

	-- Spawn Ravener guards in combat
	if (self.squad_ai:CanDirectSpawn()) then 
		self.squad_ai:DoDirectSpawn()
	end
end

function TrygonTactic:Update()

	if self:IsComplete() then
		return
	end
	
	  --state machine
	  if not InfantryTactic.Update( self ) then
		 return
	  end

	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end