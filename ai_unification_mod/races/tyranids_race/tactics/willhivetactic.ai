----------------------------------------
-- File: 'WillHivetactic.ai'
-- Edited by Gambit @ 26.082.2016

class 'WillHiveTactic' (EngineerTactic)

WillHive = {}

function WillHiveTactic:__init( squad_ai ) super( squad_ai )
	self:SetName("Will of the Hive Tactic")
	Tyranids_MagmaVentID = cpu_manager.stats:GetBuildingID( "tyranids_adv_magma_vent" )
	Tyranids_SporeChimneyID = cpu_manager.stats:GetBuildingID( "tyranids_spore_chimney" )
	Tyranids_TrygonLairID = cpu_manager.stats:GetBuildingID( "tyranids_relic_hive" )
	Tyranids_CapillaryTowerID = cpu_manager.stats:GetBuildingID( "tyranids_capillary_tower" )
	Tyranids_ShadowIntheWarpID = cpu_manager.stats:GetAbilityID( "tyranids_g_shadow_in_the_warp" )
	self.builderUpdateTMR = g_iGMT
	self.directSpawnTMR = g_iGMT
	self.previousTargetSquadID = 0
	self.previousHurtSquadID = 0
	Map_Center_Pos = self.squad_ai:GetPosition(); Map_Center_Pos.x = 0; Map_Center_Pos.z = 0
	self.magmaVents = 0
	self.sporeChimneys = 0
	self.trygonLairs = 0
	self.capillaryTowers = 0
end


function WillHiveTactic:CanRepair()
	return false
end


function WillHiveTactic:IsAffectedByMorale()
	return false
end


function WillHiveTactic:InitAbilities()
	 if WillHive.warpshadow_id == nil then
		WillHive.warpshadow_id = cpu_manager.stats:GetAbilityID( "tyranids_g_shadow_in_the_warp" )
		WillHive.globalability_id = cpu_manager.stats:GetAbilityID( "tyranids_g_jones" )
		WillHive.beacon_id = cpu_manager.stats:GetAbilityID( "tyranids_g_synaptic_beacon" )
		WillHive.what_id = cpu_manager.stats:GetAbilityID( "tyranids_g_what_the" )
	 end
end


function WillHiveTactic:DoAbilities()

	-- First, always perform builder tasks
	self:PerformBuilderTasks()

	-- Do not perform the abilities if we need to reserve Influence, or we are building
	if TyranidsReserveFaithResource then
		return
	end

	-- Try to spawn and then Deep Strike Spore Clusters
	--[[ NOTE: Ability moved from Builder to LPs, but I leave it here in case we change our minds
	if (g_iGMT > self.directSpawnTMR + 8 and self.squad_ai:CanDirectSpawn()) then
		local iInfluence = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Faith )
		local tier = cpu_manager:GetTierLevel()
		if (tier == 1 and iInfluence > 40) or (tier == 2 and iInfluence > 65) or iInfluence > 90 then
			self.squad_ai:DoDirectSpawn()
			self.directSpawnTMR = g_iGMT
			-- Every now and then, also reset the targeting stats
			self.previousTargetSquadID = 0
			self.previousHurtSquadID = 0
			return
		end
	end]]

	-- Try to do one of the 4 abilities
	if self.squad_ai:CanDoAbility(WillHive.warpshadow_id) then
		if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Faith ) > 25 then
			-- Only activate if enemy unit is attacking
			local oSquad = Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 256, 1)
			if (oSquad ~= nil and oSquad:IsAttacking()) then
				self.squad_ai:DoSpecialAbilitySquad(WillHive.warpshadow_id, oSquad:GetSquad())
				return
			end
		end
	end
	if self.squad_ai:CanDoAbility(WillHive.globalability_id) then
		if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Faith ) > 50 then
			-- Only activate if enemy unit is attacking
			local oSquad = Ability.Filters.CloseInfantryEnemy(self.squad_ai:GetPosition(), 256, 1)
			if oSquad ~= nil then
				if oSquad:IsAttacking() then
					self.squad_ai:DoSpecialAbilitySquad(WillHive.globalability_id, oSquad:GetSquad())
					return
				end
			else
				oSquad = Ability.Filters.CloseMonsterEnemy(self.squad_ai:GetPosition(), 256, 1)
				if oSquad ~= nil then
					if oSquad:IsAttacking() then
						self.squad_ai:DoSpecialAbilitySquad(WillHive.globalability_id, oSquad:GetSquad())
						return
					end
				end
			end
		end
	end
	if self.squad_ai:CanDoAbility(WillHive.beacon_id) then
		local influence = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Faith )
		if influence > 25 then
			local broken_squads = 0
			for oSquad in military_manager:GetSquads() do
				if oSquad:IsValid() and oSquad:IsBroken() then
					broken_squads = broken_squads + 1
				end
			end
			if broken_squads > 2 or (influence > 50 and broken_squads > 1) then
				self.squad_ai:DoSpecialAbility(WillHive.beacon_id)
				return
			end
		end
	end
	if self.squad_ai:CanDoAbility(WillHive.what_id) then
		if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Faith ) > 35 then
			for oSquad in military_manager:GetSquads() do
				if oSquad:IsValid() and oSquad:IsInCombat() and oSquad:WasRecentlyHurt() then
					local oPos = oSquad:GetPosition()
					local oVehicle = Ability.Filters.CloseVehicleEnemy(oPos, 30, 1)
					if oVehicle ~= nil and oVehicle:IsValid() then
						self.squad_ai:DoSpecialAbilitySquad(WillHive.what_id, oVehicle:GetSquad())
						return
					end
				end
			end
		end
	end

	-- If we have a previously spawn/held Spore Cluster, just DS it offensively.
	for e in self.squad_ai:GetEntities() do
		local build_channel = build_manager:GetBuildChannelFromID(e:GetID())
		-- The entity must have a spawner_ext in AE (empty), orelse the build_channel will ALWAYS be nil!
		if build_channel ~= nil then
			if build_channel:CanDeepStrike() then
				local oHurtSquad = cpu_manager.cpu_player:FindFirstHurtSquad( Map_Center_Pos, 640 )
				if oHurtSquad ~= nil and oHurtSquad:GetID() ~= self.previousHurtSquadID then
					self.previousHurtSquadID = oHurtSquad:GetID()
					local pos = oHurtSquad:GetPosition()
					local oEnemy = Ability.Filters.CloseInfiltrator(pos, 40, 1)
					if oEnemy ~= nil and oEnemy:GetID() ~= self.previousTargetSquadID then
						self.previousTargetSquadID = oEnemy:GetID()
						pos = oEnemy:GetPosition()
						build_channel:DoDeepStrikeToPos(pos)
						return
					else oEnemy = Ability.Filters.CloseEnemy(pos, 40, 1)
						if oEnemy ~= nil and oEnemy:GetID() ~= self.previousTargetSquadID then
							self.previousTargetSquadID = oEnemy:GetID()
							pos = oEnemy:GetPosition()
							build_channel:DoDeepStrikeToPos(pos)
							return
						end
					end
				end
			end
		end
	end
end



function WillHiveTactic:PerformBuilderTasks()
	-- Special method to FORCE-build a Listening Post, because they are crucial
	--  and must be built as desired! The AI does not build them otherwise anyway...
	if g_iGMT > self.builderUpdateTMR + 3 then
		local iInfluenceRate = resource_manager:GetResourceRate( ResourceAmount.RT_Faith )
		local iReq = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
		if not (iInfluenceRate > 9 and iReq < 800) then
			if iReq > 500 or (iReq > 125 and iInfluenceRate < 3.6) then
				local list_post = self:GetSafeClosestCapturedUnbuiltPost()
				if list_post ~= nil then
					-- Try to build
					self.squad_ai:DoBuildBuilding(Tyranids_SporeChimneyID, list_post)
					self.builderUpdateTMR = g_iGMT
					return
				end
			end
		end
	end

	local tier = cpu_manager:GetTierLevel()

	-- Special method to build an Magma Vents (Big Gen), because of the nature of the Tyranids Builder.
	-- Do it IF we have no Magma Vents, OR more seldom if we do (we want allies to have big gens as well!)
	if tier > 1 then
		if g_iGMT > self.builderUpdateTMR + 3 then
			if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Faith ) > 55 then
				-- Additional conditions
				if self.magmaVents < 2 and (resource_manager:GetResourceRate( ResourceAmount.RT_Requisition ) < 160
				or resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition ) < 1200) then
					local slug_pos = self:GetSafeClosestSlugToHive()
					if slug_pos ~= nil then
						-- Try to build
						self.squad_ai:DoBuildBuilding(Tyranids_MagmaVentID, slug_pos)
						self.builderUpdateTMR = g_iGMT
						return
					end
				end
			end
		end
	end

	-- Special method to accelerate tiering, because of the nature of the Tyranids Builder is a bit... lazy!
	-- The Trygon Lair is not an actual requirement for the Capillary Tower (T4 building), but we better try building it first.
	if tier > 2 then
		if self.trygonLairs == 0 and g_iGMT > self.builderUpdateTMR + 3 then
			if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Faith ) > 65 then
				local build_pos = self:GetValidTrygonLairBuildPosition()
				if build_pos ~= nil then
					-- Try to build
					self.squad_ai:DoBuildBuilding(Tyranids_TrygonLairID, build_pos)
					self.builderUpdateTMR = g_iGMT
					return
				end
			end
		elseif self.capillaryTowers == 0 and self.builderUpdateTMR + 3 then
			if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Faith ) > 85 then
				local build_pos = self:GetValidCapillaryTowerBuildPosition()
				if build_pos ~= nil then
					-- Try to build
					self.squad_ai:DoBuildBuilding(Tyranids_CapillaryTowerID, build_pos)
					self.builderUpdateTMR = g_iGMT
					return
				end
			end
		end
	end
end


function WillHiveTactic:ValidMove( vDestination )
	aitrace("Move Engineer to "..tostring(vDestination.x)..", "..tostring(vDestination.z))
	self.squad_ai:DoMove(vDestination)
end


function WillHiveTactic:Update()

	-- State machine
	if not InfantryTactic.Update(self) then
		return false
	end

	-- First, update buildings stats
	self:GetTyranidsBuildingsNumbers()

	self.m_vDestination = nil
	self.m_bBusy = false
	self.tagged_flag = nil
	--self.tagged_flag:TagFlagForEngineer( false )	
	return true
end


function WillHiveTactic:GetSafeClosestCapturedUnbuiltPost()
	local post_table = {}
	for list_post in resource_manager:GetStrategicPointAIs() do
		if not (list_post:IsStrategicObjective() or list_post:Owner()~= cpu_manager.player_id or list_post:HasListeningPost()) then
			local post_pos = list_post:GetPosition()
			if not cpu_manager.terrain_analyzer:HasThreat( post_pos, 35 ) then
				local dist = cpu_manager:GetShortestPathingDistance( cpu_manager.start_pos, post_pos, true)
				if self.squad_ai:CanBuild(Tyranids_SporeChimneyID) == SquadAI.CANBUILD_Ok
				and self.squad_ai:CanBuildAt(Tyranids_SporeChimneyID, post_pos) then
					table.insert( post_table, {post_pos, dist} ) 
				end
			end
		end
	end
	if table.getn(post_table) > 0 then
		sortfunc = function( item1, item2 )					
			return item1[2] < item2[2]
		end
		table.sort( post_table, sortfunc )
		return post_table[1][1]
	end
	return nil
end


function WillHiveTactic:GetSafeClosestSlugToHive()
	resource_manager:UpdateFreeSlagHeaps(Tyranids_MagmaVentID)
	local slag_table = {}
	for slag_heap in resource_manager:GetSlagHeaps() do
		local slag_pos = slag_heap:GetPosition()
		if not cpu_manager.terrain_analyzer:HasThreat( slag_pos, 35 ) then
			local dist = cpu_manager:GetShortestPathingDistance( cpu_manager.start_pos, slag_pos, true)
			if self.squad_ai:CanBuild(Tyranids_MagmaVentID) == SquadAI.CANBUILD_Ok
			and self.squad_ai:CanBuildAt(Tyranids_MagmaVentID, slag_pos) then
				table.insert( slag_table, {slag_pos, dist} ) 
			end
		end
	end
	if table.getn(slag_table) > 0 then
		sortfunc = function( item1, item2 )					
			return item1[2] < item2[2]
		end
		table.sort( slag_table, sortfunc )
		return slag_table[1][1]
	end
	return nil
end


function WillHiveTactic:GetValidTrygonLairBuildPosition()
	local pos = cpu_manager.start_pos
	if self.squad_ai:CanBuild(Tyranids_TrygonLairID) == SquadAI.CANBUILD_Ok
	and not cpu_manager.terrain_analyzer:HasThreat( pos, 40 ) then
		for i=1, 6 do
			pos.x = pos.x + math.random(-20, 20)
			pos.z = pos.z + math.random(-20, 20)
			if self.squad_ai:CanBuildAt(Tyranids_TrygonLairID, pos) then
				return pos
			end
		end
	end
	return nil
end


function WillHiveTactic:GetValidCapillaryTowerBuildPosition()
	local centre_pos = cpu_manager.start_pos; centre_pos.x=0;centre_pos.y=0;centre_pos.z=0
	local build_candidates = {}
	local dist = 0
	for oBuilding in military_manager:GetBases() do
		if oBuilding:IsValid() then
			local pos = oBuilding:GetPosition()
			if self.squad_ai:CanBuild(Tyranids_CapillaryTowerID) == SquadAI.CANBUILD_Ok
			and not cpu_manager.terrain_analyzer:HasThreat( pos, 40 ) then
				for i=1, 3 do
					pos.x = pos.x + math.random(-20, 20)
					pos.z = pos.z + math.random(-20, 20)
					if self.squad_ai:CanBuildAt(Tyranids_CapillaryTowerID, pos) then
						dist = distance(centre_pos, pos)
						table.insert( build_candidates, {pos, dist*dist} )
					end
				end
			end
		end
	end
	if table.getn(build_candidates) > 0 then
		sortfunc = function( item1, item2 )					
			return item1[2] < item2[2]
		end
		table.sort( build_candidates, sortfunc )
		return build_candidates[1][1]
	end
	return nil
end


function WillHiveTactic:GetTyranidsBuildingsNumbers()
	self.magmaVents = 0
	self.sporeChimneys = 0
	self.trygonLairs = 0
	self.capillaryTowers = 0
	for oBuilding in military_manager:GetBases() do
		if oBuilding:IsValid() then
			local oName = oBuilding:GetBaseName()
			if oName == "tyranids_adv_magma_vent" then
				self.magmaVents = self.magmaVents + 1
			elseif oName == "tyranids_spore_chimney" then
				self.sporeChimneys = self.sporeChimneys + 1
			elseif oName == "tyranids_relic_hive" then
				self.trygonLairs = self.trygonLairs + 1
			elseif oName == "tyranids_capillary_tower" then
				self.capillaryTowers = self.capillaryTowers + 1
			end
		end
	end
end
