----------------------------------------
-- File: 'HiveTyranttactic.ai'
-- Edited by Thudmeizer @ 10.10.2023

class 'HiveTyrantTactic' (TyranidInfantryTactic)

HiveTyrant = {}

function HiveTyrantTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Hive Tyrant Tactic")
end

function HiveTyrantTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function HiveTyrantTactic:IsDefender()
	return self:IsCommanderDefender()
end

-- Commander is allowed to retreat even directly after a jump
function HiveTyrantTactic:SetTarget( target, variant_type )

	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

function HiveTyrantTactic:JumpAttack()
	Tactic.JumpAttack(self)
end

function HiveTyrantTactic:InitAbilities()

	 if HiveTyrant.leech_id == nil then
		HiveTyrant.leech_id = cpu_manager.stats:GetAbilityID( "tyranids_hivetyrant_leech_essence" )
	 end

	 if HiveTyrant.leech_adv == nil then
		HiveTyrant.leech_adv = cpu_manager.stats:GetAbilityID( "tyranids_hivetyrant_leech_essence_advance" )
	 end

	 if HiveTyrant.leech_ktgm == nil then
		HiveTyrant.leech_ktgm = cpu_manager.stats:GetAbilityID( "tyranids_ls_hive_tyrant_leech_essence_ktgm" )
	 end

	 if HiveTyrant.catalyst_adv == nil then
		HiveTyrant.catalyst_adv = cpu_manager.stats:GetAbilityID( "tyranids_hivetyrant_catalyst_advance" )
	 end

	 if HiveTyrant.catalyst_ktgm == nil then
		HiveTyrant.catalyst_ktgm = cpu_manager.stats:GetAbilityID( "tyranids_ls_hive_tyrant_catalyst_ktgm" )
	 end

	 if HiveTyrant.metamorphosis_ktgm == nil then
		HiveTyrant.metamorphosis_ktgm = cpu_manager.stats:GetAbilityID( "tyranids_ls_hive_tyrant_metamorphosis" )
	 end

	 if HiveTyrant.restore_ktgm == nil then
		HiveTyrant.restore_ktgm = cpu_manager.stats:GetAbilityID( "tyranids_ls_hive_tyrant_full_restore_ktgm" )
	 end

	 if HiveTyrant.fastrestore_ktgm == nil then
		HiveTyrant.fastrestore_ktgm = cpu_manager.stats:GetAbilityID( "tyranids_ls_hive_tyrant_full_restore_fast_ktgm" )
	 end
end

function HiveTyrantTactic:DoAbilities()

	-- Do not perform the abilities if we need to reserve Influence
	-- if TyranidsReserveFaithResource then return end

	if self.squad_ai:IsInCombat() then

		if self.squad_ai:CanDoAbility(HiveTyrant.leech_id) then
			if self.squad_ai:GetHealthPercentage() < 0.7 then
				if cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), 12, 5) ~= nil then
					self.squad_ai:DoSpecialAbility(HiveTyrant.leech_id)
				end
			end
		end

		if self.squad_ai:CanDoAbility(HiveTyrant.leech_adv) then
			if self.squad_ai:GetHealthPercentage() < 0.7 then
				if cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), 12, 5) ~= nil then
					self.squad_ai:DoSpecialAbility(HiveTyrant.leech_adv)
				end
			end
		end

		if self.squad_ai:CanDoAbility(HiveTyrant.leech_ktgm) then
			if self.squad_ai:GetHealthPercentage() < 0.7 then
				if cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), 12, 5) ~= nil then
					self.squad_ai:DoSpecialAbility(HiveTyrant.leech_ktgm)
				end
			end
		end

		if self.squad_ai:CanDoAbility(HiveTyrant.metamorphosis_ktgm) then
			if self.squad_ai:GetHealthPercentage() > 0.6 then
				self.squad_ai:DoSpecialAbility(HiveTyrant.metamorphosis_ktgm)
			end
		end
	end

	-- Check if we can use catalyst (Single Player)
	if (self.squad_ai:CanDoAbility(HiveTyrant.catalyst_adv)) then
	
		-- Search a squad
		local iRange = self.squad_ai:GetAbilityRange(HiveTyrant.catalyst_adv)
		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), 10, 1)
		if (oUnit ~= nil and oUnit:IsInCombat() and cpu_manager:GetUnitStrength(oUnit) > 150) then
			self.squad_ai:DoSpecialAbility(HiveTyrant.catalyst_adv)
		end
	end

	-- Check if we can use catalyst (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(HiveTyrant.catalyst_ktgm)) then
	
		-- Search a squad
		local iRange = self.squad_ai:GetAbilityRange(HiveTyrant.catalyst_ktgm)
		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), 10, 1)
		if (oUnit ~= nil and oUnit:IsInCombat() and cpu_manager:GetUnitStrength(oUnit) > 150) then
			self.squad_ai:DoSpecialAbility(HiveTyrant.catalyst_ktgm)
		end
	end

	-- Use Restore to temporarily recharge ability times but only outside of combat with no enemies nearby (Last Stand / Kill Team)
	if self.squad_ai:CanDoAbility(HiveTyrant.restore_ktgm) then

    		-- Check for enemy in range
		local pos = self.squad_ai:GetPosition()
		if (not cpu_manager.terrain_analyzer:HasThreat(pos, 60)) then

			if (not self.squad_ai:IsInCombat() and self.squad_ai:GetHealthPercentage() < 0.6) then
				self.squad_ai:DoSpecialAbility(HiveTyrant.restore_ktgm)
			end
		end
	end

	-- Use Fast Restore to temporarily recharge ability times but only outside of combat with no enemies nearby (Last Stand / Kill Team)
	if self.squad_ai:CanDoAbility(HiveTyrant.fastrestore_ktgm) then

    		-- Check for enemy in range
		local pos = self.squad_ai:GetPosition()
		if (not cpu_manager.terrain_analyzer:HasThreat(pos, 60)) then

			if (not self.squad_ai:IsInCombat() and self.squad_ai:GetHealthPercentage() < 0.6) then
				self.squad_ai:DoSpecialAbility(HiveTyrant.fastrestore_ktgm)
			end
		end
	end
end

function HiveTyrantTactic:Upgrade()

	-- Check if we have free resources
	if (not Tactic.Options.can_reinforce) then
		return
	end

	-- Do not upgrade if we need to reserve Influence
	-- if TyranidsReserveFaithResource then return end

	if (not self.squad_ai:IsReinforcing()) then
	
		-- Upgrade if possible
		if (self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 0) then
			local class_type = cpu_manager:GetFirstEnemyPlayer():GetMajorityClassType()
			self.squad_ai:DoBestUpgrade( class_type )
		end
	end
end

function HiveTyrantTactic:Update()

	if self:IsComplete() then
		return
	end
	
	  --state machine
	  if not InfantryTactic.Update( self ) then
		 return
	  end
end