----------------------------------------
-- File: 'darkeldararchontactic.ai'
-- Edited by Thudmeizer @ 29.10.2023

class 'DarkEldarArchonTactic' (DarkEldarInfantryTactic)

DarkEldarArchon = {}

function DarkEldarArchonTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Dark Eldar Archon Tactic")
end

-- Assassinate win condition -- never attack
function DarkEldarArchonTactic:IsAttacker()
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

-- Assassinate win condition -- never defend
function DarkEldarArchonTactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end

function DarkEldarArchonTactic:InitAbilities()

	-- Init ability ID's
	if (DarkEldarArchon.vitae_id == nil) then
		DarkEldarArchon.vitae_id = cpu_manager.stats:GetAbilityID( "dark_eldar_animus_vitae" )
	end

	if (DarkEldarArchon.crucible_id == nil) then
		DarkEldarArchon.crucible_id = cpu_manager.stats:GetAbilityID( "dark_eldar_crucible" )
	end

	if (DarkEldarArchon.crucible_ktgm == nil) then
		DarkEldarArchon.crucible_ktgm = cpu_manager.stats:GetAbilityID( "dark_eldar_ls_archon_crucible" )
	end

	if (DarkEldarArchon.bombs_id == nil) then
		DarkEldarArchon.bombs_id = cpu_manager.stats:GetAbilityID( "dark_eldar_haywire_bombs_skirmish" )
	end

	if (DarkEldarArchon.bombs_ktgm == nil) then
		DarkEldarArchon.bombs_ktgm = cpu_manager.stats:GetAbilityID( "dark_eldar_ls_archon_haywire_bombs" )
	end

	if (DarkEldarArchon.bombs_sp == nil) then
		DarkEldarArchon.bombs_sp = cpu_manager.stats:GetAbilityID( "dark_eldar_haywire_bombs_sp" )
	end

	if (DarkEldarArchon.confusion_ktgm == nil) then
		DarkEldarArchon.confusion_ktgm = cpu_manager.stats:GetAbilityID( "dark_eldar_ls_archon_confusion" )
	end

	if (DarkEldarArchon.break_ktgm == nil) then
		DarkEldarArchon.break_ktgm = cpu_manager.stats:GetAbilityID( "dark_eldar_ls_archon_morale_break" )
	end
end

function DarkEldarArchonTactic:DoAbilities()

	-- We are dying, lower requisites for attacks and use life drain!
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.5) then

		Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.vitae_id, Ability.Filters.CloseSquadEnemy, 4)

		if self.squad_ai:CanDoAbility(DarkEldarArchon.crucible_id) then
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.crucible_id, Ability.Filters.CloseSquadEnemy, 4)
		end
--[[
		if self.squad_ai:CanDoAbility(DarkEldarArchon.crucible_ktgm) then
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.crucible_ktgm, Ability.Filters.CloseSquadEnemy, 4)
		end

		if self.squad_ai:CanDoAbility(DarkEldarArchon.confusion_ktgm) then
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.confusion_ktgm, Ability.Filters.CloseSquadEnemy, 4)
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.confusion_ktgm, Ability.Filters.CloseCommanderEnemy, 1)
		end

		if self.squad_ai:CanDoAbility(DarkEldarArchon.break_ktgm) then
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.break_ktgm, Ability.Filters.CloseInfantryEnemy, 4)
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.break_ktgm, Ability.Filters.CloseCommanderEnemy, 1)
		end
]]
	else
		Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.vitae_id, Ability.Filters.CloseSquadEnemy, 8)

		if self.squad_ai:CanDoAbility(DarkEldarArchon.crucible_id) then
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.crucible_id, Ability.Filters.CloseSquadEnemy, 8)
		end
--[[
		if self.squad_ai:CanDoAbility(DarkEldarArchon.crucible_ktgm) then
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.crucible_ktgm, Ability.Filters.CloseSquadEnemy, 8)
		end

		if self.squad_ai:CanDoAbility(DarkEldarArchon.confusion_ktgm) then
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.confusion_ktgm, Ability.Filters.CloseSquadEnemy, 8)
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.confusion_ktgm, Ability.Filters.CloseCommanderEnemy, 1)
		end

		if self.squad_ai:CanDoAbility(DarkEldarArchon.break_ktgm) then
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.break_ktgm, Ability.Filters.CloseInfantryEnemy, 8)
			Ability.DoAbilityTarget(self.squad_ai, DarkEldarArchon.break_ktgm, Ability.Filters.CloseCommanderEnemy, 1)
		end
]]
	end

	-- Use Crucible (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(DarkEldarArchon.crucible_ktgm)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(DarkEldarArchon.crucible_ktgm)
		local oUnit = cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), iRange, 4)
		if (oUnit ~= nil) then
			--print("Using Crucibld Ability for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(DarkEldarArchon.crucible_ktgm, oUnit:GetSquad())
			return
		end
	end

	-- Use Confusion against either close standard or infiltrating enemy (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(DarkEldarArchon.confusion_ktgm)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(DarkEldarArchon.confusion_ktgm)
		local oUnit = cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), iRange, 4)
		local oUnitB = cpu_manager.cpu_player:FindFirstCommanderEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Confusion against normal enemies for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(DarkEldarArchon.confusion_ktgm, oUnit:GetSquad())
			return
		elseif (oUnitB ~= nil) then
			--print("Using Confusion against commanders for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(DarkEldarArchon.confusion_ktgm, oUnitB:GetSquad())
			return
		end
	end

	-- Use Morale Break against either close standard or commander enemies (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(DarkEldarArchon.break_ktgm)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(DarkEldarArchon.break_ktgm)
		local oUnit = cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), iRange, 6)
		local oUnitB = cpu_manager.cpu_player:FindFirstCommanderEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Morale Break against normal enemies for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(DarkEldarArchon.break_ktgm, oUnit:GetSquad())
			return
		elseif (oUnitB ~= nil) then
			--print("Using Morale Break against Commanders for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(DarkEldarArchon.break_ktgm, oUnitB:GetSquad())
			return
		end
	end

	if self.squad_ai:CanDoAbility(DarkEldarArchon.bombs_id) then
		Ability.DoAbilityTarget( self.squad_ai, DarkEldarArchon.bombs_id, Ability.Filters.CloseVehicleEnemy, 1 )
		Ability.DoAbilityTargetEntity( self.squad_ai, DarkEldarArchon.bombs_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
	end

	if self.squad_ai:CanDoAbility(DarkEldarArchon.bombs_sp) then
		Ability.DoAbilityTarget( self.squad_ai, DarkEldarArchon.bombs_sp, Ability.Filters.CloseVehicleEnemy, 1 )
		Ability.DoAbilityTargetEntity( self.squad_ai, DarkEldarArchon.bombs_sp, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
	end
--[[
	if self.squad_ai:CanDoAbility(DarkEldarArchon.bombs_ktgm) then
		Ability.DoAbilityTarget( self.squad_ai, DarkEldarArchon.bombs_ktgm, Ability.Filters.CloseVehicleEnemy, 1 )
		Ability.DoAbilityTargetEntity( self.squad_ai, DarkEldarArchon.bombs_ktgm, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
	end
]]
	-- Try to throw Haywire Grenade (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(DarkEldarArchon.bombs_ktgm)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(DarkEldarArchon.bombs_ktgm)
		local oUnit = cpu_manager.cpu_player:FindFirstVehicleEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Haywire Grenade Ability for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(DarkEldarArchon.bombs_ktgm, oUnit:GetSquad())
			return
		end
	end
end

function DarkEldarArchonTactic:Reinforce()

	-- Always try for the actual leader first
	if not self.squad_ai:IsReinforcing() then
		if self.squad_ai:CanReinforce( false, 0 ) then
		   self.squad_ai:DoReinforce( false, 0 )
		end
	end

	if (not self.squad_ai:IsReinforcing()) then

		-- Try for different types of squad members
		local incubiIndex = 0
	
		local numIncubis = self.squad_ai:GetLeaderCount( incubiIndex )

		-- Desired number of each leader type
		local desiredIncubis = 5 
		
		local squadMax = self.squad_ai:GetMaxLeaderCount()
		if (squadMax > 4) then
		
			-- Research done - we want 7 Incubis
			desiredIncubis = 7
		end

		-- Desired order of reinforcing
		if (numIncubis < desiredIncubis) then
			if (self.squad_ai:CanReinforce( true, incubiIndex )) then
				self.squad_ai:DoReinforce( true, incubiIndex )
			end
		end
	end
end

function DarkEldarArchonTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
end
