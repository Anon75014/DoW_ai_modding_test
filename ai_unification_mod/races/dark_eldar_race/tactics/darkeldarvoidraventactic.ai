----------------------------------------
-- File: 'darkeldarvoidraventactic.ai'
-- Edited by Gambit @ 21.11.2020

class 'DarkEldarVoidravenTactic' (DarkEldarVehicleTactic)

DarkEldarVoidRaven = {}

function DarkEldarVoidravenTactic:__init( squad_ai ) super( squad_ai )
	
	self:SetName("Dark Eldar Voidraven Tactic")

	-- Used for the stuck check code for the squads that can jump
	self.initialPosition = self.squad_ai:GetPosition()
end

function DarkEldarVoidravenTactic:InitAbilities()

	if DarkEldarVoidRaven.missiles_id == nil then
		DarkEldarVoidRaven.missiles_id = cpu_manager.stats:GetAbilityID( "dark_eldar_voidraven_missiles" )
		DarkEldarVoidRaven.voidmine_id = cpu_manager.stats:GetAbilityID( "dark_eldar_void_mine" )
	end
end

function DarkEldarVoidravenTactic:DoAbilities()

	if self.squad_ai:IsInCombat() then
		-- Choose Missile Type
		local use_anti_inf = ( Ability.Filters.CloseInfantryEnemy(self.squad_ai:GetPosition(), 40, 4) ~= nil )
		if self.squad_ai:IsUsingAbility(DarkEldarVoidRaven.missiles_id) then
			if not use_anti_inf then
				self.squad_ai:DoSpecialAbility(DarkEldarVoidRaven.missiles_id)
			end
		elseif use_anti_inf then
			self.squad_ai:DoSpecialAbility(DarkEldarVoidRaven.missiles_id)
		end

		-- Try throwing the Void Mine
		if self.squad_ai:CanDoAbility(DarkEldarVoidRaven.voidmine_id) then
			if resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power ) > 1000 then
				local iPos = self.squad_ai:GetPosition()
				local oTarget = Ability.Filters.CloseInfantryEnemy(iPos, 30, 1)
				if oTarget ~= nil and oTarget:IsValid() and oTarget:GetNumTroopers() > 5 then
					self.squad_ai:DoSpecialAbilitySquad(DarkEldarVoidRaven.voidmine_id, oTarget:GetSquad())
				else
					oTarget = Ability.Filters.CloseVehicleEnemy(iPos, 30, 1)
					if oTarget ~= nil and oTarget:IsValid() then
						self.squad_ai:DoSpecialAbilitySquad(DarkEldarVoidRaven.voidmine_id, oTarget:GetSquad())
					else
						oTarget = Ability.EntityFilters.CloseBaseEntityEnemy(iPos, 20, 1)
						if oTarget ~= nil then
							self.squad_ai:DoSpecialAbilityPos(DarkEldarVoidRaven.voidmine_id, oTarget:GetPosition())
						end
					end
				end
			end
		end
	end

	-- New code to unstuck units with pathing issues, that can jump.
	-- Call it with [true], only for multi-membered squads.
	self:SolveStuckCase(false)
end