----------------------------------------
-- File: 'revenanttactic.ai'
-- Created by Gambit		@ 18.08.2020

class 'RevenantTactic' (EldarVehicleTactic)

RevenantTitan = {}

function RevenantTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Revenant Tactic")

	-- Used for the stuck check code for the squads that can jump
	self.initialPosition = self.squad_ai:GetPosition()
	self.isStuck = false
end


function RevenantTactic:InitAbilities()

	-- Init ability ID's
	if (RevenantTitan.speed == nil) then
		RevenantTitan.speed = cpu_manager.stats:GetAbilityID( "eldar_revenant_graviticbooster" )
		RevenantTitan.regen = cpu_manager.stats:GetAbilityID( "eldar_revenant_wraithtomb_of_khaine" )
	end
end


function RevenantTactic:DoAbilities()

	local health_ratio = self.squad_ai:GetHealthPercentage()
	local in_combat = self.squad_ai:IsInCombat()
	local use_regen = not (in_combat or health_ratio > 0.98 or cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 50))
	if use_regen then
		local pow_resource = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
		if pow_resource < 300 or (pow_resource < 800 and health_ratio > 0.75) then
			use_regen = false
		end
	end

	if self.squad_ai:IsUsingAbility(RevenantTitan.speed) then
		-- Stop speeding when in combat
		if in_combat then
			self.squad_ai:DoSpecialAbility(RevenantTitan.speed)
		end
	elseif not in_combat then
		-- Not in combat, so enable speeding
		self.squad_ai:DoSpecialAbility(RevenantTitan.speed)
	end

	if self.squad_ai:IsUsingAbility(RevenantTitan.regen) then
		-- Stop regen if still in combat, to keep weapons online
		if not use_regen then
			self.squad_ai:DoSpecialAbility(RevenantTitan.regen)
		end
	elseif use_regen then
		-- Not in combat, so enable regen - weapons not needed
		self.squad_ai:DoSpecialAbility(RevenantTitan.regen)
	end

	-- New code to unstuck units with pathing issues, that can jump.
	-- Call it with [true], only for multi-membered squads.
	self:SolveStuckCase(false)
end
