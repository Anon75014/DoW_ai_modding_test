----------------------------------------
-- File: 'eldradtactic.ai'
-- Edited by Gambit @ 8.03.2022

class 'EldradTactic' (EldarInfantryTactic)

Eldrad = {}

function EldradTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Farseer Eldrad Ulthran Tactic")
	self.dance_time = 0

	-- Init AoE abilities delay time
	Eldrad.NextAbilityCheck = 0
end


function EldradTactic:InitAbilities()

	-- Re-init delay, in case we are attached when AI re-initiates
	if Eldrad.NextAbilityCheck == nil then 
		Eldrad.NextAbilityCheck = 0
	end

	-- Init ability ID's
	if Eldrad.storm_id == nil then
		Eldrad.fleetoffoot_id = cpu_manager.stats:GetAbilityID( "eldar_fleetoffoot" )
		Eldrad.eldritchstorm_id = cpu_manager.stats:GetAbilityID( "eldar_eldrad_eldritchstorm" )
		Eldrad.asuryan_id = cpu_manager.stats:GetAbilityID( "eldar_eldrad_force_of_asuryan" )
		Eldrad.doom_id = cpu_manager.stats:GetAbilityID( "eldar_eldrad_doom" )
		Eldrad.projection_id = cpu_manager.stats:GetAbilityID( "eldar_eldrad_astral_projection" )
		Eldrad.temporal_id = cpu_manager.stats:GetAbilityID( "eldar_eldrad_temporal_weave" )
	end
end


function EldradTactic:DoAbilities()

	-- Make sure no other ability will be attempted, if we have performed either Eldritch Storm or Temporal Weave
	if g_iGMT < Eldrad.NextAbilityCheck + 10 then
		return
	end

	if self.squad_ai:CanDoAbility(Eldrad.asuryan_id) then
		if self.squad_ai:IsInCombat() and self.squad_ai:WasRecentlyHurt() then
			self.squad_ai:DoSpecialAbility(Eldrad.asuryan_id)
			return
		else
			local oSquad = cpu_manager.cpu_player:FindFirstHurtSquad(self.squad_ai:GetPosition(), 20)
			if oSquad ~= nil and oSquad:IsInCombat() and oSquad:GetNumTroopers() > 4 then
				self.squad_ai:DoSpecialAbility(Eldrad.asuryan_id)
				return
			end
		end
	end

	if self.squad_ai:IsInCombat() then

		if self.squad_ai:CanDoAbility(Eldrad.doom_id) then
			if Ability.DoAbilityTarget( self.squad_ai, Eldrad.doom_id, Ability.Filters.CloseCommanderEnemy, 1 )
			or Ability.DoAbilityTarget( self.squad_ai, Eldrad.doom_id, Ability.Filters.CloseSquadEnemy, 5 ) then
				return
			end
		end

		if self.squad_ai:CanDoAbility(Eldrad.eldritchstorm_id) then
			-- If we are dying, lower requisites for attacks
			if self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4 then
				if Ability.DoAbilityPos( self.squad_ai, Eldrad.eldritchstorm_id, Ability.Filters.CloseEnemy, 6 ) then
					Eldrad.NextAbilityCheck = g_iGMT
					return
				end
			else
				if Ability.DoAbilityPos( self.squad_ai, Eldrad.eldritchstorm_id, Ability.Filters.CloseEnemy, 12 ) then
					Eldrad.NextAbilityCheck = g_iGMT
					return
				end
			end
		end

		if self.squad_ai:CanDoAbility(Eldrad.temporal_id) and self.squad_ai:GetHealthPercentage() > 0.35 then
			if resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Power) > 550 then
				local pos = self.squad_ai:GetPosition()
				local oHurtFriendly = Ability.Filters.CloseLowHealth(pos, 20, 6)
				local oEnemyStrong = Ability.Filters.CloseEnemy(pos, 30, 6)
				if oHurtFriendly ~= nil and oEnemyStrong ~= nil then
					self.squad_ai:DoSpecialAbilitySquad(Eldrad.temporal_id, self.squad_ai:GetSquad())
					Eldrad.NextAbilityCheck = g_iGMT
				end
			end
		end
	end

	if self.squad_ai:CanDoAbility(Eldrad.projection_id) then
		if self.squad_ai:GetHealthPercentage() > 0.4 and cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 50) then
			self.squad_ai:DoSpecialAbilitySquad(Eldrad.projection_id, self.squad_ai:GetSquad())
		end
	end

	-- Check if I should enable/disable fleet of foot
	if (not self.squad_ai:IsAttached()) then
		self:DoAbilityFoF()
	end
end


function EldradTactic:Update()

	if (self:IsComplete()) then
		return
	end

	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
    
	-- Check for close commander
	local bSetRanged = false
	local bSetMelee = false
	local vSquadPos = self.squad_ai:GetPosition()
	local eStance = self.squad_ai:GetMeleeStance()
	local oEnemyCommander = Ability.Filters.CloseCommanderEnemy(vSquadPos, 20, 1)
	if (oEnemyCommander ~= nil) then

		-- Check health
		if (self.squad_ai:GetHealthPercentage() > 0.8 and oEnemyCommander:GetHealthPercentage() < 0.3) then
			bSetMelee = (eStance == SquadAI.MSTANCE_Ranged)
			self.dance_time = 0
		else
			bSetRanged = (eStance == SquadAI.MSTANCE_Assault)
		end
	else

		-- Check for close attached commander
		local oSquad = Ability.Filters.CloseInfantryEnemy(vSquadPos, 20, 4)
		if (oSquad ~= nil and oSquad:IsAttached()) then
			bSetRanged = (eStance == SquadAI.MSTANCE_Assault)
		else
			bSetMelee = (eStance == SquadAI.MSTANCE_Ranged)
		end
	end

	-- At leat 10 secs ranged stance/dancing
	if (bSetRanged) then
		self.squad_ai:DoSetMeleeStance( SquadAI.MSTANCE_Ranged )
		self.dance_time = g_iGMT
	elseif (bSetMelee and self.stateID ~= Tactic.StateID.DoDance and g_iGMT > self.dance_time + 10) then
		self.squad_ai:DoSetDefaultMeleeStance()
		self.dance_time = 0
	end

	-- Attach to a squad / do not attach while dancing
	if (self.squad_ai:GetMeleeStance() == SquadAI.MSTANCE_Assault) then
		if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then
			if (self:TryAttachSquad(false, true, 50, 150, self.m_fCommanderAttachHealth) == nil) then
				self:TryAttachSquadMelee()
			end
		end
	end
end
