----------------------------------------
-- File: 'renegades_acheron_tactic.ai'
-- Edited by Thudmeizer @ 10.07.2024

class 'Renegades_Acheron_Tactic' (Renegades_Infantry_Tactic)

Acheron = {}

function Renegades_Acheron_Tactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Renegades Acheron Tactic")

	-- Squad is able to occupy bunkers
	self.m_bBunkerSquad = true
end

function Renegades_Acheron_Tactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function Renegades_Acheron_Tactic:IsDefender()
	return self:IsCommanderDefender()
end

function Renegades_Acheron_Tactic:InitAbilities()

	-- Init ability ID's
	if (Acheron.move_id == nil) then
		Acheron.move_id = cpu_manager.stats:GetAbilityID( "renegade_guard_acheron_fast_move" )	
		Acheron.heal_id = cpu_manager.stats:GetAbilityID( "renegade_guard_acheron_heal" )
		Acheron.smite_id = cpu_manager.stats:GetAbilityID( "renegade_guard_acheron_smite" )
		Acheron.scope_id = cpu_manager.stats:GetAbilityID( "renegade_guard_acheron_sara_scope" )
		Acheron.spear_id = cpu_manager.stats:GetAbilityID( "renegade_guard_acheron_throwing_spear" )	
	end
end

function Renegades_Acheron_Tactic:DoAbilities()

	-- Check to make sure if no threats are nearby before we fast move
	if not (self.squad_ai:IsInCombat()) and not (self.squad_ai:IsUnderAttack()) then

		-- If I am safe I can fast move
		if (self.squad_ai:CanDoAbility( Acheron.move_id )) then
			self.squad_ai:DoSpecialAbility( Acheron.move_id )
		end
	end

	-- Check if we can initiate heal against our own
	if (self.squad_ai:CanDoAbility(Acheron.heal_id)) then

		-- Search a squad that was recently hurt
		local iRange = self.squad_ai:GetAbilityRange(Acheron.heal_id)
		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil and oUnit:IsInCombat() and cpu_manager:GetUnitStrength(oUnit) > 150) then
			self.squad_ai:DoSpecialAbilitySquad(Acheron.heal_id, oUnit:GetSquad())
		end
	end
	
	-- Check if enemies are nearby and we are engaged in combat
	if self.squad_ai:IsInCombat() then

		-- Enable scope ability to increase fighting power if enemies are close.
		local iPos = self.squad_ai:GetPosition()
		local oTarget = Ability.Filters.CloseEnemy(iPos, 20, 1)
		if oTarget ~= nil and oTarget:IsValid() then
			if (self.squad_ai:CanDoAbility( Acheron.scope_id )) then
				self.squad_ai:DoSpecialAbility( Acheron.scope_id )
			end
		end

		-- Enable spear ability if enemies are at a specific range
		local iPos = self.squad_ai:GetPosition()
		local oTarget = Ability.Filters.CloseEnemy(iPos, 40, 1)
		if oTarget ~= nil and oTarget:IsValid() then
			if (self.squad_ai:CanDoAbility( Acheron.spear_id )) then
				self.squad_ai:DoSpecialAbility( Acheron.spear_id )
			end
		end

		-- Try to use Smite based on health
		if self.squad_ai:CanDoAbility(Acheron.smite_id) then
			if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
				if Ability.DoAbilityPos(self.squad_ai, Acheron.smite_id, Ability.Filters.CloseEnemy, 3) then
					return
				end
			else
				if Ability.DoAbilityPos(self.squad_ai, Acheron.smite_id, Ability.Filters.CloseEnemy, 6) then
					return
				end
			end
		end
	end
end

function Renegades_Acheron_Tactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
   
	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end
