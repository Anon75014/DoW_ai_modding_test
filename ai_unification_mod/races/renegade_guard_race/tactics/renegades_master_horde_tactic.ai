----------------------------------------
-- File: 'renegades_master_horde_tactic.ai'
-- Edited by Gambit     @ 20.12.2014
-- Edited by Thudmeizer @ 22.06.2023

class 'Renegades_Master_Horde_Tactic' (Renegades_Infantry_Tactic)

Master = {}

function Renegades_Master_Horde_Tactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Master_horde Tactic")
	
	-- Master_horde is able to enter a bunker
	self.m_bBunkerSquad = true
end

-- Assassinate win condition -- never attack
function Renegades_Master_Horde_Tactic:IsAttacker()
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

-- Assassinate win condition -- never defend
function Renegades_Master_Horde_Tactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end

function Renegades_Master_Horde_Tactic:InitAbilities()

	-- Init ability ID's
	if (Master.heretic_id == nil) then
		Master.heretic_id = cpu_manager.stats:GetAbilityID( "renegade_guard_demagogue_heretic" )
	end

	if (Master.lightning_id == nil) then
		Master.lightning_id = cpu_manager.stats:GetAbilityID( "renegade_guard_mastermind_lightning_arc" )
	end

	if (Master.strip_id == nil) then
		Master.strip_id = cpu_manager.stats:GetAbilityID( "renegade_guard_mastermind_warp_enhancement" )
	end

	if (Master.fanatical_id == nil) then
		Master.fanatical_id = cpu_manager.stats:GetAbilityID( "renegade_guard_fanatical" )
	end

	if (Master.airstrike_id == nil) then
		Master.airstrike_id = cpu_manager.stats:GetAbilityID( "renegade_guard_strafing_run" )
	end

	if (Master.scan_id == nil) then
		Master.scan_id = cpu_manager.stats:GetAbilityID( "renegade_guard_vox_scan" )
	end
end

function Renegades_Master_Horde_Tactic:DoAbilities()

	if self.squad_ai:IsInCombat() then
		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) or (self.squad_ai:IsBroken()) then
			if (self.squad_ai:CanDoAbility( Master.heretic_id )) then
				self.squad_ai:DoSpecialAbility( Master.heretic_id )
			end
		end
		-- Try to use Lightning Arc 
		if self.squad_ai:CanDoAbility(Master.lightning_id) then
			if Ability.DoAbilityTarget(self.squad_ai, Master.lightning_id, Ability.Filters.CloseSquadEnemy, 1)
				or Ability.DoAbilityTarget(self.squad_ai, Master.lightning_id, Ability.Filters.CloseCommanderEnemy, 1) then
				return
			end
		end
		-- Try to use Warp Enhancement
		if self.squad_ai:CanDoAbility(Master.strip_id) then
			if Ability.DoAbilityTarget(self.squad_ai, Master.strip_id, Ability.Filters.CloseVehicleEnemy, 1) then
				return
			end
		end
		-- Try to use Fanatical 
		if self.squad_ai:CanDoAbility(Master.fanatical_id) then
			if Ability.DoAbilityArea(self.squad_ai, Master.fanatical_id, Ability.Filters.CloseEnemy, 5, 2) then
				return
			end
		end
		-- Try to use Air Strike
		if self.squad_ai:CanDoAbility(Master.airstrike_id) then
			if Ability.DoAbilityPos(self.squad_ai, Master.airstrike_id, Ability.Filters.CloseEnemy, 6) then
				return
			end
		end
	end

	-- Try to activate detection field
	if (self.squad_ai:CanDoAbility(Master.scan_id)) then
	
		local iRange = self.squad_ai:GetAbilityRange(Master.scan_id)
		local oSquad = Ability.Filters.CloseInfiltratedEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oSquad ~= nil) then
			
			-- Only try to detect if the infiltrated unit is attacking
			if (oSquad:IsAttacking()) then
				self.squad_ai:DoSpecialAbilitySquad(Master.scan_id, oSquad:GetSquad())
			end
		end
	end
end

function Renegades_Master_Horde_Tactic:Reinforce()

	-- Allow free reinforcing during harassing time
	if (g_iGMT > DefendChokePointPlan.HarassingTime * 60) then

		-- If there are no ressources available, don't upgrade!
		if (not Tactic.Options.can_reinforce) then
			return
		end
	end

	if (not self.squad_ai:IsReinforcing()) then

		-- Always try for the actual leader first
		if (self.squad_ai:CanReinforce( false, 0 )) then
			self.squad_ai:DoReinforce( false, 0 )
			return
		end
	end	

	-- Check if we are reinforcing
	if (not self.squad_ai:IsReinforcing()) then

		-- try for different types of squad members
		local bodyguardIndex = 0
		local witchIndex = 1
		local reaverIndex = 2
		local voxcasterIndex = 3

		local numBodyguards = self.squad_ai:GetLeaderCount( bodyguardIndex )
		local numWitchs = self.squad_ai:GetLeaderCount( witchIndex )	
		local numReavers = self.squad_ai:GetLeaderCount( reaverIndex )	
		local numVoxcasters = self.squad_ai:GetLeaderCount( voxcasterIndex )	

		-- Desired number of each bodyguard type
		local desiredBodyguards = math.random(0,1)
		local desiredWitchs = math.random(0,1) 
		local desiredReavers = math.random(0,1) 
		local desiredVoxcasters = math.random(0,1) 

		-- Desired order of reinforcing
		if (numBodyguards < desiredBodyguards) then
			if (self.squad_ai:CanReinforce( true, bodyguardIndex )) then
				self.squad_ai:DoReinforce( true, bodyguardIndex )
			end
		elseif (numWitchs < desiredWitchs) then
			if (self.squad_ai:CanReinforce( true, witchIndex )) then
				self.squad_ai:DoReinforce( true, witchIndex )
			end
		elseif (numReavers < desiredReavers) then
			if (self.squad_ai:CanReinforce( true, reaverIndex )) then
				self.squad_ai:DoReinforce( true, reaverIndex )
			end
		elseif (numVoxcasters < desiredVoxcasters) then
			if (self.squad_ai:CanReinforce( true, voxcasterIndex )) then
				self.squad_ai:DoReinforce( true, voxcasterIndex )
			end
		else
			if (self.squad_ai:CanReinforce( false, 0 )) then
				self.squad_ai:DoReinforce( false, 0 )
			end			
		end
	end
end

function Renegades_Master_Horde_Tactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end