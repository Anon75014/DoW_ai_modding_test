----------------------------------------
-- File: 'renegades_warrior_tactic.ai'
-- Edited by Thudmeizer	@ 02.08.2024

class 'Renegades_Warrior_Tactic' (Renegades_Infantry_Tactic)

Warrior = {}

function Renegades_Warrior_Tactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Renegades Warrior Squad Tactic")
	
	-- Squad is able to occupy bunkers
	self.m_bBunkerSquad = true	
end

function Renegades_Warrior_Tactic:InitAbilities()

	-- Init ability ID's
	if (Warrior.grenade_id == nil) then
		Warrior.grenade_id = cpu_manager.stats:GetAbilityID( "renegade_guard_frag_grenades_warrior" )	
	end

	if (Warrior.grenade_sp == nil) then
		Warrior.grenade_sp = cpu_manager.stats:GetAbilityID( "renegade_guard_frag_grenades_warrior_advance" )	
	end

	if (Warrior.grenade_ktgm == nil) then
		Warrior.grenade_ktgm = cpu_manager.stats:GetAbilityID( "renegade_guard_ls_frag_grenades_warrior" )	
	end

	if (Warrior.fury_id == nil) then
		Warrior.fury_id = cpu_manager.stats:GetAbilityID( "renegade_guard_warrior_fury" )	
	end

	if (Warrior.fury_ktgm == nil) then
		Warrior.fury_ktgm = cpu_manager.stats:GetAbilityID( "renegade_guard_ls_warrior_fury" )	
	end

	if (Warrior.missiles_sp == nil) then
		Warrior.missiles_sp = cpu_manager.stats:GetAbilityID( "renegade_guard_hk_missiles" )	
	end
end

function Renegades_Warrior_Tactic:DoAbilities()

	-- We are dying, lower requisites for attacks
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then

		if (self.squad_ai:CanDoAbility( Warrior.grenade_id )) then
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_id, Ability.Filters.CloseInfantryEnemy, 4 )
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_id, Ability.Filters.CloseMonsterEnemy, 4 )
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_id, Ability.Filters.CloseCommanderEnemy, 1 )
		end

		if (self.squad_ai:CanDoAbility( Warrior.grenade_sp )) then
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_sp, Ability.Filters.CloseInfantryEnemy, 4 )
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_sp, Ability.Filters.CloseMonsterEnemy, 4 )
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_sp, Ability.Filters.CloseCommanderEnemy, 1 )
		end

		-- Use Frag Grenade against enemies (Last Stand / Kill Team)
		if (self.squad_ai:CanDoAbility(Warrior.grenade_ktgm)) then 

			-- Search for a nearby enemy squad
			local iRange = self.squad_ai:GetAbilityRange(Warrior.grenade_ktgm)
			local oUnit = cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), iRange, 4)
			local oUnitB = cpu_manager.cpu_player:FindFirstCommanderEnemy(self.squad_ai:GetPosition(), iRange, 1)
			local oUnitC = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 1)
			if (oUnit ~= nil) then
				--print("Using Frag Grenade against infantry enemies for player "..tostring(cpu_manager.player_id).."")
				self.squad_ai:DoSpecialAbilitySquad(Warrior.grenade_ktgm, oUnit:GetSquad())
				return
			elseif (oUnitB ~= nil) then
				--print("Using Frag Grenade against commander enemies for player "..tostring(cpu_manager.player_id).."")
				self.squad_ai:DoSpecialAbilitySquad(Warrior.grenade_ktgm, oUnitB:GetSquad())
				return
			elseif (oUnitC ~= nil) then
				-- Get stats
				local oStats = oUnitC:GetStats()
				if (oStats ~= nil) then
					-- Check unit type
					local eClass = oStats:GetClass()
					if (eClass == UnitStatsAI.UC_MonsterMed or eClass == UnitStatsAI.UC_MonsterHigh) then
						--print("Using Frag Grenade against monster enemies for player "..tostring(cpu_manager.player_id).."")
						self.squad_ai:DoSpecialAbilitySquad(Warrior.grenade_ktgm, oUnitC:GetSquad())
						return
					end
				end
			end
		end

		if (self.squad_ai:CanDoAbility( Warrior.fury_id )) then
			Ability.DoAbilityArea( self.squad_ai, Warrior.fury_id, Ability.Filters.CloseEnemy, 5, 2 )
		end

		-- Use Fury (Last Stand / Kill Team)
		if (self.squad_ai:CanDoAbility(Warrior.fury_ktgm )) then

			-- Search for a nearby enemy squad
			local oSquad = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), 5, 2)
			if ( oSquad ~= nil ) then
				--print("Using Fury Ability against close enemies for player "..tostring(cpu_manager.player_id).."")
				self.squad_ai:DoSpecialAbility(Warrior.fury_ktgm)
			end
		end

		if (self.squad_ai:CanDoAbility( Warrior.missiles_sp )) then
			Ability.DoAbilityTarget(self.squad_ai, Warrior.missiles_sp, Ability.Filters.CloseVehicleEnemy, 1)
			Ability.DoAbilityTarget(self.squad_ai, Warrior.missiles_sp, Ability.Filters.CloseMonsterEnemy, 1)
    			Ability.DoAbilityTargetEntity( self.squad_ai, Warrior.missiles_sp, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
		end
	else
		if (self.squad_ai:CanDoAbility( Warrior.grenade_id )) then
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_id, Ability.Filters.CloseInfantryEnemy, 8 )
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_id, Ability.Filters.CloseMonsterEnemy, 8 )
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_id, Ability.Filters.CloseCommanderEnemy, 1 )
		end

		if (self.squad_ai:CanDoAbility( Warrior.grenade_sp )) then
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_sp, Ability.Filters.CloseInfantryEnemy, 8 )
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_sp, Ability.Filters.CloseMonsterEnemy, 8 )
			Ability.DoAbilityTarget( self.squad_ai, Warrior.grenade_sp, Ability.Filters.CloseCommanderEnemy, 1 )
		end

		-- Use Frag Grenade against enemies (Last Stand / Kill Team)
		if (self.squad_ai:CanDoAbility(Warrior.grenade_ktgm)) then 

			-- Search for a nearby enemy squad
			local iRange = self.squad_ai:GetAbilityRange(Warrior.grenade_ktgm)
			local oUnit = cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), iRange, 8)
			local oUnitB = cpu_manager.cpu_player:FindFirstCommanderEnemy(self.squad_ai:GetPosition(), iRange, 1)
			local oUnitC = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 1)
			if (oUnit ~= nil) then
				--print("Using Frag Grenade against infantry enemies for player "..tostring(cpu_manager.player_id).."")
				self.squad_ai:DoSpecialAbilitySquad(Warrior.grenade_ktgm, oUnit:GetSquad())
				return
			elseif (oUnitB ~= nil) then
				--print("Using Frag Grenade against commander enemies for player "..tostring(cpu_manager.player_id).."")
				self.squad_ai:DoSpecialAbilitySquad(Warrior.grenade_ktgm, oUnitB:GetSquad())
				return
			elseif (oUnitC ~= nil) then
				-- Get stats
				local oStats = oUnitC:GetStats()
				if (oStats ~= nil) then
					-- Check unit type
					local eClass = oStats:GetClass()
					if (eClass == UnitStatsAI.UC_MonsterMed or eClass == UnitStatsAI.UC_MonsterHigh) then
						--print("Using Frag Grenade against monster enemies for player "..tostring(cpu_manager.player_id).."")
						self.squad_ai:DoSpecialAbilitySquad(Warrior.grenade_ktgm, oUnitC:GetSquad())
						return
					end
				end
			end
		end

		if (self.squad_ai:CanDoAbility( Warrior.fury_id )) then
			Ability.DoAbilityArea( self.squad_ai, Warrior.fury_id, Ability.Filters.CloseEnemy, 5, 4 )
		end

		-- Use Fury (Last Stand / Kill Team)
		if (self.squad_ai:CanDoAbility(Warrior.fury_ktgm )) then

			-- Search for a nearby enemy squad
			local oSquad = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), 5, 4)
			if ( oSquad ~= nil ) then
				--print("Using Fury Ability against close enemies for player "..tostring(cpu_manager.player_id).."")
				self.squad_ai:DoSpecialAbility(Warrior.fury_ktgm)
			end
		end

		if (self.squad_ai:CanDoAbility( Warrior.missiles_sp )) then
			Ability.DoAbilityTarget(self.squad_ai, Warrior.missiles_sp, Ability.Filters.CloseVehicleEnemy, 2)
			Ability.DoAbilityTarget(self.squad_ai, Warrior.missiles_sp, Ability.Filters.CloseMonsterEnemy, 2)
    			Ability.DoAbilityTargetEntity( self.squad_ai, Warrior.missiles_sp, Ability.EntityFilters.CloseBaseEntityEnemy, 2)
		end
	end
end

function Renegades_Warrior_Tactic:Upgrade()

 	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- If there are no ressources available, don't upgrade!
	if (not Tactic.Options.can_reinforce) then
		return
	end
   
	if (not self.squad_ai:IsReinforcing() and cpu_manager:GetTierLevel() >= 2) then
	  
		-- Try for upgrade if we've a leader and more than 6 troopers
		if (self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 6 and self.squad_ai:HasLeader()) then
			local class_type = cpu_manager:FindClosestEnemyPlayer():GetMajorityClassType()
			self.squad_ai:DoBestUpgrade( class_type )
		end
	end
end

function Renegades_Warrior_Tactic:Reinforce()

	-- Check if we are reinforcing
	if self.squad_ai:IsReinforcing() then
		return
	end

	if build_manager:GetSquadCapCurrentMax() < 8 then
		--Don't reinforce more than 2 guys early on
		if self.squad_ai:GetNumTroopers() < 2 then
			if self.squad_ai:CanReinforce( false, 0 ) then
				self.squad_ai:DoReinforce( false, 0 )
			end
		end
	else
		if self.squad_ai:CanReinforce( false, 0 ) then
			self.squad_ai:DoReinforce( false, 0 )
		end
	end


	-- if I am broken, don't reinforce!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- If there are no ressources available, don't upgrade!
	local iRequisition = resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Requisition)
	if (iRequisition < 800 and not Tactic.Options.can_reinforce) then
		return
	end
	
	-- Try for leader
	if (not self.squad_ai:IsReinforcing()) then
	  
		if (self.squad_ai:CanReinforce(true, 0)) then
			self.squad_ai:DoReinforce(true, 0)
		elseif (self.squad_ai:CanReinforce(false, 0)) then

			-- Don't reinforce more than 4 guards without a leader
			if (self.squad_ai:HasLeader() or self.squad_ai:GetNumTroopers() < 4) then
				self.squad_ai:DoReinforce(false, 0)
			end
		end
	end
end
