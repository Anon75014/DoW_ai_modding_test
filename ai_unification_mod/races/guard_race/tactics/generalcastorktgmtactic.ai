----------------------------------------
-- File: 'GeneralCastorKtgmktgmtactic.ai'
-- Edited by Thudmeizer @ 29.10.2023

class 'GeneralCastorKtgmTactic' (GuardInfantryTactic)

GeneralCastorKtgm = {}

function GeneralCastorKtgmTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("General Castor Kill Team Squad Tactic")
end

function GeneralCastorKtgmTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function GeneralCastorKtgmTactic:IsDefender()
	return self:IsCommanderDefender()
end

function GeneralCastorKtgmTactic:InitAbilities()

	-- Init ability ID's
	if (GeneralCastorKtgm.field_id == nil) then
		GeneralCastorKtgm.field_id = cpu_manager.stats:GetAbilityID( "guard_ls_general_castor_refractor_field" )	
	end

	if (GeneralCastorKtgm.rocket_id == nil) then
		GeneralCastorKtgm.rocket_id = cpu_manager.stats:GetAbilityID( "guard_ls_general_castor_rocket_run" )	
	end

	if (GeneralCastorKtgm.turret_id == nil) then
		GeneralCastorKtgm.turret_id = cpu_manager.stats:GetAbilityID( "guard_ls_general_castor_turret" )	
	end

	if (GeneralCastorKtgm.reinforce_id == nil) then
		GeneralCastorKtgm.reinforce_id = cpu_manager.stats:GetAbilityID( "guard_ls_general_castor_reinforce" )	
	end

	if (GeneralCastorKtgm.repair_id == nil) then
		GeneralCastorKtgm.repair_id = cpu_manager.stats:GetAbilityID( "guard_ls_general_castor_repair" )	
	end

	if (GeneralCastorKtgm.aim_id == nil) then
		GeneralCastorKtgm.aim_id = cpu_manager.stats:GetAbilityID( "guard_ls_general_castor_take_aim" )	
	end
end

function GeneralCastorKtgmTactic:DoAbilities()

	-- Try to use abilities
	if self.squad_ai:IsInCombat() then

		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) or (self.squad_ai:IsBroken()) then

			-- Try to use Shield Generator if low on health or broken (Last Stand / Kill Team)
			if (self.squad_ai:CanDoAbility( GeneralCastorKtgm.field_id )) then
				self.squad_ai:DoSpecialAbility( GeneralCastorKtgm.field_id )
			end

			-- Try to use army wide squad reinforce if low on health or broken (Last Stand / Kill Team)
			if (self.squad_ai:CanDoAbility( GeneralCastorKtgm.reinforce_id )) then
				self.squad_ai:DoSpecialAbility( GeneralCastorKtgm.reinforce_id )
			end
		end
--[[
		-- Launch rocket salvo at close enemy (Last Stand / Kill Team)
		if self.squad_ai:CanDoAbility(GeneralCastorKtgm.rocket_id) then
			if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) then
				Ability.DoAbilityPos( self.squad_ai, GeneralCastorKtgm.rocket_id, Ability.Filters.CloseEnemy, 3 )
			else
				Ability.DoAbilityPos( self.squad_ai, GeneralCastorKtgm.rocket_id, Ability.Filters.CloseEnemy, 5 )
			end
		end

		-- Drop Heavy Bolter near enemy infantry (Last Stand / Kill Team)
		if self.squad_ai:CanDoAbility(GeneralCastorKtgm.turret_id) then
			if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) then
				Ability.DoAbilityPos( self.squad_ai, GeneralCastorKtgm.turret_id, Ability.Filters.CloseInfantryEnemy, 3 )
				Ability.DoAbilityPos( self.squad_ai, GeneralCastorKtgm.turret_id, Ability.Filters.CloseMonsterEnemy, 2 )
				Ability.DoAbilityPos( self.squad_ai, GeneralCastorKtgm.turret_id, Ability.Filters.CloseCommanderEnemy, 1 )
			else
				Ability.DoAbilityPos( self.squad_ai, GeneralCastorKtgm.turret_id, Ability.Filters.CloseInfantryEnemy, 6 )
				Ability.DoAbilityPos( self.squad_ai, GeneralCastorKtgm.turret_id, Ability.Filters.CloseMonsterEnemy, 4 )
				Ability.DoAbilityPos( self.squad_ai, GeneralCastorKtgm.turret_id, Ability.Filters.CloseCommanderEnemy, 1 )
			end
		end
]]
	end

	-- Launch rocket salvo at close enemy (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(GeneralCastorKtgm.rocket_id)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(GeneralCastorKtgm.rocket_id)
		local oUnit = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 8)
		if (oUnit ~= nil) then
			--print("Using Deploy Rocket Salvo for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(GeneralCastorKtgm.rocket_id, oUnit:GetSquad())
			return
		end
	end

	-- Try to summon a Guard Turret Emplacement ability (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(GeneralCastorKtgm.turret_id)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(GeneralCastorKtgm.turret_id)
		local oUnit = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 6)
		if (oUnit ~= nil) then
			--print("Using Deploy Guard Turret Emplacement for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(GeneralCastorKtgm.turret_id, oUnit:GetSquad())
			return
		end
	end

	-- Use the vehicle health-restoring ability (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(GeneralCastorKtgm.repair_id)) then
		local range = self.squad_ai:GetAbilityRange( GeneralCastorKtgm.repair_id )	
		local squad_filter = function( squad_ai )		
			return squad_ai:CanBeRepaired() and squad_ai:IsInCombat() and squad_ai:GetHealthPercentage() < 0.6
		end	
   		local oSquad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
		if (oSquad ~= nil) then
			oStats = oSquad:GetStats()
			if (oStats ~= nil) then
				local eClass = oStats:GetClass()
				local eName = oSquad:GetSquadName()
				if (eClass == UnitStatsAI.UC_VehicleLow or eClass == UnitStatsAI.UC_VehicleMed or eClass == UnitStatsAI.UC_VehicleHigh
				or eClass == UnitStatsAI.UC_AirMed) then
					self.squad_ai:DoSpecialAbilitySquad( GeneralCastorKtgm.repair_id, oSquad:GetSquad() )
				end
			end
 		end
	end

	-- Use the temprary damage boosting ability on close allied units in combat (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(GeneralCastorKtgm.aim_id)) then
		local range = self.squad_ai:GetAbilityRange( GeneralCastorKtgm.aim_id )	
		local squad_filter = function( squad_ai )		
			return squad_ai:IsInCombat() and squad_ai:GetHealthPercentage() > 0.5
		end	
   		local oSquad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
		if (oSquad ~= nil) then
			oStats = oSquad:GetStats()
			if (oStats ~= nil) then
				local eClass = oStats:GetClass()
				local eName = oSquad:GetSquadName()
				if (eClass == UnitStatsAI.UC_LightInfantryLow or eClass == UnitStatsAI.UC_LightInfantryMed or eClass == UnitStatsAI.UC_LightInfantryHigh
				or eClass == UnitStatsAI.UC_HeavyInfantryMed or eClass == UnitStatsAI.UC_HeavyInfantryHigh or eClass == UnitStatsAI.UC_MonsterMed
				or eClass == UnitStatsAI.UC_MonsterHigh or eClass == UnitStatsAI.UC_Commander) then
					self.squad_ai:DoSpecialAbilitySquad( GeneralCastorKtgm.aim_id, oSquad:GetSquad() )
				end
			end
 		end
	end
end

function GeneralCastorKtgmTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Attach to melee in tier2+
    	if (self.squad_ai:GetMeleeStance() == SquadAI.MSTANCE_Assault) then
         
        	if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then
        
            		if (self:TryAttachSquad(false, true, 50, 150, self.m_fCommanderAttachHealth) == nil) then
                		self:TryAttachSquadMelee()
            		end
        	end
    	end
end
