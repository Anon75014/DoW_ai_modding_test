----------------------------------------
-- File: 'testudocommandtactic.ai'
-- Edited by Arkhan	@ 23.11.2007
-- Edited by Thudmeizer @ 01.02.2025

class 'TestudoCommandTactic' (GuardVehicleTactic)

TestudoCommand = {}

function TestudoCommandTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Testudo Command Tactic")

	-- Vehicle is a light transport
	self.m_iTransportVehicle = 1
	self.m_iTransportSlots = 2
end

function TestudoCommandTactic:InitAbilities()

	-- Init ability ID's
	if (TestudoCommand.detection_id == nil) then
		TestudoCommand.detection_id = cpu_manager.stats:GetAbilityID( "guard_detection_field_badger" )	
	end
	
	if (TestudoCommand.strike_id == nil) then
		TestudoCommand.strike_id = cpu_manager.stats:GetAbilityID( "guard_thunderbolt_strike_badger" )	
	end
end

function TestudoCommandTactic:DoAbilities()

	-- Try to activate detection field
	if (self.squad_ai:CanDoAbility(TestudoCommand.detection_id)) then
	
		local iRange = self.squad_ai:GetAbilityRange(TestudoCommand.detection_id)
		local oSquad = Ability.Filters.CloseInfiltratedEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oSquad ~= nil) then
			
			-- Only try to detect if the infiltrated unit is attacking
			if (oSquad:IsAttacking()) then
				self.squad_ai:DoSpecialAbilitySquad(TestudoCommand.detection_id, oSquad:GetSquad())
			end
		end
	end

	-- Try to perform a Thunderbolt Strike
	if self.squad_ai:CanDoAbility(TestudoCommand.strike_id) then
		local iRange = self.squad_ai:GetAbilityRange(TestudoCommand.strike_id)
		local iPos = self.squad_ai:GetPosition()
		local oSquad = Ability.Filters.CloseInfantryEnemy( iPos , iRange, 6 )
		if oSquad == nil then
			oSquad = Ability.Filters.CloseMonsterEnemy( iPos , iRange, 6 )
			if oSquad == nil then
				oSquad = Ability.Filters.CloseCommanderEnemy( iPos , iRange, 1 )
			end
		end
		if oSquad ~= nil and oSquad:IsValid() then
			self.squad_ai:DoSpecialAbilitySquad(TestudoCommand.strike_id, oSquad:GetSquad())
		end
	end
end
