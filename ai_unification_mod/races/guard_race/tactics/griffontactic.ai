----------------------------------------
-- File: 'griffontactic.ai'
-- Edited by Gambit		@ 6.04.2021
-- Edited by Thudmeizer		@ 17.06.2024

class 'GriffonTactic' (GuardVehicleTactic)

Griffon = {}

function GriffonTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Griffon Tactic")
	self.lastAddonTry = g_iGMT

	self:InitAbilities()
	self.delay_ability_mine_first_time = g_iGMT + math.random(2, 20)
	self.lastused_ability_mine_time = g_iGMT
	self.lastused_ability_mine_position = squad_ai:GetPosition()
	self.min_mine_req_defensive_use = 100 -- amount of req to have before defensive placing 
	self.min_mine_req_in_combat_use = 200 -- amount of req to have in order to use it in combat
	self.min_mine_req_actual = 0  -- the actual req cost of the ability as set in the AE
	self.min_mine_time = 100 -- seconds to wait between use for defensive placement (offensive, uses actual ability recharge)
	self.min_mine_distance = 6 -- min distance between consecutive placements
end

function GriffonTactic:InitAbilities()

	-- Init ability ID's
	if (Griffon.smoke_id == nil) then
		Griffon.smoke_id = cpu_manager.stats:GetAbilityID("guard_smoke_shells")
	end

	if (Griffon.mine_id == nil) then
		Griffon.mine_id = cpu_manager.stats:GetAbilityID("guard_griffon_mine_layer_dummy")
	end
end

function GriffonTactic:AutoBuildAddOn( addonSlot )
	for e in self.squad_ai:GetEntities() do
		local buildChannel = build_manager:GetBuildChannelFromID(e:GetID())
		if buildChannel ~= nil then
			local addOnID = buildChannel:GetItemIDAt(BuildChannelAI.PQ_AddOn, addonSlot)
			if (buildChannel:IsBuilding() == 0 and buildChannel:CanAddToQueue(BuildChannelAI.PQ_AddOn, addOnID) == BuildChannelAI.CANBUILD_Ok) then
				buildChannel:BuildAddOn(addOnID)
				return
			end
		end
	end
	return
end

function GriffonTactic:DoAbilities()

	-- Check to build an addon every 10+ secs
	if g_iGMT > self.lastAddonTry + 10 then
		self.lastAddonTry = g_iGMT
		self:AutoBuildAddOn(0)
	end

	-- Check if I can use smoke shells
	if self.squad_ai:CanDoAbility(Griffon.smoke_id) then
		-- Search a squad
		local iRange = self.squad_ai:GetAbilityRange(Griffon.smoke_id)
		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
		if oUnit ~= nil and oUnit:IsValid() and oUnit:IsInCombat()
		and (cpu_manager:GetUnitStrength(oUnit) > 150 or oUnit:GetNumTroopers() > 8) then
			self.squad_ai:DoSpecialAbilitySquad(Griffon.smoke_id, oUnit:GetSquad())
		end
	end

	-- Check if we can use mine placement ability
	if self.squad_ai:CanDoAbility(Griffon.mine_id) then
		local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
		local weAreInCombat = self.squad_ai:IsInCombat()
		-- Check IF we have the resources for defensive placement
		if iRequisition > self.min_mine_req_defensive_use and not weAreInCombat then
			-- Check first for close strategic point within 35
			local oTarget = Ability.Filters.CloseStrategicPoint(self.squad_ai:GetPosition(), 35)
			if (oTarget ~= nil) then
				local vTargetPos = oTarget:GetPosition()
				-- Modify position
				local iOffsetX = math.random(5, 10)
				local iOffsetZ = math.random(5, 10)
				local vDir = cpu_manager:GetDirectionToEnemy(vTargetPos)		
				if math.random(1, 10) < 4 then
					if math.random(1, 2) == 1 then vDir.x = 1 else vDir.x = -1 end
					if math.random(1, 2) == 1 then vDir.z = 1 else vDir.z = -1 end
				end
				vTargetPos.x = vTargetPos.x + vDir.x * iOffsetX
				vTargetPos.z = vTargetPos.z + vDir.z * iOffsetZ
				if distance_sqr(vTargetPos, self.squad_ai:GetPosition()) > 9 then
					self:DoSpecialAbilityMine(vTargetPos, false)
				end
			else
				-- Otherwise, place the mine elsewhere nearby
				-- Modify position
				local vTargetPos = self.squad_ai:GetPosition()
				local vDir = cpu_manager:GetDirectionToEnemy(vTargetPos)
				vTargetPos.x = vTargetPos.x + vDir.x * 4.5
				vTargetPos.z = vTargetPos.z + vDir.z * 4.5
				self:DoSpecialAbilityMine(vTargetPos, false)
			end
		elseif iRequisition > self.min_mine_req_in_combat_use and weAreInCombat then
		-- Even with low resources, place the mine nearby if IN combat, for offensive usage
			-- Modify position
			local vTargetPos = self.squad_ai:GetPosition()
			local vDir = cpu_manager:GetDirectionToEnemy(vTargetPos)
			vTargetPos.x = vTargetPos.x + vDir.x * 3
			vTargetPos.z = vTargetPos.z + vDir.z * 3
			-- The "true" below is for no random delay or other limits when used in combat
			self:DoSpecialAbilityMine(vTargetPos, true)
		end
	end
	
	-- Call standard method
	GuardVehicleTactic.DoAbilities(self)
end

function GriffonTactic:DoSpecialAbilityMine(position, inCombat)

	local current_time = g_iGMT
	local current_req = resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Requisition)
	local last_time = self.lastused_ability_mine_time
	local last_pos = self.lastused_ability_mine_position
	local min_time = self.min_mine_time 
	local min_distance = self.min_mine_distance
	-- Check situation
	if current_req > self.min_mine_req_actual then
		if inCombat or (current_time - last_time > min_time and distance_sqr(position,last_pos) > min_distance*min_distance
		and self.delay_ability_mine_first_time < g_iGMT) then
			-- Use mine placement ability
			self.squad_ai:DoSpecialAbilityPos(Griffon.mine_id, position)
			self.lastused_ability_mine_time = current_time
			self.lastused_ability_mine_position = position
		end
	end
end
