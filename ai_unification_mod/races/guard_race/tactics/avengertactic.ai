----------------------------------------
-- File: 'avengertactic.ai'
-- Edited by Thudmeizer 27.03.2024
-- Edited by Shepherd 20.10.2024

class 'AvengerTactic' (GuardInfantryTactic)

Avenger = {}

function AvengerTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Avenger Tactic")
end

function AvengerTactic:InitAbilities()

	-- Init ability ID's
	if (Avenger.hypersonic_id == nil) then
		Avenger.hypersonic_id = cpu_manager.stats:GetAbilityID( "guard_aircraft_hypersonic" )	
	end
	
	if (Avenger.fuel_id == nil) then
		Avenger.fuel_id = cpu_manager.stats:GetAbilityID( "guard_avenger_fuel_bomb" )	
	end

	if (Avenger.krak_id == nil) then
		Avenger.krak_id = cpu_manager.stats:GetAbilityID( "guard_krak_bombs_vendetta" )	
	end

	if (Avenger.nuke_id == nil) then
		Avenger.nuke_id = cpu_manager.stats:GetAbilityID( "guard_vendetta_nuclear_strike" )	
	end
end

function AvengerTactic:DoAbilities()

	-- Enable Hypersonics if in combat and low on health
	if (self.squad_ai:IsInCombat()) and (self.squad_ai:IsUnderAttack()) then
		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
			if (self.squad_ai:CanDoAbility( Avenger.hypersonic_id )) then
				self.squad_ai:DoSpecialAbility( Avenger.hypersonic_id )
			end
		end
	end

	-- Try to use abilities
	if self.squad_ai:IsInCombat() then
		-- Check if we're in close combat - Fuel Bomb
		if self.squad_ai:CanDoAbility( Avenger.fuel_id ) and not self.squad_ai:IsInStateMove() then
			local selfPos = self.squad_ai:GetPosition()
			local oEnemySquad = Ability.Filters.CloseInfantryEnemy(selfPos, 25, 1)
			if oEnemySquad ~= nil and not oEnemySquad:IsBroken() then
				local oEnemyPos = oEnemySquad:GetPosition()
				selfPos.x = selfPos.x + 2*(oEnemyPos.x - selfPos.x)
				selfPos.z = selfPos.z + 2*(oEnemyPos.z - selfPos.z)
				self.squad_ai:DoMove(selfPos)
				self.squad_ai:DoSpecialAbility( Avenger.fuel_id )
				return
			end
		end
		-- Check if we're in close combat - Krak Bomb
		if self.squad_ai:CanDoAbility( Avenger.krak_id ) and not self.squad_ai:IsInStateMove() then
			local selfPos = self.squad_ai:GetPosition()
			local oEnemyVehicle = Ability.Filters.CloseVehicleEnemy(selfPos, 25, 1)
			if oEnemyVehicle ~= nil then
				local oEnemyPos = oEnemyVehicle:GetPosition()
				selfPos.x = selfPos.x + 2*(oEnemyPos.x - selfPos.x)
				selfPos.z = selfPos.z + 2*(oEnemyPos.z - selfPos.z)
				self.squad_ai:DoMove(selfPos)
				self.squad_ai:DoSpecialAbility( Avenger.krak_id )
				return
			end
		end

		-- Check if I can launch Nuclear Tomahawk Missiles
		if (self.squad_ai:CanDoAbility(Avenger.nuke_id)) then
			if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
				Ability.DoAbilityPos( self.squad_ai, Avenger.nuke_id, Ability.Filters.CloseEnemy, 4 ) 
			else
				Ability.DoAbilityPos( self.squad_ai, Avenger.nuke_id, Ability.Filters.CloseEnemy, 8 ) 
			end
		end
	end

	-- Spawn Marauder Squad (Vendetta Command)
	if (self.squad_ai:CanDirectSpawn()) then 
		self.squad_ai:DoDirectSpawn()
	end

	-- New code to unstuck units with pathing issues, that can jump.
	-- Call it with [true], only for multi-membered squads.
	self:SolveStuckCase(false)
end
