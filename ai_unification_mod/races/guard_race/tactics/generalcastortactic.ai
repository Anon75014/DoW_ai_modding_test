----------------------------------------
-- File: 'generalGeneralCastortactic.ai'
-- Edited by Thudmeizer @ 22.01.2024

class 'GeneralCastorTactic' (GuardInfantryTactic)

GeneralCastor = {}

function GeneralCastorTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("General Castor Squad Tactic")
end

function GeneralCastorTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function GeneralCastorTactic:IsDefender()
	return self:IsCommanderDefender()
end

function GeneralCastorTactic:InitAbilities()

	-- Init ability ID's
	if (GeneralCastor.rally_id == nil) then
		GeneralCastor.rally_id = cpu_manager.stats:GetAbilityID( "guard_master_vox_rally" )	
	end

	if (GeneralCastor.kasrkin_id == nil) then
		GeneralCastor.kasrkin_id = cpu_manager.stats:GetAbilityID( "guard_general_castor_kasrkin_skirmish" )	
	end
	
	if (GeneralCastor.field_id == nil) then
		GeneralCastor.field_id = cpu_manager.stats:GetAbilityID( "guard_general_castor_refractor_field_skirmish" )	
	end

	if (GeneralCastor.rocket_id == nil) then
		GeneralCastor.rocket_id = cpu_manager.stats:GetAbilityID( "guard_general_castor_rocket_run_skirmish" )	
	end

	if (GeneralCastor.turret_id == nil) then
		GeneralCastor.turret_id = cpu_manager.stats:GetAbilityID( "guard_general_castor_turret_skirmish" )	
	end

	if (GeneralCastor.terror_id == nil) then
		GeneralCastor.terror_id = cpu_manager.stats:GetAbilityID( "guard_commissar_lord_inspire_terror" )	
	end
end

function GeneralCastorTactic:DoAbilities()

	-- Try to use abilities
	if self.squad_ai:IsInCombat() then

		-- Try to use Shield Generator if low on health or broken
		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) or (self.squad_ai:IsBroken()) then
			if (self.squad_ai:CanDoAbility( GeneralCastor.field_id )) then
				self.squad_ai:DoSpecialAbility( GeneralCastor.field_id )
			end
		end

		-- Launch rocket salvo at close enemy 
		if self.squad_ai:CanDoAbility(GeneralCastor.rocket_id) then
			if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) then
				Ability.DoAbilityPos( self.squad_ai, GeneralCastor.rocket_id, Ability.Filters.CloseEnemy, 3 )
			else
				Ability.DoAbilityPos( self.squad_ai, GeneralCastor.rocket_id, Ability.Filters.CloseEnemy, 5 )
			end
		end

		-- Drop Heavy Bolter near enemy infantry
		if self.squad_ai:CanDoAbility(GeneralCastor.turret_id) then
			if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.6) then
				Ability.DoAbilityPos( self.squad_ai, GeneralCastor.turret_id, Ability.Filters.CloseInfantryEnemy, 3 )
				Ability.DoAbilityPos( self.squad_ai, GeneralCastor.turret_id, Ability.Filters.CloseMonsterEnemy, 2 )
				Ability.DoAbilityPos( self.squad_ai, GeneralCastor.turret_id, Ability.Filters.CloseCommanderEnemy, 1 )
			else
				Ability.DoAbilityPos( self.squad_ai, GeneralCastor.turret_id, Ability.Filters.CloseInfantryEnemy, 6 )
				Ability.DoAbilityPos( self.squad_ai, GeneralCastor.turret_id, Ability.Filters.CloseMonsterEnemy, 4 )
				Ability.DoAbilityPos( self.squad_ai, GeneralCastor.turret_id, Ability.Filters.CloseCommanderEnemy, 1 )
			end
		end

		-- Summon Veteran Kasrkin Bodyguards to fight for the Lord General
		if self.squad_ai:CanDoAbility(GeneralCastor.kasrkin_id) then
			Ability.DoAbilityPos( self.squad_ai, GeneralCastor.kasrkin_id, Ability.Filters.CloseVehicleEnemy, 1 )
			Ability.DoAbilityPos( self.squad_ai, GeneralCastor.kasrkin_id, Ability.EntityFilters.CloseBaseEntityEnemy, 3 )
			Ability.DoAbilityPos( self.squad_ai, GeneralCastor.kasrkin_id, Ability.Filters.CloseSquadEnemy, 1 )
			Ability.DoAbilityPos( self.squad_ai, GeneralCastor.kasrkin_id, Ability.Filters.CloseMonsterEnemy, 3 )
			Ability.DoAbilityPos( self.squad_ai, GeneralCastor.kasrkin_id, Ability.Filters.CloseCommanderEnemy, 1 )
		end
	end
	
	-- Demoralize the enemy when in range
	if self.squad_ai:CanDoAbility(GeneralCastor.terror_id) then
		-- If we are dying, lower requisites for attacks
		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
			Ability.DoAbilityTarget( self.squad_ai, GeneralCastor.terror_id, Ability.Filters.CloseInfantryEnemy, 4 )
			Ability.DoAbilityTarget( self.squad_ai, GeneralCastor.terror_id, Ability.Filters.CloseMonsterEnemy, 2 )
			Ability.DoAbilityTarget( self.squad_ai, GeneralCastor.terror_id, Ability.Filters.CloseCommanderEnemy, 1 )
		else
			Ability.DoAbilityTarget( self.squad_ai, GeneralCastor.terror_id, Ability.Filters.CloseInfantryEnemy, 8 )
			Ability.DoAbilityTarget( self.squad_ai, GeneralCastor.terror_id, Ability.Filters.CloseMonsterEnemy, 3 )
			Ability.DoAbilityTarget( self.squad_ai, GeneralCastor.terror_id, Ability.Filters.CloseCommanderEnemy, 1 )
		end
	end
end

function GeneralCastorTactic:CheckForBroken()

	if (self.squad_ai:IsBroken()) then
	
		-- Check if I can repair my morale
		if (self.squad_ai:CanDoAbility( GeneralCastor.rally_id )) then
			self.squad_ai:DoSpecialAbility( GeneralCastor.rally_id )
		end
	end

	-- Call basic broken check method
	GuardInfantryTactic.CheckForBroken(self)
end

function GeneralCastorTactic:Reinforce()

	if not self.squad_ai:IsReinforcing() then

		-- try for different types of squad members
		local iVoxIndex = 0
        	local iLordCommissarIndex = 1
		
		local iNumVox = self.squad_ai:GetLeaderCount( iVoxIndex )
		local iNumLordCommissar = self.squad_ai:GetLeaderCount( iLordCommissarIndex )

		-- Desired number of each leader type
		local iDesiredVox = 1
		local iDesiredLordCommissar = 1
		
		-- Desired order of reinforcing
		if iNumVox < iDesiredVox then
			if self.squad_ai:CanReinforce( true, iVoxIndex ) then
				self.squad_ai:DoReinforce( true, iVoxIndex )
			end
		elseif iNumLordCommissar < iDesiredLordCommissar then 
			if self.squad_ai:CanReinforce( true, iLordCommissarIndex ) then
				self.squad_ai:DoReinforce( true, iLordCommissarIndex )
			end
        else
			if (self.squad_ai:CanReinforce( false, 0 )) then
				self.squad_ai:DoReinforce( false, 0 )
			end			
		end
	end
end