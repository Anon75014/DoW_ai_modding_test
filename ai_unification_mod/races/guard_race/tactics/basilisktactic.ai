----------------------------------------
-- File: 'basilisktactic.ai'
-- Edited by Arkhan		@ 09.11.2006
-- Edited by Thudmeizer		@ 31.07.2024

class 'BasiliskTactic' (GuardVehicleTactic)

Basilisk = {}

function BasiliskTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Basilisk Tactic")
end

function BasiliskTactic:AutoBuildAddOn( addonSlot )
	for e in self.squad_ai:GetEntities() do
		local buildChannel = build_manager:GetBuildChannelFromID(e:GetID())
		if buildChannel ~= nil then
			local addOnID = buildChannel:GetItemIDAt(BuildChannelAI.PQ_AddOn, addonSlot)
			if (buildChannel:IsBuilding() == 0 and buildChannel:CanAddToQueue(BuildChannelAI.PQ_AddOn, addOnID) == BuildChannelAI.CANBUILD_Ok) then
				buildChannel:BuildAddOn(addOnID)
				return
			end
		end
	end
	return
end

function BasiliskTactic:InitAbilities()

	-- Init ability ID's
	if (Basilisk.shaker_id == nil) then
		Basilisk.shaker_id = cpu_manager.stats:GetAbilityID("earthshaker_round")
	end

	if (Basilisk.cluster_id == nil) then
		Basilisk.cluster_id = cpu_manager.stats:GetAbilityID("guard_cluster_impact_ability")
	end
end

function BasiliskTactic:DoAbilities()

	-- Check if I can launch EarthShaker Round
	if self.squad_ai:CanDoAbility(Basilisk.shaker_id) then
		local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
		local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
		if (Tactic.Options.can_reinforce and iRequisition > 500 and iPower > 500) then
			if Ability.DoAbilityPos(self.squad_ai, Basilisk.shaker_id, Ability.Filters.CloseEnemy, 16)
			or Ability.DoAbilityPos(self.squad_ai, Basilisk.shaker_id, Ability.EntityFilters.CloseBaseEntityEnemy, 3) then
				return
			end
		end
	end

	-- Check if I can launch Cluster Impact Round
	if self.squad_ai:CanDoAbility(Basilisk.cluster_id) then
		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
			if Ability.DoAbilityPos(self.squad_ai, Basilisk.cluster_id, Ability.Filters.CloseInfantryEnemy, 4)
			or Ability.DoAbilityPos(self.squad_ai, Basilisk.cluster_id, Ability.Filters.CloseMonsterEnemy, 2) then
				return
			end
		else
			if Ability.DoAbilityPos(self.squad_ai, Basilisk.cluster_id, Ability.Filters.CloseInfantryEnemy, 8)
			or Ability.DoAbilityPos(self.squad_ai, Basilisk.cluster_id, Ability.Filters.CloseMonsterEnemy, 3) then
				return
			end
		end
	end

	-- Check to build an addon and if we have available resources and health
	local iReq = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
	local iPow = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
	if iReq > 400 and iPow > 300 and self.squad_ai:GetHealthPercentage() > 0.35 then
		self:AutoBuildAddOn(0)
	end

	-- Call standard method
	GuardVehicleTactic.DoAbilities(self)
end
