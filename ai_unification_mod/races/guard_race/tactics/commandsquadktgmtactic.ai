----------------------------------------
-- File: 'commandsquadktgmtactic.ai'
-- Edited by Thudmeizer @ 04.04.2024

class 'CommandSquadKtgmTactic' (GuardInfantryTactic)

CommandSquadKtgm = {}

CommandSquadKtgmTactic.SpecialAbilities = 
{
	{ nil, "guard_ls_command_squad_priest_fanatical",			Ability.Filters.IsInCombat },
	{ nil, "guard_ls_command_squad_priest_fanatical_plus", 			Ability.Filters.IsInCombat },
}
--[[
CommandSquadKtgmTactic.PosAbilities = 
{
	--{ nil, "guard_ls_command_squad_strafing_run",				Ability.Filters.CloseEnemy, 6 },
}

CommandSquadKtgmTactic.TargetAbilities = 
{
	--{ nil, "guard_ls_command_squad_psyker_lightning_arc", 		Ability.Filters.CloseSquadEnemy, 1 },
	--{ nil, "guard_ls_command_squad_psyker_lightning_arc_plus", 		Ability.Filters.CloseSquadEnemy, 1 },
	--{ nil, "guard_ls_command_squad_psyker_strip_soul", 			Ability.Filters.CloseCommanderEnemy, 1 },
	--{ nil, "guard_ls_command_squad_psyker_strip_soul_plus", 		Ability.Filters.CloseCommanderEnemy, 1 },
	--{ nil, "guard_ls_command_squad_psyker_curse_machine_spirits", 	Ability.Filters.CloseVehicleEnemy, 1 },
	--{ nil, "guard_ls_command_squad_psyker_curse_machine_spirits_plus", 	Ability.Filters.CloseVehicleEnemy, 1 },
}
]]
function CommandSquadKtgmTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Command Squad Leader Kill Team Tactic")
	
	-- Command squad is able to enter a bunker
	self.m_bBunkerSquad = true

	-- Init execute delay time
	CommandSquadKtgm.NextExecuteCheck = 0
end

-- Assassinate win condition -- never attack
function CommandSquadKtgmTactic:IsAttacker()

	-- Never attack in assassinate game mode
	if (cpu_manager.assassinate) then
		return false
	end
	
	-- Attack if we have more than one squad member
	if (self.squad_ai:GetNumTroopers() > 1) then
		return true
	end
	return self:IsCommanderAttacker()
end

-- Assassinate win condition -- never defend
function CommandSquadKtgmTactic:IsDefender()

	-- Never defend in assassinate game mode
	if (cpu_manager.assassinate) then
		return false
	end
	
	-- Defend if we have more than one squad member
	if (self.squad_ai:GetNumTroopers() > 1) then
		return true
	end
	return self:IsCommanderDefender()
end

function CommandSquadKtgmTactic:InitAbilities()

	-- Init ability ID's
	if (CommandSquadKtgmTactic.SpecialAbilities[1][1] == nil) then
		for i in CommandSquadKtgmTactic.SpecialAbilities do
			local ability_id = cpu_manager.stats:GetAbilityID( CommandSquadKtgmTactic.SpecialAbilities[i][2] )
			CommandSquadKtgmTactic.SpecialAbilities[i][1] = ability_id
		end
	end
--[[	
	if (CommandSquadKtgmTactic.PosAbilities[1][1] == nil) then
		for i in CommandSquadKtgmTactic.PosAbilities do
			local ability_id = cpu_manager.stats:GetAbilityID( CommandSquadKtgmTactic.PosAbilities[i][2] )
			CommandSquadKtgmTactic.PosAbilities[i][1] = ability_id
		end
	end
	
	if (CommandSquadKtgmTactic.TargetAbilities[1][1] == nil) then
		for i in CommandSquadKtgmTactic.TargetAbilities do
			local ability_id = cpu_manager.stats:GetAbilityID( CommandSquadKtgmTactic.TargetAbilities[i][2] )
			CommandSquadKtgmTactic.TargetAbilities[i][1] = ability_id
		end
	end
]]
	-- Init additional ability ID's
	if (CommandSquadKtgm.execute_id == nil) then
		CommandSquadKtgm.execute_id = cpu_manager.stats:GetAbilityID( "guard_ls_command_squad_commissar_execute" )
	end

	if (CommandSquadKtgm.strafing_id == nil) then
		CommandSquadKtgm.strafing_id = cpu_manager.stats:GetAbilityID( "guard_ls_command_squad_strafing_run" )
	end

	if (CommandSquadKtgm.lightning_id == nil) then
		CommandSquadKtgm.lightning_id = cpu_manager.stats:GetAbilityID( "guard_ls_command_squad_psyker_lightning_arc" )
	end

	if (CommandSquadKtgm.lightning_plus == nil) then
		CommandSquadKtgm.lightning_plus = cpu_manager.stats:GetAbilityID( "guard_ls_command_squad_psyker_lightning_arc_plus" )
	end

	if (CommandSquadKtgm.strip_id == nil) then
		CommandSquadKtgm.strip_id = cpu_manager.stats:GetAbilityID( "guard_ls_command_squad_psyker_strip_soul" )
	end

	if (CommandSquadKtgm.strip_plus == nil) then
		CommandSquadKtgm.strip_plus = cpu_manager.stats:GetAbilityID( "guard_ls_command_squad_psyker_strip_soul_plus" )
	end

	if (CommandSquadKtgm.spirits_id == nil) then
		CommandSquadKtgm.spirits_id = cpu_manager.stats:GetAbilityID( "guard_ls_command_squad_psyker_curse_machine_spirits" )
	end

	if (CommandSquadKtgm.spirits_plus == nil) then
		CommandSquadKtgm.spirits_plus = cpu_manager.stats:GetAbilityID( "guard_ls_command_squad_psyker_curse_machine_spirits_plus" )
	end
end

function CommandSquadKtgmTactic:DoAbilities()

	for i in CommandSquadKtgmTactic.SpecialAbilities do
		local ability_id = CommandSquadKtgmTactic.SpecialAbilities[i][1]
		if ability_id ~= nil then

		local filter = CommandSquadKtgmTactic.SpecialAbilities[i][3]
			Ability.DoAbility( self.squad_ai, ability_id, filter ) 
		end
	end
--[[
	for i in CommandSquadKtgmTactic.PosAbilities do
		local ability_id = CommandSquadKtgmTactic.PosAbilities[i][1]
		if ability_id ~= nil then

			local filter = CommandSquadKtgmTactic.PosAbilities[i][3]
			local squad_count = CommandSquadKtgmTactic.PosAbilities[i][4]
			Ability.DoAbilityPos( self.squad_ai, ability_id, filter, squad_count ) 
		end
	end

	for i in CommandSquadKtgmTactic.TargetAbilities do
		local ability_id = CommandSquadKtgmTactic.TargetAbilities[i][1]
		if ability_id ~= nil then

			local filter = CommandSquadKtgmTactic.TargetAbilities[i][3]
			local squad_count = CommandSquadKtgmTactic.TargetAbilities[i][4]
			Ability.DoAbilityTarget( self.squad_ai, ability_id, filter, squad_count ) 
		end
	end
]]
	-- Launch strafing run at close enemy (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(CommandSquadKtgm.strafing_id)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(CommandSquadKtgm.strafing_id)
		local oUnit = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 8)
		if (oUnit ~= nil) then
			--print("Using Deploy Strafing Run for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(CommandSquadKtgm.strafing_id, oUnit:GetSquad())
			return
		end
	end

	-- Launch lightning arc at close enemy (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(CommandSquadKtgm.lightning_id)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(CommandSquadKtgm.lightning_id)
		local oUnit = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 6)
		if (oUnit ~= nil) then
			--print("Using Lightning Arc for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(CommandSquadKtgm.lightning_id, oUnit:GetSquad())
			return
		end
	end

	-- Launch lightning arc plus at close enemy (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(CommandSquadKtgm.lightning_plus)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(CommandSquadKtgm.lightning_plus)
		local oUnit = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 6)
		if (oUnit ~= nil) then
			--print("Using Lightning Arc Plus for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(CommandSquadKtgm.lightning_plus, oUnit:GetSquad())
			return
		end
	end

	-- Launch strip soul at close enemy commander (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(CommandSquadKtgm.strip_id)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(CommandSquadKtgm.strip_id)
		local oUnit = cpu_manager.cpu_player:FindFirstCommanderEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Strip Soul for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(CommandSquadKtgm.strip_id, oUnit:GetSquad())
			return
		end
	end

	-- Launch strip soul plus at close enemy commander (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(CommandSquadKtgm.strip_plus)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(CommandSquadKtgm.strip_plus)
		local oUnit = cpu_manager.cpu_player:FindFirstCommanderEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Strip Soul Plus for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(CommandSquadKtgm.strip_plus, oUnit:GetSquad())
			return
		end
	end

	-- Launch curse spirits at close enemy vehicle (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(CommandSquadKtgm.spirits_id)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(CommandSquadKtgm.spirits_id)
		local oUnit = cpu_manager.cpu_player:FindFirstVehicleEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Curse Spirits for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(CommandSquadKtgm.spirits_id, oUnit:GetSquad())
			return
		end
	end

	-- Launch curse spirits plus at close enemy vehicle (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(CommandSquadKtgm.spirits_plus)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(CommandSquadKtgm.spirits_plus)
		local oUnit = cpu_manager.cpu_player:FindFirstVehicleEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Curse Spirits Plus for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(CommandSquadKtgm.spirits_plus, oUnit:GetSquad())
			return
		end
	end

	if CommandSquadKtgm.NextExecuteCheck == nil then 
		CommandSquadKtgm.NextExecuteCheck = 0
	end

	-- TargetSelf: When attached to squad, executes one of his own soldiers to increase their fighting potential
	-- GAMBIT: Added one more function (IsNearbySquadsMoraleBelow), for more cases of nearby morale-broken troops
	if g_iGMT > CommandSquadKtgm.NextExecuteCheck and (self.squad_ai:CanDoAbility(CommandSquadKtgm.execute_id))
	and self.squad_ai:IsAttacking() and self.squad_ai:IsAttached() then
		if self.squad_ai:GetNumTroopers() > 3
		or self:IsNearbySquadsMoraleBelow( self.squad_ai:GetPosition(), 30, 0.3, false ) then
			-- Use execute ability
			if self.squad_ai:CanDoAbility(CommandSquadKtgm.execute_id) then
				self.squad_ai:DoSpecialAbility(CommandSquadKtgm.execute_id) 
				CommandSquadKtgm.NextExecuteCheck = g_iGMT + 20
			end
		end
	end

	-- Spawn Ogryn Command Squad
	if (self.squad_ai:CanDirectSpawn()) then 
		self.squad_ai:DoDirectSpawn()
	end
end

function CommandSquadKtgmTactic:Reinforce()

	-- Allow free reinforcing during harassing time
	if (g_iGMT > DefendChokePointPlan.HarassingTime * 60) then

		-- If there are no ressources available, don't upgrade!
		if (not Tactic.Options.can_reinforce) then
			return
		end
	end

	if (not self.squad_ai:IsReinforcing()) then

		-- Always try for the actual leader first
		if (self.squad_ai:CanReinforce( false, 0 )) then
			self.squad_ai:DoReinforce( false, 0 )
			return
		end

		-- Try for different types of squad members
		local commissarIndex = 0
		local psykerIndex = 1
		local sergeantIndex = 2
		local priestIndex = 3
	
		-- Get current leader count
		local numCommissars = self.squad_ai:GetLeaderCount( commissarIndex )
		local numPsykers = self.squad_ai:GetLeaderCount( psykerIndex)
		local numSergeants = self.squad_ai:GetLeaderCount( sergeantIndex )
		local numPriests = self.squad_ai:GetLeaderCount( priestIndex )

		-- Desired number of each leader type
		local desiredCommissars = 0
		local desiredPsykers = 0
		local desiredSergeants = 0
		local desiredPriests = 2
		
		-- If squad size research is done want a psyker
		local squadMax = self.squad_ai:GetMaxLeaderCount()
		if (squadMax >= 4) then
			desiredCommissars = 0
			desiredPsykers = 1
			desiredSergeants = 0
			desiredPriests = 3
		end
		
		-- Check if the enemy has infiltrators
		if (cpu_manager:EnemyHasUnitInfiltrators() or cpu_manager:EnemyHasBaseInfiltrators()) then
		
			-- Make sure we have a psyker
			if (numPsykers <= 0) then
				desiredPsykers = 1
				desiredPriests = 1
				desiredSergeants = 0
				desiredCommissars = 0
			end
		end

		-- Desired order of reinforcing
		if (numPsykers < desiredPsykers) then
			if self.squad_ai:CanReinforce( true, psykerIndex ) then
				self.squad_ai:DoReinforce( true, psykerIndex )
			end
		elseif (numPriests < desiredPriests) then
			if self.squad_ai:CanReinforce( true, priestIndex ) then
				self.squad_ai:DoReinforce( true, priestIndex )
			end
		elseif (numSergeants < desiredSergeants) then
			if self.squad_ai:CanReinforce( true, sergeantIndex ) then
				self.squad_ai:DoReinforce( true, sergeantIndex )
			end
		elseif (numCommissars < desiredCommissars) then
			if self.squad_ai:CanReinforce( true, commissarIndex ) then
				self.squad_ai:DoReinforce( true, commissarIndex )
			end
		end
	end
end

