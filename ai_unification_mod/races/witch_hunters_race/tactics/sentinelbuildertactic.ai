----------------------------------------
-- File: 'sentinelbuilderTactic.ai'
-- Created by Thudmeizer	@ 21.02.2009
-- Updated by Gambit		@ 07.01.2025

class 'SentinelBuilderTactic' (EngineerTactic)

SentinelBuilder = {}

function SentinelBuilderTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Sentinel Builder Tactic")

    	-- Squad is able to deep-strike    
    	self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("witch_hunters_adeptus_arbites_hq")
end

function SentinelBuilderTactic:IsAttacker()
    	return false
end

function SentinelBuilderTactic:IsDefender()
    	-- Don't defend if we are too far away from home, or severely damaged
    	if distance_sqr(self.squad_ai:GetPosition(), cpu_manager.start_pos) > 2800
    	or self.squad_ai:GetHealthPercentage() < 0.3 then
        	return false
    	end

    	return cpu_manager:HQThreat()
    	or self.squad_ai:IsUsingAbility(SentinelBuilder.combatboost_id)
    	or self.squad_ai:WasRecentlyHurt()
end

function SentinelBuilderTactic:IsAffectedByMorale()
    	return false
end

function SentinelBuilderTactic:InitAbilities()
	if SentinelBuilder.combatboost_id == nil then
        	SentinelBuilder.combatboost_id = cpu_manager.stats:GetAbilityID( "witch_hunters_sentinel_combat" )
        	SentinelBuilder.full_repair_id = cpu_manager.stats:GetAbilityID( "witch_hunters_builder_repair" )
    	end
end

function SentinelBuilderTactic:CheckForDeath()
end

function SentinelBuilderTactic:CheckForDance()
end

function SentinelBuilderTactic:GatherMove(vPos)
end

function SentinelBuilderTactic:DoAbilities()

	if self.squad_ai:GetHealthPercentage() < 0.6 then
        	if (self.squad_ai:CanDoAbility(SentinelBuilder.full_repair_id) and not self.squad_ai:IsInCombat()
        	and not cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 30)) then
            		self.squad_ai:DoSpecialAbility(SentinelBuilder.full_repair_id)
        end
    	elseif self.squad_ai:GetHealthPercentage() < 0.9 then
        	if (self.squad_ai:CanDoAbility(SentinelBuilder.full_repair_id) and not self.squad_ai:IsInCombat()
        	and not cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 50)) then
            		self.squad_ai:DoSpecialAbility(SentinelBuilder.full_repair_id)
        	end
    	end

    	-- Check if we can use the melee ability
    	if self.squad_ai:CanDoAbility(SentinelBuilder.combatboost_id) then

        	-- Check for potential direct attackers
        	local isHurt = self.squad_ai:WasRecentlyHurt()
        	-- Check for distant/close enemies
        	local oEnemy = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), 30, 1)
        	local oCloseEnemy = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), 6, 1)

        	-- Switch-on combat ability, if we have to defend our base against close enemies
        	if not self.squad_ai:IsUsingAbility(SentinelBuilder.combatboost_id) and oEnemy ~= nil then
            		-- Switch on combat ability
            		if oCloseEnemy ~= nil then
                		self.squad_ai:DoSpecialAbility(SentinelBuilder.combatboost_id)
            		end
            	self.m_iMoveDelay = g_iGMT
            	self.m_bBusy = true

        	-- Switch-off combat ability if there's no close enemy unit
        	elseif self.squad_ai:IsUsingAbility(SentinelBuilder.combatboost_id) and oCloseEnemy == nil then
            		-- Switch off combat ability
            		self.squad_ai:DoSpecialAbility(SentinelBuilder.combatboost_id)
            		self.m_iMoveDelay = 0
            		self.m_bBusy = false
        	end

        	if oEnemy ~= nil then
            		self.squad_ai:DoStop()
            		if distance_sqr(oEnemy:GetPosition(), cpu_manager.start_pos) < 2800 then
                		self.squad_ai:DoAttackMove(oEnemy:GetPosition())
            		else
                		Tactic.SetState( self, self:GetState() )
                		cpu_manager:DoMove(self.squad_ai, cpu_manager.start_pos, false, "DefendBase")
            		end
        	end
    	end
end

function SentinelBuilderTactic:HoldState()

    	-- If I'm idle or was hurt, restart
    	if (self.squad_ai:IsIdle() or not self:IsMoving() or self.squad_ai:WasRecentlyHurt()) then
        	Tactic.SetState( self, self:GetState() )
    	end
end

function SentinelBuilderTactic:AttackingState()

    	-- If I'm idle or was hurt, restart
    	if (self.squad_ai:IsIdle() or not self:IsMoving() or self.squad_ai:WasRecentlyHurt()) then
        	Tactic.SetState( self, self:GetState() )
    	end
end

function SentinelBuilderTactic:Update()
    	if self:IsComplete() then
        	return
    	end

    	-- State machine
    	if not EngineerTactic.Update(self) then
        	return
    	end
end