----------------------------------------
-- File: 'culexustactic.ai'
-- Edited by Gambit @ 25.09.2020

class 'CulexusTactic' (WitchHuntersInfantryTactic)

Culexus = {}

function CulexusTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Culexus Tactic")
    self.abilityLastUse = g_iGMT
end

function CulexusTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function CulexusTactic:IsDefender()
	return self:IsCommanderDefender()
end

function CulexusTactic:InitAbilities()

	 if Culexus.grenade_id == nil then
		Culexus.grenade_id = cpu_manager.stats:GetAbilityID( "witch_hunters_culexus_psykout_grenades" )
		Culexus.speculum_id = cpu_manager.stats:GetAbilityID( "witch_hunters_culexus_animus_speculum" )
	 end
end

function CulexusTactic:DoAbilities()

	if g_iGMT > self.abilityLastUse + 7 and self.squad_ai:IsInCombat() then

		if self.squad_ai:CanDoAbility(Culexus.grenade_id) then
			if Ability.DoAbilityTarget( self.squad_ai, Culexus.grenade_id, Ability.Filters.CloseCommanderEnemy, 1 )
			or Ability.DoAbilityTarget( self.squad_ai, Culexus.grenade_id, Ability.Filters.CloseMonsterEnemy, 1 )
			then
				self.abilityLastUse = g_iGMT
				return
			end
		end

		if self.squad_ai:CanDoAbility(Culexus.speculum_id) then
			local iPos = self.squad_ai:GetPosition()
			local iRange = self.squad_ai:GetAbilityRange(Culexus.speculum_id) + 2
			local oUnit = Ability.Filters.CloseCommanderEnemy(iPos, iRange, 1)
			if oUnit == nil then
				oUnit = Ability_WH.Filters.CloseMonsterHighEnemy(iPos, iRange, 1)
			end
			if oUnit ~= nil and cpu_manager:GetUnitStrength(oUnit) > 200 and distance_sqr(iPos, oUnit:GetPosition())> 30 then
				self.squad_ai:DoSpecialAbilitySquad(Culexus.speculum_id, oUnit:GetSquad())
				self.abilityLastUse = g_iGMT
				return
			end
		end
	end
end


---------------------------------------------------------

Ability_WH = 
{
Filters = 
{
	CloseMonsterEnemy = function(vPosition, iTolerance, iCount)

		-- Make sure that count is valid
		if (iCount == nil) then
			iCount = 1
		end

		-- Quick check
		if (not cpu_manager:CloseEnemyUnits(vPosition, iTolerance)) then
			return nil
		end

		local oFunctor = function(oSquad, iCount)
			local oStats = oSquad:GetStats()
			if (oStats == nil) then
				return false
			end
			return ((oStats:GetClass() == UnitStatsAI.UC_MonsterHigh or oStats:GetClass() == UnitStatsAI.UC_MonsterMed) and oSquad:GetNumTroopers() >= iCount)
		end
		return AbbessSanctorumTactic:GetClosestEnemySquad(vPosition, iTolerance, oFunctor, iCount)
	end,


	CloseMonsterHighEnemy = function(vPosition, iTolerance, iCount)

		-- Make sure that count is valid
		if (iCount == nil) then
			iCount = 1
		end

		-- Quick check
		if (not cpu_manager:CloseEnemyUnits(vPosition, iTolerance)) then
			return nil
		end

		local oFunctor = function(oSquad, iCount)
			local oStats = oSquad:GetStats()
			if (oStats == nil) then
				return false
			end
			return (oStats:GetClass() == UnitStatsAI.UC_MonsterHigh and oSquad:GetNumTroopers() >= iCount)
		end
		return AbbessSanctorumTactic:GetClosestEnemySquad(vPosition, iTolerance, oFunctor, iCount)
	end,
}
}