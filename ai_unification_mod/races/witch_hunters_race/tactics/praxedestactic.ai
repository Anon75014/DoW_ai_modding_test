----------------------------------------
-- File: 'praxedestactic.ai'
-- Edited by Thudmeizer @ 07.11.2024

class 'PraxedesTactic' (WitchHuntersInfantryTactic)

Praxedes = {}

function PraxedesTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Praxedes Tactic")

	self.timedDirectSpawnAbility = Timer( PraxedesTactic.DoDirectSpawnAbility, self, 5 )
end

-- Praxedes is allowed to retreat even directly after a jump
function PraxedesTactic:SetTarget( target, variant_type )

	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

function PraxedesTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function PraxedesTactic:IsDefender()
	return self:IsCommanderDefender()
end

function PraxedesTactic:JumpAttack()
	Tactic.JumpAttack(self)
end

function PraxedesTactic:CanOnlyDecap()
	return true
end

function PraxedesTactic:InitAbilities()

	if Praxedes.brazier_id == nil then
		Praxedes.brazier_id = cpu_manager.stats:GetAbilityID( "witch_hunters_brasero" )
	end

	if Praxedes.heresius_id == nil then
		Praxedes.heresius_id = cpu_manager.stats:GetAbilityID( "witch_hunters_canoness_liber_heresius" )
	end

	if Praxedes.heresiusb_id == nil then
		Praxedes.heresiusb_id = cpu_manager.stats:GetAbilityID( "witch_hunters_canoness_liber_heresius_advance" )
	end

	if Praxedes.heresius_ktgm == nil then
		Praxedes.heresius_ktgm = cpu_manager.stats:GetAbilityID( "witch_hunters_ls_saint_praxedes_liber_heresius_ktgm" )
	end

	if Praxedes.ophelia_id == nil then
		Praxedes.ophelia_id = cpu_manager.stats:GetAbilityID( "witch_hunters_canoness_mantle_ophelia_praxedes" )
	end

	if Praxedes.opheliab_id == nil then
		Praxedes.opheliab_id = cpu_manager.stats:GetAbilityID( "witch_hunters_canoness_mantle_ophelia_praxedes_advance" )
	end

	if Praxedes.ophelia_ktgm == nil then
		Praxedes.ophelia_ktgm = cpu_manager.stats:GetAbilityID( "witch_hunters_ls_saint_praxedes_mantle_ophelia_praxedes_ktgm" )
	end

	if Praxedes.martyr_id == nil then
		Praxedes.martyr_id = cpu_manager.stats:GetAbilityID( "witch_hunters_canoness_true_martyr" )
	end

	if Praxedes.martyr_ktgm == nil then
		Praxedes.martyr_ktgm = cpu_manager.stats:GetAbilityID( "witch_hunters_ls_saint_praxedes_true_martyr_ktgm" )
	end
end

function PraxedesTactic:DoAbilities()

	-- Always try to call the Zealots, if available
	if (self.timedDirectSpawnAbility ~= nil) then
		self.timedDirectSpawnAbility:Call()
	else
		PraxedesTactic.DoDirectSpawnAbility(self)
	end

	if self.squad_ai:CanDoAbility(Praxedes.heresius_id) then
		Ability.DoAbilityArea( self.squad_ai, Praxedes.heresius_id, Ability.Filters.CloseEnemy, 30, 1 ) 
	end

	if self.squad_ai:CanDoAbility(Praxedes.heresiusb_id) then
		Ability.DoAbilityArea( self.squad_ai, Praxedes.heresiusb_id, Ability.Filters.CloseEnemy, 30, 1 ) 
	end

	if self.squad_ai:CanDoAbility(Praxedes.heresius_ktgm) then
		Ability.DoAbilityArea( self.squad_ai, Praxedes.heresius_ktgm, Ability.Filters.CloseEnemy, 30, 1 ) 
	end

	if self.squad_ai:CanDoAbility(Praxedes.ophelia_id) then
		Ability.DoAbilityArea( self.squad_ai, Praxedes.ophelia_id, Ability.Filters.CloseEnemy, 40, 1 )
	end

	if self.squad_ai:CanDoAbility(Praxedes.opheliab_id) then
		Ability.DoAbilityArea( self.squad_ai, Praxedes.opheliab_id, Ability.Filters.CloseEnemy, 40, 1 )
	end

	if self.squad_ai:CanDoAbility(Praxedes.ophelia_ktgm) then
		Ability.DoAbilityArea( self.squad_ai, Praxedes.ophelia_ktgm, Ability.Filters.CloseEnemy, 40, 1 )
	end

	if self.squad_ai:CanDoAbility(Praxedes.martyr_id) then

		if (self.squad_ai:GetHealthPercentage() < 0.4) then

			if resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Requisition) > 150 then

				if (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 40, 1) == nil and not self.squad_ai:IsInCombat()) then
					self.squad_ai:DoSpecialAbility(Praxedes.martyr_id)
				end
			end
		end
	end

	if self.squad_ai:CanDoAbility(Praxedes.martyr_ktgm) then

		if (self.squad_ai:GetHealthPercentage() < 0.4) then

			if resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Requisition) > 150 then

				if (Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 40, 1) == nil and not self.squad_ai:IsInCombat()) then
					self.squad_ai:DoSpecialAbility(Praxedes.martyr_ktgm)
				end
			end
		end
	end

	if self.squad_ai:CanDoAbility(Praxedes.brazier_id) then
		if resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Requisition) > 300
		and resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Power) > 300 then
			local iPos = self.squad_ai:GetPosition()
			local vDir = cpu_manager:GetDirectionToEnemy(iPos)
			iPos.x = iPos.x + vDir.x * math.random(1, 5)
			iPos.z = iPos.z + vDir.z * math.random(1, 5)
			if cpu_manager.cpu_player:FindFirstBaseEnemy(iPos, 10, 1) == nil
			and resource_manager:FindFirstStrategicPoint(iPos, 10) == nil
			and not self:IsAlliedBuildingWithin(iPos, 10) then
				self.squad_ai:DoSpecialAbilityPos(Praxedes.brazier_id, iPos)
			end
		end
	end
end

function PraxedesTactic:DoDirectSpawnAbility()

	-- Spawn Zealots in combat
	if (self.squad_ai:CanDirectSpawn()) then 
		self.squad_ai:DoDirectSpawn()
	end
end

function PraxedesTactic:Upgrade()

	-- Check if we have free resources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	if (not self.squad_ai:IsReinforcing()) then
	
		-- Upgrade if possible
		if (self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 0) then
			local class_type = cpu_manager:GetFirstEnemyPlayer():GetMajorityClassType()
			self.squad_ai:DoBestUpgrade( class_type )
		end
	end
end

function PraxedesTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end

	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end

function PraxedesTactic:IsAlliedBuildingWithin(iPos, iRange)
	for oPlayer in cpu_manager.stats:GetPlayerStats() do
		if not oPlayer:IsPlayerDead() then
			if not cpu_manager.player_stats:IsEnemy(oPlayer) then
				for oBuilding in oPlayer:GetBases() do
					if oBuilding:IsValid() then
						if distance_sqr(oBuilding:GetPosition(),iPos) < iRange*iRange then
							return true
						end
					end
				end
			end
		end
	end
	return false
end