----------------------------------------
-- File: 'templaremperorschampionktgmtactic.ai'
-- Edited by Thudmeizer @ 06.08.2024

class 'TemplarEmperorsChampionKtgmTactic' (TemplarInfantryTactic)

TemplarEmperorsChampionKtgm = {}

function TemplarEmperorsChampionKtgmTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Templar EmperorsChampion Tactic")
end

function TemplarEmperorsChampionKtgmTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function TemplarEmperorsChampionKtgmTactic:IsDefender()
	return self:IsCommanderDefender()
end

function InfantryTactic:IsAffectedByMorale()
	return false
end

function TemplarEmperorsChampionKtgmTactic:IsCommanderAttacker()

	-- Check if we are attacking
	if (self.squad_ai:IsLocked()) then
	
		-- Retreat if almost dead and not part of a large army
		if (self.squad_ai:GetHealthPercentage() < 0.3 and cpu_manager:GetArmyStrength() < 4000) then
			return false
		end
	else
		-- Don't join attacks if severly hurt
		if (self.squad_ai:GetHealthPercentage() < 0.3) then
			return false
		end
	end
	return true
end

function TemplarEmperorsChampionKtgmTactic:InitAbilities()

	-- Init ability ID's
	if (TemplarEmperorsChampionKtgm.frag_grenade_id == nil) then
		TemplarEmperorsChampionKtgm.frag_grenade_id = cpu_manager.stats:GetAbilityID( "templar_ls_frag_grenades_blessed" )
	end

	if (TemplarEmperorsChampionKtgm.krak_grenade_id == nil) then
		TemplarEmperorsChampionKtgm.krak_grenade_id = cpu_manager.stats:GetAbilityID( "templar_ls_krak_grenades_blessed" )
	end

	if (TemplarEmperorsChampionKtgm.orbital_b == nil) then
		TemplarEmperorsChampionKtgm.orbital_b = cpu_manager.stats:GetAbilityID( "templar_ls_orbital_bombardment" )
	end

	if (TemplarEmperorsChampionKtgm.holyorb_id == nil) then
		TemplarEmperorsChampionKtgm.holyorb_id = cpu_manager.stats:GetAbilityID( "templar_ls_holy_orb" )
	end

	if (TemplarEmperorsChampionKtgm.droppod_summon_a == nil) then
		TemplarEmperorsChampionKtgm.droppod_summon_a = cpu_manager.stats:GetAbilityID( "templar_ls_dropod_summon" )
	end

	if (TemplarEmperorsChampionKtgm.droppod_summon_b == nil) then
		TemplarEmperorsChampionKtgm.droppod_summon_b = cpu_manager.stats:GetAbilityID( "templar_ls_dropod_summon1" )
	end

	if (TemplarEmperorsChampionKtgm.droppod_summon_c == nil) then
		TemplarEmperorsChampionKtgm.droppod_summon_c = cpu_manager.stats:GetAbilityID( "templar_ls_dropod_summon2" )
	end
end

function TemplarEmperorsChampionKtgmTactic:DoAbilities()

	-- Use Frag Grenade against enemies (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(TemplarEmperorsChampionKtgm.frag_grenade_id)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.frag_grenade_id)
		local oUnit = cpu_manager.cpu_player:FindFirstInfantryEnemy(self.squad_ai:GetPosition(), iRange, 2)
		local oUnitB = cpu_manager.cpu_player:FindFirstCommanderEnemy(self.squad_ai:GetPosition(), iRange, 1)
		local oUnitC = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Frag Grenade against infantry enemies for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.frag_grenade_id, oUnit:GetSquad())
			return
		elseif (oUnitB ~= nil) then
			--print("Using Frag Grenade against commander enemies for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.frag_grenade_id, oUnitB:GetSquad())
			return
		elseif (oUnitC ~= nil) then
			-- Get stats
			local oStats = oUnitC:GetStats()
			if (oStats ~= nil) then
				-- Check unit type
				local eClass = oStats:GetClass()
				if (eClass == UnitStatsAI.UC_MonsterMed or eClass == UnitStatsAI.UC_MonsterHigh) then
					--print("Using Frag Grenade against monster enemies for player "..tostring(cpu_manager.player_id).."")
					self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.frag_grenade_id, oUnitC:GetSquad())
					return
				end
			end
		end
	end

	-- Use Krak Grenade against vehicle enemies (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(TemplarEmperorsChampionKtgm.krak_grenade_id)) then 

		-- Search for a nearby enemy squad
		local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.krak_grenade_id)
		local oUnit = cpu_manager.cpu_player:FindFirstVehicleEnemy(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Krak Grenade against vehicle enemies for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.krak_grenade_id, oUnit:GetSquad())
			return
		end
	end

	if self.squad_ai:IsInCombat() then
	
		-- Try to use orbital bombardment at close enemy (Last Stand / Kill Team)
		if (self.squad_ai:CanDoAbility(TemplarEmperorsChampionKtgm.orbital_b)) then 
			if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
				-- Search for a nearby enemy squad
				local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.orbital_b)
				local oUnit = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 8)
				if (oUnit ~= nil) then
					--print("Using Orbital Bombardment with low health for player "..tostring(cpu_manager.player_id).."")
					self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.orbital_b, oUnit:GetSquad())
					return
				end
			else
				-- Search for a nearby enemy squad
				local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.orbital_b)
				local oUnit = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 12)
				if (oUnit ~= nil) then
					--print("Using Orbital Bombardment with good health for player "..tostring(cpu_manager.player_id).."")
					self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.orbital_b, oUnit:GetSquad())
					return
				end
			end
		end

		-- Try to use holy orb at close vehicle or monster enemies (Last Stand / Kill Team)
		if (self.squad_ai:CanDoAbility(TemplarEmperorsChampionKtgm.holyorb_id)) then 
			if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
				-- Search for a nearby enemy squad
				local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.holyorb_id)
				local oUnit = cpu_manager.cpu_player:FindFirstVehicleEnemy(self.squad_ai:GetPosition(), iRange, 1)
				local oUnitB = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 1)
				if (oUnit ~= nil) then
					--print("Using Holy Orb with low health against vehicle enemies for player "..tostring(cpu_manager.player_id).."")
					self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.holyorb_id, oUnit:GetSquad())
					return
				elseif (oUnitB ~= nil) then
					-- Get stats
					local oStats = oUnitB:GetStats()
					if (oStats ~= nil) then
						-- Check unit type
						local eClass = oStats:GetClass()
						if (eClass == UnitStatsAI.UC_MonsterMed or eClass == UnitStatsAI.UC_MonsterHigh) then
							--print("Using Holy Orb with low health against monster enemies for player "..tostring(cpu_manager.player_id).."")
							self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.frag_grenade_id, oUnitB:GetSquad())
							return
						end
					end
				end
			else
				-- Search for a nearby enemy squad
				local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.holyorb_id)
				local oUnit = cpu_manager.cpu_player:FindFirstVehicleEnemy(self.squad_ai:GetPosition(), iRange, 1)
				local oUnitB = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), iRange, 3)
				if (oUnit ~= nil) then
					--print("Using Holy Orb with good health against vehicle enemies for player "..tostring(cpu_manager.player_id).."")
					self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.holyorb_id, oUnit:GetSquad())
					return
				elseif (oUnitB ~= nil) then
					-- Get stats
					local oStats = oUnitB:GetStats()
					if (oStats ~= nil) then
						-- Check unit type
						local eClass = oStats:GetClass()
						if (eClass == UnitStatsAI.UC_MonsterMed or eClass == UnitStatsAI.UC_MonsterHigh) then
							--print("Using Holy Orb with good health against monster enemies for player "..tostring(cpu_manager.player_id).."")
							self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.frag_grenade_id, oUnitB:GetSquad())
							return
						end
					end
				end
			end
		end
	end

	-- Try to summon a droppod for unit drops -- Killteam
	if self.squad_ai:CanDoAbility(TemplarEmperorsChampionKtgm.droppod_summon_a) then

		-- Condition 1: Search for a nearby hurt squad
       		local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.droppod_summon_a)
       		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
       		if (oUnit ~= nil) then
			--print("Using Emperors Champion Close Hurt Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.droppod_summon_a, oUnit:GetSquad()) then
            			return
       			end
       		end

       		-- Condition 2: Check for health below a certain percentage
       		if (self.squad_ai:GetHealthPercentage() < 0.9) then
			--print("Using Emperors Champion Health Based Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilityPos(TemplarEmperorsChampionKtgm.droppod_summon_a, self.squad_ai:GetPosition()) then
               			return
       			end
		end

       		-- Condition 3: Random calling, just for the sake of creating new squads
       		if math.random(1,10) == 1 then
			--print("Using Emperors Champion Random Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilityPos(TemplarEmperorsChampionKtgm.droppod_summon_a, self.squad_ai:GetPosition()) then
              			return
       			end
		end
       	end

	-- Try to summon a 2nd stage droppod for unit drops -- Killteam
	if self.squad_ai:CanDoAbility(TemplarEmperorsChampionKtgm.droppod_summon_b) then

		-- Condition 1: Search for a nearby hurt squad
       		local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.droppod_summon_b)
       		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
       		if (oUnit ~= nil) then
			--print("Using Emperors Champion Close Hurt Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.droppod_summon_b, oUnit:GetSquad()) then
            			return
       			end
       		end

       		-- Condition 2: Check for health below a certain percentage
       		if (self.squad_ai:GetHealthPercentage() < 0.9) then
			--print("Using Emperors Champion Health Based Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilityPos(TemplarEmperorsChampionKtgm.droppod_summon_b, self.squad_ai:GetPosition()) then
               			return
       			end
		end

       		-- Condition 3: Random calling, just for the sake of creating new squads
       		if math.random(1,10) == 1 then
			--print("Using Emperors Champion Random Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilityPos(TemplarEmperorsChampionKtgm.droppod_summon_b, self.squad_ai:GetPosition()) then
              			return
       			end
		end
       	end

	-- Try to summon a 3rd stage droppod for unit drops -- Killteam
	if self.squad_ai:CanDoAbility(TemplarEmperorsChampionKtgm.droppod_summon_c) then

		-- Condition 1: Search for a nearby hurt squad
       		local iRange = self.squad_ai:GetAbilityRange(TemplarEmperorsChampionKtgm.droppod_summon_c)
       		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
       		if (oUnit ~= nil) then
			--print("Using Emperors Champion Close Hurt Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilitySquad(TemplarEmperorsChampionKtgm.droppod_summon_c, oUnit:GetSquad()) then
            			return
       			end
       		end

       		-- Condition 2: Check for health below a certain percentage
       		if (self.squad_ai:GetHealthPercentage() < 0.9) then
			--print("Using Emperors Champion Health Based Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilityPos(TemplarEmperorsChampionKtgm.droppod_summon_c, self.squad_ai:GetPosition()) then
               			return
       			end
		end

       		-- Condition 3: Random calling, just for the sake of creating new squads
       		if math.random(1,10) == 1 then
			--print("Using Emperors Champion Random Drop Pod for player "..tostring(cpu_manager.player_id).."")
       			if self.squad_ai:DoSpecialAbilityPos(TemplarEmperorsChampionKtgm.droppod_summon_c, self.squad_ai:GetPosition()) then
              			return
       			end
		end
       	end

end

function TemplarEmperorsChampionKtgmTactic:Update()

	if (self:IsComplete()) then
      		return
  	end
  
  	-- State machine
  	if (not InfantryTactic.Update( self )) then
      		return
  	end
    
  	-- Check health
  	if (self.squad_ai:GetHealthPercentage() > 0.3) then
    		self.squad_ai:DoSetDefaultMeleeStance()
    
    		-- Check for close commander
    		local vSquadPos = self.squad_ai:GetPosition()
    		local oEnemyCommander = Ability.Filters.CloseCommanderEnemy(vSquadPos, 35, 1)
    		if (oEnemyCommander ~= nil) then
       			self.squad_ai:DoAttackMove(oEnemyCommander:GetPosition())
       			return
		else
       			-- Check for close attached commander
    			local oSquad = Ability.Filters.CloseInfantryEnemy(vSquadPos, 20, 4)
    			if (oSquad ~= nil and oSquad:IsAttached()) then
				self.squad_ai:DoAttackMove(oSquad:GetPosition())
    			end
    		end
    
    		if (self:TryAttachSquad(true, true, 50, 100, self.m_fCommanderAttachHealth) == nil) then
      			self:TryAttachSquadMelee()
    		end
  	end
end