----------------------------------------
-- File: 'TemplarCastellantactic.ai'
-- Edited by Thudmeizer @ 15.04.2008
-- Edited by Melooo   @ 02.01.2008

class 'TemplarCastellanTactic' (TemplarInfantryTactic)

TemplarCastellan = {}

function TemplarCastellanTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Templar Castellan Tactic")
end

function TemplarCastellanTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function TemplarCastellanTactic:IsDefender()
	return self:IsCommanderDefender()
end

function TemplarCastellanTactic:InitAbilities()

	-- Init ability ID's
	if (TemplarCastellan.battlecry_id == nil) then
		TemplarCastellan.battlecry_id = cpu_manager.stats:GetAbilityID( "templar_battlecry" )
	end

  	if (TemplarCastellan.holyorb_id == nil) then
		TemplarCastellan.holyorb_id = cpu_manager.stats:GetAbilityID( "templar_holy_orb" )
	end
end

function TemplarCastellanTactic:DoAbilities()

	-- Try to use holy orb
  	if (self.squad_ai:CanDoAbility(TemplarCastellan.holyorb_id)) then
		Ability.DoAbilityPos(self.squad_ai, TemplarCastellan.holyorb_id, Templar_Ability.Filters.CloseMonsterHighEnemy, 1)
    		Ability.DoAbilityPos(self.squad_ai, TemplarCastellan.holyorb_id, Templar_Ability.Filters.CloseVehicleHighEnemy, 1)
    		Ability.DoAbilityPos(self.squad_ai, TemplarCastellan.holyorb_id, Ability.Filters.CloseCommanderEnemy, 5)
    
    		local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
    		local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
    
    		if ( iRequisition > 300 and iPower > 300) then
      			Ability.DoAbilityPos(self.squad_ai, TemplarCastellan.holyorb_id, Ability.Filters.CloseEnemy, 16)
      			Ability.DoAbilityPos(self.squad_ai, TemplarCastellan.holyorb_id, Templar_Ability.Filters.CloseVehicleMedEnemy, 3)  
      			Ability.DoAbilityPos(self.squad_ai, TemplarCastellan.holyorb_id, Ability.EntityFilters.CloseBaseEntityEnemy, 5)
    		end
   	else 
    		if (self.squad_ai:CanPossess()) then

			-- Check if we are in combat
      			if (self.squad_ai:IsInCombat() or cpu_manager.terrain_analyzer:HasThreat(self.squad_ai:GetPosition(), 35)) then
        			self.squad_ai:DoPossess()
      			end
    		end
	end
end

function TemplarCastellanTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update(self)) then
		return
	end
	
	-- Assassinate win condition -- never attach to a squad
  	if (not cpu_manager.assassinate ) then
       
    		if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then
			self:TryAttachSquadMelee()
		end
      
    		if self.squad_ai:GetHealthPercentage() > 0.6 then 
        		local vSquadPos = self.squad_ai:GetPosition()  
        		local oEnemyCommander = Ability.Filters.CloseCommanderEnemy(vSquadPos, 20, 1)
        		if (oEnemyCommander ~= nil) then
           			self.squad_ai:DoAttackMove(oEnemyCommander:GetPosition())
           				return
        		else

          			-- Check for close attached commander
          			local oSquad = Ability.Filters.CloseInfantryEnemy(vSquadPos, 15, 4)
          			if (oSquad ~= nil and oSquad:IsAttached()) then
             				self.squad_ai:DoAttackMove(oSquad:GetPosition())
              			end
			end 
		end      
  	end
	self:EmergencyRetreat()
end