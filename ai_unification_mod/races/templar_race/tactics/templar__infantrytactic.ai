----------------------------------------
-- File: 'templarinfantrytactic.ai'
-- Edited by Thudmeizer         @ 06.08.2024

class 'TemplarInfantryTactic' (InfantryTactic)

function TemplarInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Templar Infantry Tactic")
  
  	-- Set infantry options
  	local sSquadName = squad_ai:GetSquadName()
  
  	if  (sSquadName == "templar_squad_assault") then

    		-- Assault jumppack Squads cannot garrison or deepstrike

  	elseif (sSquadName == "templar_squad_terminator" or sSquadName == "templar_squad_terminator_assault" or
      		sSquadName == "templar_squad_castellan_terminator" or sSquadName == "templar_squad_castellan_terminator_sp" ) then

    		-- Squads are vehicle transportable
    		self.m_iTransportable = 2  -- LR Crusader

    		-- Squads can deepstrike from buildings
    		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("templar_barracks")
  	else
     		 -- Squads are vehicle transportable
    		self.m_iTransportable = 1  -- Rhino / Razorback
    
    		-- Squads can deepstrike from buildings
    		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("templar_orbital_relay")
  	end
end

function TemplarInfantryTactic:AddTargetAbilities()
  	table.insert(InfantryTactic.TargetAbilities, { nil, "templar_melta_bombs", Ability.Filters.CloseVehicleEnemy, 1, 0 })
  	table.insert(InfantryTactic.TargetAbilities, { nil, "templar_krak_grenades", Ability.Filters.CloseVehicleEnemy, 1, 0 })
  	table.insert(InfantryTactic.TargetAbilities, { nil, "templar_frag_grenades", Ability.Filters.CloseSquadEnemy, 1, 0 })
end

function TemplarInfantryTactic:AddCommanders()
	table.insert(self.commander, { "templar_squad_marshall", false })
	table.insert(self.commander, { "templar_squad_marshall_ktgm", false })
  	table.insert(self.commander, { "templar_squad_castellan", true })
  	table.insert(self.commander, { "templar_squad_chaplain", false })
  	table.insert(self.commander, { "templar_squad_chaplain_ktgm", false })
  	table.insert(self.commander, { "templar_squad_champion", false })
  	table.insert(self.commander, { "templar_squad_champion_2", false })
  	table.insert(self.commander, { "templar_squad_champion_ktgm", false })
    	table.insert(self.commander, { "templar_castellan_advance_sp", true })
   	table.insert(self.commander, { "templar_squad_castellan_terminator", false }) 
   	table.insert(self.commander, { "templar_squad_castellan_terminator_sp", false }) 
end

function TemplarInfantryTactic:DoAbilities()

	-- Enable infiltration (Sword Brethern)
  	local sSquadName = self.squad_ai:GetSquadName()

  	-- I might have these attached
  	if (self.squad_ai:IsAttached()) then
  
    		if (self.squad_ai:HasSquadAttached("templar_squad_castellan")) or (self.squad_ai:HasSquadAttached("templar_castellan_advance_sp")) or
       			(self.squad_ai:HasSquadAttached("templar_squad_castellan_terminator")) or 
       			(self.squad_ai:HasSquadAttached("templar_squad_castellan_terminator_sp")) then
      				TemplarCastellanTactic.InitAbilities( self )
      				TemplarCastellanTactic.DoAbilities( self )
      
    		elseif (self.squad_ai:HasSquadAttached("templar_squad_chaplain")) then
      			TemplarChaplainTactic.InitAbilities( self )
      			TemplarChaplainTactic.DoAbilities( self )

    		elseif (self.squad_ai:HasSquadAttached("templar_squad_chaplain_ktgm")) then
      			TemplarChaplainKtgmTactic.InitAbilities( self )
      			TemplarChaplainKtgmTactic.DoAbilities( self )
      
    		elseif (self.squad_ai:HasSquadAttached("templar_squad_champion")) or (self.squad_ai:HasSquadAttached("templar_squad_champion_2")) then
      			TemplarEmperorsChampionTactic.InitAbilities( self )
      			TemplarEmperorsChampionTactic.DoAbilities( self )

    		elseif (self.squad_ai:HasSquadAttached("templar_squad_champion_ktgm")) then
      			TemplarEmperorsChampionKtgmTactic.InitAbilities( self )
      			TemplarEmperorsChampionKtgmTactic.DoAbilities( self )

    		elseif (self.squad_ai:HasSquadAttached("templar_squad_marshall")) then
      			TemplarMarshallTactic.InitAbilities( self )
      			TemplarMarshallTactic.DoAbilities( self )

    		elseif (self.squad_ai:HasSquadAttached("templar_squad_marshall_ktgm")) then
      			TemplarMarshallKtgmTactic.InitAbilities( self )
      			TemplarMarshallKtgmTactic.DoAbilities( self )
    		end
	end
  
 	 -- Call basic DoAbilities methods
  	InfantryTactic.DoAbilities(self)
end


function TemplarInfantryTactic:CheckDance(oSquad)

	-- Check opponent
  	if (oSquad == nil) then
    		return false
  	end
  
  	-- Compare opponents
  	local sSquadName = self.squad_ai:GetSquadName()
  	if (sSquadName == "templar_squad_combat" or sSquadName == "templar_squad_terminator") then
    
    		-- Check opponent
    		if (oSquad:GetSquadName() == "chaos_squad_cultist") or (oSquad:GetSquadName() == "tyranids_squad_hormagaunt") or 
       			(oSquad:GetSquadName() == "dark_eldar_squad_mandrake") then 
      			return false
    		end
  	end
	return true
end

function TemplarInfantryTactic:CanOnlyDecap()

	local sSquadName = self.squad_ai:GetSquadName()
  	local pHealph = self.squad_ai:GetHealthPercentage() 
  
  	if  sSquadName == "templar_squad_command_squad" or
      		sSquadName == "templar_squad_terminator_assault" or 
      		sSquadName == "templar_squad_sword_brethren_cc" or
    		((sSquadName == "templar_squad_combat"  or
      		sSquadName == "templar_squad_terminator" ) and pHealph < 0.3) then
    			return true
  	end
end  

function TemplarInfantryTactic:Upgrade()

	-- Check if we have free resources
  	if (not Tactic.Options.can_reinforce) then
    		return
  	end
  
  	-- If I am broken, don't upgrade!
  	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
    		return
  	end
  
  	local sSquadName = self.squad_ai:GetSquadName()
  	local iNumTroopers = self.squad_ai:GetNumTroopers()
  	-- Don't upgrade squads with less than X troopers
  	if ( sSquadName == "templar_squad_crusader" and iNumTroopers < 5) then
    		return
  	end 

  	if ( sSquadName == "templar_squad_assault" and iNumTroopers < 8) then
    		return
  	end 

  	if ( sSquadName == "templar_squad_sword_brethren_cc" and iNumTroopers < 8) then
    		return
  	end 
  
  	if (not self.squad_ai:IsReinforcing() and self.squad_ai:HasUpgradableTrooper() and iNumTroopers > 2) then
    
    	-- Figure out my enemy's favourite class
    	local enemy = cpu_manager:FindClosestEnemyPlayer()
    	if (enemy == nil) then
      		return
    	end

    	local class_type = enemy:GetMajorityClassType()
    
    	-- Larkins hard counter upgrade for HeavyInfantryMed 
    	if (class_type < UnitStatsAI.UC_HeavyInfantryMed) then    
      
      		local enemy_race = enemy:GetPlayerRaceName()
      		if (enemy_race == "space_marine_race" or enemy_race == "chaos_marine_race" or enemy_race == "necron_race" or enemy_race == "templar_race") then
          		class_type = UnitStatsAI.UC_HeavyInfantryMed
        	end
    	end
    
	-- Do best upgrade
    	self.squad_ai:DoBestUpgrade(class_type)
  	end
end


function TemplarInfantryTactic:Update()

	if (self:IsComplete()) then
    		return
  	end
  
  	-- State machine
  	if (not InfantryTactic.Update( self )) then
    		return
  	end
  
	local sSquadName = self.squad_ai:GetSquadName()
  	local can_ranged = (sSquadName == "templar_squad_terminator") or (sSquadName == "templar_squad_combat")
  
  	if ((not can_ranged)  and self.squad_ai:GetMeleeStance() ~= SquadAI.MSTANCE_Assault) then
    		self.squad_ai:DoSetDefaultMeleeStance()
  	end  
    	return true
end