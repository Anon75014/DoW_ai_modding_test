----------------------------------------
-- File: 'templarcrusadertactic.ai'
-- Edited by JONES   		@ 07.01.2010
-- Edited by Thudmeizer		@ 27.02.2023

class 'TemplarCrusaderTactic' (TemplarInfantryTactic)

TemplarCrusader = {}

function TemplarCrusaderTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Templar Crusader Tactic")
end

function TemplarCrusaderTactic:InitAbilities()

	-- Init ability ID's
	if (TemplarCrusader.krak_id == nil) then
		TemplarCrusader.krak_id = cpu_manager.stats:GetAbilityID( "templar_krak_grenades" )
	end
end

function TemplarCrusaderTactic:DoAbilities()

	Ability.DoAbilityTarget( self.squad_ai, TemplarCrusader.krak_id, Ability.Filters.CloseVehicleEnemy, 1 )
  	Ability.DoAbilityTargetEntity( self.squad_ai, TemplarCrusader.krak_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
	
	-- Call basic DoAbilities methods
	TemplarInfantryTactic.DoAbilities(self)
end

function TemplarCrusaderTactic:IsAffectedByMorale()
	return (self.squad_ai:GetHealthPercentage() < 0.5)
end

function TemplarCrusaderTactic:Reinforce()

	-- Check if we are reinforcing
	if (self.squad_ai:IsReinforcing()) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- Don't reinforce squads in critical condition
	if (self.squad_ai:GetNumTroopers() <= self.squad_ai:GetMaxTroopers() / 3 and self.squad_ai:IsUnderAttack()) then
		return
	end

	-- Check resources
	local iRequisition = resource_manager:GetResourceAmount():Get(ResourceAmount.RT_Requisition)

	if ((iRequisition < 500 or self.m_bPowerCost) and not Tactic.Options.can_reinforce) then
		return
	end
  
  	-- Reinforce, as long as I have money
	if (self.squad_ai:CanReinforce( false, 0 )) then
		self.squad_ai:DoReinforce( false, 0 )
    		return
	end
  
	-- Train Neophytes for Second
  	if (iRequisition > 500) then
    		if (self.squad_ai:CanReinforce(true, 0)) and ( self.squad_ai:GetLeaderCount(0) < (self.squad_ai:GetMaxLeaderCount()-1)) then
      			self.squad_ai:DoReinforce(true, 0)
      			return
    		end
  	end  
end

function TemplarCrusaderTactic:Recalc_GetUnitStrength()

	-- Get unit strength
  	local sUnitName = self.squad_ai:GetSquadName()
	local fUnitStrength = UnitStrengths[sUnitName]
	if (fUnitStrength == nil) then
		--print("Warning: "..sUnitName.." has no unit strength!")
		return 0
	end
  
	-- Check unit class
	local iTrooperCount = self.squad_ai:GetNumTroopers()
	if (iTrooperCount == 1) then
		fUnitStrength = fUnitStrength * self.squad_ai:GetHealthPercentage()
	else
		fUnitStrength = fUnitStrength * iTrooperCount
	end
  
   	--aitrace("Tactic: Patch... iTrooperCount = " .. iTrooperCount)
	
	-- Check if the squad has a leader
	if (self.squad_ai:HasLeader()) then
	
    		local neophytesStrength = 40 * self.squad_ai:GetLeaderCount( 0)
    		--aitrace("Tactic: Patch... fUnitStrength = " .. fUnitStrength)
    		--aitrace("Tactic: Patch...  + neophytesStrength = " .. neophytesStrength)
   		fUnitStrength = fUnitStrength + neophytesStrength
	end
	
	-- Check if the squad has a unit attached
	if (self.squad_ai:IsAttached()) then
	
		-- Get attachment list
		local aAttachments = Attachments[sUnitName]
		if (aAttachments ~= nil) then
		
			-- Check attachment list
			for iLoop1 in aAttachments do
			
				-- Check attachment
				if (self.squad_ai:HasSquadAttached(aAttachments[iLoop1])) then
					fUnitStrength = fUnitStrength + UnitStrengths[aAttachments[iLoop1]] * self.squad_ai:GetAttachedHealthPercentage()
					break
				end		
			end
		end
	end
	return fUnitStrength
end

function TemplarCrusaderTactic:Update()

	if self:IsComplete() then
      		return
   	end
   
	--state machine
	if not TemplarInfantryTactic.Update( self ) then
		return
	end

  	-- JONES Update unit strength Patch 
  	if (self.squad_ai:HasLeader()) then
    		local old_iUnitStrength = self.m_iUnitStrength
    		self.m_iUnitStrength = self:Recalc_GetUnitStrength()  --  cpu_manager:GetUnitStrength(self.squad_ai)  
    
    		if old_iUnitStrength ~= self.m_iUnitStrength then
      			--aitrace("Tactic: Update UnitStrength Patch... old value ".. old_iUnitStrength .." real_value ".. self.m_iUnitStrength)
    		end
  	end
end

