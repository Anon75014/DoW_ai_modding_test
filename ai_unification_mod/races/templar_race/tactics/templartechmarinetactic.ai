----------------------------------------
-- File: 'servitortactic.ai'
-- Edited by Thudmeizer   @ 27.02.2023

class 'TemplarTechmarineTactic' (EngineerTactic)

function TemplarTechmarineTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Templar Techmarine Tactic")
end

function TemplarTechmarineTactic:IsAttacker()
	return false
end

function TemplarTechmarineTactic:IsDefender()
	return false -- self.squad_ai:GetHealthPercentage() > 0.9
end

function TemplarTechmarineTactic:AddTargetAbilities()
	table.insert(InfantryTactic.TargetAbilities, { nil, "templar_frag_grenades", Ability.Filters.CloseSquadEnemy, 1, 0 })
end

function TemplarTechmarineTactic:IsEngineerWhoCanCapture()
  	return (cpu_manager:GetArmyStrength() < 450)
end

function TemplarTechmarineTactic:CanOnlyDecap()
	return false
end  

-- JONES: override this to make techmarine more brutal
function TemplarTechmarineTactic:GoToNextPost()     

	self.m_bBusy = false
	local vEngineerPos = self.squad_ai:GetPosition()

	if ( (self.squad_ai:GetHealthPercentage() < 0.5) and self.squad_ai:WasRecentlyHurt()) then
		local vBasePos = cpu_manager:FindClosestFriendlyBaseOrStrategicPoint(vEngineerPos, cpu_manager.start_pos, true, true)
		if (vBasePos ~= nil) then
			self:ValidMove(vBasePos)
			self.m_iValidRange = 35
      			--aitrace("TechmarineTactic: Moving to Safe...")
			return
		end
	end

	-- Only attempt vehicle repair if we can
	local iClosestDistance = 0
  
	-- Find the closest vehicle that can be repaired
  	local oVehicleToRepair = cpu_manager:GetDamagedVehicleInRange()
  	if (oVehicleToRepair ~= nil) then
    		--aitrace("TechmarineTactic: Repairing vehicle...")
    		self.squad_ai:DoRepairSquad(oVehicleToRepair)
    		self.m_vDestination = oVehicleToRepair:GetPosition()
    		self.m_bBusy = true
    		return
  	end

	-- Try to help finish a building
	local oBuildingToFinish = cpu_manager:GetUnfinishedBuildingInRange()
	if (oBuildingToFinish ~= nil) then
		aitrace("TechmarineTactic: Help finishing a building...")
		self.squad_ai:DoFinishBuilding(oBuildingToFinish)
		self.m_vDestination = oBuildingToFinish:GetPosition()
		self.m_bBusy = true
		return
	end
  
  	-- Find the closest building that can be repaired
  	local oBuildingToRepair = cpu_manager:GetDamagedBuildingInRange()
  	if (oBuildingToRepair ~= nil) then
    		--aitrace("TechmarineTactic: Repairing building...")
    		self.squad_ai:DoRepairBase(oBuildingToRepair)
    		self.m_vDestination = oBuildingToRepair:GetPosition()
    		self.m_bBusy = true
		return
  	end
end

function TemplarTechmarineTactic:Update()

	if (not EngineerTactic.Update( self )) then
		return false
	end
	return true
end
