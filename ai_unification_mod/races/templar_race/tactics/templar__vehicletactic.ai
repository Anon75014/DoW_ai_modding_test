----------------------------------------
-- File: 'templarvehicleTactic.ai'
-- Edited by Melooo		@ 02.01.2008
-- Edited by Thudmeizer		@ 25.01.2024

class 'TemplarVehicleTactic' (VehicleTactic)

function TemplarVehicleTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Black Marine Vehicle Tactic")
	
	-- Dreadnoughts can enter deepstrike buildings
	local sName = squad_ai:GetSquadName()
	if (sName == "templar_dreadnought_codex") or (sName == "templar_squad_dreadnought_venerable") then
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("templar_orbital_relay")
	end
end

-- Check if the vehicle should dance away in melee
function TemplarVehicleTactic:CheckVehicleDance(sName)

	if (sName == "templar_squad_rhino" or
		sName == "templar_land_speeder" or
		sName == "templar_squad_tempest" or
		sName == "templar_squad_damocles" or
		sName == "templar_squad_razorback" or
		sName == "templar_squad_predator" or
		sName == "templar_squad_vindicator" or
		sName == "templar_squad_dreadnought_codex" or
		sName == "templar_squad_dreadnought_venerable" or
		sName == "templar_squad_land_raider" or 
		sName == "templar_squad_land_raider_achilles" or 
		sName == "templar_squad_land_raider_prometheus" or 
		sName == "templar_squad_land_raider_crusader" or
		sName == "templar_squad_armiger") then
		return true
	end
	return false
end

function TemplarVehicleTactic:DoAbilities()

	-- Check if we can launch smoke
	local iSmokeID = cpu_manager.stats:GetAbilityID( "templar_smoke_launchers" )
	if (self.squad_ai:CanDoAbility(iSmokeID)) then
	
		-- Search a squad
		local iRange = self.squad_ai:GetAbilityRange(iSmokeID)
		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil and oUnit:IsInCombat() and cpu_manager:GetUnitStrength(oUnit) > 200) then
			self.squad_ai:DoSpecialAbilitySquad(iSmokeID, oUnit:GetSquad())
		end
	end

	-- Call standard method
	VehicleTactic.DoAbilities(self)
end

function TemplarVehicleTactic:Upgrade()

	-- Check if we have free resources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- Upgrade if possible
	if (self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 0 and not self.squad_ai:WasRecentlyHurt()) then
		local class_type = cpu_manager:GetFirstEnemyPlayer():GetMajorityClassType()
		self.squad_ai:DoBestUpgrade( class_type )
	end
end

function TemplarVehicleTactic:Reinforce()

	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- Reinforce right away!
	if (not self.squad_ai:IsReinforcing()) then
			
		if (self.squad_ai:CanReinforce( true, 0 )) then
			self.squad_ai:DoReinforce( true, 0 )
		elseif (self.squad_ai:CanReinforce( false, 0 )) then
			self.squad_ai:DoReinforce( false, 0 )
		end
	end
end


function TemplarVehicleTactic:MoveToDisengage()

	local maxd = 100
	local mind = 40
	local safe_radius = 35
	local jump_ok = false
	local squad_pos = self.squad_ai:GetPosition()
	
	-- Broken squad will need bigger safe area than others
	
  	-- No double jump within 10 secs
  	if (self.squad_ai:CanJump() and g_iGMT > self.last_jump + 10) then
  		jump_ok = true
  		maxd = self.squad_ai:GetJumpDistance()
  	end
  	
	-- We are safe, no need to jump if not forced to do so
	if (not cpu_manager.terrain_analyzer:HasThreat( squad_pos, safe_radius )) then
		mind = 10
		jump_ok = false
	end
	local deviate = false
	
	-- No SP, check for friendly squad
	local move_pos = nil
	if (jump_ok and self.squad_ai:WasRecentlyHurt()) then
	
		local squad_filter = function( squad_ai )
			return not cpu_manager.terrain_analyzer:HasThreat( squad_ai:GetPosition(), 35 )
		end
	
		-- Check for friendly squad
		move_pos = cpu_manager:GetClosestSquadWithin( squad_pos, mind, maxd, squad_filter )
		if (CpuManager.AISettings.bUseMapDB and move_pos == nil and jump_ok) then
		
			-- No friendly squad and SP, do compass move
			move_pos = self:CompassMove( maxd - 5 )
		end
	else
		deviate = true
	end
	
	-- Check if we already have a move pos
  	local vBasePos = nil
	if (move_pos == nil) then
    
    		local aBuilders = cpu_manager:GetAvailableBuilders()
    
    		if (table.getn(aBuilders) > 0) then
      			local distance_max = 1000
      			local best_index = 1
      
      			for iLoop1 in aBuilders do
        			local oSquad = aBuilders[iLoop1]
        			local aBuilders_pos = oSquad:GetPosition()
        			local aDist = distance_sqr(squad_pos, aBuilders_pos)
        		if aDist < distance_max then
          			distance_max = aDist
          			best_index = iLoop1
        		end
      		end
      			vBasePos = aBuilders[best_index]:GetPosition()
    		else 
			--aitrace( "Templar Vehicle Tactic: No free techmarine available" )
			-- Get closest strat to retreat
			vBasePos = cpu_manager:FindClosestFriendlyBaseOrStrategicPoint(squad_pos, cpu_manager.start_pos, true, false)  
    		end	
    
		if (vBasePos ~= nil) then
			move_pos = Vector3f(vBasePos)
		end
	end
	
	-- We have a valid destination
	if (move_pos ~= nil) then
	
		local safe_point = Vector3f( move_pos )
		
		-- Deviate as we can't jump directly on SP (x/z)
		if deviate then
			safe_point.x = safe_point.x + deviate_pos( 5 )
			safe_point.z = safe_point.z + deviate_pos( 5 )
		end
		if (jump_ok and self.squad_ai:CanJumpToPosition( safe_point ) and distance_sqr(squad_pos, safe_point) > sqr(mind)) then
			self.squad_ai:DoJump( safe_point )
			self.last_jump = g_iGMT
		else
			cpu_manager:DoMove( self.squad_ai, move_pos, false, "Disengage", false )
		end
		self.safe_point = Vector3f( move_pos )
		return true
	end
		
	-- Check for save point
	if (jump_ok) then
	
		-- Check for save point
		self.squad_ai:DoMoveToClosestSafePoint(self.safe_point, maxd)
		if (self.squad_ai:CanJumpToPosition(self.safe_point) and distance_sqr(squad_pos, self.safe_point) > sqr(mind)) then
			self.squad_ai:DoJump(self.safe_point)
			self.last_jump = g_iGMT
		end
		return true
	end
	return false
end