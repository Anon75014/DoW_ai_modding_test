----------------------------------------
-- File: 'templarcommandsquadtactic.ai'
-- Edited by Melooo   @ 02.01.2008
-- Edited by Thudmeizer @ 27.02.2023

class 'TemplarCommandSquadTactic' (TemplarInfantryTactic)

TemplarCommandSquad = {}

function TemplarCommandSquadTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Templar Command Squad Tactic")
  
  	-- try for different types of squad members
	self.sergeantIndex = 1
	self.apothecaryIndex = 0
  	self.bannerIndex = 2
end

function TemplarCommandSquadTactic:IsAttacker()
	return true -- self:IsCommanderAttacker()
end

function TemplarCommandSquadTactic:IsDefender()
	return true -- self:IsCommanderDefender()
end

function TemplarCommandSquadTactic:IsAffectedByMorale()
	return (self.squad_ai:GetHealthPercentage() < 0.5)
end

function TemplarCommandSquadTactic:InitAbilities()

	if TemplarCommandSquad.frag_id == nil then
	   TemplarCommandSquad.frag_id = cpu_manager.stats:GetAbilityID( "templar_frag_grenades" )	
	end

	if TemplarCommandSquad.melta_id == nil then
	   TemplarCommandSquad.melta_id = cpu_manager.stats:GetAbilityID( "templar_melta_bombs" )	
	end
end

function TemplarCommandSquadTactic:DoAbilities()

	Ability.DoAbilityTarget( self.squad_ai, TemplarCommandSquad.frag_id, Ability.Filters.CloseSquadEnemy, 4 )
	Ability.DoAbilityTarget( self.squad_ai, TemplarCommandSquad.melta_id, Ability.Filters.CloseVehicleEnemy, 1 )
  	Ability.DoAbilityTargetEntity( self.squad_ai, TemplarCommandSquad.melta_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
end

function TemplarCommandSquadTactic:Reinforce()

	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end

	-- Allow free reinforcing during harassing time
	if (g_iGMT > DefendChokePointPlan.HarassingTime * 60) then

		-- If there are no resources available, don't upgrade!
		if (not Tactic.Options.can_reinforce) then
			return
		end
	end

	if not self.squad_ai:IsReinforcing() then

		-- Always try for the actual leader first
		if self.squad_ai:CanReinforce( false, 0 ) then
			self.squad_ai:DoReinforce( false, 0 )
			return
		end

		-- Get current leader count
		local numA = self.squad_ai:GetLeaderCount(0)
		local numB = self.squad_ai:GetLeaderCount(1)
		local numC = self.squad_ai:GetLeaderCount(2)
		local numD = self.squad_ai:GetLeaderCount(3)
	
		if numA < 1 then
			if self.squad_ai:CanReinforce( true, 0 ) then
				self.squad_ai:DoReinforce( true, 0 )
			end
		elseif numB < 1 then
			if self.squad_ai:CanReinforce( true, 1 ) then
				self.squad_ai:DoReinforce( true, 1 )
			end

		elseif numC < 1 then
			if self.squad_ai:CanReinforce( true, 2 ) then
				self.squad_ai:DoReinforce( true, 2 )
			end
		elseif numD < 1 then
			if self.squad_ai:CanReinforce( true, 3 ) then
				self.squad_ai:DoReinforce( true, 3 )
			end
		end
	end
end

function TemplarCommandSquadTactic:Recalc_GetUnitStrength()

	-- Get unit strength
  	local sUnitName = self.squad_ai:GetSquadName()
	local fUnitStrength = UnitStrengths[sUnitName]
	if (fUnitStrength == nil) then
		print("Warning: "..sUnitName.." has no unit strength!")
		return 0
	end
  
	-- Check unit class
	local iTrooperCount = self.squad_ai:GetNumTroopers()
	if (iTrooperCount == 1) then
		fUnitStrength = fUnitStrength * self.squad_ai:GetHealthPercentage()
	else
		fUnitStrength = fUnitStrength * iTrooperCount
	end
	
	-- Check if the squad has a leader
	if (self.squad_ai:HasLeader()) then
	
		local numApothecaries = 60 * self.squad_ai:GetLeaderCount( self.apothecaryIndex )
    		local numSergeants    = 75 * self.squad_ai:GetLeaderCount( self.sergeantIndex )
		local numBanners      = 85 * self.squad_ai:GetLeaderCount( self.bannerIndex )
    
    		fUnitStrength = fUnitStrength + numApothecaries + numSergeants  + numBanners -- + numChampions
	end
	
	-- Check if the squad has a unit attached
	if (self.squad_ai:IsAttached()) then
	
		-- Get attachment list
		local aAttachments = Attachments[sUnitName]
		if (aAttachments ~= nil) then
		
			-- Check attachment list
			for iLoop1 in aAttachments do
			
				-- Check attachment
				if (self.squad_ai:HasSquadAttached(aAttachments[iLoop1])) then
					fUnitStrength = fUnitStrength + UnitStrengths[aAttachments[iLoop1]] * self.squad_ai:GetAttachedHealthPercentage()
					break
				end		
			end
		end
	end
	return fUnitStrength
end

function TemplarCommandSquadTactic:Update()

	if self:IsComplete() then
      		return
	end
   
	--state machine
	if not TemplarInfantryTactic.Update( self ) then
		return
	end

  	-- JONES Update unit strength Patch 
  	if (self.squad_ai:HasLeader()) then
    		local old_iUnitStrength = self.m_iUnitStrength
    		self.m_iUnitStrength = self:Recalc_GetUnitStrength()  --  cpu_manager:GetUnitStrength(self.squad_ai)  
    
    		if old_iUnitStrength ~= self.m_iUnitStrength then
      			--aitrace("Tactic: Update UnitStrength Patch... old value ".. old_iUnitStrength .." real_value ".. self.m_iUnitStrength)
    		end
  	end
end
