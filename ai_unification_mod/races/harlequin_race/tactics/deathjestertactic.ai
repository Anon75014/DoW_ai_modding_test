----------------------------------------
-- File: 'DeathJestertactic.ai'
-- Edited by Thudmeizer @ 20.06.2023

class 'DeathJesterTactic' (HarlequinInfantryTactic)

DeathJester = {}

function DeathJesterTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("DeathJester Tactic")
	self.numUpgrades = 2
end

function DeathJesterTactic:InitAbilities()

    if (DeathJester.shot_id == nil) then
	    DeathJester.shot_id = cpu_manager.stats:GetAbilityID( "harlequin_shrieker_shot" )
	end
	
	if (DeathJester.curses_id == nil) then
		DeathJester.curses_id = cpu_manager.stats:GetAbilityID( "harlequin_song_of_curses" )
	end
end

function DeathJesterTactic:DoAbilities()

	-- Causes heavy enemy morale damage
	Ability.DoAbilityArea( self.squad_ai, DeathJester.curses_id, Ability.Filters.CloseSquadEnemy, 10, 1 ) 
	Ability.DoAbilityArea( self.squad_ai, DeathJester.curses_id, Ability.Filters.CloseCommanderEnemy, 10, 1 )
	
	Ability.DoAbilityPos( self.squad_ai, DeathJester.shot_id, Ability.Filters.CloseSquadEnemy, 1 ) 
	Ability.DoAbilityPos( self.squad_ai, DeathJester.shot_id, Ability.Filters.CloseCommanderEnemy, 1 )
end

function DeathJesterTactic:Upgrade()

	-- Check if we have free resources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end

	if (not self.squad_ai:IsReinforcing()) then
		-- Upgrade if possible
		if self.squad_ai:GetNumTroopers() == 1 or self.squad_ai:GetNumTroopers() == 2 then
			 self.numUpgrades = 1
		end
		if (self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 2 and self.squad_ai:GetHealthPercentage() > 0.4) then	
			if self.numUpgrades < 2 then
				local oEnemy = cpu_manager:FindClosestEnemyPlayer()
				if (oEnemy ~= nil) then
					local eUpgradeType = oEnemy:GetMajorityClassType()
					self.squad_ai:DoBestUpgrade( eUpgradeType )
					self.numUpgrades = self.numUpgrades + 1
				end
			end
		end
	end
end

function DeathJesterTactic:CanOnlyDecap()
	return true
end