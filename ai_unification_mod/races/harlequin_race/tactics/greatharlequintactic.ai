----------------------------------------
-- File: 'GreatHarlequintactic.ai'
-- Edited by Thudmeizer @ 28.03.2007

class 'GreatHarlequinTactic' (HarlequinInfantryTactic)

GreatHarlequin = {}

function GreatHarlequinTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Great Harlequin Tactic")
end


-- Assassinate win condition -- never attack
function GreatHarlequinTactic:IsAttacker()
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

-- Assassinate win condition -- never defend
function GreatHarlequinTactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end

function GreatHarlequinTactic:InitAbilities()

	if (GreatHarlequin.mask_id == nil) then
		GreatHarlequin.mask_id = cpu_manager.stats:GetAbilityID( "harlequin_rictus_mask" )
	end
	if (GreatHarlequin.laugh_id == nil) then
		GreatHarlequin.laugh_id = cpu_manager.stats:GetAbilityID( "harlequin_last_laugh" )
	end
end

function GreatHarlequinTactic:DoAbilities()
	
	if (self.squad_ai:CanDoAbility(GreatHarlequin.mask_id) and (not self.squad_ai:IsCapturing())) and
	(Ability.Filters.CloseInfantryEnemy(self.squad_ai:GetPosition(), 15, 5) ~= nil or
	Ability.Filters.CloseCommanderEnemy(self.squad_ai:GetPosition(), 15, 1) ~= nil) then
		self.squad_ai:DoSpecialAbility(GreatHarlequin.mask_id)
	end

	if (self.squad_ai:CanDoAbility(GreatHarlequin.laugh_id) and self.squad_ai:GetHealthPercentage() < 0.3) then 
		self.squad_ai:DoSpecialAbility(GreatHarlequin.laugh_id)
	end

end

function GreatHarlequinTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Assassinate win condition -- never attach to a squad
	if (not cpu_manager.assassinate) then
		
		-- Attach to melee in tier2+
		if (cpu_manager:GetTierLevel() > 1) then
		
			if (self:TryAttachSquad(true, true, 1000, 100, nil) ~= nil) then
				return
			end
		end
		if (self:TryAttachSquad(false, true, 1000, 100, self.m_fCommanderAttachHealth) == nil) then
			self:TryAttachSquadMelee()
		end
	end
end
