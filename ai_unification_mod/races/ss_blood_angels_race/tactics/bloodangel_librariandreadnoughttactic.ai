----------------------------------------
-- File: 'BloodAngelLibrarianDreadnoughttactic.ai'
-- Edited by Thudmeizer @ 29.11.2022

class 'BloodAngelLibrarianDreadnoughtTactic' (BloodAngelsVehicleTactic)

BloodAngelLibrarianDreadnought = {}

function BloodAngelLibrarianDreadnoughtTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Librarian Dreadnought Tactic")

	self.upgradeWeaponLastcheck = g_iGMT
end

function BloodAngelLibrarianDreadnoughtTactic:InitAbilities()

	-- Init ability ID's

	if (BloodAngelLibrarianDreadnought.smite_id == nil) then
		BloodAngelLibrarianDreadnought.smite_id = cpu_manager.stats:GetAbilityID( "blood_angel_smite" )
	end
	if (BloodAngelLibrarianDreadnought.shield_id == nil) then
		BloodAngelLibrarianDreadnought.shield_id = cpu_manager.stats:GetAbilityID( "blood_angel_shield_of_sanguinius" )
	end
	if (BloodAngelLibrarianDreadnought.boil_id == nil) then
		BloodAngelLibrarianDreadnought.boil_id = cpu_manager.stats:GetAbilityID( "blood_angel_blood_boil" )
	end
end

function BloodAngelLibrarianDreadnoughtTactic:DoAbilities()
	
	if (self.squad_ai:CanDoAbility(BloodAngelLibrarianDreadnought.shield_id)) then
		local range = self.squad_ai:GetAbilityRange( BloodAngelLibrarianDreadnought.shield_id )	
		local squad_filter = function( squad_ai )		
			return squad_ai:IsInCombat() and squad_ai:IsInStateAttackMove() and 
					squad_ai:GetNumTroopers() >= 4 and not squad_ai:IsBroken() and
					not squad_ai:IsCapturing()
		end	
   		local target_squad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
		if (target_squad ~= nil) then
			self.squad_ai:DoSpecialAbilitySquad( BloodAngelLibrarianDreadnought.shield_id, target_squad:GetSquad() )
 		end
	end
	
	-- If we are dying, lower requisites for attacks
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
			

	   Ability.DoAbilityTarget( self.squad_ai, BloodAngelLibrarianDreadnought.smite_id, Ability.Filters.CloseInfantryEnemy, 1 )
	   Ability.DoAbilityTarget( self.squad_ai, BloodAngelLibrarianDreadnought.boil_id, Ability.Filters.CloseInfantryEnemy, 1 )

	   if (self.squad_ai:CanDoAbility(BloodAngelLibrarianDreadnought.shield_id)) then
			local range = self.squad_ai:GetAbilityRange( BloodAngelLibrarianDreadnought.shield_id )	
			local squad_filter = function( squad_ai )		
				return squad_ai:IsInCombat() and squad_ai:IsInStateAttackMove() and 
						squad_ai:GetNumTroopers() >= 2 and not squad_ai:IsBroken() and
						not squad_ai:IsCapturing()
			end	
   			local target_squad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
			if (target_squad ~= nil) then
				self.squad_ai:DoSpecialAbilitySquad( BloodAngelLibrarianDreadnought.shield_id, target_squad:GetSquad() )
 			end
 		end
 	else

		Ability.DoAbilityTarget( self.squad_ai, BloodAngelLibrarianDreadnought.smite_id, Ability.Filters.CloseCommanderEnemy, 1 )		
		Ability.DoAbilityTarget( self.squad_ai, BloodAngelLibrarianDreadnought.boil_id, Ability.Filters.CloseCommanderEnemy, 1 )		
	end
end

function BloodAngelLibrarianDreadnoughtTactic:Upgrade()


	-- Check if we have free resources and the option to upgrade
	if not (Tactic.Options.can_reinforce and self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetHealthPercentage() > 0.4) then
		return
	end

	-- Check regularly if we have to upgrade
	if ( g_iGMT > self.upgradeWeaponLastcheck + 16 ) then
		-- Figure out my closest enemy's favourite class
		local class_type = cpu_manager:FindClosestEnemyPlayer():GetMajorityClassType()  
		if (class_type == UnitStatsAI.UC_VehicleLow or class_type == UnitStatsAI.UC_VehicleMed or
		class_type == UnitStatsAI.UC_VehicleHigh or class_type == UnitStatsAI.UC_AirMed or math.random( 1, 25 ) > 24) then
			VehicleTactic.Upgrade(self)
			self.upgradeWeaponLastcheck = g_iGMT
		end
	end
end

function BloodAngelLibrarianDreadnoughtTactic:Update()

    if (self:IsComplete()) then
        return
    end
    
    -- State machine
    if (not VehicleTactic.Update( self )) then
        return
    end
end


