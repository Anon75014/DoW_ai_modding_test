----------------------------------------
-- File: 'honorguardtactic.ai'
-- Edited by Thudmeizer @ 27.11.2022

class 'BloodAngelHonorGuardTactic' (BloodAngelsInfantryTactic)

BloodAngelHonorGuard = {}

function BloodAngelHonorGuardTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Blood Angel Honor Guard Tactic")
end

-- BloodAngelHonorGuard is allowed to retreat even directly after a jump
function BloodAngelHonorGuardTactic:SetTarget( target, variant_type )

	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

function BloodAngelHonorGuardTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function BloodAngelHonorGuardTactic:IsDefender()
	return self:IsCommanderDefender()
end

function BloodAngelHonorGuardTactic:InitAbilities()
--[[
	if (BloodAngelHonorGuard.orbitalstrike_id == nil) then
		BloodAngelHonorGuard.orbitalstrike_id = cpu_manager.stats:GetAbilityID( "blood_angel_wrath_of_sanguinus" )
	end
]]
	if (BloodAngelHonorGuard.melta_id == nil) then
      		BloodAngelHonorGuard.melta_id = cpu_manager.stats:GetAbilityID( "blood_angel_melta_bombs_honour" )
	end

	if (BloodAngelHonorGuard.frag_id == nil) then
      		BloodAngelHonorGuard.frag_id = cpu_manager.stats:GetAbilityID( "blood_angel_frag_grenades_honour" )
	end
end

function BloodAngelHonorGuardTactic:DoAbilities()

	-- Try to use orbital strike
	--Ability.DoAbilityPos(self.squad_ai, BloodAngelHonorGuard.orbitalstrike_id, Ability.Filters.CloseEnemy, 12)
	--Ability.DoAbilityPos(self.squad_ai, BloodAngelHonorGuard.orbitalstrike_id, Ability.EntityFilters.CloseBaseEntityEnemy, 3)

	Ability.DoAbilityTarget(self.squad_ai, BloodAngelHonorGuard.melta_id, Ability.Filters.CloseVehicleEnemy, 1)
	Ability.DoAbilityTargetEntity( self.squad_ai, BloodAngelHonorGuard.melta_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1)

	Ability.DoAbilityTarget(self.squad_ai, BloodAngelHonorGuard.frag_id, Ability.Filters.CloseSquadEnemy, 1)
	Ability.DoAbilityTargetEntity( self.squad_ai, BloodAngelHonorGuard.frag_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1)
end

function BloodAngelHonorGuardTactic:Reinforce()

  --always try for the actual leader first
	if not self.squad_ai:IsReinforcing() then
		if self.squad_ai:CanReinforce( false, 0 ) then
		   self.squad_ai:DoReinforce( false, 0 )
		end
	end

	if not self.squad_ai:IsReinforcing() then

		-- try for different types of squad members
		local guardIndex = 0
	
		local numGuards = self.squad_ai:GetLeaderCount( guardIndex )

		-- Desired order of reinforcing
		if numGuards < 4 then
			if self.squad_ai:CanReinforce( true, guardIndex ) then
				self.squad_ai:DoReinforce( true, guardIndex )
			end
		end
	end
end

function BloodAngelHonorGuardTactic:Update()

    if (self:IsComplete()) then
        return
    end

    -- State machine
    if (not InfantryTactic.Update(self)) then
        return
    end
    
	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end