----------------------------------------
-- File: 'dakkajettactic.ai'
-- Created by Gambit @ 22.10.2021

class 'DakkajetTactic' (OrkVehicleTactic)

DakkaJet = {}

function DakkajetTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Dakkajet Tactic Tactic")

	-- Used for the stuck check code for the squads that can jump
	self.initialPosition = self.squad_ai:GetPosition()
end


function DakkajetTactic:InitAbilities()

	-- Init ability ID's
	if DakkaJet.kamikaze_id == nil then
		DakkaJet.kamikaze_id = cpu_manager.stats:GetAbilityID( "ork_dakkajet_kamikaze" )
	end
end


function DakkajetTactic:DoAbilities()

	if self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.3 then
		if self.squad_ai:CanDoAbility(DakkaJet.kamikaze_id) then
			-- Check if there is an Aircraft nearby to use the ability
			local oAircraft = self:GetEnemyAircraftWithin(self.squad_ai:GetPosition(), 30)
			if oAircraft ~= nil then
				self.squad_ai:DoSpecialAbilitySquad(DakkaJet.kamikaze_id, oAircraft:GetSquad())
				return
			end
		end
	end
	
	-- New code to unstuck units with pathing issues, that can jump.
	-- Call it with [true], only for multi-membered squads.
	self:SolveStuckCase(false)
end


-- Called directly to find an enemy aircraft within range.
function DakkajetTactic:GetEnemyAircraftWithin(iPos, iRange)
	for oPlayer in cpu_manager.stats:GetPlayerStats() do
		if not oPlayer:IsPlayerDead() then
			if cpu_manager.player_stats:IsEnemy(oPlayer) then
				for oSquad in oPlayer:GetSquads() do
					if oSquad:IsValid() then
						local oStats = oSquad:GetStats()
						if oStats ~= nil then
							-- 16, is Air Med. The other STATS value... Did NOT worked!
							if oStats:GetClass() == 16 then
								if distance_sqr(oSquad:GetPosition(),iPos) < iRange*iRange then 
									return oSquad
								end
							end
						end
					end
				end
			end
		end
	end
	return nil
end