----------------------------------------
-- File: 'weirdboytactic.ai'
-- Edited by Thudmeizer @ 22.09.2023

class 'WeirdboyTactic' (OrkInfantryTactic)

WeirdBoy = {}

function WeirdboyTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("WeirdBoy Tactic")

	self.m_iLastEntrenchTime = g_iGMT
end

function WeirdboyTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function WeirdboyTactic:IsDefender()
	return self:IsCommanderDefender()
end

-- Arkhan 03.2006: Inherited method used by commanders which are able to jump with an attached squad
function WeirdboyTactic:CanJumpAttached()
	return true
end

function WeirdboyTactic:SetTarget( target, variant_type )
	self.variant_type = variant_type
	self.target = Vector3f(target)
	self.m_iMoveDelay = 0
	self.last_jump = 0
end

function WeirdboyTactic:InitAbilities()

	-- Init ability ID's
	if WeirdBoy.roar_of_mork_id == nil then
		WeirdBoy.roar_of_mork_id = cpu_manager.stats:GetAbilityID("ork_weirdboy_roar_of_mork")
		WeirdBoy.fists_of_gork_id = cpu_manager.stats:GetAbilityID("ork_weirdboy_fists_of_gork")
		WeirdBoy.da_krunch_id = cpu_manager.stats:GetAbilityID("ork_weirdboy_da_krunch")
	end
end

function WeirdboyTactic:DoAbilities()

	if self.squad_ai:IsInCombat() then

		if self.squad_ai:CanDoAbility(WeirdBoy.roar_of_mork_id) then
			if Ability.DoAbilityTarget( self.squad_ai, WeirdBoy.roar_of_mork_id, Ability.Filters.CloseSquadEnemy, 4 )
			or Ability.DoAbilityTarget( self.squad_ai, WeirdBoy.roar_of_mork_id, Ability.Filters.CloseCommanderEnemy, 1 ) then
				return
			end
		end

		if self.squad_ai:CanDoAbility(WeirdBoy.fists_of_gork_id) then
			if Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), 20, 3) ~= nil then
				self.squad_ai:DoSpecialAbility(WeirdBoy.fists_of_gork_id)
				return
			end
		end

		if self.squad_ai:CanDoAbility(WeirdBoy.da_krunch_id) then
			if Ability.DoAbilityTarget( self.squad_ai, WeirdBoy.da_krunch_id, Ability.Filters.CloseSquadEnemy, 6 )
			or Ability.DoAbilityTarget( self.squad_ai, WeirdBoy.da_krunch_id, Ability.Filters.CloseCommanderEnemy, 1 )
			or Ability.DoAbilityTarget( self.squad_ai, WeirdBoy.da_krunch_id, Ability.Filters.CloseVehicleEnemy, 1 ) then
				return
			end
		end
	end

	if not self.squad_ai:IsAttached() then
		-- Make 100% sure the time var is initialised
		if self.m_iLastEntrenchTime == nil then
			self.m_iLastEntrenchTime = g_iGMT
		end
		local delay = 4
		if bDoEntrench == true then delay = 10 end
		-- Don't entrench/detrench too fast after a detrench/entrench
		if g_iGMT < self.m_iLastEntrenchTime + delay then
			return
		end
		local bDoEntrench = false	-- Detrench, by default (and var initialisation)
		local self_pos = self.squad_ai:GetPosition()
		if (not cpu_manager.terrain_analyzer:HasThreat(self_pos, 28)) or self.squad_ai:GetHealthPercentage() < 0.4 then
			bDoEntrench = false
		else
			local oUnit = Ability.Filters.CloseHurt(self_pos, 25, 1)
			if oUnit ~= nil and oUnit:IsValid() and oUnit:GetNumTroopers() > 5 then
				bDoEntrench = true
			end
		end
		-- Check if we can entrench/detrench, for the Maniacal Seizure ability
		if self.squad_ai:CanEntrench(true) then
			-- Try to entrench
			if bDoEntrench then
				self.squad_ai:DoEntrench(true)
				self.m_iLastEntrenchTime = g_iGMT
			end
		elseif self.squad_ai:CanEntrench(false) then
			-- Try to detrench
			if not bDoEntrench then
				self.squad_ai:DoEntrench(false)
				self.m_iLastEntrenchTime = g_iGMT
			end
		end
	end
end

function WeirdboyTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
	
	-- Check if we are in serious trouble
	self:EmergencyRetreat()

	--attach to squad
	self:TryAttachSquad( false, false, 1000, 100, nil )
end

