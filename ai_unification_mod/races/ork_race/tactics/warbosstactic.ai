----------------------------------------
-- File: 'warbosstactic.ai'
-- Edited by LarkinVB   @ 31.07.2005
-- Edited by Thudmeizer @ 28.10.2023

class 'WarBossTactic' (OrkInfantryTactic)

WarBoss = {}

function WarBossTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("WarBoss Tactic")
end

function WarBossTactic:IsAttacker()
	return self:IsCommanderAttacker()
end

function WarBossTactic:IsDefender()
	return self:IsCommanderDefender()
end

function WarBossTactic:InitAbilities()

	-- Init ability ID's
	if (WarBoss.waagh == nil) then
		WarBoss.waagh = cpu_manager.stats:GetAbilityID( "ork_power_of_waagh" )
	end
	if (WarBoss.waagh_ktgm == nil) then
		WarBoss.waagh_ktgm = cpu_manager.stats:GetAbilityID( "ork_ls_warboss_power_of_waagh" )
	end
	if (WarBoss.shield_ktgm == nil) then
		WarBoss.shield_ktgm = cpu_manager.stats:GetAbilityID( "ork_ls_warboss_force_field" )
	end
	if (WarBoss.banner_ktgm == nil) then
		WarBoss.banner_ktgm = cpu_manager.stats:GetAbilityID( "ork_ls_warboss_giant_waagh_banner" )
	end
	if (WarBoss.disengage_ktgm == nil) then
		WarBoss.disengage_ktgm = cpu_manager.stats:GetAbilityID( "ork_ls_warboss_cunning_disengage" )
	end
	if (WarBoss.throw_ktgm == nil) then
		WarBoss.throw_ktgm = cpu_manager.stats:GetAbilityID( "ork_ls_warboss_throw" )
	end
end

function WarBossTactic:DoAbilities()

	-- Try to use Waaagh ability
	if (self.squad_ai:CanDoAbility(WarBoss.waagh)) then
		Ability.DoAbility( self.squad_ai, WarBoss.waagh, Ability.Filters.IsInCombat ) 
	end

	-- Try to use Waaagh ability (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(WarBoss.waagh_ktgm)) then
		Ability.DoAbility( self.squad_ai, WarBoss.waagh_ktgm, Ability.Filters.IsInCombat ) 
	end
--[[
	-- Try to deploy the large Waaagh banner (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(WarBoss.banner_ktgm)) then

		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
			Ability.DoAbilityPos( self.squad_ai, WarBoss.banner_ktgm, Ability.Filters.CloseEnemy, 3 ) 
		else
			Ability.DoAbilityPos( self.squad_ai, WarBoss.banner_ktgm, Ability.Filters.CloseEnemy, 6 ) 
		end
	end
]]
	-- Try to deploy the large Waaagh banner (Last Stand / Kill Team)
	if (self.squad_ai:CanDoAbility(WarBoss.banner_ktgm)) then 

		-- Search for a nearby enemy 
		local iRange = self.squad_ai:GetAbilityRange(WarBoss.banner_ktgm)
		local oUnit = Ability.Filters.CloseHurt(self.squad_ai:GetPosition(), iRange, 1)
		if (oUnit ~= nil) then
			--print("Using Large Waaagh Banner ability Ability for player "..tostring(cpu_manager.player_id).."")
			self.squad_ai:DoSpecialAbilitySquad(WarBoss.banner_ktgm, oUnit:GetSquad())
			return
		end
	end

	if self.squad_ai:IsInCombat() then
 
		-- Use force field ability if low on health (Last Stand / Kill Team)
		if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then

			if (self.squad_ai:CanDoAbility(WarBoss.shield_ktgm)) then 
				self.squad_ai:DoSpecialAbility(WarBoss.shield_ktgm)
			end
		end

		-- Try to use Cunning Disengage ability if we have enough health (Last Stand / Kill Team)
		if (self.squad_ai:GetHealthPercentage() > 0.5) then

			if (self.squad_ai:CanDoAbility(WarBoss.disengage_ktgm)) then
				Ability.DoAbilityArea( self.squad_ai, WarBoss.disengage_ktgm, Ability.Filters.CloseInCombat, 10, 3 )
			end
		end

		-- Use force throw ability (Last Stand / Kill Team)
		if (self.squad_ai:CanDoAbility(WarBoss.throw_ktgm)) then
			Ability.DoAbilityArea( self.squad_ai, WarBoss.throw_ktgm, Ability.Filters.CloseInCombat, 15, 3 ) 
		end
	end

	-- Spawn Slugga Squad (Last Stand / Kill Team)
	if (self.squad_ai:CanDirectSpawn()) then 
		self.squad_ai:DoDirectSpawn()
	end
end
	
function WarBossTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
	
	-- Attach to melee
    	if (self.squad_ai:GetMeleeStance() == SquadAI.MSTANCE_Assault) then
         
        	if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then
        
            		if (self:TryAttachSquad(false, true, 50, 150, self.m_fCommanderAttachHealth) == nil) then
                		self:TryAttachSquadMelee()
            		end
        	end
    	end
end
