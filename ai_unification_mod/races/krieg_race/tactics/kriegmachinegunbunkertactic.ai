----------------------------------------
-- File: 'kriegmachinegunbunkertactic.ai'
-- Edited by Thudmeizer		@ 10.05.2024

class 'KriegMachineGunBunkerTactic' (BaseTactic)

KriegMachineGunBunker = {}

function KriegMachineGunBunkerTactic:__init( base_ai ) super( base_ai )

	self:SetName("Krieg Machine Gun Bunker Tactic")

	-- Building is a bunker
	self:AddToBunkerList()
end

function KriegMachineGunBunkerTactic:AutoBuildAddOn( addonSlot, iID )
	local buildChannelLP = build_manager:GetBuildChannelFromID(iID)
	if (buildChannelLP ~= nil) then
		local addOnID = buildChannelLP:GetItemIDAt(BuildChannelAI.PQ_AddOn, addonSlot)
		if (buildChannelLP:IsBuilding() == 0 and buildChannelLP:CanAddToQueue(BuildChannelAI.PQ_AddOn, addOnID) == BuildChannelAI.CANBUILD_Ok) then
			buildChannelLP:BuildAddOn(addOnID)
		end
	end
end

function KriegHQTactic:InitAbilities()

	if (KriegMachineGunBunker.m_iTrapID == nil) then
		KriegMachineGunBunker.m_iTrapID = cpu_manager.stats:GetAbilityID( "krieg_bunker_bolster_defenses_trap" )
	end

	if (KriegMachineGunBunker.m_iWireID == nil) then
		KriegMachineGunBunker.m_iWireID = cpu_manager.stats:GetAbilityID( "krieg_bunker_bolster_defenses_wire" )
	end
end

function KriegMachineGunBunkerTactic:DoAbilities()

	-- Available addons
	-- [addon_01] = addon_krieg_netting
	-- [addon_02] = addon_krieg_bunker_autocannon
	-- [addon_03] = addon_krieg_bunker_lascannon
	-- [addon_04] = addon_krieg_bunker_medic
	-- [addon_05] = addon_krieg_bunker_engineer


	local trapChance = math.random (1,100)
	local wireChance = math.random (1,100)

	local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
	local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )

	if (iRequisition >= 300 and iPower >= 300) then

		-- Randomly select between netting or autocannon or lascannon bunker addons
		local random_bunker_addon = math.random( 0,2 )
		self:AutoBuildAddOn(random_bunker_addon, self.base_ai:GetEntity():GetID())	-- Select only one of these addons

		if (trapChance > 35) then

			-- Try to drop a trap against an enemy vehicle
			if (self.base_ai:CanDoAbility(KriegMachineGunBunker.m_iTrapID)) then
	
				-- Search attacking enemies in range
				local iRange = self.base_ai:GetAbilityRange(KriegMachineGunBunker.m_iTrapID)
				local oEnemy = Ability.Filters.CloseVehicleEnemy(self.base_ai:GetPosition(), iRange + 25, 1)
				if (oEnemy ~= nil and oEnemy:IsAttacking()) then
			
					-- Search the closest friendly unit in range
					local oUnit = Ability.Filters.CloseHurt(oEnemy:GetPosition(), 35, 1)
					if (oUnit ~= nil and distance_sqr(self.base_ai:GetPosition(), oUnit:GetPosition()) < sqr(iRange)) then
				
						-- Use ability on squad
						self.base_ai:DoSpecialAbilitySquad(KriegMachineGunBunker.m_iTrapID, oUnit:GetSquad())
						--print("Using Bunker Trap Drop ability for player "..tostring(cpu_manager.player_id).."")
					end
				end
			end
		end

		if (wireChance > 65) then

			-- Try to drop a wire against enemy infantry
			if (self.base_ai:CanDoAbility(KriegMachineGunBunker.m_iWireID)) then
	
				-- Search attacking infantry enemies in range
				local iRange = self.base_ai:GetAbilityRange(KriegMachineGunBunker.m_iWireID)
				local oEnemy = Ability.Filters.CloseInfantryEnemy(self.base_ai:GetPosition(), iRange + 25, 4)
				if (oEnemy ~= nil and oEnemy:IsAttacking()) then
			
					-- Search the closest friendly unit in range
					local oUnit = Ability.Filters.CloseHurt(oEnemy:GetPosition(), 35, 1)
					if (oUnit ~= nil and distance_sqr(self.base_ai:GetPosition(), oUnit:GetPosition()) < sqr(iRange)) then
				
						-- Use ability on squad
						self.base_ai:DoSpecialAbilitySquad(KriegMachineGunBunker.m_iWireID, oUnit:GetSquad())
						--print("Using Bunker Wire Drop ability for player "..tostring(cpu_manager.player_id).."")
					end
				end
			end
		end
	end

	if (iRequisition >= 100 and iPower >= 200) then

		-- Randomly select either medic or engineer bunker addons
		local random_secondary_bunker_addon = math.random( 3,4 )
		self:AutoBuildAddOn(random_secondary_bunker_addon, self.base_ai:GetEntity():GetID())	-- Select only one of these addons
	end
end
