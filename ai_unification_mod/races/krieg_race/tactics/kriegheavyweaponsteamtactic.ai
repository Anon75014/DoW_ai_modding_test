----------------------------------------
-- File: 'krieghwttactic.ai'
-- Edited by Thudmeizer @ 25.04.2022
-- Edited by Shepherd   @ 24.11.2024

class 'KriegHeavyWeaponsTeamTactic' (KriegInfantryTactic)

KriegHeavyWeaponsTeam = {}

function KriegHeavyWeaponsTeamTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Krieg Heavy Weapons Team Tactic")
	
	--self.autocannonBuiltTime = g_iGMT

	-- Squad is transportable and able to occupy bunkers
		self.m_iTransportable = 1
		self.m_bBunkerSquad = true
end

function KriegGrenadierTactic:InitAbilities()

	-- Init ability ID's
	if (KriegHeavyWeaponsTeam.entrench_id == nil) then
		KriegHeavyWeaponsTeam.entrench_id = cpu_manager.stats:GetAbilityID( "krieg_hwt_entrench" )
	end
end

function KriegHeavyWeaponsTeamTactic:DoAbilities()

	-- We are dying, lower requisites for attacks
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.5) then

		-- Check if we can Dig In
		if (self.squad_ai:CanDoAbility(KriegHeavyWeaponsTeam.entrench_id)) then
	
			local oSquad = Ability.Filters.CloseEnemy(self.squad_ai:GetPosition(), 20, 1)
			if (oSquad ~= nil) then
			
				-- Only try to Dig In if enemy unit is attacking
				if (oSquad:IsAttacking()) then
					self.squad_ai:DoSpecialAbility(KriegHeavyWeaponsTeam.entrench_id)
					print("Using Heavy Weapons Team Entrench ability for player "..tostring(cpu_manager.player_id).."")
				end
			end
		end
	end
end

function KriegHeavyWeaponsTeamTactic:Reinforce()

	if not self.squad_ai:IsReinforcing() then

		-- try for different types of squad members
		local HeavyFlamerIndex = 0
		local AutocannonIndex = 1
		local LascannonIndex = 2
	
		-- Get current leader count
		local numHeavyFlamer = self.squad_ai:GetLeaderCount( HeavyFlamerIndex )
		local numAutocannon = self.squad_ai:GetLeaderCount( AutocannonIndex )
		local numLascannon = self.squad_ai:GetLeaderCount( LascannonIndex )

		-- Desired number of each leader type
		local desiredAutocannon = 1
		local desiredLascannon = 1
		local desiredHeavyFlamer = 1

		-- Figure out my enemy's favourite class
		local enemy = cpu_manager:FindClosestEnemyPlayer()
			if (enemy == nil) then
				return
			end

		local class_type = enemy:GetMajorityClassType()
		
		-- Larkins hard counter upgrade for Vehicles
		if (class_type == UnitStatsAI.UC_VehicleLow) or 
			(class_type == UnitStatsAI.UC_VehicleMed) or
			(class_type == UnitStatsAI.UC_VehicleHigh) then
				bVehicleEnemies = true
		end

		-- Check available requisition
		local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )

		-- Desired order of reinforcing
		if bVehicleEnemies and iRequisition >= 85 then
			if self.squad_ai:CanReinforce( true, LascannonIndex ) then
				self.squad_ai:DoReinforce( true, LascannonIndex )
			end
		end
--[[
		if numAutocannon < desiredAutocannon -1 or numAutocannon < desiredAutocannon and (g_iGMT - self.autocannonBuiltTime) > 5 then
			if self.squad_ai:CanReinforce( true, AutocannonIndex ) then
				self.squad_ai:DoReinforce( true, AutocannonIndex )
				self.autocannonBuiltTime = g_iGMT
			end
		end
]]
		if numAutocannon < desiredAutocannon then
			if self.squad_ai:CanReinforce( true, AutocannonIndex ) then
				self.squad_ai:DoReinforce( true, AutocannonIndex )
			end
		end
		if numHeavyFlamer < desiredHeavyFlamer then
			if self.squad_ai:CanReinforce( true, HeavyFlamerIndex ) then
				self.squad_ai:DoReinforce( true, HeavyFlamerIndex )
			end
		end
	end
		
	-- Always try for the actual leader next
	if not self.squad_ai:IsReinforcing() then
		if (self.squad_ai:CanReinforce( false, 0 )) then
			self.squad_ai:DoReinforce( false, 0 )
		elseif (self.squad_ai:CanReinforce( true, 0 )) then
			self.squad_ai:DoReinforce( true, 0 )
		end
	end
end

function KriegHeavyWeaponsTeamTactic:Update()

	if (self:IsComplete()) then
		return
	end

	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
end

