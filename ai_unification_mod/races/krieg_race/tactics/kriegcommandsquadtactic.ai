----------------------------------------
-- File: 'kriegcommandsquadtactic.ai'
-- Edited by fuggles @ 09.04.2022
-- Edited by Thudmeizer @ 18.08.2024

class 'KriegCommandSquadTactic' (KriegInfantryTactic)

KriegCommandSquad = {}

KriegCommandSquadTactic.PosAbilities = 
{
	{ nil, "krieg_strafing_run",				Ability.Filters.CloseEnemy, 6 },
	{ nil, "krieg_vox_earthshaker_round",			Ability.Filters.CloseEnemy, 6 },
}

KriegCommandSquadTactic.TargetAbilities = 
{
	{ nil, "krieg_gas_grenades", 				Ability.Filters.CloseSquadEnemy, 1 },
}

function KriegCommandSquadTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Krieg Command Squad Tactic")
	
	-- Command squad is able to enter a bunker
	self.m_bBunkerSquad = true
end

-- Assassinate win condition -- never attack
function KriegCommandSquadTactic:IsAttacker()

	-- Never attack in assassinate game mode
	if (cpu_manager.assassinate) then
		return false
	end
	
	-- Attack if we have more than one squad member
	if (self.squad_ai:GetNumTroopers() > 1) then
		return true
	end
	return self:IsCommanderAttacker()
end

-- Assassinate win condition -- never defend
function KriegCommandSquadTactic:IsDefender()

	-- Never defend in assassinate game mode
	if (cpu_manager.assassinate) then
		return false
	end
	
	-- Defend if we have more than one squad member
	if (self.squad_ai:GetNumTroopers() > 1) then
		return true
	end
	return self:IsCommanderDefender()
end

function KriegCommandSquadTactic:InitAbilities()

	-- Init ability ID's
	if (KriegCommandSquadTactic.PosAbilities[1][1] == nil) then
		for i in KriegCommandSquadTactic.PosAbilities do
			local ability_id = cpu_manager.stats:GetAbilityID( KriegCommandSquadTactic.PosAbilities[i][2] )
			KriegCommandSquadTactic.PosAbilities[i][1] = ability_id
		end
	end
	
	if (KriegCommandSquadTactic.TargetAbilities[1][1] == nil) then
		for i in KriegCommandSquadTactic.TargetAbilities do
			local ability_id = cpu_manager.stats:GetAbilityID( KriegCommandSquadTactic.TargetAbilities[i][2] )
			KriegCommandSquadTactic.TargetAbilities[i][1] = ability_id
		end
	end
end

function KriegCommandSquadTactic:DoAbilities()

	for i in KriegCommandSquadTactic.PosAbilities do
		local ability_id = KriegCommandSquadTactic.PosAbilities[i][1]
		if ability_id ~= nil then

			local filter = KriegCommandSquadTactic.PosAbilities[i][3]
			local squad_count = KriegCommandSquadTactic.PosAbilities[i][4]
			Ability.DoAbilityPos( self.squad_ai, ability_id, filter, squad_count ) 
		end
	end

	for i in KriegCommandSquadTactic.TargetAbilities do
		local ability_id = KriegCommandSquadTactic.TargetAbilities[i][1]
		if ability_id ~= nil then

			local filter = KriegCommandSquadTactic.TargetAbilities[i][3]
			local squad_count = KriegCommandSquadTactic.TargetAbilities[i][4]
			Ability.DoAbilityTarget( self.squad_ai, ability_id, filter, squad_count ) 
		end
	end
end

function KriegCommandSquadTactic:Reinforce()

	-- Allow free reinforcing during harassing time
	if (g_iGMT > DefendChokePointPlan.HarassingTime * 60) then

		-- If there are no ressources available, don't upgrade!
		if (not Tactic.Options.can_reinforce) then
			return
		end
	end

	if (not self.squad_ai:IsReinforcing()) then

		-- Always try for the actual leader first
		if (self.squad_ai:CanReinforce( false, 0 )) then
			self.squad_ai:DoReinforce( false, 0 )
			return
		end

		-- Try for different types of squad members
		local bannerIndex = 0
		local voxIndex = 1
		local meleeIndex = 2
		local rangedIndex = 3
	
		-- Get current leader count
		local numMelee = self.squad_ai:GetLeaderCount( meleeIndex )
		local numRanged = self.squad_ai:GetLeaderCount( rangedIndex)
		local numBanner = self.squad_ai:GetLeaderCount( bannerIndex )
		local numVox = self.squad_ai:GetLeaderCount( voxIndex )

		-- Desired number of each leader type
		local desiredMelee = 1
		local desiredRanged = 1
		local desiredBanner = 0
		local desiredVox = 0
		
		-- If squad size research is done want a psyker
		local squadMax = self.squad_ai:GetMaxLeaderCount()
		if (squadMax >= 4) then
			desiredMelee = 1
			desiredRanged = 1
			desiredBanner = 1
			desiredVox = 1
		end
		
		-- Check if the enemy has infiltrators
		if (cpu_manager:EnemyHasUnitInfiltrators() or cpu_manager:EnemyHasBaseInfiltrators()) then
		
			-- Make sure we have a psyker
			if (numVox <= 0) then
				desiredVox = 1
				desiredMelee = 1
				desiredBanner = 0
			end
		end

		-- Desired order of reinforcing
		if (numRanged < desiredRanged) then
			if self.squad_ai:CanReinforce( true, rangedIndex ) then
				self.squad_ai:DoReinforce( true, rangedIndex )
			end
		elseif (numMelee < desiredMelee) then
			if self.squad_ai:CanReinforce( true, meleeIndex ) then
				self.squad_ai:DoReinforce( true, meleeIndex )
			end

		elseif (numVox < desiredVox) then
			if self.squad_ai:CanReinforce( true, voxIndex ) then
				self.squad_ai:DoReinforce( true, voxIndex )
			end
		elseif (numBanner < desiredBanner) then
			if self.squad_ai:CanReinforce( true, bannerIndex ) then
				self.squad_ai:DoReinforce( true, bannerIndex )
			end
		end
	end
end

