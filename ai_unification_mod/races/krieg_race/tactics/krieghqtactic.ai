----------------------------------------
-- File: 'krieghqtactic.ai'
-- Edited by Arkhan		@ 24.10.2006
-- Edited by Thudmeizer		@ 29.10.2022

class 'KriegHQTactic' (BaseTactic)

KriegHQ = {}

function KriegHQTactic:__init( base_ai ) super( base_ai )

	self:SetName("Krieg HQ Tactic")
	
	-- Building is a bunker
	--self:AddToBunkerList()
end

function KriegHQTactic:InitAbilities()

	-- Init ability ID's
	if (KriegHQ.m_iMineID == nil) then
		KriegHQ.m_iMineID = cpu_manager.stats:GetAbilityID( "krieg_hq_bolster_defenses_mine" )
	end

	if (KriegHQ.m_iTrapID == nil) then
		KriegHQ.m_iTrapID = cpu_manager.stats:GetAbilityID( "krieg_hq_bolster_defenses_trap" )
	end

	if (KriegHQ.m_iWireID == nil) then
		KriegHQ.m_iWireID = cpu_manager.stats:GetAbilityID( "krieg_hq_bolster_defenses_wire" )
	end
end

function KriegHQTactic:DoAbilities()

	local mineChance = math.random (1,100)
	local trapChance = math.random (1,100)
	local wireChance = math.random (1,100)

	local iRequisition = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
	local iPower = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )

	if (iRequisition >= 200 and iPower >= 200) then

		if (mineChance > 25) then

			-- Try to drop a mine against enemy infantry
			if (self.base_ai:CanDoAbility(KriegHQ.m_iMineID)) then
	
				-- Search attacking enemies in range
				local iRange = self.base_ai:GetAbilityRange(KriegHQ.m_iMineID)
				local oEnemy = Ability.Filters.CloseSquadEnemy(self.base_ai:GetPosition(), iRange + 25, 1)
				if (oEnemy ~= nil and oEnemy:IsAttacking()) then
			
					-- Search the closest friendly unit in range
					local oUnit = Ability.Filters.CloseHurt(oEnemy:GetPosition(), 35, 1)
					if (oUnit ~= nil and distance_sqr(self.base_ai:GetPosition(), oUnit:GetPosition()) < sqr(iRange)) then
				
						-- Use ability on squad
						self.base_ai:DoSpecialAbilitySquad(KriegHQ.m_iMineID, oUnit:GetSquad())
						--print("Using HQ Mine Drop ability for player "..tostring(cpu_manager.player_id).."")
					end
				end
			end
		end

		if (trapChance > 45) then

			-- Try to drop a trap against an enemy vehicle
			if (self.base_ai:CanDoAbility(KriegHQ.m_iTrapID)) then
	
				-- Search attacking enemies in range
				local iRange = self.base_ai:GetAbilityRange(KriegHQ.m_iTrapID)
				local oEnemy = Ability.Filters.CloseVehicleEnemy(self.base_ai:GetPosition(), iRange + 25, 1)
				if (oEnemy ~= nil and oEnemy:IsAttacking()) then
			
					-- Search the closest friendly unit in range
					local oUnit = Ability.Filters.CloseHurt(oEnemy:GetPosition(), 35, 1)
					if (oUnit ~= nil and distance_sqr(self.base_ai:GetPosition(), oUnit:GetPosition()) < sqr(iRange)) then
				
						-- Use ability on squad
						self.base_ai:DoSpecialAbilitySquad(KriegHQ.m_iTrapID, oUnit:GetSquad())
						--print("Using HQ Trap Drop ability for player "..tostring(cpu_manager.player_id).."")
					end
				end
			end
		end

		if (wireChance > 65) then

			-- Try to drop a wire against enemy infantry
			if (self.base_ai:CanDoAbility(KriegHQ.m_iWireID)) then
	
				-- Search attacking infantry enemies in range
				local iRange = self.base_ai:GetAbilityRange(KriegHQ.m_iWireID)
				local oEnemy = Ability.Filters.CloseInfantryEnemy(self.base_ai:GetPosition(), iRange + 25, 4)
				if (oEnemy ~= nil and oEnemy:IsAttacking()) then
			
					-- Search the closest friendly unit in range
					local oUnit = Ability.Filters.CloseHurt(oEnemy:GetPosition(), 35, 1)
					if (oUnit ~= nil and distance_sqr(self.base_ai:GetPosition(), oUnit:GetPosition()) < sqr(iRange)) then
				
						-- Use ability on squad
						self.base_ai:DoSpecialAbilitySquad(KriegHQ.m_iWireID, oUnit:GetSquad())
						--print("Using HQ Wire Drop ability for player "..tostring(cpu_manager.player_id).."")
					end
				end
			end
		end
	end
end
