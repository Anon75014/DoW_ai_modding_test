
 --File: 'ynnarivehicletactic.ai'
 --Created by Arkhan		@ 31.01.2006
 --Edited by Thudmeizer         @ 12.03.2025

class 'YnnariVehicleTactic' (VehicleTactic)

YnnariVehicleAbility =
{
    CircuitID = cpu_manager.stats:GetAbilityID("ynnari_short_circuit")
	,HorrorfexID = cpu_manager.stats:GetAbilityID("ynnari_horrorfex")
	,WildfireID = cpu_manager.stats:GetAbilityID("ynnari_wildfire")
	,SurgeID = cpu_manager.stats:GetAbilityID("ynarri_talos_power_surge")
}

function YnnariVehicleTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Ynnari Vehicle Tactic")

	self.circuitLastUse = g_iGMT
	self.horrorfexLastUse = g_iGMT
	self.wildfireLastUse = g_iGMT
	self.surgeLastUse = g_iGMT
end

-- Check if the vehicle should dance away in melee
function YnnariVehicleTactic:CheckVehicleDance(sName)

	if (sName == "ynnari_squad_raven" or
		sName == "ynnari_squad_razorwing" or
		sName == "ynnari_squad_talos" or
		sName == "ynnari_squad_ravager" or
		sName == "ynnari_squad_venom" or
		sName == "ynnari_squad_vehicle_war_walker" or
		sName == "ynnari_squad_vehicle_hornet" or
		sName == "ynnari_squad_vehicle_lynx" or
		sName == "ynnari_squad_harlequin_wraith_lord" or
		sName == "ynnari_squad_mocking_bird" or
		sName == "ynnari_squad_vehicle_night_spinner" or
		sName == "ynnari_squad_mocking_bird" or
		sName == "ynnari_squad_void_dragon_phoenix_titan" or
		sName == "ynnari_squad_phantom_titan") then
		return true
	end
	return false
end

function YnnariVehicleTactic:DoAbilities()

	-- New code to unstuck units with pathing issues, that can jump
    	-- Can also be used for flying squads with map stuck issues
    	-- Call it with [true], only for multi-membered squads
    	local sSquadName = self.squad_ai:GetSquadName()
    	if (sSquadName == "ynnari_squad_vehicle_hornet") or
        	(sSquadName == "ynnari_squad_vehicle_lynx") then
        	self:SolveStuckCase(false)
    	end

	self:DoVehicleAbilities()
end

function YnnariVehicleTactic:DoVehicleAbilities()

	if self.squad_ai:IsInCombat() then
        
		if ( g_iGMT > self.horrorfexLastUse + 90 ) then
            		if Ability.DoAbilityTarget( self.squad_ai, YnnariVehicleAbility.HorrorfexID, Ability.Filters.CloseCommanderEnemy, 1 ) 
            		or Ability.DoAbilityTarget( self.squad_ai, YnnariVehicleAbility.HorrorfexID, Ability.Filters.CloseSquadEnemy, 1 )
            		or Ability.DoAbilityTarget( self.squad_ai, YnnariVehicleAbility.HorrorfexID, Ability.Filters.CloseMonsterEnemy, 1 )
            		then
				--print("Horrfex deployed for player "..tostring(cpu_manager.player_id).."")
                		self.horrorfexLastUse = g_iGMT 
            		end
        	end

		if ( g_iGMT > self.wildfireLastUse + 90 ) then
            		if Ability.DoAbilityTarget( self.squad_ai, YnnariVehicleAbility.WildfireID, Ability.Filters.CloseEnemy, 3 ) 
            		then
				--print("Wildfire deployed for player "..tostring(cpu_manager.player_id).."")
                		self.wildfireLastUse = g_iGMT 
            		end
        	end

		if ( g_iGMT > self.surgeLastUse + 90 ) then
			local squad_pos = self.squad_ai:GetPosition()
			if (((self.squad_ai:IsInCombat() and Ability.Filters.CloseEnemy( squad_pos, 20, 1 ) == nil) or
	   		self.squad_ai:IsBroken()) and self.squad_ai:GetHealthPercentage() > 0.8 and self:IsMoving()) then 
				if (self.squad_ai:CanDoAbility(YnnariVehicleAbility.SurgeID)) then
					self.squad_ai:DoSpecialAbility(YnnariVehicleAbility.SurgeID)
				end
				--print("Power Surge deployed for player "..tostring(cpu_manager.player_id).."")
                		self.surgeLastUse = g_iGMT 
            		end
        	end

		if ( g_iGMT > self.circuitLastUse + 90 ) then        
            		if Ability.DoAbilityTarget( self.squad_ai, YnnariVehicleAbility.CircuitID, Ability.Filters.CloseVehicleEnemy, 1 )
            		or Ability.DoAbilityTargetEntity( self.squad_ai, YnnariVehicleAbility.CircuitID, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
            		then
				--print("Short Curcuit deployed for player "..tostring(cpu_manager.player_id).."")
                		self.circuitLastUse = g_iGMT
            		end
        	end 
	end
end