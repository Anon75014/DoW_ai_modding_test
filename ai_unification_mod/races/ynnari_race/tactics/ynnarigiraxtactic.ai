----------------------------------------
-- File: 'ynnarigiraxtactic.ai'
-- Edited by Gambit/Thudmeizer @ 06.03.2023

class 'YnnariGiraxTactic' (YnnariInfantryTactic)

YnnariGirax = {}

function YnnariGiraxTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Ynnari Girax Tactic")
end

------------------------------------------------------------------------------
------------------------------------------------------------------------------
-- GAMBIT: Function used to find specific squads (so that a commander can try
--   to attach to later, as utilized in his Update() function)
-- Called directly to find specifically-named own player squad within range.
-- Returns a squad if found, or nil if not.
------------------------------------------------------------------------------
function YnnariGiraxTactic:Player_GetFirstNamedUnattachedSquadWithin(iNames, iRange)
	local function IsInList(name, array)
		for i = 1, table.getn(array) do
			if array[i] == name then return true end
		end
		return false
	end
	local iSelfPos = self.squad_ai:GetPosition()
	for oSquad in military_manager:GetSquads() do
		if oSquad:IsValid() and not oSquad:IsAttached() and IsInList(oSquad:GetSquadName(), iNames) then
			if distance_sqr(oSquad:GetPosition(), iSelfPos) < iRange*iRange then
				-- Named squad found within range.
				return oSquad
			end
		end
	end
	-- Squad not found, return nil.
	return nil
end

function YnnariGiraxTactic:TryToAttachToNamedSquadWithin(iNames, iRange)
	if self.squad_ai:IsInCombat() then
	-- Limit the range, we do not want the commander to unnecessarily disengage
		iRange = 40
	end
	local iSquadToAttach = self:Player_GetFirstNamedUnattachedSquadWithin(iNames, iRange)
	if iSquadToAttach ~= nil then
		self.squad_ai:DoAttachSquad(iSquadToAttach)
	end
end

------------------------------------------------------------------------------
------------------------------------------------------------------------------

function YnnariGiraxTactic:Update()

	if (self:IsComplete()) then
		return
	end

	-- State machine
	if (not InfantryTactic.Update(self)) then
		return
	end

	-- GAMBIT: New method of selective attachment, via seeking a squad on the map, moving to it, and then attach
	-- Normal range here is the whole map (when trying to move to one of the named squads). Can be set much smaller.
	local iRange = 512
	-- The names of the squads we want this Commander to attach to. Order does not matter.
	local iNames = {"ynnari_squad_yvainne"}
	self:TryToAttachToNamedSquadWithin(iNames, iRange)
end
 