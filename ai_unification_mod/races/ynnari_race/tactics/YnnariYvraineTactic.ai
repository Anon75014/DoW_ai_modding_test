----------------------------------------
-- File: 'ynnariyvrainetactic.ai'
-- Edited by LarkinVB   @ 15.08.2005
-- Edited by Thudmeizer @ 21.04.2024

class 'YnnariYvraineTactic' (InfantryTactic)

Yvraine = {}

function YnnariYvraineTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Ynnari Yvraine Tactic")
end

-- Assassinate win condition -- never attack
function YnnariYvraineTactic:IsAttacker()	
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

-- Assassinate win condition -- never defend
function YnnariYvraineTactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end

function YnnariYvraineTactic:InitAbilities()

	-- Init ability ID's
	if (Yvraine.storm_id == nil) then
		Yvraine.storm_id = cpu_manager.stats:GetAbilityID( "ynnari_storm_of_whispers" )
	end
	if (Yvraine.eldritchstorm_id == nil) then
		Yvraine.eldritchstorm_id = cpu_manager.stats:GetAbilityID( "ynnari_unbind_souls" )
	end
	if (Yvraine.mind_war_id == nil) then
		Yvraine.mind_war_id = cpu_manager.stats:GetAbilityID( "ynnari_gaze" )
	end
	if (Yvraine.guide_id == nil) then
		Yvraine.guide_id = cpu_manager.stats:GetAbilityID( "ynnari_word_of_the_phoenix" )
	end
end

function YnnariYvraineTactic:DoAbilities()
	
	if (self.squad_ai:CanDoAbility(Yvraine.guide_id)) then
		local range = self.squad_ai:GetAbilityRange( Yvraine.guide_id )	
		local squad_filter = function( squad_ai )		
			return squad_ai:IsInCombat() and squad_ai:IsInStateAttackMove() and 
					squad_ai:GetNumTroopers() >= 4 and not squad_ai:IsBroken() and
					not squad_ai:IsCapturing()
		end	
   		local target_squad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
		if (target_squad ~= nil) then
			self.squad_ai:DoSpecialAbilitySquad( Yvraine.guide_id, target_squad:GetSquad() )
 		end
	end
	
	-- If we are dying, lower requisites for attacks
	if (self.squad_ai:WasRecentlyHurt() and self.squad_ai:GetHealthPercentage() < 0.4) then
			
	   Ability.DoAbilityPos( self.squad_ai, Yvraine.eldritchstorm_id, Ability.Filters.CloseEnemy, 6 ) 	
	   Ability.DoAbilityTarget( self.squad_ai, Yvraine.storm_id, Ability.Filters.CloseInfantryEnemy, 4 ) 
	   Ability.DoAbilityTarget( self.squad_ai, Yvraine.mind_war_id, Ability.Filters.CloseInfantryEnemy, 1 )

	   if (self.squad_ai:CanDoAbility(Yvraine.guide_id)) then
			local range = self.squad_ai:GetAbilityRange( Yvraine.guide_id )	
			local squad_filter = function( squad_ai )		
				return squad_ai:IsInCombat() and squad_ai:IsInStateAttackMove() and 
						squad_ai:GetNumTroopers() >= 2 and not squad_ai:IsBroken() and
						not squad_ai:IsCapturing()
			end	
   			local target_squad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), range, squad_filter )
			if (target_squad ~= nil) then
				self.squad_ai:DoSpecialAbilitySquad( Yvraine.guide_id, target_squad:GetSquad() )
 			end
 		end
 	else
		Ability.DoAbilityPos( self.squad_ai, Yvraine.eldritchstorm_id, Ability.Filters.CloseEnemy, 12 ) 
		Ability.DoAbilityTarget( self.squad_ai, Yvraine.storm_id, Ability.Filters.CloseInfantryEnemy, 8 ) 
		Ability.DoAbilityTarget( self.squad_ai, Yvraine.mind_war_id, Ability.Filters.CloseCommanderEnemy, 1 )		
	end
end

function YnnariYvraineTactic:Update()

	if (self:IsComplete()) then
		return
   	end

	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
end

function YnnariYvraineTactic:CheckForDetach()
	-- GAMBIT: The following code includes the names of Commanders
	--  we want this squad to remain PERMANENTLY attach to.
	local iNames = { "ynnari_squad_girax", "ynnari_squad_visarch" }
	for name in iNames do
		if self.squad_ai:HasSquadAttached(name) then return end
	end

	-- Set detach health
	local fDetachHealth = self.m_fCommanderAttachHealth + 0.2

	-- Detach healthy commanders after combat.
    	if (not self.squad_ai:IsInCombat() and not self.squad_ai:WasRecentlyHurt() and
        	self:CommanderAttached() and self.squad_ai:GetAttachedHealthPercentage() > fDetachHealth) then
        	self.squad_ai:DoDetachSquad()
        	self.squad_ai:DoSetDefaultMeleeStance()
    	end
	
	-- Detach commander from broken/capturing
	if ((self.squad_ai:IsBroken() or self.squad_ai:IsCapturing()) and
		(self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt())) then 
		self.squad_ai:DoDetachSquad()
		self.squad_ai:DoSetDefaultMeleeStance()
	end
end