----------------------------------------
-- File: 'firstborninfantrytactic.ai'
-- Edited by Thudmeizer		@ 26.10.2025

class 'FirstbornInfantryTactic' (InfantryTactic)

function FirstbornInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Firstborn Infantry Tactic")
	
	-- Firstborn infantry is able to enter transport vehicles
	self.m_iTransportable = 1	-- Pegasus AFV / Praetor

	-- Firstborn infantry are able to occupy bunkers
	self.m_bBunkerSquad = true

	-- Set FoF range
	--self.m_iFoFRange = 25
end

function FirstbornInfantryTactic:AddTargetAbilities()
	table.insert(InfantryTactic.TargetAbilities, { nil, "firstborn_frag_grenades", Ability.Filters.CloseSquadEnemy, 4, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "firstborn_molotovs", Ability.Filters.CloseSquadEnemy, 4, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "firstborn_demo_charges", Ability.Filters.CloseVehicleEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "firstborn_magnetic_grenade", Ability.Filters.CloseVehicleEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "firstborn_emp_grenades", Ability.Filters.CloseVehicleEnemy, 1, 0 })
	table.insert(InfantryTactic.TargetAbilities, { nil, "firstborn_cryo_grenades", Ability.Filters.CloseSquadEnemy, 1, 0 })
end

function FirstbornInfantryTactic:AddCommanders()
	table.insert(self.commander, { "firstborn_squad_command_squad", true })
	table.insert(self.commander, { "firstborn_squad_harazim", false })
	table.insert(self.commander, { "firstborn_squad_vanus", false })
	table.insert(self.commander, { "firstborn_squad_lieutenant", false })
	table.insert(self.commander, { "firstborn_squad_vox_lieutenant", false })
	table.insert(self.commander, { "firstborn_squad_commissar", false })
	table.insert(self.commander, { "firstborn_squad_medic", false })
	table.insert(self.commander, { "firstborn_squad_priest", false })
	table.insert(self.commander, { "firstborn_squad_banner_bearer", false })
	table.insert(self.commander, { "firstborn_squad_mirror_maiden", false })
end

function FirstbornInfantryTactic:DoAbilities()

	-- Check if we can use Demo Charges (Special Weapons)
	local democharge_id = cpu_manager.stats:GetAbilityID( "firstborn_demo_charges" )
	Ability.DoAbilityTarget( self.squad_ai, democharge_id, Ability.Filters.CloseVehicleEnemy, 1 )
	Ability.DoAbilityTargetEntity( self.squad_ai, democharge_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1)

	-- Check if we can use shroud remove near enemy (Ambushers)
	local shroudremove_id = cpu_manager.stats:GetAbilityID( "firstborn_shroud_remove_abilities" )
	if (self.squad_ai:CanDoAbility(shroudremove_id)) then
		
		-- Allows the squad to have double damage but cannot move
		local oEnemySquad = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), 10, 5)
		if (oEnemySquad ~= nil) then
			
			-- Switch on double-damage
			if (not self.squad_ai:IsUsingAbility(shroudremove_id)) then
				self.squad_ai:DoSpecialAbility(shroudremove_id)
			end
			
		elseif (self.squad_ai:IsUsingAbility(shroudremove_id)) then
			
			-- Switch off double-damage
			self.squad_ai:DoSpecialAbility(shroudremove_id)
		end
	end

	-- Check if I should enable/disable sprint
	--self:DoAbilityFoF()

	-- I might have these attached
	if (self.squad_ai:IsAttached()) then
	
		if (self.squad_ai:HasSquadAttached("firstborn_squad_command_squad")) then
			FirstbornCommandSquadTactic.InitAbilities( self )
			FirstbornCommandSquadTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("firstborn_squad_commissar")) then
			FirstbornCommissarTactic.InitAbilities( self )
			FirstbornCommissarTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("firstborn_squad_priest")) then
			FirstbornPriestTactic.InitAbilities( self )
			FirstbornPriestTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("firstborn_squad_vox_lieutenant")) then
			FirstbornVoxLieutenantTactic.InitAbilities( self )
			FirstbornVoxLieutenantTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("firstborn_squad_harazim")) then
			FirstbornHarazimTactic.InitAbilities( self )
			FirstbornHarazimTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("firstborn_squad_mirror_maiden")) then
			FirstbornMaidenTactic.InitAbilities( self )
			FirstbornMaidenTactic.DoAbilities( self )
		end
	end
	
	-- Call basic DoAbilities methods
	InfantryTactic.DoAbilities(self)
end

function FirstbornInfantryTactic:CheckForDetach()

	-- Detach commander from broken/capturing. troops stay attached
	if ((self.squad_ai:IsBroken() or self.squad_ai:IsCapturing()) and
		(self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) and
		not self.squad_ai:HasSquadAttached( "firstborn_squad_command_squad" ) and
		not self.squad_ai:HasSquadAttached( "firstborn_squad_commissar" ) and
		not self.squad_ai:HasSquadAttached( "firstborn_squad_lieutenant" ) and
		not self.squad_ai:HasSquadAttached( "firstborn_squad_harazim" ) and
		not self.squad_ai:HasSquadAttached( "firstborn_squad_priest" ) and
		not self.squad_ai:HasSquadAttached( "firstborn_squad_mirror_maiden" )) then 
		
		self.squad_ai:DoDetachSquad()
		self.squad_ai:DoSetDefaultMeleeStance()
	end

	-- Call basic detach method
	InfantryTactic.CheckForDetach(self)
end

function FirstbornInfantryTactic:TryAttachSquadMelee()

   	--if I'm in combat
   	local bInfiltrator = self.squad_ai:IsInfiltrating()
	if not self.squad_ai:IsBroken() and self.squad_ai:IsInCombat() then
	  
		if self.squad_ai:GetHealthPercentage() < 0.3 then
		 
			local attachable_filter = function( squad_ai )
			local oTactic = squad_ai:GetTactic()
			return self.squad_ai:CanAttachTo( squad_ai ) and not squad_ai:IsBroken() and
			   	not squad_ai:IsCapturing() and not oTactic:IsInSubState() and
			   	(not squad_ai:IsInfiltrating() or bInfiltrator) and oTactic:IsAttacker()
		end
		 
		 --find close by squads
		 local attach_to = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), 10, attachable_filter )
		 if attach_to ~= nil then 
--[[			
			--sync FoF
			self:ToggleFoF( self.squad_ai, false )
			self:ToggleFoF( attach_to, false )  
]]			
			self.squad_ai:DoAttachSquad( attach_to )
			attach_to:DoSetMeleeStance( SquadAI.MSTANCE_Assault )
		 end 
	  else 
		local melee_filter = function( squad_ai )
		local oTactic = squad_ai:GetTactic()
	        return self.squad_ai:CanAttachTo( squad_ai ) and not squad_ai:IsRanged() and 
			   not squad_ai:IsBroken() and not squad_ai:IsCapturing() and not oTactic:IsInSubState() and
			   (not squad_ai:IsInfiltrating() or bInfiltrator) and oTactic:IsAttacker()
		end
		 
			local attach_to = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), 10, melee_filter )
			if attach_to ~= nil then 
--[[			
				--sync FoF
				self:ToggleFoF( self.squad_ai, false )
				self:ToggleFoF( attach_to, false )  
]]			
				self.squad_ai:DoAttachSquad( attach_to )
				attach_to:DoSetMeleeStance( SquadAI.MSTANCE_Assault )
		 	end 
		end	  
	end
end

function FirstbornInfantryTactic:DoMoveAttach( attach_to )
--[[   
	-- Sync FoF
	self:ToggleFoF( self.squad_ai, fof )
	self:ToggleFoF( attach_to, fof )
]]
	-- Call standard method
	Tactic.DoMoveAttach(self, attach_to)
end
--[[
function FirstbornInfantryTactic:ToggleFoF( squad_ai, state )

	-- Check if the squad can handle sprint
	local id = cpu_manager.stats:GetAbilityID( "firstborn_sprint" )
	if (not squad_ai:CanDoAbility(id)) then
		return
	end
	
	-- Check if it's already in desired state
	if (squad_ai:IsUsingAbility(id) == state) then
		return 
	end
	
	-- Activate sprint
	squad_ai:DoSpecialAbility(id)
end

-- Dreddnott edit (April 16th)
function FirstbornInfantryTactic:DoAbilityFoF()

    -- Check if we should toggle FoF
    local iFoFID = cpu_manager.stats:GetAbilityID( "firstborn_sprint" )
    local bToggleFoF = false

    -- Check whether we're using the ability
    local bIsUsing = self.squad_ai:IsUsingAbility(iFoFID)

    -- Check if we're attacking
    local bIsAttacking = self.squad_ai:IsInStateAttackMove()
    
    -- Check if we are shooting or fighting in melee
    local bIsFighting = self.squad_ai:IsAttacking()
    
    -- Check if we're moving normally
    local bIsMoving = (self.squad_ai:IsInStateMove() and not bIsAttacking)

    -- Check if we're in a state that should FoF regardless of enemy presence
    local bAvoidCombat = (self.squad_ai:IsBroken() or self:IsInSubState() or self.squad_ai:IsCapturing() or bIsMoving)

    -- Check if we should slow down for enemies nearing range
    local vSquadPos = self.squad_ai:GetPosition()
    local oEnemy = cpu_manager.cpu_player:FindFirstEnemy(vSquadPos, self.m_iFoFRange, 1)
    local bCloseEnemy = (oEnemy ~= nil)
    
    -- Helper flags
    local bIsCharging = (bIsAttacking and bCloseEnemy)
    local bIsDefending = (not bIsMoving and bCloseEnemy)
    local bIsInCombat = (bIsFighting or bIsCharging or bIsDefending)

    -- Check if FoF should be toggled
    if ((bIsUsing and bIsInCombat and not bAvoidCombat) or
    	(not bIsUsing and (not bIsInCombat or bAvoidCombat))) then        
        bToggleFoF = true
    end

    -- Toggle FoF
    if (bToggleFoF and self.squad_ai:CanDoAbility(iFoFID)) then
        self.squad_ai:DoSpecialAbility(iFoFID)
    end
end
]]