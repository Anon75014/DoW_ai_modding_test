----------------------------------------
-- File: 'firstborncommandsquadtactic.ai'
-- Edited by Thudmeizer		@ 07.11.2024

class 'FirstbornCommandSquadTactic' (FirstbornInfantryTactic)

FirstbornCommandSquad = {}

FirstbornCommandSquadTactic.SpecialAbilities = 
{
	{ nil, "firstborn_regent_ura",                		Ability.Filters.IsInCombat },
}

FirstbornCommandSquadTactic.PosAbilities = 
{
	{ nil, "firstborn_blackjack_bombing",			Ability.Filters.CloseEnemy, 8 },
	{ nil, "firstborn_nuke_artillery_regent",		Ability.Filters.CloseEnemy, 12 },
}

FirstbornCommandSquadTactic.TargetAbilities = 
{
        { nil, "firstborn_regent_grenade", 			Ability.Filters.CloseSquadEnemy, 4 },
}

function FirstbornCommandSquadTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Firstborn Command Squad Tactic")
	
	-- Command squad is able to enter a bunker
	self.m_bBunkerSquad = true

	self.timedDirectSpawnAbility = Timer( FirstbornCommandSquadTactic.DoDirectSpawnAbility, self, 5 )
end

function FirstbornCommandSquadTactic:InitAbilities()

	-- Init ability ID's
	if (FirstbornCommandSquadTactic.SpecialAbilities[1][1] == nil) then
		for i in FirstbornCommandSquadTactic.SpecialAbilities do
			local ability_id = cpu_manager.stats:GetAbilityID( FirstbornCommandSquadTactic.SpecialAbilities[i][2] )
			FirstbornCommandSquadTactic.SpecialAbilities[i][1] = ability_id
		end
	end

	if (FirstbornCommandSquadTactic.PosAbilities[1][1] == nil) then
		for i in FirstbornCommandSquadTactic.PosAbilities do
			local ability_id = cpu_manager.stats:GetAbilityID( FirstbornCommandSquadTactic.PosAbilities[i][2] )
			FirstbornCommandSquadTactic.PosAbilities[i][1] = ability_id
		end
	end
	
	if (FirstbornCommandSquadTactic.TargetAbilities[1][1] == nil) then
		for i in FirstbornCommandSquadTactic.TargetAbilities do
			local ability_id = cpu_manager.stats:GetAbilityID( FirstbornCommandSquadTactic.TargetAbilities[i][2] )
			FirstbornCommandSquadTactic.TargetAbilities[i][1] = ability_id
		end
	end
end

function FirstbornCommandSquadTactic:DoAbilities()

	for i in FirstbornCommandSquadTactic.SpecialAbilities do
		local ability_id = FirstbornCommandSquadTactic.SpecialAbilities[i][1]
		if ability_id ~= nil then

		local filter = FirstbornCommandSquadTactic.SpecialAbilities[i][3]
			Ability.DoAbility( self.squad_ai, ability_id, filter ) 
		end
	end

	for i in FirstbornCommandSquadTactic.PosAbilities do
		local ability_id = FirstbornCommandSquadTactic.PosAbilities[i][1]
		if ability_id ~= nil then

			local filter = FirstbornCommandSquadTactic.PosAbilities[i][3]
			local squad_count = FirstbornCommandSquadTactic.PosAbilities[i][4]
			Ability.DoAbilityPos( self.squad_ai, ability_id, filter, squad_count ) 
		end
	end

	for i in FirstbornCommandSquadTactic.TargetAbilities do
		local ability_id = FirstbornCommandSquadTactic.TargetAbilities[i][1]
		if ability_id ~= nil then

			local filter = FirstbornCommandSquadTactic.TargetAbilities[i][3]
			local squad_count = FirstbornCommandSquadTactic.TargetAbilities[i][4]
			Ability.DoAbilityTarget( self.squad_ai, ability_id, filter, squad_count ) 
		end
	end

	-- Try to spawn Shturmoviki
	if (self.timedDirectSpawnAbility ~= nil) then
		self.timedDirectSpawnAbility:Call()
	else
		FirstbornCommandSquadTactic.DoDirectSpawnAbility(self)
	end
end

-- Assassinate win condition -- never attack
function FirstbornCommandSquadTactic:IsAttacker()

	-- Never attack in assassinate game mode
	if (cpu_manager.assassinate) then
		return false
	end
	
	-- Attack if we have more than one squad member
	if (self.squad_ai:GetNumTroopers() > 1) then
		return true
	end
	return self:IsCommanderAttacker()
end

-- Assassinate win condition -- never defend
function FirstbornCommandSquadTactic:IsDefender()

	-- Never defend in assassinate game mode
	if (cpu_manager.assassinate) then
		return false
	end
	
	-- Defend if we have more than one squad member
	if (self.squad_ai:GetNumTroopers() > 1) then
		return true
	end
	return self:IsCommanderDefender()
end

function FirstbornCommandSquadTactic:DoDirectSpawnAbility()

	-- Spawn Shturmoviki in combat
	if (self.squad_ai:CanDirectSpawn()) then 
		self.squad_ai:DoDirectSpawn()
	end
end

function FirstbornCommandSquadTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Assassinate win condition -- never attach to a squad
   	 if (not cpu_manager.assassinate and self.squad_ai:GetMeleeStance() == SquadAI.MSTANCE_Assault) then
         
        	if (self.squad_ai:IsInCombat() or self.squad_ai:WasRecentlyHurt()) then
        
            		if (self:TryAttachSquad(false, true, 50, 150, self.m_fCommanderAttachHealth) == nil) then
                		self:TryAttachSquadMelee()
            		end
        	end
    	end
end



