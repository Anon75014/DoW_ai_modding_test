----------------------------------------
-- File: 'Dorntactic.ai'
-- Edited by Thudmeizer @ 08.02.2019

class 'DornTactic' (ImperialFistsInfantryTactic)

Dorn = {}

function DornTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Dorn Tactic")
end




function DornTactic:InitAbilities()

	-- Init ability ID's
	if (Dorn.missile_id == nil) then
		Dorn.missile_id = cpu_manager.stats:GetAbilityID( "imperial_fists_dorns_missile_tits" )
		Dorn.missile_id4= cpu_manager.stats:GetAbilityID( "imperial_fists_dorns_missile_tits_4" )
		Dorn.rally_id= cpu_manager.stats:GetAbilityID( "imperial_fists_dorns_rally" )
		Dorn.phalanx_id= cpu_manager.stats:GetAbilityID( "imperial_fists_dorns_phalanx" )
	end
end

function DornTactic:DoAbilities()


	if self.squad_ai:IsAttacking() then
		if self.squad_ai:CanDoAbility(Dorn.rally_id) then
			self.squad_ai:DoSpecialAbilitySquad(Dorn.rally_id, self.squad_ai:GetSquad())
			return
		end
		if self.squad_ai:CanDoAbility(Dorn.missile_id) then
			if Ability.DoAbilityTarget( self.squad_ai, Dorn.missile_id, Ability.Filters.CloseVehicleEnemy, 1 )
			or Ability.DoAbilityTargetEntity( self.squad_ai, Dorn.missile_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
			or Ability.DoAbilityTarget( self.squad_ai, Dorn.missile_id, Ability.Filters.CloseSquadEnemy, 4 ) then
				return
			end
		end
		if self.squad_ai:CanDoAbility(Dorn.missile_id4) then
			if Ability.DoAbilityTarget( self.squad_ai, Dorn.missile_id4, Ability.Filters.CloseVehicleEnemy, 1 )
			or Ability.DoAbilityTargetEntity( self.squad_ai, Dorn.missile_id4, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
			or Ability.DoAbilityTarget( self.squad_ai, Dorn.missile_id4, Ability.Filters.CloseSquadEnemy, 4 ) then
				return
			end
		end
		if self.squad_ai:CanDoAbility(Dorn.phalanx_id) then
			local iReq = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Requisition )
			local iPow = resource_manager:GetResourceAmount():Get( ResourceAmount.RT_Power )
			if iReq > 1000 and iPow > 1000 then
				if Ability.DoAbilityTargetEntity( self.squad_ai, Dorn.phalanx_id, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
				or Ability.DoAbilityTarget( self.squad_ai, Dorn.phalanx_id, Ability.Filters.CloseVehicleEnemy, 1 )
				or Ability.DoAbilityTarget( self.squad_ai, Dorn.phalanx_id, Ability.Filters.CloseEnemy, 8 ) then
					return
				end
			end
		end
	end
end

function DornTactic:Update()

	if (self:IsComplete()) then
		return
	end
	
	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		

	-- Check if we are in serious trouble
	self:EmergencyRetreat()
end
