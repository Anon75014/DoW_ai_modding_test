----------------------------------------
-- File: 'imperialfistsinfantrytactic.ai'
-- Edited by Thudmeizer         @ 01.09.2025

class 'ImperialFistsInfantryTactic' (InfantryTactic)

ImperialFistsInfantryAbility =
{
	-- Infantry
    	FragBombID = cpu_manager.stats:GetAbilityID("imperial_fists_frag_grenades"),
  	MeltaBombID = cpu_manager.stats:GetAbilityID("imperial_fists_melta_bombs_tactical"),
	BolterDrillID = cpu_manager.stats:GetAbilityID("imperial_fists_bolter_drill"),
  	PhosphorID = cpu_manager.stats:GetAbilityID("imperial_fists_crimson_phosphor_grenades"),
  	VengeanceID = cpu_manager.stats:GetAbilityID("imperial_fists_crimson_vengeance_grenade_shot")
}

function ImperialFistsInfantryTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("Imperial Fists Infantry Tactic")
	
	-- Set infantry options
	local sSquadName = squad_ai:GetSquadName()
	if (sSquadName == "imperial_fists_squad_tactical" or
		sSquadName == "imperial_fists_squad_assault" or
		sSquadName == "imperial_fists_squad_devastator" or
		sSquadName == "imperial_fists_squad_apothecary" or
		sSquadName == "imperial_fists_squad_crimson_voxer" or
		sSquadName == "imperial_fists_squad_librarian" or
		sSquadName == "imperial_fists_squad_chaplain") then
		
		-- Squads are transportable and able to deepstrike	
		self.m_iTransportable = 1	-- Rhino and Razorback
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("imperial_fists_orbital_relay")
		
	elseif (sSquadName == "imperial_fists_squad_captain_primaris" or
			sSquadName == "imperial_fists_squad_centurion" or
			sSquadName == "imperial_fists_squad_centurion_assault" or
			sSquadName == "imperial_fists_squad_crimson_primaris" or
			sSquadName == "imperial_fists_squad_terminator_assault") then
		
		-- Squads are transportable and able to deepstrike	
		self.m_iTransportable = 2	-- Land Raider, Prometheus, Achilles, and Rynn
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("imperial_fists_barracks")

	elseif (sSquadName == "imperial_fists_squad_captain" or
			sSquadName == "imperial_fists_squad_diomedes" or
			sSquadName == "imperial_fists_squad_morales" or
			sSquadName == "imperial_fists_squad_pedro_kantor") then

		-- Squads are transportable	
		self.m_iTransportable = 3	-- Damocles Command Rhino
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("imperial_fists_orbital_relay")

	elseif (sSquadName == "imperial_fists_squad_siege_marines" or
			sSquadName == "imperial_fists_squad_dorn_of_war" or
			sSquadName == "imperial_fists_squad_mavuika") then

		-- Squads are transportable
		self.m_iDeepStrikeBlueprintID = cpu_manager.stats:GetBuildingID("imperial_fists_orbital_relay")
	end

    self.fragBombLastUse = g_iGMT
    self.meltaBombLastUse = g_iGMT
    self.vortexBombLastUse = g_iGMT
    self.phosphorLastUse = g_iGMT
    self.vengeanceLastUse = g_iGMT
end

function ImperialFistsInfantryTactic:AddTargetAbilities()
table.insert(InfantryTactic.TargetAbilities, { nil, "imperial_fists_marines_vortex_grenades_idh", Ability.Filters.CloseEnemy, 1, 0 })
end

-- They are Fanatically Stubborn, no need to retreat!
function ImperialFistsInfantryTactic:IsAffectedByMorale()
	return false
end


function ImperialFistsInfantryTactic:AddCommanders()
	table.insert(self.commander, { "imperial_fists_squad_captain", true })
	table.insert(self.commander, { "imperial_fists_squad_captain_primaris", true })
	table.insert(self.commander, { "imperial_fists_squad_librarian", false })
	table.insert(self.commander, { "imperial_fists_squad_chaplain", false })
	table.insert(self.commander, { "imperial_fists_squad_diomedes", false })
	table.insert(self.commander, { "imperial_fists_squad_pedro_kantor", false })
	table.insert(self.commander, { "imperial_fists_squad_morales", false })
	table.insert(self.commander, { "imperial_fists_squad_mavuika", false })
end

function ImperialFistsInfantryTactic:DoAbilities()

	-- I might have these attached
	if (self.squad_ai:IsAttached()) then
	
		if (self.squad_ai:HasSquadAttached("imperial_fists_squad_captain")) then
			CaptainTactic.InitAbilities( self )
			CaptainTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("imperial_fists_squad_captain_primaris")) then
			CaptainPrimarisTactic.InitAbilities( self )
			CaptainPrimarisTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("imperial_fists_squad_librarian")) then
			LibrarianTactic.InitAbilities( self )
			LibrarianTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("imperial_fists_squad_chaplain")) then
			ChaplainTactic.InitAbilities( self )
			ChaplainTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("imperial_fists_squad_diomedes")) then
			LexTactic.InitAbilities( self )
			LexTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("imperial_fists_squad_morales")) then
			AlessioCortezTactic.InitAbilities( self )
			AlessioCortezTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("imperial_fists_squad_pedro_kantor")) then
			PedroKantorTactic.InitAbilities( self )
			PedroKantorTactic.DoAbilities( self )
		elseif (self.squad_ai:HasSquadAttached("imperial_fists_squad_mavuika")) then
			MavuikaTactic.InitAbilities( self )
			MavuikaTactic.DoAbilities( self )
		end
	end
	
	self:DoThrowGrenades()

	-- Call basic DoAbilities methods
	InfantryTactic.DoAbilities(self)
end

function ImperialFistsInfantryTactic:DoThrowGrenades()

	if self.squad_ai:IsInCombat() then
        
		-- Frag Grenade
		if ( g_iGMT > self.fragBombLastUse + 30 ) then
            		if Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.FragBombID, Ability.Filters.CloseCommanderEnemy, 1 ) 
            		or Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.FragBombID, Ability.Filters.CloseSquadEnemy, 4 )
            		or Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.FragBombID, Ability.Filters.CloseMonsterEnemy, 4 )
            		then
                		self.fragBombLastUse = g_iGMT 
            		end
		end
  
		-- Melta Bomb
		if ( g_iGMT > self.meltaBombLastUse + 65 ) then        
            		if Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.MeltaBombID, Ability.Filters.CloseVehicleEnemy, 1 )
  			or Ability.DoAbilityTargetEntity( self.squad_ai, ImperialFistsInfantryAbility.MeltaBombID, Ability.EntityFilters.CloseBaseEntityEnemy, 1 )
            		then
                		self.meltaBombLastUse = g_iGMT
			end
		end

		-- Bolter Drill
		if self.squad_ai:CanDoAbility(ImperialFistsInfantryAbility.BolterDrillID) then
			if self.squad_ai:IsAttacking() then
				local nearby_squad = cpu_manager.cpu_player:FindFirstEnemy(self.squad_ai:GetPosition(), 25, 1)
				if nearby_squad == nil then
					self.squad_ai:DoSpecialAbility(ImperialFistsInfantryAbility.BolterDrillID)
				end
			end
		end

		-- CF Phosphor Grenade
		if ( g_iGMT > self.phosphorLastUse + 30 ) then
            		if Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.PhosphorID, Ability.Filters.CloseSquadEnemy, 4 )
            		or Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.PhosphorID, Ability.Filters.CloseCommanderEnemy, 1 ) 
            		or Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.PhosphorID, Ability.Filters.CloseMonsterEnemy, 4 )
            		then
                		self.phosphorLastUse = g_iGMT 
            		end
		end

		-- CF Vengeance Shot
		if ( g_iGMT > self.vengeanceLastUse + 30 ) then
            		if Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.VengeanceID, Ability.Filters.CloseSquadEnemy, 4 )
            		or Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.VengeanceID, Ability.Filters.CloseCommanderEnemy, 1 ) 
            		or Ability.DoAbilityTarget( self.squad_ai, ImperialFistsInfantryAbility.VengeanceID, Ability.Filters.CloseMonsterEnemy, 4 )
            		then
                		self.vengeanceLastUse = g_iGMT 
            		end
		end
	end
end

function ImperialFistsInfantryTactic:CheckForBroken()

	if (self.squad_ai:IsBroken()) then
	
		-- Check if I can repair my morale
		local rally_id = cpu_manager.stats:GetAbilityID( "imperial_fists_rally" )
		if (self.squad_ai:CanDoAbility( rally_id )) then
			self.squad_ai:DoSpecialAbility( rally_id )
		end
	end
	
	-- Call basic broken check method
	InfantryTactic.CheckForBroken(self)
end

function ImperialFistsInfantryTactic:CheckDance(oSquad)

	-- Check opponent
	if (oSquad == nil) then
		return false
	end
	
	-- Compare opponents
	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "imperial_fists_squad_tactical" or sSquadName == "imperial_fists_squad_terminator") then
		
		-- Check opponent
		if (oSquad:GetSquadName() == "chaos_squad_cultist") then
			return false
		end
	end
	return true
end

function ImperialFistsInfantryTactic:Upgrade()

	-- Check if we have free ressources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- Don't upgrade space marine squads with less than 6 troopers
	if (self.squad_ai:GetSquadName() == "imperial_fists_squad_tactical" and self.squad_ai:GetNumTroopers() < 6) then
		return
	end
	
	if (not self.squad_ai:IsReinforcing() and self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 3) then
		
		-- Figure out my enemy's favourite class
		local enemy = cpu_manager:FindClosestEnemyPlayer()
		if (enemy == nil) then
			return
		end
		local class_type = enemy:GetMajorityClassType()
		
		-- Larkins hard counter upgrade for HeavyInfantryMed 
		if (class_type < UnitStatsAI.UC_HeavyInfantryMed) then	  
		  
			local enemy_race = enemy:GetPlayerRaceName()
			if (enemy_race == "imperial_fists_race" or enemy_race == "chaos_marine_race" or enemy_race == "necron_race") then
		    	class_type = UnitStatsAI.UC_HeavyInfantryMed
		  	end
		end
		
		-- Do best upgrade
		self.squad_ai:DoBestUpgrade(class_type)
	end
end