----------------------------------------
-- File: 'DHLordtactic.ai'
-- Edited by Gambit 	@ 15.02.2021
-- Edited by Thudmeizer @ 31.10.2023

class 'DHLordTactic' (DaemonhuntInfantryTactic)

DHLord = {}

function DHLordTactic:__init( squad_ai ) super( squad_ai )

	self:SetName("DHLord Tactic")
	self.daemonhostTime = g_iGMT
end

-- Assassinate win condition -- never attack
function DHLordTactic:IsAttacker()
	return (not cpu_manager.assassinate and self:IsCommanderAttacker())
end

-- Assassinate win condition -- never defend
function DHLordTactic:IsDefender()
	return (not cpu_manager.assassinate and self:IsCommanderDefender())
end

function DHLordTactic:InitAbilities()

	if (DHLord.banish_id == nil) then
	    	DHLord.banish_id = cpu_manager.stats:GetAbilityID( "inquisition_inquisitor_lord_banish" )
	    	DHLord.wrath_id = cpu_manager.stats:GetAbilityID( "inquisition_inquisitor_lord_emperor_wrath" )
		DHLord.daemonhost = cpu_manager.stats:GetAbilityID( "inquisition_inquisitor_lord_create_daemonhost" )
		DHLord.daemonhostB = cpu_manager.stats:GetAbilityID( "inquisition_inquisitor_lord_create_daemonhost_2" )
		DHLord.strength_id = cpu_manager.stats:GetAbilityID( "inquisition_daemon_strength" )	
	end
end

function DHLordTactic:DoAbilities()

	if self.daemonhostTime == nil then self.daemonhostTime = g_iGMT end

	-- Use the Create Daemonhost ability when alone and out of trouble
	if g_iGMT > self.daemonhostTime + 10 and not self.squad_ai:IsAttached() then
		if not self.squad_ai:IsInCombat() and self.squad_ai:CanDoAbility(DHLord.daemonhost) then	
			local squad_filter = function( squad_ai )
				return squad_ai:IsValid() and squad_ai:GetSquadName() == "inquisition_squad_acolyte_doomed"
			end	
			local oSquad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), 20, squad_filter )
			if oSquad ~= nil and oSquad:IsValid() then
				if oSquad:GetHealthPercentage() > 0.8 then
					self.squad_ai:DoSpecialAbilitySquad( DHLord.daemonhost, oSquad:GetSquad() )
					self.daemonhostTime = g_iGMT
				end
			end
 		end
	end

	-- Use the Create 2nd Daemonhost ability when alone and out of trouble (Single Player)
	if g_iGMT > self.daemonhostTime + 10 and not self.squad_ai:IsAttached() then
		if not self.squad_ai:IsInCombat() and self.squad_ai:CanDoAbility(DHLord.daemonhostB) then	
			local squad_filter = function( squad_ai )
				return squad_ai:IsValid() and squad_ai:GetSquadName() == "inquisition_squad_acolyte_doomed"
			end	
			local oSquad = cpu_manager:GetClosestSquad( self.squad_ai:GetPosition(), 20, squad_filter )
			if oSquad ~= nil and oSquad:IsValid() then
				if oSquad:GetHealthPercentage() > 0.8 then
					self.squad_ai:DoSpecialAbilitySquad( DHLord.daemonhostB, oSquad:GetSquad() )
					self.daemonhostTime = g_iGMT
				end
			end
 		end
	end

	if g_iGMT > self.daemonhostTime + 10 and self.squad_ai:IsInCombat() then
		Ability.DoAbility( self.squad_ai, DHLord.strength_id, Ability.Filters.IsInCombat )
		Ability.DoAbilityPos( self.squad_ai, DHLord.banish_id, Ability.Filters.CloseMonsterEnemy, 1 )
		Ability.DoAbilityPos( self.squad_ai, DHLord.banish_id, Ability.Filters.CloseCommanderEnemy, 1 )  
		Ability.DoAbilityArea( self.squad_ai, DHLord.wrath_id, Ability.Filters.CloseEnemy, 15, 2 )
	end
end


function DHLordTactic:Update()

	if (self:IsComplete()) then
		return
	end

	-- Make sure we are not creating a Daemonhost
	if self.daemonhostTime ~= nil and g_iGMT < self.daemonhostTime + 12 then
		return
	end

	-- State machine
	if (not InfantryTactic.Update( self )) then
		return
	end
		
	-- Assassinate win condition -- never attach to a squad
	if (not cpu_manager.assassinate) then
		
		-- Attach to melee in tier3+
		if (cpu_manager:GetTierLevel() > 2) then
		
			if (self:TryAttachSquad(true, true, 50, 100, nil) ~= nil) then
				return
			end
		end
		if (self:TryAttachSquad(false, true, 50, 100, self.m_fCommanderAttachHealth) == nil) then
			self:TryAttachSquadMelee()
		end
	end
end
