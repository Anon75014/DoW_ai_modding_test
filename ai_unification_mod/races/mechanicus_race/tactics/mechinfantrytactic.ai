----------------------------------------
-- File: 'MechInfantryTactic.ai'
-- Edited by Thudmeizer		@ 26.10.2008
-- Edited by Karandras  	@ 17.03.2012
-- Heavily edited by Gambit	@ 14.10.2015

class 'MechInfantryTactic' (InfantryTactic)

function MechInfantryTactic:__init( squad_ai ) super( squad_ai )
	self:SetName("Mech Infantry Tactic")
end

function MechInfantryTactic:AddTargetAbilities()
	table.insert(InfantryTactic.TargetAbilities, { nil, "mechanicus_omnissiah_grenades", Ability.Filters.CloseVehicleEnemy, 1, 0 })
end

function MechInfantryTactic:AddCommanders()
	table.insert(self.commander, { "mechanicus_squad_arhimagos", true })
	table.insert(self.commander, { "mechanicus_squad_magos_explorator", false })
--	table.insert(self.commander, { "mechanicus_squad_skull_probes", false })
end

function MechInfantryTactic:DoAbilities()

	-- I might have these attached
	if self.squad_ai:IsAttached() then
		if self.squad_ai:HasSquadAttached("mechanicus_squad_skull_probes")
		or self.squad_ai:HasSquadAttached("mechanicus_squad_skull_probes_2")
		or self.squad_ai:HasSquadAttached("mechanicus_squad_skull_probes_3") then
			-- Detach attached skull probes if need be
			if self.squad_ai:IsAttached() then
				if (self.squad_ai:GetHealthPercentage() > 0.85 and not self.squad_ai:WasRecentlyHurt())
				or self.squad_ai:GetNumTroopers() < 4 then
					self.squad_ai:DoDetachSquad()
				end
			end
			SkullProbesTactic.InitAbilities( self )
			SkullProbesTactic.DoAbilities( self )
		elseif self.squad_ai:HasSquadAttached("mechanicus_squad_arhimagos") then
			ArhimagosTactic.InitAbilities( self )
			ArhimagosTactic.DoAbilities( self )
		end
	end
	
	-- Call basic DoAbilities methods
	InfantryTactic.DoAbilities(self)
end


function MechInfantryTactic:CheckDance(oSquad)

	-- Check opponent
	if (oSquad == nil) then
		return false
	end
	
	-- Compare opponents
	local sSquadName = self.squad_ai:GetSquadName()
	if (sSquadName == "mechanicus_squad_skitarii" or sSquadName == "mechanicus_squad_skitarii_hover") then
		
		-- Check opponent
		if (oSquad:GetSquadName() == "chaos_squad_cultist") then
			return false
		end
	end
	return true
end

function MechInfantryTactic:Upgrade()

	-- Check if we have free ressources
	if (not Tactic.Options.can_reinforce) then
		return
	end
	
	-- If I am broken, don't upgrade!
	if (self:IsAffectedByMorale() and self.squad_ai:IsBroken()) then
		return
	end
	
	-- Don't upgrade space skitatii squads with less than 4 troopers
	if (self.squad_ai:GetSquadName() == "mechanicus_squad_skitarii" and self.squad_ai:GetNumTroopers() < 4) then
	elseif (self.squad_ai:GetSquadName() == "mechanicus_squad_skitarii_hover" and self.squad_ai:GetNumTroopers() < 4) then
		return
	end
	
	if (not self.squad_ai:IsReinforcing() and self.squad_ai:HasUpgradableTrooper() and self.squad_ai:GetNumTroopers() > 3) then
		
		-- Figure out my enemy's favourite class
		local enemy = cpu_manager:FindClosestEnemyPlayer()
		if (enemy == nil) then
			return
		end
		local class_type = enemy:GetMajorityClassType()
		
		-- Larkins hard counter upgrade for HeavyInfantryMed 
		if (class_type < UnitStatsAI.UC_HeavyInfantryMed) then	  
		  
			local enemy_race = enemy:GetPlayerRaceName()
			if (enemy_race == "space_marine_race" or enemy_race == "chaos_marine_race" or enemy_race == "necron_race") then
		    	class_type = UnitStatsAI.UC_HeavyInfantryMed
		  	end
		end
		
		-- Do best upgrade
		self.squad_ai:DoBestUpgrade(class_type)
	end
end

